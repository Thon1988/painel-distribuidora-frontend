<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Peça Seus Ovos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { --brand: #e11d48; }
        body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #1f2937; -webkit-tap-highlight-color: transparent; }
        
        .premium-card { background: white; border-radius: 32px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.03); transition: all 0.3s ease; }
        .premium-card:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--brand); color: white; border-radius: 24px; font-weight: 900; text-transform: uppercase; letter-spacing: -0.5px; transition: 0.2s; shadow: 0 10px 20px rgba(225, 29, 72, 0.2); }
        .btn-primary:disabled { background: #e5e7eb; color: #9ca3af; shadow: none; }

        .egg-badge { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); padding: 6px 12px; border-radius: 14px; font-weight: 800; font-size: 10px; color: var(--brand); }
        
        .status-pill { padding: 6px 12px; border-radius: 12px; font-size: 10px; font-weight: 900; text-transform: uppercase; }
        .status-CRIADO { background: #f3f4f6; color: #6b7280; }
        .status-PREPARANDO { background: #fef3c7; color: #d97706; }
        .status-SAIU { background: #dcfce7; color: #166534; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";
        const IMG_DEFAULT = "https://via.placeholder.com/300x300?text=AppEgg+Ovos";

        window.state = {
            view: 'loja', // loja, pedidos, checkout
            produtos: [],
            meusPedidos: [],
            carrinho: null,
            loading: true,
            cliente: JSON.parse(localStorage.getItem('appegg_user')) || null
        };

        // Lógica de Foto Segura (Mesma do Admin para paridade total)
        window.safeImg = (url) => {
            if (!url || typeof url !== "string" || url.trim() === "" || url.includes("null")) return IMG_DEFAULT;
            return url.trim();
        };

        async function init() {
            await loadProdutos();
            if (state.cliente) {
                syncMeusPedidos();
            }
            render();
        }

        async function loadProdutos() {
            try {
                const r = await fetch(`${API_BASE}/produtos`);
                const data = await r.json();
                state.produtos = Array.isArray(data) ? data : [];
            } catch (e) {
                console.error("Erro API:", e);
                state.produtos = [];
            }
            state.loading = false;
            render();
        }

        function syncMeusPedidos() {
            const q = query(
                collection(db, "vendas_logs"), 
                where("telefone", "==", state.cliente.telefone),
                orderBy("criadoEm", "desc")
            );
            onSnapshot(q, s => {
                state.meusPedidos = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        window.render = () => {
            const root = document.getElementById('app-root');
            
            root.innerHTML = `
                <header class="p-6 pt-10 bg-white mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-black tracking-tighter text-gray-900">AppEgg</h1>
                            <p class="text-[10px] font-bold text-rose-600 uppercase tracking-widest">Ovos Direto da Granja</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="state.view='loja';render()" class="p-3 rounded-2xl ${state.view==='loja'?'bg-rose-50 text-rose-600':'text-gray-400'}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                            </button>
                            <button onclick="state.view='pedidos';render()" class="p-3 rounded-2xl ${state.view==='pedidos'?'bg-rose-50 text-rose-600':'text-gray-400'}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                            </button>
                        </div>
                    </div>
                </header>

                <main class="px-6">
                    ${state.view === 'loja' ? renderLoja() : 
                      state.view === 'checkout' ? renderCheckout() : renderMeusPedidos()}
                </main>
            `;
        };

        function renderLoja() {
            if (state.loading) return `<div class="py-20 text-center font-black text-gray-300 animate-pulse">CARREGANDO ESTOQUE...</div>`;
            
            return `
                <div class="grid grid-cols-1 gap-6">
                    ${state.produtos.map(p => `
                        <div class="premium-card overflow-hidden" onclick="abrirCheckout(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                            <div class="relative h-48">
                                <img src="${safeImg(p.foto_url)}" class="w-full h-full object-cover">
                                <div class="egg-badge">${p.embalagem}</div>
                            </div>
                            <div class="p-6 flex justify-between items-end">
                                <div>
                                    <h3 class="font-black text-lg uppercase">${p.nome}</h3>
                                    <p class="text-rose-600 font-black text-xl">R$ ${Number(p.preco).toFixed(2)}</p>
                                </div>
                                <div class="bg-gray-900 text-white p-4 rounded-2xl shadow-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        window.abrirCheckout = (prod) => {
            state.carrinho = prod;
            state.view = 'checkout';
            render();
        };

        function renderCheckout() {
            const p = state.carrinho;
            return `
                <div class="premium-card p-8">
                    <button onclick="state.view='loja';render()" class="text-[10px] font-black text-gray-400 mb-6 uppercase">← Voltar</button>
                    <div class="flex items-center gap-4 mb-8">
                        <img src="${safeImg(p.foto_url)}" class="w-20 h-20 rounded-[24px] object-cover">
                        <div>
                            <h2 class="font-black text-xl uppercase">${p.nome}</h2>
                            <p class="text-rose-600 font-black">${p.embalagem} • R$ ${p.preco}</p>
                        </div>
                    </div>

                    <form onsubmit="finalizarPedido(event)" class="space-y-4">
                        <input name="nome" placeholder="Seu Nome" required class="w-full p-5 bg-gray-50 rounded-2xl border-none font-bold outline-none focus:ring-2 ring-rose-500" value="${state.cliente?.nome || ''}">
                        <input name="whatsapp" placeholder="WhatsApp (DDD)" required type="tel" class="w-full p-5 bg-gray-50 rounded-2xl border-none font-bold outline-none focus:ring-2 ring-rose-500" value="${state.cliente?.telefone || ''}">
                        <input name="endereco" placeholder="Endereço de Entrega" required class="w-full p-5 bg-gray-50 rounded-2xl border-none font-bold outline-none focus:ring-2 ring-rose-500">
                        
                        <div class="pt-6">
                            <button class="btn-primary w-full py-6 text-sm">Confirmar Pedido</button>
                        </div>
                    </form>
                </div>
            `;
        }

        window.finalizarPedido = async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const cliente = { nome: f.get('nome'), telefone: f.get('whatsapp') };
            localStorage.setItem('appegg_user', JSON.stringify(cliente));
            state.cliente = cliente;

            const pedido = {
                clienteNome: cliente.nome,
                telefone: cliente.telefone,
                endereco: f.get('endereco'),
                produto: state.carrinho.nome,
                quantidade: 1,
                valorTotal: state.carrinho.preco,
                status: 'CRIADO',
                criadoEm: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "vendas_logs"), pedido);
                state.view = 'pedidos';
                syncMeusPedidos();
                render();
            } catch (err) {
                alert("Erro ao enviar pedido.");
            }
        };

        function renderMeusPedidos() {
            if (!state.cliente) return `<div class="py-20 text-center font-black text-gray-300">VOCÊ AINDA NÃO TEM PEDIDOS</div>`;

            return `
                <h2 class="font-black uppercase text-xs text-gray-400 mb-6 tracking-widest text-center">Acompanhe seus pedidos</h2>
                <div class="space-y-4">
                    ${state.meusPedidos.map(p => `
                        <div class="premium-card p-6 border-l-[10px] ${p.status === 'SAIU PARA ENTREGA' ? 'border-green-500' : 'border-rose-500'}">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="font-black text-sm uppercase">${p.produto}</p>
                                    <p class="text-[10px] font-bold text-gray-400">${new Date(p.criadoEm?.seconds * 1000).toLocaleDateString()}</p>
                                </div>
                                <span class="status-pill status-${p.status?.split(' ')[0]}">${p.status}</span>
                            </div>
                            <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl">
                                <span class="text-[10px] font-black text-gray-400 uppercase">Total</span>
                                <span class="font-black text-rose-600">R$ ${Number(p.valorTotal).toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('') || '<p class="text-center py-10 font-bold text-gray-300">Nenhum pedido recente</p>'}
                </div>
            `;
        }

        init();
    </script>
</body>
</html>