<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AppEgg | Meus Pedidos</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap');
body { font-family: 'Inter', sans-serif; background:#fff; padding-bottom:120px; color:#1f2937 }
.logo-text{font-weight:900;color:#e11d48;font-size:1.8rem}
.nav-bottom{position:fixed;bottom:20px;left:15px;right:15px;background:#111;border-radius:32px;display:flex;justify-content:space-around;padding:14px;z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;color:#666;font-size:10px;font-weight:800}
.nav-item.active{color:#fff}
.card-pedido{background:white;border:1px solid #f3f4f6;border-radius:32px;padding:24px;margin-bottom:16px}
.btn-refazer{background:#1f2937;color:white;padding:12px;border-radius:16px;font-weight:900;font-size:10px;flex:1}
.btn-agendar{background:#2563eb;color:white;padding:12px;border-radius:16px;font-weight:900;font-size:10px;flex:1}
.input-egg{width:100%;padding:18px;background:#f9fafb;border-radius:20px;font-weight:700}
</style>
</head>
<body>
<div id="app-root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig={apiKey:"AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",authDomain:"distribuidora-de-ovos-aline.firebaseapp.com",projectId:"distribuidora-de-ovos-aline",storageBucket:"distribuidora-de-ovos-aline.firebasestorage.app",messagingSenderId:"92187548716",appId:"1:92187548716:web:d61d18a29aa76aead7c589"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

window.state={user:null,view:'loja',produtos:[],pedidos:[],comprando:null,qtd:1,filtroData:'todos'};
const s=window.state;

onAuthStateChanged(auth,u=>{s.user=u;if(u){loadProdutos();syncPedidos()}render()});

async function loadProdutos(){
 const r=await fetch("https://painel-distribuidora-backend.onrender.com/api/produtos");
 s.produtos=await r.json(); render();
}

function syncPedidos(){
 const q=query(collection(db,"vendas_logs"),where("clienteId","==",auth.currentUser.uid),orderBy("criadoEm","desc"));
 onSnapshot(q,snap=>{s.pedidos=snap.docs.map(d=>({id:d.id,...d.data()}));render()});
}

window.render=()=>{
 const r=document.getElementById("app-root");
 if(!s.user){r.innerHTML=login();return}
 r.innerHTML=`
 <div class="p-6 max-w-lg mx-auto">
  <header class="flex justify-between mb-10">
   <div class="logo-text">AppEgg</div>
   <div class="bg-gray-100 px-4 py-2 rounded-2xl font-black text-[10px]">@${s.user.email.split('@')[0]}</div>
  </header>
  ${s.view==='loja'?loja():pedidos()}
 </div>
 <nav class="nav-bottom">
  <button onclick="state.view='loja';render()" class="nav-item ${s.view==='loja'?'active':''}">üè† LOJA</button>
  <button onclick="state.view='pedidos';render()" class="nav-item ${s.view==='pedidos'?'active':''}">üì¶ PEDIDOS</button>
  <button onclick="signOut(auth)" class="nav-item text-rose-500">üö™ SAIR</button>
 </nav>
 ${s.comprando?modal():''}`;
};

function loja(){
 return s.produtos.map((p,i)=>`
 <div class="card-pedido flex gap-5" onclick="abrir(${i})">
  <div class="flex-1">
   <h3 class="font-black">${p.nome}</h3>
   <p class="text-rose-600 font-black">R$ ${p.preco}</p>
  </div>
 </div>`).join('');
}

function pedidos(){
 return s.pedidos.map(p=>`
 <div class="card-pedido border-t-8 ${p.status==='FINALIZADO'?'border-emerald-500':'border-rose-500'}">
  <h4 class="font-black">${p.quantidade}x ${p.produto}</h4>
  <span class="text-xs font-black">${p.status}</span>
 </div>`).join('');
}

window.abrir=i=>{s.comprando=s.produtos[i];s.qtd=1;render()}

window.finalizarPedido=async e=>{
 e.preventDefault();
 const f=new FormData(e.target);
 const p=s.comprando;
 await addDoc(collection(db,"vendas_logs"),{
  clienteId:auth.currentUser.uid,
  clienteNome:s.user.email.split('@')[0],
  produto:p.nome,
  produtoId:p.id,
  quantidade:s.qtd,
  valorTotal:p.preco*s.qtd,
  recorrencia:f.get("recorrencia"),
  proximaEntrega:f.get("proximaEntrega")||null,
  status:"CRIADO",
  criadoEm:serverTimestamp()
 });
 s.comprando=null;s.view='pedidos';render();
}

function modal(){
 return `
 <div class="fixed inset-0 bg-black/80 flex items-end">
 <div class="bg-white w-full p-10 rounded-t-[48px]">
 <form onsubmit="finalizarPedido(event)" class="space-y-4">
  <div class="flex justify-between">
   <button type="button" onclick="state.qtd--;render()">-</button>
   <span class="text-3xl font-black">${s.qtd}</span>
   <button type="button" onclick="state.qtd++;render()">+</button>
  </div>
  <select name="recorrencia" onchange="document.getElementById('dt').style.display=this.value?'block':'none'" class="input-egg">
   <option value="">Uma vez</option>
   <option>Semanal</option>
   <option>Quinzenal</option>
   <option>Mensal</option>
  </select>
  <input id="dt" name="proximaEntrega" type="date" class="input-egg hidden">
  <button class="w-full bg-rose-600 text-white py-6 rounded-[28px] font-black">Confirmar</button>
 </form>
 </div></div>`;
}

function login(){
 return `<form onsubmit="handle(event)">
 <input name="email" class="input-egg">
 <input name="pass" type="password" class="input-egg">
 <button>Entrar</button></form>`;
}

window.handle=async e=>{
 e.preventDefault();
 const f=new FormData(e.target);
 await signInWithEmailAndPassword(auth,f.get("email"),f.get("pass"));
};
</script>
</body>
</html>
