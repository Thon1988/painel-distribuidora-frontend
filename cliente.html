<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { 
        getFirestore, collection, onSnapshot, doc, getDoc, addDoc, 
        serverTimestamp, increment, updateDoc, setDoc, runTransaction 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    
    // Importação CORRETA e completa do firebase-auth
    import { 
        getAuth, 
        onAuthStateChanged, 
        signOut, 
        signInWithEmailAndPassword, 
        updatePassword, 
        signInAnonymously, 
        signInWithCustomToken 
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // (opcional - se for usar notificações push)
    // import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

    // --- CONFIGURAÇÃO FIREBASE ---
    const firebaseConfig = JSON.parse(__firebase_config || '{"apiKey":"AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro","authDomain":"distribuidora-de-ovos-aline.firebaseapp.com","projectId":"distribuidora-de-ovos-aline","storageBucket":"distribuidora-de-ovos-aline.firebasestorage.app","messagingSenderId":"92187548716","appId":"1:92187548716:web:d61d18a29aa76aead7c589"}');
    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);
    const auth = getAuth(appFB);
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : "app-egg-pro-transacional";
    const DISTRIBUIDORA_ENDERECO = "R. Antônio Freire da Silva, 67 - Jd. Camelias, SP";

    // --- ESTADO GLOBAL ---
    window.state = { 
        user: null, 
        profile: null,
        view: 'loja', 
        produtos: [], 
        pedidos: [], 
        cart: [],
        pix: { key: '', type: '', copiaCola: '' }, 
        checkout: { tipoEntrega: 'entrega', endereco: null, metodoPagamento: 'pix_agora' },
        profileMode: 'view',
        ordersFilter: 'aberto', 
        loading: true, 
        processing: false,
        payingOrder: null,
        toast: null
    };

    let lastStateHash = "";
    let renderTimeout = null;

    // ... (mantenha todas as suas funções auxiliares: scheduleRender, showToast, setView, copyToClipboard, maskTel, maskCEP, maskDoc, gerarPix, addToCart, updateCartQtd, etc.)

    // --- RENDERIZAÇÃO (exemplo simplificado – adapte conforme seu render completo) ---
    window.render = () => {
        const root = document.getElementById('app-root');
        if (!root) return;

        const s = window.state;
        if (s.loading) {
            root.innerHTML = `<div class="loading-screen">Carregando...</div>`;
            return;
        }

        if (!s.user) {
            root.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <form onsubmit="window.handleLogin(event)">
                        <input id="le" type="email" placeholder="Email">
                        <input id="lp" type="password" placeholder="Senha">
                        <button type="submit">Entrar</button>
                    </form>
                </div>`;
            return;
        }

        // Seu conteúdo principal quando logado
        root.innerHTML = `<div>Bem-vindo! View: ${s.view}</div>`;
    };

    // --- INICIALIZAÇÃO E AUTH ---
    onAuthStateChanged(auth, (user) => {
        window.state.user = user;
        window.state.loading = false;
        window.scheduleRender();  // ou window.render() se não usar schedule
    });

    // Primeira renderização
    window.scheduleRender();
</script>
