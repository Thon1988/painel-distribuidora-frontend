<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Sua Loja de Ovos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background: #f8fafc; padding-bottom: 120px; color: #1e293b; overflow-x: hidden; }
        
        /* Design System AppEgg */
        .logo-text { font-weight: 900; color: #e11d48; font-size: 1.8rem; letter-spacing: -1px; }
        .nav-bottom { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #0f172a; border-radius: 32px; display: flex; justify-content: space-around; padding: 18px; z-index: 100; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #64748b; font-size: 9px; font-weight: 900; text-transform: uppercase; border: none; background: transparent; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: #fff; transform: scale(1.1); }
        
        .card-egg { background: white; border: 1px solid #f1f5f9; border-radius: 40px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); transition: 0.3s; }
        .card-egg:active { transform: scale(0.98); }
        
        .btn-main { background: #e11d48; color: white; padding: 22px; border-radius: 28px; font-weight: 900; text-transform: uppercase; font-size: 13px; box-shadow: 0 10px 25px rgba(225, 29, 72, 0.2); width: 100%; transition: 0.2s; cursor: pointer; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .input-egg { width: 100%; padding: 20px; background: #f9fafb; border-radius: 24px; border: 1px solid #eee; font-weight: 700; font-size: 14px; outline: none; transition: 0.2s; }
        .input-egg:focus { border-color: #e11d48; background: #fff; }
        
        .modal-up { animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="no-scrollbar text-left">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, getDoc, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // âœ… CORREÃ‡ÃƒO ERRO 3: ConfiguraÃ§Ã£o fixa e estÃ¡vel para GitHub Pages/Render
        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const auth = getAuth(appFB);
        const appId = "app-egg-pro-total";

        window.state = { 
            user: null, 
            view: 'loja', 
            produtos: [], 
            pedidos: [], 
            comprando: null, 
            qtd: 1, 
            loading: true, 
            processing: false 
        };
        
        window.activeListeners = [];

        // âœ… CORREÃ‡ÃƒO ERRO 2: GestÃ£o de Unsubscribe para evitar duplicaÃ§Ã£o de listeners
        const syncRealtime = () => {
            if (!auth.currentUser) return;
            
            // Limpa listeners antigos antes de criar novos
            if (window.activeListeners.length > 0) {
                window.activeListeners.forEach(unsub => unsub());
                window.activeListeners = [];
            }

            // Listener de Estoque
            const unsub1 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'estoque'), s => { 
                window.state.produtos = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.nome || "").localeCompare(b.nome || "")); 
                window.render(); 
            });
            window.activeListeners.push(unsub1);

            // Listener de Pedidos do UsuÃ¡rio
            const unsub2 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), s => { 
                const all = s.docs.map(d => ({ id: d.id, ...d.data() }));
                window.state.pedidos = all.filter(p => p.clienteId === auth.currentUser?.uid).sort((a, b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));
                window.render(); 
            });
            window.activeListeners.push(unsub2);
        };

        onAuthStateChanged(auth, user => {
            if (user && (user.email === 'teste@lojista.com.br' || user.isAnonymous)) {
                window.state.user = user;
                syncRealtime();
            } else {
                window.state.user = null;
            }
            window.state.loading = false;
            window.render();
        });

        // --- RENDERIZAÃ‡ÃƒO PRINCIPAL ---
        window.render = () => {
            const root = document.getElementById('app-root');
            const s = window.state;
            
            if (s.loading) { 
                root.innerHTML = '<div class="h-screen flex items-center justify-center font-[950] text-rose-600 animate-pulse text-2xl uppercase italic text-center">AppEgg</div>'; 
                return; 
            }
            
            if (!s.user) { 
                root.innerHTML = renderLogin(); 
                return; 
            }

            root.innerHTML = `
                <div class="p-8 max-w-lg mx-auto fade-in">
                    <header class="flex justify-between items-center mb-12">
                        <div class="logo-text italic uppercase">AppEgg</div>
                        <div class="bg-white border px-4 py-2 rounded-2xl font-black text-[9px] uppercase text-slate-400 italic">Cliente</div>
                    </header>
                    ${s.view === 'loja' ? renderLoja() : renderPedidos()}
                </div>
                <nav class="nav-bottom">
                    <button onclick="window.setView('loja')" class="nav-item ${s.view==='loja'?'active':''}">LOJA</button>
                    <button onclick="window.setView('pedidos')" class="nav-item ${s.view==='pedidos'?'active':''}">PEDIDOS</button>
                    <button onclick="signOut(auth)" class="nav-item text-rose-500">SAIR</button>
                </nav>
                ${s.comprando ? renderModalCompra() : ''}`;
        };

        // --- VIEWS ---

        function renderLoja() {
            return `
                <h2 class="font-black uppercase text-[10px] tracking-[0.3em] text-slate-300 mb-8 italic">CatÃ¡logo de Hoje</h2>
                <div class="space-y-6">
                    ${window.state.produtos.map(p => `
                        <div class="card-egg flex gap-6 items-center shadow-sm" onclick="window.abrirCompra('${p.id}')">
                            <div class="w-24 h-24 bg-slate-50 rounded-[32px] overflow-hidden flex items-center justify-center shadow-inner">
                                ${p.foto_url ? `<img src="${p.foto_url}" class="w-full h-full object-cover">` : `<span class="text-3xl text-left">ðŸ¥š</span>`}
                            </div>
                            <div class="flex-1 text-left">
                                <h3 class="font-black uppercase text-sm mb-1 text-slate-800 leading-tight">${p.nome}</h3>
                                <p class="text-slate-400 text-[10px] font-bold uppercase mb-4 text-left">${p.embalagem}</p>
                                <p class="text-[#e11d48] font-[950] text-2xl italic tracking-tighter">R$ ${Number(p.preco).toFixed(2)}</p>
                            </div>
                        </div>`).join('') || '<p class="text-center py-20 font-black text-slate-200 uppercase">Aguardando estoque...</p>'}
                </div>`;
        }

        function renderPedidos() {
            return `
                <h2 class="font-black uppercase text-[10px] tracking-[0.3em] text-slate-300 mb-8 italic">Minhas Encomendas</h2>
                <div class="space-y-4">
                    ${window.state.pedidos.map(p => `
                        <div class="card-egg border-t-[12px] border-rose-500 text-left">
                            <div class="flex justify-between items-start mb-6">
                                <span class="bg-rose-50 text-rose-600 px-4 py-1 rounded-full text-[9px] font-black uppercase">${p.status}</span>
                                <span class="text-[9px] font-bold text-slate-200 uppercase italic">#${p.id.substring(0,6).toUpperCase()}</span>
                            </div>
                            <div class="text-left">
                                <h4 class="font-black uppercase text-sm text-slate-800">${p.quantidade}x ${p.produto}</h4>
                                <p class="text-[#e11d48] font-[950] text-3xl tracking-tighter italic mt-4">R$ ${Number(p.valorTotal).toFixed(2)}</p>
                            </div>
                        </div>`).join('') || '<p class="text-center py-20 font-black text-slate-200 uppercase">Nenhum pedido efetuado.</p>'}
                </div>`;
        }

        // âœ… CORREÃ‡ÃƒO ERRO 1: FunÃ§Ã£o renderModalCompra() definida e integrada
        function renderModalCompra() {
            const p = window.state.comprando;
            if (!p) return '';

            return `
                <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[200] flex items-end">
                    <div class="bg-white w-full p-10 rounded-t-[56px] shadow-2xl modal-up text-center">
                        <div class="flex gap-6 items-center text-left mb-10">
                            <div class="w-16 h-16 bg-slate-50 rounded-[28px] overflow-hidden text-center">
                                ${p.foto_url ? `<img src="${p.foto_url}" class="w-full h-full object-cover">` : `<span class="text-2xl text-left">ðŸ¥š</span>`}
                            </div>
                            <div>
                                <h3 class="font-black uppercase text-xl text-slate-900 italic tracking-tighter">${p.nome}</h3>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">${p.embalagem}</p>
                            </div>
                        </div>
                        <form onsubmit="window.handleFinalizarCompra(event)" class="space-y-6">
                            <div class="flex items-center justify-between bg-slate-50 p-4 rounded-[32px] border-2 border-slate-100 text-center">
                                <button type="button" onclick="window.state.qtd=Math.max(1, window.state.qtd-1);window.render()" class="w-14 h-14 bg-white rounded-2xl font-black text-2xl active:scale-90 transition shadow-sm text-center">-</button>
                                <span class="text-4xl font-[950] text-slate-800 italic text-center">${window.state.qtd}</span>
                                <button type="button" onclick="window.state.qtd=window.state.qtd+1;window.render()" class="w-14 h-14 bg-white rounded-2xl font-black text-2xl active:scale-90 transition shadow-sm text-center">+</button>
                            </div>
                            <button ${window.state.processing ? 'disabled' : ''} class="btn-main italic">
                                ${window.state.processing ? 'A PROCESSAR...' : `CONFIRMAR â€¢ R$ ${(p.preco * window.state.qtd).toFixed(2)}`}
                            </button>
                        </form>
                        <button onclick="window.state.comprando=null;window.render()" class="w-full py-8 text-slate-300 font-black text-[10px] uppercase">Cancelar</button>
                    </div>
                </div>`;
        }

        function renderLogin() { 
            return `
                <div class="min-h-screen flex items-center justify-center bg-white p-8">
                    <div class="w-full max-w-sm text-center">
                        <div class="logo-text text-6xl mb-12 italic text-center">AppEgg</div>
                        <form onsubmit="window.hLog(event)" class="space-y-4 text-left">
                            <input id="le" class="input-egg" placeholder="Email (teste@lojista.com.br)">
                            <input id="lp" type="password" class="input-egg" placeholder="Senha (882010)">
                            <button type="submit" class="btn-main mt-6 italic text-center">Entrar na Loja</button>
                        </form>
                    </div>
                </div>`; 
        }

        // --- HANDLERS ---

        window.hLog = async (e) => {
            e.preventDefault();
            const em = document.getElementById('le').value.trim();
            const ps = document.getElementById('lp').value;
            try { await signInWithEmailAndPassword(auth, em, ps); } catch (err) { alert("DADOS INVÃLIDOS"); }
        };

        window.setView = (v) => { window.state.view = v; window.state.comprando = null; window.render(); };
        
        window.abrirCompra = (id) => { 
            const p = window.state.produtos.find(x => x.id === id); 
            if (!p) return; 
            window.state.comprando = p; 
            window.state.qtd = 1; 
            window.render(); 
        };

        window.handleFinalizarCompra = async (e) => {
            e.preventDefault(); 
            if (window.state.processing) return;
            window.state.processing = true; 
            window.render();
            
            const p = window.state.comprando;
            try {
                const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'estoque', p.id);
                const currentSnap = await getDoc(prodRef);
                
                if (!currentSnap.exists() || currentSnap.data().quantidade < window.state.qtd) {
                    throw new Error("Desculpe, o estoque deste item acabou de esgotar.");
                }

                // DÃ©bito AtÃ³mico no Firestore
                await updateDoc(prodRef, { quantidade: increment(-window.state.qtd) });
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), {
                    clienteId: auth.currentUser.uid,
                    clienteNome: auth.currentUser.email?.split('@')[0] || 'Cliente',
                    produtoId: p.id,
                    produto: p.nome,
                    quantidade: window.state.qtd,
                    valorTotal: Number(p.preco) * window.state.qtd,
                    custoUnitario: Number(p.preco_custo || 0),
                    status: 'PEDIDO CRIADO',
                    criadoEm: serverTimestamp()
                });
                
                window.state.comprando = null; 
                window.state.view = 'pedidos'; 
                alert("Pedido Realizado com Sucesso! ðŸ¥š");
            } catch (err) { 
                alert(err.message); 
            } finally { 
                window.state.processing = false; 
                window.render(); 
            }
        };

        window.render();
    </script>
</body>
</html>