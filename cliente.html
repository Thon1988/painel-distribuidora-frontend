<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AppEgg</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; background:#fff; }
.logo-text { font-weight:800; color:#e11d48; letter-spacing:-0.05em; }
.nav-bottom {
  position:fixed; bottom:20px; left:15px; right:15px;
  background:#111827; border-radius:24px;
  display:flex; justify-content:space-around;
  padding:10px; z-index:50;
}
.nav-item { flex:1; text-align:center; color:#9ca3af; font-size:10px; font-weight:800; }
.nav-item.active { background:#e11d48; color:#fff; border-radius:18px; padding:8px; }
.whats-btn {
  position:fixed; bottom:90px; right:20px;
  background:#25D366; color:white;
  padding:14px; border-radius:50%;
  font-size:20px; z-index:60;
}
</style>
</head>

<body>
<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
  authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
  projectId: "distribuidora-de-ovos-aline",
  storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
  messagingSenderId: "92187548716",
  appId: "1:92187548716:web:d61d18a29aa76aead7c589"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const auth = getAuth(appFB);

const API = "https://painel-distribuidora-backend.onrender.com/api";
const WHATS = "https://wa.me/5511985706243";

window.state = {
  user:null,
  tela:'catalogo',
  produtos:[],
  pedidos:[],
  confirmando:null
};

onAuthStateChanged(auth, user=>{
  window.state.user = user;
  if(user){
    carregarProdutos();
    monitorarPedidos();
  }
  render();
});

function render(){
  const el = document.getElementById('app');

  if(!window.state.user){
    el.innerHTML = `
    <div class="min-h-screen flex flex-col justify-center p-8 text-center">
      <div class="logo-text text-5xl mb-10">AppEgg</div>
      <form onsubmit="login(event)" class="space-y-4">
        <input name="email" type="email" placeholder="E-mail" class="w-full p-4 bg-gray-50 rounded-xl font-bold" required>
        <input name="pass" type="password" placeholder="Senha" class="w-full p-4 bg-gray-50 rounded-xl font-bold" required>
        <button class="w-full bg-rose-600 text-white py-4 rounded-xl font-black">Entrar</button>
      </form>
    </div>`;
    return;
  }

  el.innerHTML = `
    <div class="pb-32">
      ${window.state.tela==='catalogo'?renderCatalogo():renderPedidos()}
    </div>

    ${window.state.tela==='pedidos' && window.state.pedidos.length?`
      <a href="${WHATS}" target="_blank" class="whats-btn">ðŸ’¬</a>
    `:''}

    <div class="nav-bottom">
      <button class="nav-item ${window.state.tela==='catalogo'?'active':''}" onclick="go('catalogo')">Comprar</button>
      <button class="nav-item ${window.state.tela==='pedidos'?'active':''}" onclick="go('pedidos')">Pedidos</button>
      <button class="nav-item" onclick="logout()">Sair</button>
    </div>

    <footer class="text-center text-[10px] text-gray-400 py-6">
      AppEgg â€¢ Distribuidora de Ovos Aline<br>
      WhatsApp: (11) 98570-6243
    </footer>
  `;
}

window.go = t => { window.state.tela=t; render(); };

function renderCatalogo(){
  return `
  <header class="p-6 border-b">
    <div class="logo-text text-2xl">AppEgg</div>
  </header>
  <div class="p-4 grid grid-cols-2 gap-4">
    ${window.state.produtos.map(p=>`
      <div class="border rounded-2xl p-4 text-center">
        <img src="${p.foto_url}" class="h-20 mx-auto mb-2">
        <p class="text-[10px] font-black uppercase">${p.nome}</p>
        <p class="text-rose-600 font-black">R$ ${Number(p.preco).toFixed(2)}</p>
        <button onclick='confirmar(${JSON.stringify(p)})'
          class="mt-3 w-full bg-gray-900 text-white py-2 rounded-xl text-[10px] font-black">
          Pedir
        </button>
      </div>`).join('')}
  </div>`;
}

function renderPedidos(){
  return `
  <div class="p-6">
    <h2 class="text-2xl font-black mb-6 uppercase">Meus Pedidos</h2>
    ${window.state.pedidos.map(p=>`
      <div class="border rounded-2xl p-4 mb-4">
        <span class="text-[9px] font-black text-rose-600 uppercase">${p.status}</span>
        <p class="font-bold uppercase text-xs my-2">${p.produto}</p>
        ${p.pixChave?`
          <div class="bg-gray-50 p-3 rounded-xl text-[10px]">
            PIX: <b>${p.pixChave}</b>
            <button onclick="copiar('${p.pixChave}')" class="block mt-2 bg-emerald-500 text-white px-3 py-1 rounded">Copiar</button>
          </div>
          ${p.status==='AGUARDANDO PAGAMENTO'?`
            <button onclick="jaPaguei('${p.id}')" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-xl font-black text-[10px]">
              JÃ¡ paguei
            </button>`:''}
        `:''}
      </div>`).join('') || '<p class="text-gray-400">Nenhum pedido.</p>'}
  </div>`;
}

window.confirmar = p=>{
  const pix = "PIX-"+Math.random().toString(36).substring(2,10).toUpperCase();
  addDoc(collection(db,"vendas_logs"),{
    clienteNome:window.state.user.email.split('@')[0],
    clienteWhatsapp:window.state.user.email,
    produto:p.nome,
    precoNoMomento:p.preco,
    pagamento:"PIX",
    pixChave:pix,
    status:"AGUARDANDO PAGAMENTO",
    criadoEm:serverTimestamp()
  });
  window.state.tela='pedidos';
};

window.jaPaguei = async id=>{
  await updateDoc(doc(db,"vendas_logs",id),{ status:"PENDENTE" });
};

window.copiar = t=>{
  navigator.clipboard.writeText(t);
  alert("PIX copiado");
};

async function carregarProdutos(){
  const r = await fetch(`${API}/produtos`);
  window.state.produtos = await r.json();
  render();
}

function monitorarPedidos(){
  const q = query(collection(db,"vendas_logs"),
    where("clienteWhatsapp","==",window.state.user.email),
    orderBy("criadoEm","desc")
  );
  onSnapshot(q,s=>{
    window.state.pedidos = s.docs.map(d=>({id:d.id,...d.data()}));
    render();
  });
}

window.login = async e=>{
  e.preventDefault();
  await signInWithEmailAndPassword(auth,e.target.email.value,e.target.pass.value);
};

window.logout = async()=>{ await signOut(auth); };
</script>
</body>
</html>
