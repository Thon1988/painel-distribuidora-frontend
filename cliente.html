<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>AppEgg</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700;900&display=swap" rel="stylesheet">
<style>
body{font-family:'DM Sans',sans-serif}
.nav.active{background:#e11d48;color:#fff}
</style>
</head>
<body>

<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
  authDomain:"distribuidora-de-ovos-aline.firebaseapp.com",
  projectId:"distribuidora-de-ovos-aline"
};

const appFB=initializeApp(firebaseConfig);
const auth=getAuth(appFB);
const db=getFirestore(appFB);

const API_PRODUTOS="https://painel-distribuidora-backend.onrender.com/api/produtos";

const state={user:null,view:'catalogo',produtos:[],pedidos:[]};

onAuthStateChanged(auth,u=>{
  state.user=u;
  if(u){ carregarProdutos(); monitorarPedidos(); }
  render();
});

function render(){
  const el=document.getElementById("app");
  if(!state.user){
    el.innerHTML=`
    <div class="min-h-screen flex items-center justify-center">
      <form onsubmit="login(event)" class="p-10 bg-white rounded-3xl shadow w-full max-w-sm space-y-4">
        <h1 class="text-4xl font-black italic text-rose-600 text-center">AppEgg</h1>
        <input name="email" class="w-full p-4 bg-gray-100 rounded-xl" placeholder="E-mail" required>
        <input name="pass" type="password" class="w-full p-4 bg-gray-100 rounded-xl" placeholder="Senha" required>
        <button class="w-full py-4 bg-rose-600 text-white rounded-xl font-black uppercase">Entrar</button>
      </form>
    </div>`;
    return;
  }

  el.innerHTML=`
  <div class="pb-32">
    ${state.view==='catalogo'?renderCatalogo():renderPedidos()}
  </div>

  <nav class="fixed bottom-4 left-4 right-4 bg-gray-900 rounded-3xl flex">
    <button onclick="state.view='catalogo';render()" class="nav flex-1 py-3 ${state.view==='catalogo'?'active':''}">Comprar</button>
    <button onclick="state.view='pedidos';render()" class="nav flex-1 py-3 ${state.view==='pedidos'?'active':''}">Pedidos</button>
    <button onclick="logout()" class="flex-1 py-3 text-gray-400">Sair</button>
  </nav>
  `;
}

function renderCatalogo(){
  return `<div class="p-4 grid grid-cols-2 gap-4">
    ${state.produtos.map(p=>`
      <div class="bg-white p-4 rounded-3xl shadow">
        <img src="${p.foto_url}" class="h-20 mx-auto mb-2 object-contain">
        <p class="text-xs font-bold">${p.nome}</p>
        <p class="text-rose-600 font-black">R$ ${p.preco.toFixed(2)}</p>
        <button onclick="comprar('${p.nome}',${p.preco})" class="w-full mt-2 bg-gray-900 text-white py-2 rounded-xl text-xs font-black">Pedir</button>
      </div>`).join('')}
  </div>`;
}

function renderPedidos(){
  return `<div class="p-6 space-y-4">
    ${state.pedidos.map(p=>`
      <div class="bg-white p-4 rounded-2xl shadow">
        <b>${p.produto}</b>
        <p class="text-xs text-gray-400">${p.status}</p>
      </div>`).join('')}
  </div>`;
}

window.login=async e=>{
  e.preventDefault();
  await signInWithEmailAndPassword(auth,e.target.email.value,e.target.pass.value);
};
window.logout=()=>signOut(auth);

async function carregarProdutos(){
  const r=await fetch(API_PRODUTOS);
  state.produtos=await r.json();
  render();
}

window.comprar=async(nome,preco)=>{
  await addDoc(collection(db,"vendas_logs"),{
    clienteNome:state.user.email,
    clienteWhatsapp:state.user.email,
    produto:nome,
    precoNoMomento:preco,
    pagamento:"PIX ONLINE",
    status:"PENDENTE",
    criadoEm:serverTimestamp()
  });
  alert("Pedido enviado!");
};

function monitorarPedidos(){
  onSnapshot(
    query(collection(db,"vendas_logs"),
      where("clienteWhatsapp","==",state.user.email),
      orderBy("criadoEm","desc")),
    s=>{
      state.pedidos=s.docs.map(d=>d.data());
      render();
    }
  );
}
</script>
</body>
</html>
