<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Comprar Ovos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        :root { --main: #e11d48; }
        body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #111827; -webkit-tap-highlight-color: transparent; }
        .card-egg { background: white; border-radius: 28px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; transition: 0.3s; }
        .btn-buy { background: var(--main); color: white; border-radius: 20px; font-weight: 900; text-transform: uppercase; padding: 18px; width: 100%; transition: 0.2s; border: none; box-shadow: 0 10px 20px rgba(225, 29, 72, 0.2); }
        .btn-buy:active { transform: scale(0.96); }
        .btn-buy:disabled { opacity: 0.5; transform: scale(1); }
        .input-user { width: 100%; padding: 16px; background: #f3f4f6; border-radius: 16px; border: 2px solid transparent; font-weight: 700; outline: none; transition: 0.2s; }
        .input-user:focus { border-color: var(--main); background: white; }
        .cart-badge { position: absolute; top: -4px; right: -4px; background: var(--main); color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-20">
    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const API_URL = "https://painel-distribuidora-backend.onrender.com/api";

        window.state = {
            view: 'vitrine',
            produtos: [],
            carrinho: [],
            meusPedidos: [],
            perfil: JSON.parse(localStorage.getItem('appegg_perfil')) || { nome: '', fone: '', locais: [] },
            selecao: { pagamento: '', local: '' }
        };

        async function initApp() {
            try {
                const r = await fetch(`${API_URL}/produtos`);
                const data = await r.json();
                window.state.produtos = Array.isArray(data) ? data.map(p => ({...p, id: p._id || p.id})) : [];
            } catch (e) { console.error("Erro API:", e); }
            
            if (window.state.perfil.fone) syncOrders();
            render();
        }

        window.render = () => {
            const root = document.getElementById('app-root');
            root.innerHTML = `
                <header class="p-6 pt-10 bg-white sticky top-0 z-40 flex justify-between items-center shadow-sm">
                    <h1 class="text-2xl font-black tracking-tighter uppercase text-rose-600">AppEgg</h1>
                    <div class="flex gap-4">
                        <button onclick="setView('vitrine')" class="p-2 ${window.state.view==='vitrine'?'text-rose-600':'text-gray-300'}">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                        </button>
                        <button onclick="setView('carrinho')" class="relative p-2 ${window.state.view==='carrinho'?'text-rose-600':'text-gray-300'}">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 100-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3z"></path></svg>
                            ${window.state.carrinho.length ? `<span class="cart-badge">${window.state.carrinho.length}</span>`:''}
                        </button>
                        <button onclick="setView('meus')" class="p-2 ${window.state.view==='meus'?'text-rose-600':'text-gray-300'}">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"></path></svg>
                        </button>
                    </div>
                </header>
                <main class="p-6">${drawCurrentView()}</main>
            `;
        };

        window.setView = (v) => { window.state.view = v; window.render(); };

        function drawCurrentView() {
            if (window.state.view === 'vitrine') return drawVitrine();
            if (window.state.view === 'carrinho') return drawCarrinho();
            if (window.state.view === 'checkout') return drawCheckout();
            if (window.state.view === 'meus') return drawMeusPedidos();
        }

        function drawVitrine() {
            return `<div class="grid gap-6">${window.state.produtos.map(p => `
                <div class="card-egg overflow-hidden">
                    <img src="${p.foto_url || 'https://via.placeholder.com/400'}" class="w-full h-48 object-cover">
                    <div class="p-6 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-black text-gray-400 uppercase">${p.embalagem}</p>
                            <h3 class="font-black uppercase text-sm">${p.nome}</h3>
                            <p class="text-rose-600 font-black text-lg">R$ ${Number(p.preco).toFixed(2)}</p>
                        </div>
                        <button onclick='addToCart(${JSON.stringify(p)})' class="bg-gray-900 text-white p-4 rounded-2xl active:scale-90 transition">+</button>
                    </div>
                </div>`).join('')}</div>`;
        }

        window.addToCart = (p) => { window.state.carrinho.push(p); window.render(); };

        function drawCarrinho() {
            const sum = window.state.carrinho.reduce((a, b) => a + Number(b.preco), 0);
            if (!window.state.carrinho.length) return `<div class="text-center py-20 font-black text-gray-300 uppercase">Carrinho Vazio</div>`;
            return `
                <div class="card-egg p-6 mb-6">
                    <h2 class="font-black text-xl mb-4 uppercase">Resumo</h2>
                    ${window.state.carrinho.map((item, i) => `
                        <div class="flex justify-between py-3 border-b border-gray-100">
                            <div><p class="text-xs font-black uppercase">${item.nome}</p></div>
                            <div class="flex items-center gap-3">
                                <span class="font-black text-rose-600">R$ ${Number(item.preco).toFixed(2)}</span>
                                <button onclick="window.state.carrinho.splice(${i},1);window.render()" class="text-gray-300 font-black">REMOVER</button>
                            </div>
                        </div>`).join('')}
                    <div class="mt-6 flex justify-between items-center">
                        <span class="font-black text-gray-400 text-xs uppercase">Total</span>
                        <span class="text-2xl font-black text-rose-600">R$ ${sum.toFixed(2)}</span>
                    </div>
                </div>
                <button onclick="setView('checkout')" class="btn-buy">Pr√≥ximo Passo</button>`;
        }

        function drawCheckout() {
            return `
                <div class="card-egg p-6 mb-6">
                    <h2 class="font-black text-xl mb-6 uppercase">Finalizar</h2>
                    <div class="space-y-3 mb-8">
                        <button onclick="setPay('PIX')" class="input-user text-left border-2 ${window.state.selecao.pagamento==='PIX'?'border-rose-600 bg-white':'border-transparent'}">PIX (J√° realizei)</button>
                        <button onclick="setPay('ENTREGA')" class="input-user text-left border-2 ${window.state.selecao.pagamento==='ENTREGA'?'border-rose-600 bg-white':'border-transparent'}">Pagar na Entrega</button>
                    </div>
                    <p class="text-[10px] font-black uppercase text-gray-400 mb-2 ml-2">Endere√ßo de Entrega</p>
                    <div class="space-y-2 mb-6">
                        ${window.state.perfil.locais.map(l => `
                            <button onclick="setLoc('${l}')" class="input-user text-xs text-left border-2 ${window.state.selecao.local===l?'border-rose-600 bg-white':'border-transparent'}">${l}</button>
                        `).join('')}
                        <div class="flex gap-2">
                            <input id="newLoc" placeholder="Novo endere√ßo" class="input-user !py-3">
                            <button onclick="addLoc()" class="bg-gray-900 text-white px-4 rounded-xl font-black">+</button>
                        </div>
                    </div>
                    <input id="uNome" placeholder="Seu Nome" value="${window.state.perfil.nome}" class="input-user mb-2">
                    <input id="uFone" placeholder="WhatsApp (DDD + N√∫mero)" value="${window.state.perfil.fone}" class="input-user">
                </div>
                <button onclick="sendOrder()" class="btn-buy" ${!window.state.selecao.pagamento || !window.state.selecao.local ? 'disabled' : ''}>Confirmar Pedido</button>`;
        }

        window.setPay = (v) => { window.state.selecao.pagamento = v; window.render(); };
        window.setLoc = (v) => { window.state.selecao.local = v; window.render(); };
        window.addLoc = () => { 
            const v = document.getElementById('newLoc').value; 
            if(v){ window.state.perfil.locais.push(v); window.render(); } 
        };

        window.sendOrder = async () => {
            const n = document.getElementById('uNome').value;
            const f = document.getElementById('uFone').value;
            if(!n || !f) return alert("Preencha seu nome e telefone!");

            window.state.perfil.nome = n;
            window.state.perfil.fone = f;
            localStorage.setItem('appegg_perfil', JSON.stringify(window.state.perfil));

            const total = window.state.carrinho.reduce((a, b) => a + Number(b.preco), 0);
            
            // Estrutura de itens preparada para o Admin baixar estoque
            const itensProcessados = window.state.carrinho.map(item => ({
                produtoId: item.id,
                nome: item.nome,
                embalagem: item.embalagem,
                preco: item.preco,
                quantidadeVendida: 1
            }));

            const orderObj = {
                clienteNome: n,
                telefone: f,
                endereco: window.state.selecao.local,
                produto: window.state.carrinho.map(i => `${i.nome} (${i.embalagem})`).join(', '),
                itens: itensProcessados, // Array para o loop de baixa
                valorTotal: total,
                metodoPagamento: window.state.selecao.pagamento,
                statusPagamento: window.state.selecao.pagamento === 'PIX' ? 'PAGO' : 'PENDENTE',
                status: 'CRIADO',
                criadoEm: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "vendas_logs"), orderObj);
                alert("üê£ Pedido enviado com sucesso!");
                window.state.carrinho = [];
                window.state.selecao = { pagamento: '', local: '' };
                setView('meus');
                syncOrders();
            } catch (e) {
                alert("Erro ao enviar pedido.");
            }
        };

        function syncOrders() {
            const q = query(collection(db, "vendas_logs"), where("telefone", "==", window.state.perfil.fone), orderBy("criadoEm", "desc"));
            onSnapshot(q, s => { 
                window.state.meusPedidos = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                window.render(); 
            });
        }

        function drawMeusPedidos() {
            return `
                <div class="space-y-4">
                    <h2 class="font-black text-xl mb-4 uppercase">Acompanhar Pedidos</h2>
                    ${window.state.meusPedidos.map(p => `
                        <div class="card-egg p-5 border-l-8 ${p.status === 'FINALIZADO' ? 'border-green-500' : 'border-rose-600'}">
                            <div class="flex justify-between items-start">
                                <p class="font-black text-xs uppercase text-gray-700">${p.produto}</p>
                                <span class="text-[9px] font-black px-2 py-1 bg-gray-100 rounded uppercase text-gray-500">${p.status}</span>
                            </div>
                            <div class="flex justify-between mt-4">
                                <span class="text-rose-600 font-black">R$ ${Number(p.valorTotal).toFixed(2)}</span>
                                <span class="text-[9px] font-black uppercase text-gray-400 italic">${p.statusPagamento}</span>
                            </div>
                        </div>`).join('') || '<div class="text-center py-10 text-gray-300 font-black">NENHUM PEDIDO ENCONTRADO</div>'}
                </div>`;
        }

        initApp();
    </script>
</body>
</html>