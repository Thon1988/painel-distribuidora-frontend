<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Sua Loja de Ovos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        :root { --brand: #e11d48; }
        body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #1f2937; -webkit-tap-highlight-color: transparent; }
        
        .premium-card { background: white; border-radius: 32px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }
        .btn-primary { background: var(--brand); color: white; border-radius: 24px; font-weight: 900; text-transform: uppercase; padding: 20px; width: 100%; transition: 0.3s; box-shadow: 0 10px 20px rgba(225, 29, 72, 0.2); }
        .btn-primary:active { transform: scale(0.95); }
        .btn-primary:disabled { background: #e5e7eb; color: #9ca3af; box-shadow: none; cursor: not-allowed; }
        
        .input-egg { width: 100%; padding: 18px; background: #f3f4f6; border-radius: 20px; border: 2px solid transparent; font-weight: 700; outline: none; transition: 0.2s; }
        .input-egg:focus { border-color: var(--brand); background: #fff; }
        
        .badge-cart { position: absolute; top: -5px; right: -5px; background: var(--brand); color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 900; border: 2px solid white; }
        
        .step-pill { padding: 8px 16px; border-radius: 12px; font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
        .step-active { background: #ffe4e6; color: var(--brand); }
        .step-inactive { background: #f3f4f6; color: #9ca3af; }

        /* Anima√ß√£o simples de fade */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-24">
    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";

        window.state = {
            view: 'loja', 
            produtos: [],
            carrinho: [],
            meusPedidos: [],
            cliente: JSON.parse(localStorage.getItem('appegg_user')) || { nome: '', telefone: '', enderecos: [] },
            checkout: { metodoPagamento: '', enderecoSelecionado: '' }
        };

        async function init() {
            try {
                const r = await fetch(`${API_BASE}/produtos`);
                const data = await r.json();
                window.state.produtos = Array.isArray(data) ? data : [];
            } catch { window.state.produtos = []; }
            if (window.state.cliente.telefone) syncMeusPedidos();
            render();
        }

        window.render = () => {
            const root = document.getElementById('app-root');
            root.innerHTML = `
                <header class="p-6 pt-10 bg-white mb-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                    <div>
                        <h1 class="text-3xl font-black tracking-tighter text-gray-900">AppEgg</h1>
                        <p class="text-[9px] font-black text-rose-600 uppercase tracking-widest">Premium Delivery</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="window.state.view='loja';render()" class="relative p-2 ${window.state.view==='loja'?'text-rose-600':'text-gray-300'}">
                            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                        </button>
                        <button onclick="window.state.view='carrinho';render()" class="relative p-2 ${window.state.view==='carrinho'?'text-rose-600':'text-gray-300'}">
                            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 100-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path></svg>
                            ${window.state.carrinho.length > 0 ? `<div class="badge-cart">${window.state.carrinho.length}</div>` : ''}
                        </button>
                        <button onclick="window.state.view='pedidos';render()" class="p-2 ${window.state.view==='pedidos'?'text-rose-600':'text-gray-300'}">
                            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"></path></svg>
                        </button>
                    </div>
                </header>
                <main class="px-6 fade-in">${renderView()}</main>
            `;
        };

        function renderView() {
            switch(window.state.view) {
                case 'loja': return renderLoja();
                case 'carrinho': return renderCarrinho();
                case 'pagamento': return renderPagamento();
                case 'endereco': return renderEndereco();
                case 'pedidos': return renderMeusPedidos();
                default: return renderLoja();
            }
        }

        function renderLoja() {
            return `
                <div class="grid gap-6">
                    ${window.state.produtos.map(p => `
                        <div class="premium-card overflow-hidden">
                            <img src="${p.foto_url || 'https://via.placeholder.com/300'}" class="w-full h-48 object-cover">
                            <div class="p-6 flex justify-between items-center">
                                <div>
                                    <h3 class="font-black uppercase text-xs text-gray-400">${p.embalagem}</h3>
                                    <h2 class="font-black uppercase text-sm text-gray-800">${p.nome}</h2>
                                    <p class="text-rose-600 font-black text-lg">R$ ${p.preco.toFixed(2)}</p>
                                </div>
                                <button onclick='window.addToCart(${JSON.stringify(p)})' class="bg-gray-900 text-white p-4 rounded-2xl shadow-lg active:scale-90 transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        window.addToCart = (p) => { 
            window.state.carrinho.push(p); 
            render(); 
        };

        function renderCarrinho() {
            const total = window.state.carrinho.reduce((acc, i) => acc + i.preco, 0);
            if (window.state.carrinho.length === 0) return `<div class="text-center py-20 font-black text-gray-300">CARRINHO VAZIO</div>`;
            return `
                <div class="flex gap-2 mb-8">
                    <span class="step-pill step-active">Carrinho</span>
                    <span class="step-pill step-inactive">Pagamento</span>
                    <span class="step-pill step-inactive">Entrega</span>
                </div>
                <div class="premium-card p-6 mb-6">
                    <h2 class="font-black text-xl mb-6 uppercase tracking-tighter">Itens Selecionados</h2>
                    <div class="space-y-4">
                        ${window.state.carrinho.map((item, idx) => `
                            <div class="flex justify-between items-center py-3 border-b border-gray-50">
                                <div>
                                    <p class="font-bold text-sm uppercase">${item.nome}</p>
                                    <p class="text-[10px] font-black text-gray-400 uppercase">${item.embalagem}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="font-black text-rose-600">R$ ${item.preco.toFixed(2)}</span>
                                    <button onclick="window.state.carrinho.splice(${idx},1);render()" class="text-gray-300 hover:text-rose-600">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-8 flex justify-between items-center bg-gray-50 p-6 rounded-3xl">
                        <span class="font-black text-xs text-gray-400 uppercase">Subtotal</span>
                        <span class="text-2xl font-black text-rose-600">R$ ${total.toFixed(2)}</span>
                    </div>
                </div>
                <button onclick="window.state.view='pagamento';render()" class="btn-primary">Pr√≥ximo: Pagamento</button>
            `;
        }

        function renderPagamento() {
            const metodos = [
                { id: 'PAGO_PIX', label: 'J√° paguei via PIX', icon: 'üì±' },
                { id: 'PENDENTE_ENTREGA', label: 'Pagar na Entrega', icon: 'üöö' },
                { id: 'PENDENTE_RETIRADA', label: 'Pagar na Retirada', icon: 'üè™' }
            ];

            return `
                <div class="flex gap-2 mb-8">
                    <span class="step-pill step-inactive">Carrinho</span>
                    <span class="step-pill step-active">Pagamento</span>
                    <span class="step-pill step-inactive">Entrega</span>
                </div>
                <div class="premium-card p-8">
                    <h2 class="font-black text-xl mb-6 uppercase tracking-tighter">Escolha o Pagamento</h2>
                    <div class="space-y-3">
                        ${metodos.map(m => `
                            <button onclick="window.setPagamento('${m.id}')" 
                                class="input-egg text-left flex justify-between items-center border-2 ${window.state.checkout.metodoPagamento === m.id ? 'border-rose-500 bg-white shadow-md' : 'border-transparent'}">
                                <span>${m.label}</span>
                                <span>${m.icon}</span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="mt-10 flex gap-4">
                        <button onclick="window.state.view='carrinho';render()" class="w-1/3 p-5 font-black uppercase text-[10px] text-gray-400">Voltar</button>
                        <button onclick="window.state.view='endereco';render()" class="btn-primary" ${!window.state.checkout.metodoPagamento ? 'disabled' : ''}>Pr√≥ximo: Endere√ßo</button>
                    </div>
                </div>
            `;
        }

        window.setPagamento = (val) => { window.state.checkout.metodoPagamento = val; render(); };

        function renderEndereco() {
            return `
                <div class="flex gap-2 mb-8">
                    <span class="step-pill step-inactive">Carrinho</span>
                    <span class="step-pill step-inactive">Pagamento</span>
                    <span class="step-pill step-active">Entrega</span>
                </div>
                <div class="premium-card p-8 mb-6">
                    <h2 class="font-black text-xl mb-6 uppercase tracking-tighter">Onde entregar?</h2>
                    
                    <div class="flex gap-2 mb-6">
                        <input id="new-end" placeholder="Novo endere√ßo..." class="input-egg !py-4">
                        <button onclick="window.addEndereco()" class="bg-gray-900 text-white px-6 rounded-2xl font-black">+</button>
                    </div>
                    
                    <div class="space-y-3 mb-8">
                        ${window.state.cliente.enderecos.length > 0 ? window.state.cliente.enderecos.map(end => `
                            <button onclick="window.state.checkout.enderecoSelecionado='${end}';render()" 
                                class="input-egg text-left text-xs border-2 ${window.state.checkout.enderecoSelecionado === end ? 'border-rose-500 bg-white shadow-md' : 'border-transparent'}">
                                ${end}
                            </button>
                        `).join('') : '<p class="text-[10px] font-bold text-gray-300 uppercase text-center py-4">Nenhum endere√ßo cadastrado</p>'}
                    </div>

                    <div class="space-y-4 pt-6 border-t border-gray-50">
                        <div class="space-y-1">
                            <label class="text-[9px] font-black uppercase text-gray-400 ml-2">Seu Nome</label>
                            <input id="user-nome" class="input-egg" value="${window.state.cliente.nome || ''}">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black uppercase text-gray-400 ml-2">Seu WhatsApp</label>
                            <input id="user-tel" type="tel" class="input-egg" value="${window.state.cliente.telefone || ''}">
                        </div>
                    </div>
                </div>
                <button onclick="window.finalizarCompra()" class="btn-primary" 
                    ${!window.state.checkout.enderecoSelecionado ? 'disabled opacity-50' : ''}>
                    Finalizar Compra
                </button>
            `;
        }

        window.addEndereco = () => {
            const val = document.getElementById('new-end').value;
            if(val) { 
                window.state.cliente.enderecos.push(val); 
                window.state.checkout.enderecoSelecionado = val;
                render(); 
            }
        };

        window.finalizarCompra = async () => {
            const nome = document.getElementById('user-nome').value;
            const tel = document.getElementById('user-tel').value;
            
            if(!nome || !tel) return alert("Preencha seu nome e telefone!");

            window.state.cliente.nome = nome;
            window.state.cliente.telefone = tel;
            localStorage.setItem('appegg_user', JSON.stringify(window.state.cliente));

            const total = window.state.carrinho.reduce((acc, i) => acc + i.preco, 0);
            
            const pedido = {
                clienteNome: nome,
                telefone: tel,
                endereco: window.state.checkout.enderecoSelecionado,
                produto: window.state.carrinho.map(i => i.nome).join(', '),
                valorTotal: total,
                metodoPagamento: window.state.checkout.metodoPagamento,
                statusPagamento: window.state.checkout.metodoPagamento === 'PAGO_PIX' ? 'PAGO' : 'PENDENTE',
                status: 'CRIADO',
                criadoEm: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "vendas_logs"), pedido);
                alert("üê£ Pedido criado com sucesso!");
                window.state.carrinho = [];
                window.state.checkout = { metodoPagamento: '', enderecoSelecionado: '' };
                window.state.view = 'pedidos';
                syncMeusPedidos();
            } catch (err) {
                alert("Erro ao enviar pedido ao banco de dados.");
            }
        };

        function syncMeusPedidos() {
            const q = query(collection(db, "vendas_logs"), where("telefone", "==", window.state.cliente.telefone), orderBy("criadoEm", "desc"));
            onSnapshot(q, s => { 
                window.state.meusPedidos = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                render(); 
            });
        }

        function renderMeusPedidos() {
            if (window.state.meusPedidos.length === 0) return `<div class="text-center py-20 font-black text-gray-300">NENHUM PEDIDO ENCONTRADO</div>`;
            return `
                <h2 class="font-black text-xl mb-6 uppercase tracking-tighter">Meus Pedidos</h2>
                <div class="space-y-4">
                    ${window.state.meusPedidos.map(p => `
                        <div class="premium-card p-6 border-l-[12px] ${p.status === 'FINALIZADO' ? 'border-green-500' : 'border-rose-500'}">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="font-black text-xs uppercase text-gray-800">${p.produto}</p>
                                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Status: ${p.status}</p>
                                </div>
                                <span class="bg-gray-100 px-3 py-1 rounded-full text-[9px] font-black uppercase text-gray-500">${p.statusPagamento}</span>
                            </div>
                            <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl">
                                <span class="text-[10px] font-black text-gray-400 uppercase">Valor Pago</span>
                                <span class="font-black text-rose-600">R$ ${Number(p.valorTotal).toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        init();
    </script>
</body>
</html>