<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg - Cadastro e Loja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        input, textarea, select { outline: none !important; }
    </style>
</head>
<body class="pb-24">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const app = initializeApp(firebaseConfig);
        const dbFirestore = getFirestore(app);
        const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";

        window.state = {
            view: 'loja', 
            produtos: [],
            carrinho: null,
            clienteData: JSON.parse(localStorage.getItem('appegg_user')) || null
        };

        window.actions = {
            loadProdutos: async () => {
                const res = await fetch(`${API_BASE}/produtos`);
                window.state.produtos = await res.json();
                window.render();
            },
            salvarCadastro: (e) => {
                e.preventDefault();
                const f = new FormData(e.target);
                
                if(f.get('senha') !== f.get('repete_senha')) {
                    alert("As senhas não conferem!");
                    return;
                }

                const data = {
                    nome: f.get('nome'),
                    email: f.get('email'),
                    whatsapp: f.get('whatsapp'),
                    doc: f.get('doc'),
                    cep: f.get('cep'),
                    rua: f.get('rua'),
                    numero: f.get('numero'),
                    cidade: f.get('cidade'),
                    estado: f.get('estado'),
                    senha: f.get('senha') // Salvo localmente para simular sessão
                };

                localStorage.setItem('appegg_user', JSON.stringify(data));
                window.state.clienteData = data;
                window.render();
            },
            finalizarPedido: async (e) => {
                e.preventDefault();
                const form = e.target;
                const c = window.state.clienteData;

                const pedido = {
                    produtoNome: window.state.carrinho.nome,
                    quantidade: parseInt(form.quantidade.value),
                    precoNoMomento: window.state.carrinho.preco,
                    tipoEstoque: window.state.carrinho.tipo_estoque,
                    // Dados do Cliente (Cadastro Completo)
                    clienteNome: c.nome,
                    clienteDoc: c.doc,
                    clienteWhatsapp: c.whatsapp,
                    clienteEmail: c.email,
                    enderecoEntrega: `${c.rua}, ${c.numero} - ${c.cidade}/${c.estado} (CEP: ${c.cep})`,
                    status: 'PENDENTE',
                    criadoEm: serverTimestamp()
                };

                await addDoc(collection(dbFirestore, "vendas_logs"), pedido);
                alert("Pedido confirmado! Prepare o omelete!");
                window.state.view = 'loja';
                window.state.carrinho = null;
                window.render();
            }
        };

        window.render = () => {
            const root = document.getElementById('app-root');

            if (!window.state.clienteData) {
                root.innerHTML = `
                    <div class="min-h-screen p-6 bg-indigo-600 flex flex-col items-center">
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md my-10">
                            <h1 class="text-3xl font-black text-indigo-600 mb-2 italic text-center">AppEgg</h1>
                            <p class="text-slate-400 text-[10px] font-black mb-8 uppercase text-center tracking-widest">Cadastro de Novo Cliente</p>
                            
                            <form onsubmit="window.actions.salvarCadastro(event)" class="space-y-3">
                                <input name="nome" placeholder="Nome ou Razão Social" required class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                <div class="grid grid-cols-2 gap-2">
                                    <input name="doc" placeholder="CPF ou CNPJ" required class="p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                    <input name="whatsapp" type="tel" placeholder="WhatsApp" required class="p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                </div>
                                <input name="email" type="email" placeholder="E-mail" required class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                
                                <div class="pt-4 border-t">
                                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Endereço</p>
                                    <input name="cep" placeholder="CEP" required class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-sm mb-2">
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <input name="rua" placeholder="Rua/Av" required class="col-span-2 p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                        <input name="numero" placeholder="Nº" required class="p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input name="cidade" placeholder="Cidade" required class="p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                        <input name="estado" placeholder="UF" maxlength="2" required class="p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                    </div>
                                </div>

                                <div class="pt-4 border-t">
                                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Segurança</p>
                                    <input name="senha" type="password" placeholder="Crie uma Senha" required class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-sm mb-2">
                                    <input name="repete_senha" type="password" placeholder="Repita a Senha" required class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-sm">
                                </div>

                                <button class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg mt-4">FINALIZAR CADASTRO</button>
                            </form>
                        </div>
                    </div>`;
                return;
            }

            if (window.state.view === 'loja') {
                root.innerHTML = `
                    <header class="p-6 flex justify-between items-center">
                        <div>
                            <h1 class="text-2xl font-black text-indigo-600 italic leading-none">AppEgg</h1>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Olá, ${window.state.clienteData.nome}</p>
                        </div>
                        <button onclick="localStorage.clear(); location.reload()" class="text-[9px] font-black text-slate-300">SAIR</button>
                    </header>
                    <main class="px-6 grid gap-4">
                        ${window.state.produtos.map(p => `
                            <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm flex justify-between items-center">
                                <div>
                                    <h3 class="font-black text-slate-800 uppercase text-xs">${p.nome}</h3>
                                    <p class="text-2xl font-black text-indigo-600">R$ ${parseFloat(p.preco).toFixed(2)}</p>
                                    <p class="text-[9px] font-bold text-slate-300 uppercase">${p.quantidade} ${p.tipo_estoque || 'un'} em estoque</p>
                                </div>
                                <button onclick='window.state.carrinho = ${JSON.stringify(p)}; window.state.view = "checkout"; window.render()' class="bg-indigo-600 text-white px-6 py-4 rounded-2xl font-black text-xs">PEDIR</button>
                            </div>
                        `).join('')}
                    </main>`;
            } 
            else if (window.state.view === 'checkout') {
                root.innerHTML = `
                    <div class="p-6">
                        <button onclick="window.state.view='loja'; window.render()" class="text-indigo-600 font-black mb-6 flex items-center gap-2">← VOLTAR</button>
                        <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm">
                            <h2 class="font-black text-slate-800 uppercase text-sm mb-4">Confirmar Pedido</h2>
                            <div class="bg-slate-50 p-4 rounded-2xl mb-6 border border-dashed">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Item Selecionado</p>
                                <p class="font-black text-slate-700 uppercase">${window.state.carrinho.nome}</p>
                                <p class="text-indigo-600 font-bold">R$ ${window.state.carrinho.preco.toFixed(2)} / ${window.state.carrinho.tipo_estoque}</p>
                            </div>
                            <form onsubmit="window.actions.finalizarPedido(event)" class="space-y-4">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Quantidade (${window.state.carrinho.tipo_estoque})</label>
                                    <input name="quantidade" type="number" value="1" min="1" required class="w-full p-4 bg-slate-50 border rounded-2xl font-black outline-none">
                                </div>
                                <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                                    <p class="text-[10px] font-black text-indigo-400 uppercase">Entregar em:</p>
                                    <p class="text-xs font-bold text-indigo-900">${window.state.clienteData.rua}, ${window.state.clienteData.numero}</p>
                                    <p class="text-[10px] text-indigo-800">${window.state.clienteData.cidade} - ${window.state.clienteData.estado}</p>
                                </div>
                                <button class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">ENVIAR PEDIDO AGORA</button>
                            </form>
                        </div>
                    </div>`;
            }
        };

        window.actions.loadProdutos();
    </script>
</body>
</html>