<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg | Pedir Ovos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #ffffff; color: #111; }
        .logo-text { font-weight: 800; color: #e11d48; font-style: italic; }
        .card-egg { background: white; border: 1px solid #f3f4f6; border-radius: 24px; padding: 16px; margin-bottom: 12px; }
        .input-cliente { width: 100%; padding: 16px; background: #f9fafb; border-radius: 16px; border: 1px solid #f3f4f6; font-weight: 700; outline: none; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-around; padding: 15px; }
    </style>
</head>
<body>
<div id="app-root"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
        authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
        projectId: "distribuidora-de-ovos-aline",
        storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
        messagingSenderId: "92187548716",
        appId: "1:92187548716:web:d61d18a29aa76aead7c589"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";

    window.state = { user: null, view: 'loja', produtos: [], pedidos: [], comprando: null, qtd: 1 };

    onAuthStateChanged(auth, user => {
        window.state.user = user;
        if(user) { loadProdutos(); syncPedidos(); }
        render();
    });

    async function loadProdutos() {
        const r = await fetch(`${API_BASE}/produtos`);
        state.produtos = await r.json();
        render();
    }

    function syncPedidos() {
        const q = query(collection(db, "vendas_logs"), where("clienteId", "==", auth.currentUser.uid), orderBy("criadoEm", "desc"));
        onSnapshot(q, s => {
            state.pedidos = s.docs.map(d => ({id:d.id, ...d.data()}));
            render();
        });
    }

    function render() {
        const root = document.getElementById('app-root');
        if(!window.state.user) {
            root.innerHTML = `<div class="p-8 mt-20"><div class="logo-text text-4xl mb-8">AppEgg</div><form onsubmit="handleLogin(event)" class="space-y-4"><input name="email" placeholder="E-mail" class="input-cliente"><input name="pass" type="password" placeholder="Senha" class="input-cliente"><button class="w-full bg-rose-600 text-white py-4 rounded-xl font-black">ENTRAR</button></form></div>`;
            return;
        }

        root.innerHTML = `
            <div class="p-4 pb-24">
                <div class="logo-text text-2xl mb-6">AppEgg</div>
                ${state.view === 'pedidos' ? renderPedidos() : renderLoja()}
            </div>
            <nav class="nav-bottom">
                <button onclick="state.view='loja';render()" class="font-black text-xs">LOJA</button>
                <button onclick="state.view='pedidos';render()" class="font-black text-xs">PEDIDOS</button>
                <button onclick="window.logout()" class="font-black text-xs text-gray-400">SAIR</button>
            </nav>
            ${state.comprando ? renderModal() : ''}
        `;
    }

    function renderLoja() {
        return state.produtos.map(p => `
            <div class="card-egg flex justify-between items-center" onclick='window.abrirCompra(${JSON.stringify(p)})'>
                <div><h3 class="font-black uppercase">${p.nome}</h3><p class="text-rose-600 font-bold">R$ ${p.preco.toFixed(2)}</p></div>
                <button class="bg-gray-900 text-white px-4 py-2 rounded-lg font-black text-[10px]">COMPRAR</button>
            </div>`).join('');
    }

    function renderPedidos() {
        return state.pedidos.map(p => `
            <div class="card-egg">
                <p class="text-[9px] font-black uppercase text-rose-600">${p.status}</p>
                <h4 class="font-black text-xs uppercase">${p.quantidade}x ${p.produto}</h4>
                <p class="font-bold text-gray-400 text-[10px]">R$ ${p.valorTotal.toFixed(2)}</p>
            </div>`).join('');
    }

    function renderModal() {
        const p = state.comprando;
        return `
        <div class="fixed inset-0 bg-black/80 flex items-end z-50">
            <div class="bg-white w-full p-8 rounded-t-[40px]">
                <h3 class="font-black text-xl uppercase mb-2">${p.nome}</h3>
                <div class="flex items-center gap-6 my-6">
                    <button onclick="window.qtd(-1)" class="w-12 h-12 bg-gray-100 rounded-xl font-black">-</button>
                    <span class="text-2xl font-black">${state.qtd}</span>
                    <button onclick="window.qtd(1)" class="w-12 h-12 bg-gray-100 rounded-xl font-black">+</button>
                </div>
                <form onsubmit="confirmarPedido(event)" class="space-y-4">
                    <select name="recorrencia" class="input-cliente font-black text-xs">
                        <option value="">Compra Única</option>
                        <option value="Semanal">Toda Semana</option>
                        <option value="Quinzenal">A cada 15 dias</option>
                    </select>
                    <button class="w-full bg-rose-600 text-white py-5 rounded-2xl font-black uppercase">Finalizar • R$ ${(p.preco * state.qtd).toFixed(2)}</button>
                </form>
                <button onclick="state.comprando=null;render()" class="w-full py-4 text-gray-400 font-black text-xs">CANCELAR</button>
            </div>
        </div>`;
    }

    window.handleLogin = async e => { e.preventDefault(); await signInWithEmailAndPassword(auth, e.target.email.value, e.target.pass.value); };
    window.logout = () => signOut(auth);
    window.abrirCompra = p => { state.comprando = p; state.qtd = 1; render(); };
    window.qtd = v => { if(state.qtd+v > 0) { state.qtd += v; render(); }};

    window.confirmarPedido = async e => {
        e.preventDefault();
        const p = state.comprando;
        const rec = new FormData(e.target).get('recorrencia');
        
        // A CORREÇÃO DA ANÁLISE:
        await addDoc(collection(db, "vendas_logs"), {
            clienteId: auth.currentUser.uid,
            clienteNome: auth.currentUser.email.split('@')[0],
            produtoId: p.id,
            produto: p.nome,
            quantidade: state.qtd,
            precoUnidade: p.preco, // Adicionado para relatórios
            valorTotal: p.preco * state.qtd,
            recorrencia: rec,
            status: 'AGUARDANDO PAGAMENTO', // Padronizado
            criadoEm: serverTimestamp()
        });

        await fetch(`${API_BASE}/produtos/${p.id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ quantidade: p.quantidade - state.qtd })
        });

        state.comprando = null;
        state.view = 'pedidos';
        render();
    };

    window.render = render;
</script>
</body>
</html>