<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Sua Loja de Ovos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f8fafc; 
            padding-bottom: 120px; 
            color: #1e293b; 
            overflow-x: hidden; 
        }

        .logo-text { font-weight: 900; color: #e11d48; font-size: 1.8rem; letter-spacing: -1px; }
        
        .nav-bottom { 
            position: fixed; bottom: 20px; left: 15px; right: 15px; 
            background: #0f172a; border-radius: 32px; display: flex; 
            justify-content: space-around; padding: 18px; z-index: 100; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        .nav-item { 
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; 
            color: #64748b; font-size: 9px; font-weight: 900; text-transform: uppercase; 
            border: none; background: transparent; cursor: pointer; transition: 0.3s;
        }
        .nav-item.active { color: #fff; transform: scale(1.1); }
        
        .card-egg { 
            background: white; border: 1px solid #f1f5f9; border-radius: 40px; 
            padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); 
            transition: 0.3s; position: relative;
        }
        
        .btn-main { 
            background: #e11d48; color: white; padding: 20px; border-radius: 28px; 
            font-weight: 900; text-transform: uppercase; font-size: 13px; 
            box-shadow: 0 10px 25px rgba(225, 29, 72, 0.2); width: 100%; 
            transition: 0.2s; cursor: pointer; border: none;
        }
        .btn-main:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        
        .input-egg { 
            width: 100%; padding: 18px; background: #f1f5f9; border-radius: 20px; 
            border: 2px solid transparent; font-weight: 700; font-size: 14px; outline: none; transition: 0.2s; 
        }
        .input-egg:focus { border-color: #e11d48; background: #fff; }

        .btn-add-fast {
            background: #e11d48; color: white; width: 44px; height: 44px;
            border-radius: 16px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 900; transition: 0.2s;
        }
        .btn-add-fast:active { transform: scale(0.9); }

        .option-card {
            border: 2px solid #f1f5f9; border-radius: 24px; padding: 16px;
            transition: 0.2s; cursor: pointer; text-align: left;
        }
        .option-card.active { border-color: #e11d48; background: #fff1f2; }

        .btn-filter {
            padding: 10px 14px; border-radius: 16px; font-size: 10px; font-weight: 800;
            text-transform: uppercase; transition: 0.2s; border: 2px solid #f1f5f9;
            color: #64748b; background: white; white-space: nowrap;
        }
        .btn-filter.active { background: #e11d48; color: white; border-color: #e11d48; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pix-box { background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 24px; padding: 20px; margin-top: 15px; text-align: center; }
        
        .text-label-red { color: #e11d48; font-weight: 800; text-transform: uppercase; font-size: 10px; letter-spacing: 0.05em; }

        .qr-container { background: white; padding: 15px; border-radius: 20px; display: inline-block; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="no-scrollbar">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, addDoc, 
            serverTimestamp, increment, updateDoc, setDoc, runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, updatePassword 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const auth = getAuth(appFB);
        
        const appId = "app-egg-pro-transacional";
        const DISTRIBUIDORA_ENDERECO = "R. Antônio Freire da Silva, 67 - Jardim das Camelias, São Paulo - SP, 08050-300";

        // --- ESTADO GLOBAL ---
        window.state = { 
            user: null, 
            profile: null,
            view: 'loja', 
            produtos: [], 
            pedidos: [], 
            cart: [],
            pix: { key: '', type: '', copiaCola: '' }, 
            checkout: { tipoEntrega: 'entrega', endereco: null, metodoPagamento: 'pix_agora' },
            profileMode: 'view',
            ordersFilter: 'aberto', 
            ordersDate: '', 
            loading: true, 
            processing: false,
            payingOrder: null
        };

        // --- FUNÇÕES GLOBAIS ---

        window.handleLogin = async (e) => {
            if (e) e.preventDefault();
            const email = document.getElementById('le').value.trim();
            const pass = document.getElementById('lp').value;
            try { 
                await signInWithEmailAndPassword(auth, email, pass); 
            } catch (err) { 
                alert("Dados de acesso incorretos."); 
            }
        };

        window.setView = (v) => { 
            window.state.view = v; 
            window.state.profileMode = 'view';
            window.state.payingOrder = null;
            window.render(); 
        };

        window.handleSignOut = () => signOut(auth);

        window.maskDoc = (i) => {
            let v = i.value.replace(/\D/g, "");
            if (v.length <= 11) i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g, "$1.$2.$3-$4");
            else i.value = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g, "$1.$2.$3/$4-$5");
        };

        window.maskTel = (i) => { 
            let v = i.value.replace(/\D/g, ""); 
            i.value = v.replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d{5})(\d)/, "$1-$2").substring(0, 15); 
        };

        window.maskCEP = (i) => { 
            let v = i.value.replace(/\D/g, ""); 
            i.value = v.replace(/(\d{5})(\d)/, "$1-$2").substring(0, 9); 
        };

        window.addToCart = (id) => {
            const p = window.state.produtos.find(x => x.id === id);
            if (!p) return;
            const existing = window.state.cart.find(x => x.id === id);
            if (existing) {
                if (existing.qtd + 1 > p.quantidade) { alert("Estoque máximo atingido!"); return; }
                existing.qtd++;
            } else {
                if (p.quantidade < 1) { alert("Produto esgotado!"); return; }
                window.state.cart.push({ ...p, qtd: 1 });
            }
            window.render();
        };

        window.removeFromCart = (id) => {
            window.state.cart = window.state.cart.filter(x => x.id !== id);
            window.render();
        };

        window.updateQtd = (id, delta) => {
            const item = window.state.cart.find(x => x.id === id);
            if (item) {
                item.qtd += delta;
                const p = window.state.produtos.find(x => x.id === id);
                if (item.qtd > p.quantidade) item.qtd = p.quantidade;
                if (item.qtd <= 0) window.removeFromCart(id);
            }
            window.render();
        };

        window.calculateTotal = () => {
            return window.state.cart.reduce((acc, item) => acc + (item.preco * item.qtd), 0).toFixed(2);
        };

        window.setTipoEntrega = (tipo) => {
            window.state.checkout.tipoEntrega = tipo;
            window.state.checkout.endereco = tipo === 'retirada' ? DISTRIBUIDORA_ENDERECO : window.state.profile?.address;
            window.render();
        };

        window.setMetodoPagamento = (metodo) => {
            window.state.checkout.metodoPagamento = metodo;
            window.render();
        };

        // --- GERAÇÃO DE PIX DINÂMICO ---
        window.gerarPix = ({ chave, tipo, valor, txid }) => {
            function tlv(id, value) {
                return id + value.length.toString().padStart(2, '0') + value;
            }
            let chaveFinal = chave;
            if (tipo === 'Celular') chaveFinal = '+55' + chave.replace(/\D/g, '');
            let payload = '000201' + tlv('26', tlv('00', 'BR.GOV.BCB.PIX') + tlv('01', chaveFinal)) + '52040000' + '5303986' + tlv('54', valor.toFixed(2)) + '5802BR' + tlv('59', 'APPEGG') + tlv('60', 'SAOPAULO') + tlv('62', tlv('05', txid.substring(0, 25))) + '6304';
            let crc = 0xFFFF;
            for (let i = 0; i < payload.length; i++) {
                crc ^= payload.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) { crc = crc & 0x8000 ? (crc << 1) ^ 0x1021 : crc << 1; }
            }
            return payload + (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        };

        window.handleCheckout = async () => {
            if (!window.state.cart.length) return;
            if (!window.state.profile) return alert('Complete seu perfil antes de finalizar o pedido.');
            window.state.processing = true;
            window.render();
            try {
                const order = {
                    clienteId: window.state.user.uid,
                    clienteNome: window.state.profile.name,
                    itens: window.state.cart.map(item => ({ id: item.id, nome: item.nome, qtd: item.qtd, preco: item.preco })),
                    tipoEntrega: window.state.checkout.tipoEntrega,
                    endereco: window.state.checkout.endereco,
                    metodoPagamento: window.state.checkout.metodoPagamento,
                    valorTotal: parseFloat(window.calculateTotal()),
                    criadoEm: serverTimestamp(),
                    status: 'aberto'
                };
                const orderRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), order);
                if (window.state.checkout.metodoPagamento === 'pix_agora') {
                    const pixPayload = window.gerarPix({
                        chave: window.state.pix.key,
                        tipo: window.state.pix.type,
                        valor: order.valorTotal,
                        txid: orderRef.id
                    });
                    await updateDoc(orderRef, { pixCopiaCola: pixPayload });
                    window.state.payingOrder = { ...order, id: orderRef.id, pixCopiaCola: pixPayload };
                }
                window.state.cart = [];
                window.showToast('Pedido realizado com sucesso!');
                window.setView('pedidos');
            } catch (err) {
                console.error(err);
                alert('Erro ao realizar pedido.');
            } finally {
                window.state.processing = false;
                window.render();
            }
        };

        window.handlePayOrder = async (orderId) => {
            const order = window.state.pedidos.find(p => p.id === orderId);
            if (!order) return;
            window.state.processing = true;
            window.render();
            try {
                const pixPayload = window.gerarPix({
                    chave: window.state.pix.key,
                    tipo: window.state.pix.type,
                    valor: order.valorTotal,
                    txid: orderId
                });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vendas_logs', orderId), { pixCopiaCola: pixPayload });
                window.state.payingOrder = { ...order, pixCopiaCola: pixPayload };
                window.render();
            } catch (err) {
                console.error(err);
                alert('Erro ao gerar PIX.');
            } finally {
                window.state.processing = false;
            }
        };

        window.handleUpdateProfile = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.name.value,
                doc: form.doc.value,
                phone: form.phone.value,
                address: {
                    rua: form.rua.value,
                    numero: form.numero.value,
                    bairro: form.bairro.value,
                    cep: form.cep.value,
                    cidade: form.cidade.value,
                    estado: form.estado.value.toUpperCase(),
                }
            };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, 'profiles', 'main'), data);
                window.showToast('Perfil atualizado!');
                window.setView('perfil');
            } catch (err) {
                alert('Erro ao atualizar perfil.');
            }
        };

        window.handleUpdatePassword = async (e) => {
            e.preventDefault();
            const newPass = document.getElementById('newPass').value;
            try {
                await updatePassword(auth.currentUser, newPass);
                window.showToast('Senha alterada com sucesso!');
                window.setView('perfil');
            } catch (err) {
                alert('Erro ao alterar senha.');
            }
        };

        window.copyToClipboard = (text) => {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                window.showToast('Código PIX copiado!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
            });
        };

        window.showToast = (msg) => {
            // Implementação simples de toast (pode ser expandida com animações)
            const toast = document.createElement('div');
            toast.className = 'toast-container';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO ---

        function renderLoja() {
            return `<div class="p-6 space-y-6 fade-in">
                <h2 class="text-3xl font-black text-slate-800 italic uppercase">Loja de Ovos</h2>
                ${window.state.produtos.map(p => `
                    <div class="card-egg flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold">${p.nome}</h3>
                            <p class="text-sm text-slate-500">R$ ${p.preco.toFixed(2)} | Estoque: ${p.quantidade}</p>
                        </div>
                        <button class="btn-add-fast" onclick="addToCart('${p.id}')">+</button>
                    </div>
                `).join('') || '<p class="text-center text-slate-500">Nenhum produto disponível.</p>'}
            </div>`;
        }

        function renderCarrinho() {
            const total = window.calculateTotal();
            return `<div class="p-6 space-y-6 fade-in">
                <h2 class="text-3xl font-black text-slate-800 italic uppercase">Carrinho</h2>
                ${window.state.cart.map(item => `
                    <div class="card-egg flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold">${item.nome}</h3>
                            <p class="text-sm text-slate-500">R$ ${(item.preco * item.qtd).toFixed(2)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="btn-add-fast text-xl" onclick="updateQtd('${item.id}', -1)">-</button>
                            <span class="font-bold">${item.qtd}</span>
                            <button class="btn-add-fast text-xl" onclick="updateQtd('${item.id}', 1)">+</button>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-slate-500">Carrinho vazio.</p>'}
                <div class="border-t pt-4">
                    <p class="text-right font-bold text-lg">Total: R$ ${total}</p>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xl font-bold">Tipo de Entrega</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="option-card ${window.state.checkout.tipoEntrega === 'entrega' ? 'active' : ''}" onclick="setTipoEntrega('entrega')">
                            <p class="font-bold">Entrega</p>
                        </div>
                        <div class="option-card ${window.state.checkout.tipoEntrega === 'retirada' ? 'active' : ''}" onclick="setTipoEntrega('retirada')">
                            <p class="font-bold">Retirada</p>
                        </div>
                    </div>
                    <p class="text-sm text-slate-500">${window.state.checkout.endereco}</p>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xl font-bold">Pagamento</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="option-card ${window.state.checkout.metodoPagamento === 'pix_agora' ? 'active' : ''}" onclick="setMetodoPagamento('pix_agora')">
                            <p class="font-bold">PIX Agora</p>
                        </div>
                        <div class="option-card ${window.state.checkout.metodoPagamento === 'pix_depois' ? 'active' : ''}" onclick="setMetodoPagamento('pix_depois')">
                            <p class="font-bold">PIX Depois</p>
                        </div>
                    </div>
                </div>
                <button class="btn-main mt-6" onclick="handleCheckout()" disabled="${window.state.processing || !window.state.cart.length}">${window.state.processing ? 'Processando...' : 'Finalizar Pedido'}</button>
            </div>`;
        }

        function renderPedidos() {
            const filtered = window.state.pedidos.filter(p => p.status === window.state.ordersFilter || !window.state.ordersFilter);
            return `<div class="p-6 space-y-6 fade-in">
                <h2 class="text-3xl font-black text-slate-800 italic uppercase">Meus Pedidos</h2>
                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                    <button class="btn-filter ${window.state.ordersFilter === 'aberto' ? 'active' : ''}" onclick="window.state.ordersFilter='aberto';render()">Abertos</button>
                    <button class="btn-filter ${window.state.ordersFilter === 'finalizado' ? 'active' : ''}" onclick="window.state.ordersFilter='finalizado';render()">Finalizados</button>
                    <button class="btn-filter ${window.state.ordersFilter === 'cancelado' ? 'active' : ''}" onclick="window.state.ordersFilter='cancelado';render()">Cancelados</button>
                </div>
                ${filtered.map(p => `
                    <div class="card-egg space-y-2">
                        <div class="flex justify-between">
                            <p class="font-bold">#${p.id.slice(0,8)}</p>
                            <p class="badge-status ${p.status === 'aberto' ? 'bg-yellow-100 text-yellow-600' : p.status === 'finalizado' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${p.status}</p>
                        </div>
                        <p class="text-sm text-slate-500">Valor: R$ ${p.valorTotal.toFixed(2)}</p>
                        <p class="text-sm text-slate-500">Itens: ${p.itens.length}</p>
                        ${p.metodoPagamento.includes('pix') && p.status === 'aberto' ? `<button class="btn-main text-xs py-2" onclick="handlePayOrder('${p.id}')">Pagar com PIX</button>` : ''}
                        ${window.state.payingOrder && window.state.payingOrder.id === p.id ? `
                            <div class="pix-box">
                                <p class="text-label-red mb-2">Código PIX</p>
                                <div class="qr-container mx-auto">
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.state.payingOrder.pixCopiaCola)}" alt="QR Code PIX">
                                </div>
                                <p class="text-xs text-slate-500 mt-2 break-all">${window.state.payingOrder.pixCopiaCola}</p>
                                <button class="btn-main mt-4 text-xs" onclick="copyToClipboard('${window.state.payingOrder.pixCopiaCola}')">Copiar Código</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') || '<p class="text-center text-slate-500">Nenhum pedido encontrado.</p>'}
            </div>`;
        }

        function renderPerfil() {
            const p = window.state.profile;
            return `<div class="p-6 space-y-6 fade-in">
                <h2 class="text-3xl font-black text-slate-800 italic uppercase">Meu Perfil</h2>
                <div class="card-egg space-y-4">
                    <p class="font-bold">${p?.name || 'Nome não definido'}</p>
                    <p class="text-sm text-slate-500">${p?.doc || 'Documento não definido'}</p>
                    <p class="text-sm text-slate-500">${p?.phone || 'Telefone não definido'}</p>
                </div>
                <div class="card-egg space-y-2">
                    <p class="font-bold">Endereço</p>
                    <p class="text-sm text-slate-500">${p?.address ? `${p.address.rua}, ${p.address.numero} - ${p.address.bairro}, ${p.address.cidade} - ${p.address.estado} CEP: ${p.address.cep}` : 'Endereço não definido'}</p>
                </div>
                <button class="btn-main" onclick="window.state.profileMode='edit';render()">Editar Perfil</button>
                <button class="btn-main bg-slate-100 text-slate-600" onclick="window.state.profileMode='password';render()">Alterar Senha</button>
                <button class="btn-main bg-red-100 text-red-600" onclick="handleSignOut()">Sair</button>
            </div>`;
        }

        function renderEditPerfil() {
            const p = window.state.profile;
            return `<div class="p-6 space-y-6 fade-in">
                <h2 class="text-3xl font-black text-slate-800 italic uppercase">Editar Perfil</h2>
                <form onsubmit="handleUpdateProfile(event)" class="space-y-4">
                    <input name="name" value="${p?.name || ''}" placeholder="Nome" class="input-egg" required>
                    <input name="doc" value="${p?.doc || ''}" placeholder="CPF/CNPJ" class="input-egg" oninput="maskDoc(this)" required>
                    <input name="phone" value="${p?.phone || ''}" placeholder="Telefone" class="input-egg" oninput="maskTel(this)" required>
                    <input name="rua" value="${p?.address?.rua || ''}" placeholder="Rua" class="input-egg" required>
                    <input name="numero" value="${p?.address?.numero || ''}" placeholder="Número" class="input-egg" required>
                    <input name="bairro" value="${p?.address?.bairro || ''}" placeholder="Bairro" class="input-egg" required>
                    <input name="cep" value="${p?.address?.cep || ''}" placeholder="CEP" class="input-egg" oninput="maskCEP(this)" required>
                    <input name="cidade" value="${p?.address?.cidade || ''}" placeholder="Cidade" class="input-egg" required>
                    <input name="estado" value="${p?.address?.estado || ''}" placeholder="Estado (UF)" class="input-egg" maxlength="2" required>
                    <button class="btn-main" type="submit">Salvar</button>
                </form>
            </div>`;
        }

        function renderChangePassword() {
            return `<div class="p-6 space-y-6 fade-in">
                <h2 class="text-3xl font-black text-slate-800 italic uppercase">Alterar Senha</h2>
                <form onsubmit="handleUpdatePassword(event)" class="space-y-4">
                    <input id="newPass" type="password" placeholder="Nova Senha" class="input-egg" minlength="6" required>
                    <button class="btn-main" type="submit">Confirmar</button>
                </form>
            </div>`;
        }

        function renderLogin() {
            return `<div class="min-h-screen flex flex-col justify-center p-6 space-y-6">
                <h1 class="text-5xl font-black text-rose-600 italic uppercase text-center">AppEgg</h1>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input id="le" type="email" placeholder="Email" class="input-egg" required>
                    <input id="lp" type="password" placeholder="Senha" class="input-egg" required>
                    <button class="btn-main" type="submit">Entrar</button>
                </form>
            </div>`;
        }

        function renderNavBottom() {
            return `<div class="nav-bottom">
                <button class="nav-item ${window.state.view === 'loja' ? 'active' : ''}" onclick="setView('loja')">
                    <span>Loja</span>
                </button>
                <button class="nav-item ${window.state.view === 'carrinho' ? 'active' : ''}" onclick="setView('carrinho')">
                    <span>Carrinho (${window.state.cart.length})</span>
                </button>
                <button class="nav-item ${window.state.view === 'pedidos' ? 'active' : ''}" onclick="setView('pedidos')">
                    <span>Pedidos</span>
                </button>
                <button class="nav-item ${window.state.view === 'perfil' ? 'active' : ''}" onclick="setView('perfil')">
                    <span>Perfil</span>
                </button>
            </div>`;
        }

        window.render = () => {
            const root = document.getElementById('app-root');
            if (window.state.loading) {
                root.innerHTML = `<div class="min-h-screen flex items-center justify-center text-slate-500">Carregando...</div>`;
                return;
            }
            if (!window.state.user) {
                root.innerHTML = renderLogin();
                return;
            }
            let content = '';
            switch (window.state.view) {
                case 'loja': content = renderLoja(); break;
                case 'carrinho': content = renderCarrinho(); break;
                case 'pedidos': content = renderPedidos(); break;
                case 'perfil':
                    if (window.state.profileMode === 'edit') content = renderEditPerfil();
                    else if (window.state.profileMode === 'password') content = renderChangePassword();
                    else content = renderPerfil();
                    break;
            }
            root.innerHTML = content + renderNavBottom();
        };

        onAuthStateChanged(auth, async (u) => {
            window.state.user = u;
            if (u) {
                onSnapshot(doc(db, 'artifacts', appId, 'users', u.uid, 'profiles', 'main'), (snap) => { 
                    if (snap.exists()) { 
                        window.state.profile = snap.data(); 
                        window.render(); 
                    } 
                });
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), (snap) => { 
                    if (snap.exists()) { 
                        window.state.pix = snap.data(); 
                        window.render(); 
                    } 
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'estoque'), s => { 
                    window.state.produtos = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); 
                    window.state.loading = false; 
                    window.render(); 
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), s => { 
                    window.state.pedidos = s.docs.map(d => ({id: d.id, ...d.data()})).filter(p => p.clienteId === u.uid).sort((a,b)=>(b.criadoEm?.seconds||0)-(a.criadoEm?.seconds||0)); 
                    window.render(); 
                });
            } else { 
                window.state.loading = false; 
                window.render(); 
            }
        });
    </script>
</body>
</html>
