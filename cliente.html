<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Sua Loja de Ovos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f8fafc; 
            padding-bottom: 120px; 
            color: #1e293b; 
            overflow-x: hidden; 
        }

        .logo-text { font-weight: 900; color: #e11d48; font-size: 1.8rem; letter-spacing: -1px; }
        
        .nav-bottom { 
            position: fixed; bottom: 20px; left: 15px; right: 15px; 
            background: #0f172a; border-radius: 32px; display: flex; 
            justify-content: space-around; padding: 18px; z-index: 100; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        .nav-item { 
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; 
            color: #64748b; font-size: 9px; font-weight: 900; text-transform: uppercase; 
            border: none; background: transparent; cursor: pointer; transition: 0.3s;
        }
        .nav-item.active { color: #fff; transform: scale(1.1); }
        
        .card-egg { 
            background: white; border: 1px solid #f1f5f9; border-radius: 40px; 
            padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); 
            transition: 0.3s; position: relative;
        }
        
        .btn-main { 
            background: #e11d48; color: white; padding: 20px; border-radius: 28px; 
            font-weight: 900; text-transform: uppercase; font-size: 13px; 
            box-shadow: 0 10px 25px rgba(225, 29, 72, 0.2); width: 100%; 
            transition: 0.2s; cursor: pointer; border: none;
        }
        .btn-main:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        
        .input-egg { 
            width: 100%; padding: 18px; background: #f1f5f9; border-radius: 20px; 
            border: 2px solid transparent; font-weight: 700; font-size: 14px; outline: none; transition: 0.2s; 
        }
        .input-egg:focus { border-color: #e11d48; background: #fff; }

        .btn-add-fast {
            background: #e11d48; color: white; width: 44px; height: 44px;
            border-radius: 16px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 900; transition: 0.2s;
        }
        .btn-add-fast:active { transform: scale(0.9); }

        .option-card {
            border: 2px solid #f1f5f9; border-radius: 24px; padding: 16px;
            transition: 0.2s; cursor: pointer; text-align: left;
        }
        .option-card.active { border-color: #e11d48; background: #fff1f2; }

        .btn-filter {
            padding: 10px 14px; border-radius: 16px; font-size: 10px; font-weight: 800;
            text-transform: uppercase; transition: 0.2s; border: 2px solid #f1f5f9;
            color: #64748b; background: white; white-space: nowrap;
        }
        .btn-filter.active { background: #e11d48; color: white; border-color: #e11d48; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pix-box { background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 24px; padding: 20px; margin-top: 15px; text-align: center; }
        
        .text-label-red { color: #e11d48; font-weight: 800; text-transform: uppercase; font-size: 10px; letter-spacing: 0.05em; }

        .qr-container { background: white; padding: 15px; border-radius: 20px; display: inline-block; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="no-scrollbar">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, addDoc, 
            serverTimestamp, increment, updateDoc, setDoc, runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, updatePassword 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const auth = getAuth(appFB);
        
        const appId = "app-egg-pro-transacional";
        const DISTRIBUIDORA_ENDERECO = "R. Ant√¥nio Freire da Silva, 67 - Jardim das Camelias, S√£o Paulo - SP, 08050-300";

        // --- ESTADO GLOBAL ---
        window.state = { 
            user: null, 
            profile: null,
            view: 'loja', 
            produtos: [], 
            pedidos: [], 
            cart: [],
            pix: { key: '', type: '', copiaCola: '' }, 
            checkout: { tipoEntrega: 'entrega', endereco: null, metodoPagamento: 'pix_agora' },
            profileMode: 'view',
            ordersFilter: 'aberto', 
            ordersDate: '', 
            loading: true, 
            processing: false,
            payingOrder: null
        };

        // --- FUN√á√ïES GLOBAIS ---

        window.handleLogin = async (e) => {
            if (e) e.preventDefault();
            const email = document.getElementById('le').value.trim();
            const pass = document.getElementById('lp').value;
            try { 
                await signInWithEmailAndPassword(auth, email, pass); 
            } catch (err) { 
                alert("Dados de acesso incorretos."); 
            }
        };

        window.setView = (v) => { 
            window.state.view = v; 
            window.state.profileMode = 'view';
            window.state.payingOrder = null;
            window.render(); 
        };

        window.handleSignOut = () => signOut(auth);

        window.maskDoc = (i) => {
            let v = i.value.replace(/\D/g, "");
            if (v.length <= 11) i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g, "$1.$2.$3-$4");
            else i.value = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g, "$1.$2.$3/$4-$5");
        };

        window.maskTel = (i) => { 
            let v = i.value.replace(/\D/g, ""); 
            i.value = v.replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d{5})(\d)/, "$1-$2").substring(0, 15); 
        };

        window.maskCEP = (i) => { 
            let v = i.value.replace(/\D/g, ""); 
            i.value = v.replace(/(\d{5})(\d)/, "$1-$2").substring(0, 9); 
        };

        window.addToCart = (id) => {
            const p = window.state.produtos.find(x => x.id === id);
            if (!p) return;
            const existing = window.state.cart.find(x => x.id === id);
            if (existing) {
                if (existing.qtd + 1 > p.quantidade) { alert("Stock m√°ximo atingido!"); return; }
                existing.qtd++;
            } else {
                if (p.quantidade < 1) { alert("Produto esgotado!"); return; }
                window.state.cart.push({ ...p, qtd: 1 });
            }
            window.render();
        };

        window.repeatOrder = (pedidoId) => {
            const pedido = window.state.pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;
            const items = pedido.items || [{ produto: pedido.produto, quantidade: pedido.quantidade }];
            items.forEach(item => {
                const p = window.state.produtos.find(x => x.nome === item.produto);
                if (p && p.quantidade >= item.quantidade) {
                    const existing = window.state.cart.find(x => x.id === p.id);
                    if (existing) existing.qtd += item.quantidade; else window.state.cart.push({ ...p, qtd: item.quantidade });
                }
            });
            window.state.view = 'carrinho'; window.render();
        };

        window.updateCartQtd = (id, val) => {
            const item = window.state.cart.find(x => x.id === id);
            const p = window.state.produtos.find(x => x.id === id);
            if (!item) return;
            item.qtd = Math.max(0, item.qtd + val);
            if (item.qtd > p.quantidade) item.qtd = p.quantidade;
            if (item.qtd === 0) window.state.cart = window.state.cart.filter(x => x.id !== id);
            window.render();
        };

        window.copyPixCopiaCola = (texto) => {
            if (!texto) { alert("Aguardando c√≥digo PIX..."); return; }
            navigator.clipboard.writeText(texto).then(() => {
                alert("C√≥digo PIX Copia e Cola copiado!");
            }).catch(() => {
                const el = document.createElement('textarea'); el.value = texto; document.body.appendChild(el);
                el.select(); document.execCommand('copy'); document.body.removeChild(el); 
                alert("C√≥digo PIX copiado!");
            });
        };

        // ‚úÖ CONFIRMAR PAGAMENTO: UNIFICADO PARA PIX_PAGO COM ATUALIZA√á√ÉO LOCAL
        window.confirmarPagamentoPix = async (pedidoId) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vendas_logs', pedidoId), {
                    'pagamento.pago': true,
                    'pagamento.confirmadoEm': serverTimestamp(),
                    status: 'PIX_PAGO'
                });
                
                // ‚úÖ ATUALIZA√á√ÉO LOCAL IMEDIATA
                const pedIdx = window.state.pedidos.findIndex(p => p.id === pedidoId);
                if (pedIdx !== -1) {
                    window.state.pedidos[pedIdx].status = 'PIX_PAGO';
                    if(window.state.pedidos[pedIdx].pagamento) window.state.pedidos[pedIdx].pagamento.pago = true;
                }

                alert("Obrigado! O lojista foi notificado do seu pagamento.");
                window.state.payingOrder = null;
                window.state.view = 'pedidos';
                window.render();
            } catch (e) {
                alert("Erro ao confirmar pagamento.");
            }
        };

        window.handleUpdateProfile = async (e) => {
            e.preventDefault();
            if (window.state.processing) return;
            window.state.processing = true; window.render();
            const f = new FormData(e.target);
            const newData = {
                name: f.get('name'), doc: f.get('doc'), phone: f.get('phone'),
                address: { rua: f.get('rua'), numero: f.get('numero'), bairro: f.get('bairro'), cep: f.get('cep'), cidade: f.get('cidade'), estado: f.get('estado').toUpperCase() },
                updatedAt: serverTimestamp()
            };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, 'profiles', 'main'), newData, { merge: true });
                window.state.profileMode = 'view';
                alert("Dados atualizados com sucesso!");
            } catch (err) { alert("Erro ao atualizar perfil."); } 
            finally { window.state.processing = false; window.render(); }
        };

        window.handleUpdatePassword = async (e) => {
            e.preventDefault();
            const newPass = document.getElementById('newPass').value;
            if (newPass.length < 6) { alert("A senha deve ter no m√≠nimo 6 caracteres."); return; }
            window.state.processing = true; window.render();
            try {
                await updatePassword(auth.currentUser, newPass);
                alert("Senha alterada com sucesso!");
                window.state.profileMode = 'view';
            } catch (err) { alert("Erro ao trocar senha: " + err.message); } 
            finally { window.state.processing = false; window.render(); }
        };

        window.handleSaveCheckoutAddress = (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            window.state.checkout.endereco = { rua: f.get('rua'), numero: f.get('numero'), bairro: f.get('bairro'), cep: f.get('cep'), cidade: f.get('cidade'), estado: f.get('estado').toUpperCase() };
            window.state.checkout.tipoEntrega = 'entrega';
            window.state.view = 'checkout-endereco';
            window.render();
        };

        // --- FINALIZA√á√ÉO AT√îMICA COM PEDIDO CONSOLIDADO ---
        window.handleFinalizeOrder = async () => {
            if (window.state.processing || window.state.cart.length === 0) return;
            window.state.processing = true; window.render();
            try {
                const s = window.state;
                const totalPedido = s.cart.reduce((acc, i) => acc + (i.preco * i.qtd), 0);
                const finalAddr = s.checkout.tipoEntrega === 'retirada' ? DISTRIBUIDORA_ENDERECO : (s.checkout.endereco ? `${s.checkout.endereco.rua}, ${s.checkout.endereco.numero} - ${s.checkout.endereco.bairro}` : `${s.profile?.address?.rua || ''}, ${s.profile?.address?.numero || ''}`);

                let pedidoCriadoId = "";

                await runTransaction(db, async (transaction) => {
                    const stockUpdates = [];
                    for (const item of s.cart) {
                        const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'estoque', item.id);
                        const prodSnap = await transaction.get(prodRef);
                        if (!prodSnap.exists()) throw new Error(`Produto ${item.nome} indispon√≠vel.`);
                        const currentQty = Number(prodSnap.data().quantidade);
                        if (currentQty < item.qtd) throw new Error(`Estoque insuficiente para ${item.nome}.`);
                        stockUpdates.push({ ref: prodRef, newQty: currentQty - item.qtd });
                    }

                    stockUpdates.forEach(upd => transaction.update(upd.ref, { quantidade: upd.newQty }));
                    
                    const orderRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'));
                    pedidoCriadoId = orderRef.id;
                    
                    transaction.set(orderRef, {
                        clienteId: auth.currentUser.uid,
                        clienteNome: s.profile?.name || auth.currentUser.email?.split('@')[0],
                        items: s.cart.map(i => ({ produto: i.nome, quantidade: i.qtd, precoUn: i.preco, embalagem: i.embalagem })),
                        valorTotal: totalPedido,
                        tipoEntrega: s.checkout.tipoEntrega,
                        enderecoEntrega: finalAddr,
                        status: 'EM SEPARA√á√ÉO', // ‚úÖ REGRA DE NEG√ìCIO: STATUS INICIAL AUTOM√ÅTICO
                        pagamento: {
                            metodo: s.checkout.metodoPagamento,
                            pago: false,
                            pix: s.checkout.metodoPagamento === 'pix_agora' ? { copiaCola: s.pix.copiaCola, keyUsed: s.pix.key } : null
                        },
                        criadoEm: serverTimestamp()
                    });
                });

                if (s.checkout.metodoPagamento === 'pix_agora') {
                    window.state.payingOrder = { id: pedidoCriadoId, valor: totalPedido, pixString: s.pix.copiaCola };
                } else {
                    window.state.view = 'pedidos';
                    alert("Pedido em separa√ß√£o! ü•ö‚ú®");
                }

                window.state.cart = [];
                window.render();
            } catch (e) { alert(e.message); } finally { window.state.processing = false; window.render(); }
        };

        const safeImg = (url) => (url && url.startsWith('data:image')) ? url : "https://via.placeholder.com/300x300?text=AppEgg";

        // --- RENDERIZA√á√ÉO DAS TELAS ---
        window.render = () => {
            const root = document.getElementById('app-root');
            const s = window.state;
            if (s.loading) { root.innerHTML = `<div class="h-screen flex items-center justify-center font-black text-rose-600 animate-pulse text-2xl uppercase italic text-center">AppEgg...</div>`; return; }
            if (!s.user) { root.innerHTML = renderLogin(); return; }

            root.innerHTML = `
                <div class="p-6 max-w-lg mx-auto text-left">
                    <header class="flex justify-between items-center mb-8">
                        <div class="logo-text italic uppercase">AppEgg</div>
                        <div class="bg-slate-100 px-4 py-2 rounded-2xl text-[9px] font-black text-slate-400 uppercase italic">Cliente Platinum</div>
                    </header>
                    ${s.view === 'loja' ? renderLoja() : 
                      s.view === 'carrinho' ? renderCarrinho() : 
                      s.view === 'checkout-endereco' ? renderCheckoutEndereco() : 
                      s.view === 'checkout-novo-endereco' ? renderCheckoutNovoEndereco() : 
                      s.view === 'checkout-pagamento' ? renderCheckoutPagamento() : 
                      s.view === 'pedidos' ? renderPedidos() : 
                      renderPerfil()}
                </div>
                <nav class="nav-bottom">
                    <button onclick="window.setView('loja')" class="nav-item ${s.view==='loja'?'active':''}">Loja</button>
                    <button onclick="window.setView('carrinho')" class="nav-item ${s.view==='carrinho'?'active':''} relative">${s.cart.length > 0 ? `<span class="absolute -top-1 right-2 bg-rose-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-[#0f172a]">${s.cart.reduce((a,b)=>a+b.qtd,0)}</span>` : ''}Carrinho</button>
                    <button onclick="window.setView('pedidos')" class="nav-item ${s.view==='pedidos'?'active':''}">Meus Pedidos</button>
                    <button onclick="window.setView('perfil')" class="nav-item ${s.view==='perfil'?'active':''}">Perfil</button>
                </nav>
                ${s.payingOrder ? renderPixModal() : ''}
            `;
        };

        function renderLoja() { return `<div class="space-y-6 text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase">Ovos Frescos</h2><div class="grid gap-6">${window.state.produtos.map(p => `<div class="card-egg flex items-center gap-6 shadow-sm"><div class="w-24 h-24 bg-slate-50 rounded-[32px] overflow-hidden flex items-center justify-center text-center"><img src="${safeImg(p.foto_url)}" class="w-full h-full object-cover"></div><div class="flex-1 text-left"><h3 class="font-black text-xs uppercase text-slate-800 leading-none mb-1 text-left">${p.nome}</h3><p class="text-slate-400 text-[10px] font-bold uppercase mb-2 text-left">${p.embalagem}</p><p class="text-rose-600 font-[950] text-2xl tracking-tighter italic text-left leading-none">R$ ${Number(p.preco).toFixed(2)}</p></div><button onclick="window.addToCart('${p.id}')" class="btn-add-fast shadow-lg shadow-rose-200 text-center">+</button></div>`).join('')}</div></div>${window.state.cart.length > 0 ? `<div class="fixed bottom-32 left-8 right-8 z-[150] animate-bounce text-center"><button onclick="window.setView('carrinho')" class="btn-main flex items-center justify-center gap-3 shadow-2xl">Ir para o Carrinho (R$ ${window.state.cart.reduce((a,b)=>a+(b.preco*b.qtd),0).toFixed(2)})</button></div>` : ''}`; }
        function renderCarrinho() { const total = window.state.cart.reduce((acc, item) => acc + (item.preco * item.qtd), 0); return `<div class="space-y-8 fade-in text-left text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left text-left">Seu Carrinho</h2>${window.state.cart.length === 0 ? `<div class="py-20 text-center"><p class="text-slate-300 font-black uppercase text-xs mb-8">Carrinho Vazio</p><button onclick="window.setView('loja')" class="btn-main">Voltar √† Loja</button></div>` : `<div class="space-y-4 text-left">${window.state.cart.map(item => `<div class="bg-white p-6 rounded-[32px] border flex items-center gap-4 text-left"><div class="w-16 h-16 rounded-2xl overflow-hidden text-center"><img src="${safeImg(item.foto_url)}" class="w-full h-full object-cover"></div><div class="flex-1 text-left"><h4 class="font-black uppercase text-[11px] text-slate-800 leading-tight text-left">${item.nome}</h4><p class="text-rose-600 font-black text-sm mt-1 text-left">R$ ${Number(item.preco).toFixed(2)}</p></div><div class="flex items-center gap-3 bg-slate-50 p-2 rounded-2xl text-center"><button onclick="window.updateCartQtd('${item.id}', -1)" class="w-8 h-8 bg-white rounded-xl font-bold border shadow-sm text-center">-</button><span class="font-black text-sm text-center">${item.qtd}</span><button onclick="window.updateCartQtd('${item.id}', 1)" class="w-8 h-8 bg-white rounded-xl font-bold border shadow-sm text-center">+</button></div></div>`).join('')}</div><div class="p-8 bg-slate-900 rounded-[40px] text-white text-center"><h3 class="text-4xl font-[950] mb-8 text-center italic tracking-tighter">R$ ${total.toFixed(2)}</h3><div class="grid gap-3"><button onclick="window.setView('checkout-endereco')" class="btn-main !bg-white !text-rose-600 text-center">Finalizar Compra</button><button onclick="window.setView('loja')" class="w-full py-4 text-white/50 font-black text-[10px] uppercase italic text-center">Continuar Comprando</button></div></div>`}</div>`; }
        function renderCheckoutEndereco() { const addr = window.state.profile?.address; return `<div class="space-y-8 fade-in text-left text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left text-left">Onde entregar?</h2><div class="space-y-4 text-left"><div class="option-card ${window.state.checkout.tipoEntrega==='entrega'&&!window.state.checkout.endereco?'active':''}" onclick="window.state.checkout.tipoEntrega='entrega';window.state.checkout.endereco=null;window.render()"><p class="text-[10px] font-black text-rose-600 uppercase mb-2 italic">Principal</p><p class="font-bold text-sm text-left">${addr?`${addr.rua}, ${addr.numero}`:'A carregar...'}</p></div><div class="option-card ${window.state.checkout.endereco?'active':''}" onclick="window.state.view='checkout-novo-endereco';window.render()"><p class="font-bold text-sm text-left">+ Outro Endere√ßo</p></div><div class="option-card ${window.state.checkout.tipoEntrega==='retirada'?'active':''}" onclick="window.state.checkout.tipoEntrega='retirada';window.render()"><p class="text-[10px] font-black text-rose-600 uppercase mb-2 italic">Retirada</p><p class="font-bold text-sm text-left text-left">${DISTRIBUIDORA_ENDERECO}</p></div></div><button onclick="window.setView('checkout-pagamento')" class="btn-main mt-8 italic text-center text-center">Pr√≥ximo: Pagamento</button></div>`; }
        function renderCheckoutNovoEndereco() { return `<div class="space-y-8 fade-in text-left text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left text-left text-left">Novo Endere√ßo</h2><form onsubmit="window.handleSaveCheckoutAddress(event)" class="space-y-4 text-left"><input name="rua" placeholder="Rua" class="input-egg text-left" required><input name="numero" placeholder="N¬∫" class="input-egg text-left" required><input name="bairro" placeholder="Bairro" class="input-egg text-left" required><input name="cep" placeholder="CEP" class="input-egg text-left" oninput="window.maskCEP(this)" required><button class="btn-main mt-4 text-center">Usar Este</button><button type="button" onclick="window.setView('checkout-endereco')" class="w-full py-4 text-slate-400 font-black text-[10px] uppercase italic text-center text-center">Cancelar</button></form></div>`; }

        function renderCheckoutPagamento() {
            const s = window.state;
            const methods = [ { id: 'pix_agora', label: 'PIX (Antecipado)', icon: 'üì±' }, { id: 'pix_retirada', label: 'PIX (Na Retirada)', icon: 'üè™' }, { id: 'dinheiro_retirada', label: 'Dinheiro (Na Retirada)', icon: 'üíµ' }, { id: 'dinheiro_entrega', label: 'Dinheiro (Entrega)', icon: 'üè†' } ];
            return `<div class="space-y-8 fade-in text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left">Pagamento</h2><div class="space-y-3 text-left">${methods.map(m => `<div class="option-card ${s.checkout.metodoPagamento === m.id ? 'active' : ''}" onclick="window.state.checkout.metodoPagamento='${m.id}';window.render()"><div class="flex items-center gap-4 text-left"><span class="text-2xl text-center">${m.icon}</span><span class="font-black text-xs uppercase text-left">${m.label}</span></div></div>`).join('')}</div>${s.checkout.metodoPagamento === 'pix_agora' ? `<div class="pix-box fade-in text-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 italic text-center text-center">Chave PIX (${s.pix.type})</p><div class="bg-white p-4 rounded-2xl border-2 border-rose-100 font-bold text-slate-800 break-all mb-4 text-center text-center">${s.pix.key || 'Chave a carregar...'}</div><p class="text-[9px] text-slate-400 uppercase font-bold italic mb-4">Pague agora para agilizar o envio!</p></div>` : ''}<div class="p-8 bg-emerald-600 rounded-[40px] text-white mt-10 text-center text-center"><p class="text-white/60 text-[10px] font-black uppercase text-center">Total</p><h3 class="text-4xl font-[950] mb-8 text-center italic tracking-tighter text-center">R$ ${s.cart.reduce((a,b)=>a+(b.preco*b.qtd),0).toFixed(2)}</h3><button onclick="window.handleFinalizeOrder()" ${s.processing?'disabled':''} class="w-full bg-white text-emerald-600 py-6 rounded-[28px] font-black uppercase text-xs shadow-xl text-center">${s.processing ? 'A PROCESSAR...' : 'Confirmar Pedido'}</button></div></div>`;
        }

        // ‚úÖ MODAL DE PAGAMENTO PIX (Acesso seguro aos dados)
        function renderPixModal() {
            const po = window.state.payingOrder;
            const pixStr = po.pixString || window.state.pix.copiaCola;
            return `
                <div class="fixed inset-0 bg-slate-900/95 backdrop-blur-xl z-[1000] flex items-center justify-center p-4">
                    <div class="bg-white w-full max-w-sm p-8 rounded-[48px] shadow-2xl animate-in zoom-in duration-300 max-h-[90vh] overflow-y-auto no-scrollbar text-center">
                        <h2 class="text-2xl font-black uppercase italic tracking-tighter text-slate-900 mb-6 text-center">Pagamento PIX</h2>
                        <div class="card-egg mb-4 text-center border-2 border-slate-50">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 block">Op√ß√£o 1: QR Code</label>
                            <div class="qr-container mx-auto mb-2"><img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pixStr)}" class="w-48 h-48"></div>
                        </div>
                        <div class="card-egg mb-6 border-2 border-slate-50">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block text-center">Op√ß√£o 2: Copia e Cola</label>
                            <textarea readonly class="w-full p-4 bg-slate-50 rounded-2xl text-[10px] font-bold text-slate-600 border-none resize-none h-24 mb-3">${pixStr}</textarea>
                            <button onclick="window.copyPixCopiaCola('${pixStr}')" class="w-full py-4 bg-rose-50 text-rose-600 rounded-2xl font-black text-[10px] uppercase">Copiar c√≥digo PIX</button>
                        </div>
                        <div class="space-y-4">
                            <button onclick="window.confirmarPagamentoPix('${po.id}')" class="w-full py-6 bg-emerald-600 text-white rounded-[32px] font-black text-xs uppercase shadow-xl active:scale-95 text-center">J√° Realizei o Pagamento</button>
                            <button onclick="window.setView('pedidos')" class="w-full py-4 text-slate-300 font-bold text-[10px] uppercase text-center">Pagar mais tarde</button>
                        </div>
                    </div>
                </div>`;
        }

        function renderPedidos() {
            const s = window.state;
            const filtered = s.pedidos.filter(p => {
                const status = (p.status || '').toUpperCase();
                let ms = false;
                if (s.ordersFilter === 'aberto') ms = !['FINALIZADO', 'CANCELADO', 'PIX_PAGO'].includes(status);
                else if (s.ordersFilter === 'finalizado') ms = status === 'FINALIZADO' || status === 'PIX_PAGO';
                else if (s.ordersFilter === 'cancelado') ms = status === 'CANCELADO';
                let md = true; if (s.ordersDate && p.criadoEm) { const d = new Date(p.criadoEm.seconds * 1000).toISOString().split('T')[0]; md = d === s.ordersDate; }
                return ms && md;
            });
            return `<div class="space-y-6 text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left">Meus Pedidos</h2><div class="space-y-4 text-left"><div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 text-left text-left"><button onclick="window.state.ordersFilter='aberto';window.render()" class="btn-filter ${s.ordersFilter==='aberto'?'active':''}">Em Aberto</button><button onclick="window.state.ordersFilter='finalizado';window.render()" class="btn-filter ${s.ordersFilter==='finalizado'?'active':''}">Finalizados</button><button onclick="window.state.ordersFilter='cancelado';window.render()" class="btn-filter ${s.ordersFilter==='cancelado'?'active':''}">Cancelados</button></div><div class="flex flex-col gap-1 text-left"><label class="text-[9px] font-black uppercase text-slate-400 ml-2 italic text-left text-left text-left">Filtrar por data:</label><input type="date" value="${s.ordersDate}" onchange="window.state.ordersDate=this.value;window.render()" class="input-egg !py-3 text-xs text-left"></div></div><div class="space-y-4 text-left text-left">${filtered.map(p => { 
                const dO = p.criadoEm ? new Date(p.criadoEm.seconds * 1000) : new Date();
                const hourStr = dO.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const itemsStr = p.items ? p.items.map(i => `${i.quantidade}x ${i.produto}`).join(', ') : `${p.quantidade}x ${p.produto}`;
                const isPaid = p.status === 'PIX_PAGO';
                const pixStr = p.pagamento?.pix?.copiaCola || window.state.pix.copiaCola;
                return `<div class="bg-white p-6 rounded-[48px] border-t-[12px] ${p.status === 'CANCELADO' ? 'border-slate-300' : (isPaid ? 'border-emerald-500' : 'border-rose-500')} shadow-sm text-left"><div class="flex justify-between items-start mb-4 text-left text-left text-left text-left"><div class="flex-1 text-left">
                    <h4 class="font-black uppercase text-[11px] text-slate-800 leading-tight text-left">${itemsStr}</h4>
                    <p class="text-[9px] font-bold text-slate-400 uppercase mt-1 text-left text-left">${dO.toLocaleDateString()} √†s ${hourStr}</p></div>
                    <span class="bg-rose-50 text-rose-600 px-4 py-2 rounded-full font-black text-[12px] uppercase italic text-center min-w-[120px] shadow-sm">${p.status}</span></div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-center text-left">
                    <p class="text-rose-600 font-[950] text-3xl tracking-tighter italic text-left leading-none text-left">R$ ${Number(p.valorTotal).toFixed(2)}</p>
                    <div class="flex gap-2">
                        ${(p.metodoPagamento === 'pix_agora' && !isPaid && p.status !== 'CANCELADO') ? `<button onclick="window.state.payingOrder={id:'${p.id}', valor:${p.valorTotal}, pixString:'${pixStr}'};window.render()" class="bg-emerald-600 text-white px-5 py-2.5 rounded-2xl font-black text-[9px] uppercase tracking-widest active:scale-95 text-center">Pagar Agora</button>` : ''}
                        ${(p.status === 'FINALIZADO' || isPaid) ? `<button onclick="window.repeatOrder('${p.id}')" class="bg-slate-900 text-white px-5 py-2.5 rounded-2xl font-black text-[9px] uppercase tracking-widest active:scale-95 text-center">Repetir Pedido</button>` : ''}
                    </div></div></div>`; 
            }).join('') || '<div class="py-20 text-center text-center"><p class="font-black text-slate-200 uppercase tracking-widest text-xs italic text-center text-center text-center">Sem pedidos.</p></div>'}</div></div>`; 
        }

        function renderPerfil() {
            const p = window.state.profile;
            const mode = window.state.profileMode;
            if (mode === 'edit') return renderEditPerfil();
            if (mode === 'password') return renderChangePassword();
            return `<div class="space-y-8 fade-in text-left text-left text-left text-left"><div class="flex justify-between items-center text-left text-left text-left text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left">Meu Perfil</h2><button onclick="window.state.profileMode='edit';window.render()" class="text-rose-600 font-black text-[10px] uppercase underline italic text-left text-left text-left">Editar Dados</button></div><div class="bg-white p-8 rounded-[40px] shadow-sm border space-y-6 text-left text-left">
                <div><p class="text-label-red">Nome Completo</p><p class="font-bold text-slate-800 uppercase text-left">${p?.name || 'N√£o informado'}</p></div>
                <div><p class="text-label-red">Documento (CPF/CNPJ)</p><p class="font-bold text-slate-800 text-left text-left">${p?.doc || 'N/A'}</p></div>
                <div><p class="text-label-red">WhatsApp</p><p class="font-bold text-slate-800 text-left text-left text-left text-left text-left">${p?.phone || 'N/A'}</p></div>
                <div><p class="text-label-red">E-mail</p><p class="font-bold text-slate-800 text-left text-left text-left text-left text-left text-left">${window.state.user.email}</p></div>
                <div class="border-t pt-6 text-left text-left text-left text-left text-left text-left text-left text-left"><p class="text-label-red mb-3">Endere√ßo Principal</p>
                <p class="font-bold text-slate-800 text-left text-left text-left text-left text-left">${p?.address ? `${p.address.rua}, ${p.address.numero}` : 'Sem endere√ßo'}</p>
                <p class="text-sm text-slate-500 text-left text-left text-left text-left text-left text-left text-left">${p?.address ? `${p.address.bairro} - ${p.address.cidade}` : ''}</p><p class="text-[11px] font-bold text-slate-400 mt-1 text-left text-left">${p?.address?.cep ? `CEP: ${p.address.cep}` : ''}</p></div></div>
                <div class="grid grid-cols-1 gap-3 text-center text-center text-center text-center text-center text-center text-center text-center"><button onclick="window.state.profileMode='password';window.render()" class="w-full py-5 rounded-[28px] font-black text-slate-500 bg-slate-100 uppercase text-[10px] tracking-widest text-center text-center text-center text-center">Alterar Senha</button><button onclick="signOut(auth)" class="w-full py-5 rounded-[28px] font-black text-rose-600 bg-rose-50 uppercase text-[10px] tracking-widest text-center text-center text-center text-center text-center text-center text-center text-center">Sair da Conta</button></div></div>`;
        }

        function renderEditPerfil() {
            const p = window.state.profile;
            return `<div class="space-y-8 fade-in text-left text-left text-left text-left text-left text-left text-left text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left text-left text-left text-left text-left text-left">Editar Perfil</h2><form onsubmit="window.handleUpdateProfile(event)" class="space-y-4 text-left text-left text-left text-left text-left text-left text-left text-left text-left"><input name="name" value="${p?.name || ''}" placeholder="Nome" class="input-egg text-left text-left" required><input name="doc" value="${p?.doc || ''}" placeholder="CPF/CNPJ" class="input-egg text-left text-left" oninput="window.maskDoc(this)" required><input name="phone" value="${p?.phone || ''}" placeholder="WhatsApp" class="input-egg text-left text-left text-left text-left text-left" oninput="window.maskTel(this)" required><div class="border-t pt-4 text-left text-left text-left text-left"></div><input name="rua" value="${p?.address?.rua || ''}" placeholder="Rua" class="input-egg text-left text-left text-left text-left text-left" required><input name="numero" value="${p?.address?.numero || ''}" placeholder="N¬∫" class="input-egg text-left text-left text-left text-left text-left" required><input name="bairro" value="${p?.address?.bairro || ''}" placeholder="Bairro" class="input-egg text-left text-left text-left text-left text-left" required><input name="cep" value="${p?.address?.cep || ''}" placeholder="CEP" class="input-egg text-left text-left text-left text-left text-left" oninput="window.maskCEP(this)" required><input name="cidade" value="${p?.address?.cidade || ''}" placeholder="Cidade" class="input-egg text-left text-left text-left text-left text-left text-left" required><input name="estado" value="${p?.address?.estado || ''}" placeholder="UF" maxlength="2" class="input-egg uppercase text-left text-left text-left text-left text-left text-left text-left" required><button class="btn-main mt-4 text-center text-center text-center text-center text-center">Salvar Altera√ß√µes</button><button type="button" onclick="window.setView('perfil')" class="w-full py-4 text-slate-400 font-black text-[10px] uppercase text-center text-center text-center text-center text-center text-center">Cancelar</button></form></div>`;
        }

        function renderChangePassword() { return `<div class="space-y-8 fade-in text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left text-left text-left text-left text-left text-left text-left text-left text-left">Alterar Senha</h2><form onsubmit="window.handleUpdatePassword(event)" class="space-y-4 text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center"><input type="password" id="newPass" placeholder="Nova Senha" class="input-egg text-center font-bold text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center" required minlength="6"><button class="btn-main mt-6 italic text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center">Confirmar Nova Senha</button><button type="button" onclick="window.setView('perfil')" class="w-full py-4 text-slate-400 font-black text-[10px] uppercase text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center">Voltar</button></form></div>`; }
        function renderLogin() { return `<div class="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center"><h1 class="text-6xl font-[950] text-rose-600 italic uppercase tracking-tighter mb-12 text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center">AppEgg</h1><form onsubmit="window.handleLogin(event)" class="w-full max-w-sm space-y-4 text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center"><input id="le" type="email" value="teste@lojista.com.br" class="input-egg text-center font-bold text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center" required><input id="lp" type="password" placeholder="Sua Senha" class="input-egg text-center font-bold text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center" required><button class="btn-main mt-6 active:scale-95 italic text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center text-center">Entrar na Loja</button></form></div>`; }

        onAuthStateChanged(auth, async (u) => {
            window.state.user = u;
            if (u) {
                onSnapshot(doc(db, 'artifacts', appId, 'users', u.uid, 'profiles', 'main'), (snap) => { if (snap.exists()) { window.state.profile = snap.data(); window.render(); } });
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), (snap) => { 
                    if (snap.exists()) { 
                        window.state.pix = snap.data(); 
                        window.render(); 
                    } 
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'estoque'), s => { window.state.produtos = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")); window.state.loading = false; window.render(); });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), s => { window.state.pedidos = s.docs.map(d => ({id: d.id, ...d.data()})).filter(p => p.clienteId === u.uid).sort((a,b)=>(b.criadoEm?.seconds||0)-(a.criadoEm?.seconds||0)); window.render(); });
            } else { window.state.loading = false; window.render(); }
        });
    </script>
</body>
</html>