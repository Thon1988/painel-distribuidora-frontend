<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">App Ovos Aline</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      /* Identidade App Ovos Aline (Rose & Slate) */
      --primary: #e11d48; /* Rose 600 */
      --dark:    #be123c; /* Rose 700 */
      --cream:   #f8fafc; /* Slate 50 */
      --brown:   #0f172a; /* Slate 900 */
      --muted:   #64748b; /* Slate 500 */
      --white:   #ffffff;
      --green:   #10b981; /* Emerald 500 */
      --border:  #e2e8f0;
      --shadow:  0 10px 30px rgba(15, 23, 42, 0.08);
    }
    body { font-family:'Inter', system-ui, sans-serif; background:var(--cream); color:var(--brown); min-height:100vh; overflow-x: hidden; }

    /* HEADER */
    header {
      background: var(--white);
      color: var(--brown); padding:0 20px; height:76px;
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    }
    .logo-wrap { display:flex; align-items:center; gap:12px; }
    .logo-icon { background: var(--cream); color: var(--primary); border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; font-size:1.4rem; border: 2px solid #f1f5f9; }
    .logo-text strong { font-size:1.2rem; font-weight:900; color: var(--primary); display:block; letter-spacing: -0.5px; }
    .logo-text span   { font-size:.7rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    
    .cart-btn {
      background: var(--brown); color:#fff; border: none;
      border-radius:50px; padding:8px 18px; cursor:pointer;
      font-size:.9rem; font-weight:700; display:flex; align-items:center; gap:8px; transition:all .2s;
      box-shadow: 0 4px 12px rgba(15,23,42,0.15);
    }
    .badge { background:var(--primary); color:#fff; border-radius:50%; width:22px; height:22px; font-size:.7rem; font-weight:800; display:flex; align-items:center; justify-content:center; }

    /* HERO */
    .hero {
      background: linear-gradient(150deg, var(--dark) 0%, var(--primary) 60%, #fda4af 100%);
      text-align:center; padding:45px 20px 55px; position:relative; overflow:hidden; color: #fff;
    }
    .hero h1 { font-size:clamp(1.8rem, 5vw, 2.8rem); font-weight:900; line-height:1.1; letter-spacing: -1px; }
    .hero p  { margin-top:12px; font-size:1rem; opacity: 0.9; max-width:450px; margin-inline:auto; font-weight: 500; }

    /* CATALOGO */
    main { padding:30px 20px 80px; max-width:1100px; margin:0 auto; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:24px; }
    .card { background:var(--white); border-radius:24px; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; transition:transform .3s; border:1px solid var(--border); }
    .card:hover { transform:translateY(-8px); border-color: #cbd5e1; }
    .card-img { background:#f1f5f9; display:flex; align-items:center; justify-content:center; height:140px; font-size:4rem; position:relative; overflow:hidden;}
    .card-img img { width:100%; height:100%; object-fit:cover; }
    .pill { position:absolute; top:12px; right:12px; background:var(--primary); color:#fff; font-size:.65rem; font-weight:800; border-radius:50px; padding:4px 10px; text-transform:uppercase; }
    
    .card-body { padding:20px; flex:1; display:flex; flex-direction:column; gap:4px; }
    .card-body h3 { font-size:1.1rem; font-weight:800; color: var(--brown); }
    .card-price { font-size:1.3rem; font-weight:900; color:var(--brown); margin-top:10px; }
    
    .qty-row { display:flex; align-items:center; gap:10px; margin-top:15px; }
    .qty-btn { width:34px; height:34px; border-radius:10px; border:2px solid var(--border); background:transparent; font-size:1.1rem; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .add-btn { flex:1; background:var(--primary); color:#fff; border:none; border-radius:10px; padding:10px; font-size:.85rem; font-weight:800; cursor:pointer; text-transform: uppercase; }

    /* SIDEBAR */
    .overlay { position:fixed; inset:0; background:rgba(15,23,42,.6); backdrop-filter: blur(2px); z-index:200; display:none; opacity:0; transition:opacity .3s; }
    .overlay.open { display:block; opacity:1; }
    .sidebar { position:fixed; top:0; right:-450px; bottom:0; width:min(420px,100vw); background:var(--white); z-index:201; display:flex; flex-direction:column; transition:right .35s cubic-bezier(.4,0,.2,1); box-shadow:-10px 0 40px rgba(0,0,0,.1); }
    .sidebar.open { right:0; }
    .sb-header { padding:20px 24px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .close-x { background:#f1f5f9; border:none; color:var(--brown); width:32px; height:32px; border-radius:50%; font-size:0.9rem; font-weight: bold; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    
    .cart-items { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px; }
    .ci { display:flex; gap:15px; align-items:center; border-bottom: 1px solid #f8fafc; padding-bottom:15px; }
    .ci-info { flex:1; }
    .qty-controls { display:flex; align-items:center; gap:10px; margin-top:4px; }
    .qty-controls button { width:24px; height:24px; border-radius:6px; border:1px solid #ddd; background:none; font-weight:900; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .ci-price { font-size:.95rem; font-weight:900; color:var(--primary); }

    .sb-footer { padding:20px 24px; border-top:1px solid var(--border); background: #fcfcfc; }
    .total-row { display:flex; justify-content:space-between; font-size:1.2rem; font-weight:900; margin-bottom:15px; }
    .checkout-btn { width:100%; background:linear-gradient(135deg,var(--primary),var(--dark)); color:#fff; border:none; border-radius:14px; padding:16px; font-size:1rem; font-weight:800; cursor:pointer; text-transform: uppercase; }
    .checkout-btn:disabled { opacity:.4; pointer-events:none; }

    /* MODAIS */
    .mbk { position:fixed; inset:0; background:rgba(15,23,42,.7); backdrop-filter: blur(4px); z-index:300; display:none; align-items:center; justify-content:center; padding:20px; }
    .mbk.open { display:flex; }
    .modal { background:var(--white); border-radius:28px; width:100%; max-width:460px; max-height:92vh; overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.2); position: relative; }
    
    .close-modal-x {
      position: absolute; top: 15px; right: 15px;
      background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3);
      color: #fff; width: 32px; height: 32px; border-radius: 50%;
      font-size: 0.9rem; font-weight: bold; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 20; transition: transform 0.2s;
    }
    .close-modal-x:hover { transform: rotate(90deg); background: rgba(255,255,255,0.3); }
    .close-modal-x.dark { color: var(--brown); border-color: #ddd; background: #f8fafc; }

    .checkout-top { background:linear-gradient(135deg,var(--primary) 0%,var(--dark) 100%); padding:25px; border-radius:28px 28px 0 0; color:#fff; text-align:center; }
    .modal-body { padding:25px; display:flex; flex-direction:column; align-items:center; gap:18px; }
    .form-input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; font-size: .9rem; font-weight: 700; outline: none; background: #f8fafc; }
    .form-input:focus { border-color: var(--primary); background: #fff; }
    
    .btn-ghost { background:transparent; border:2px solid var(--border); color:var(--muted); cursor:pointer; font-weight:800; padding: 14px; border-radius: 12px; width: 100%; display: flex; align-items:center; justify-content:center; gap:6px; margin-top:5px; }

    .success { position:fixed; inset:0; background:var(--white); z-index:400; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:30px; }
    .success.open { display:flex; }
    .order-box { margin-top:20px; background:linear-gradient(135deg,var(--primary),var(--dark)); color:#fff; border-radius:18px; padding:15px 35px; font-size:1.6rem; font-weight:900; letter-spacing:3px; }
    
    .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--brown); color:#fff; padding:12px 25px; border-radius:50px; font-size:.9rem; font-weight:700; z-index:600; transition:transform .4s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .toast.show { transform:translateX(-50%) translateY(0); }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .animate-pulse { animation: pulse 2s infinite; }
    
    footer { text-align:center; padding:24px; font-size:.85rem; font-weight: 600; color:var(--muted); border-top:1px solid var(--border); margin-top: 20px; }
  </style>
</head>
<body>

<header>
  <div class="logo-wrap"><div class="logo-icon" id="h-emoji">ü•ö</div><div class="logo-text"><strong id="h-name">App Ovos Aline</strong><span id="h-slogan">A carregar...</span></div></div>
  <button class="cart-btn" onclick="window.toggleCart()">üõí <span class="badge" id="cart-count">0</span></button>
</header>

<div class="hero"><h1 id="hero-title">Ovos Fresquinhos</h1><p id="hero-desc">Qualidade granja.</p></div>

<main>
  <h2 class="section-title">üõí Cat√°logo de Produtos</h2>
  <div class="grid" id="product-grid">
      <div id="loader-msg" style="grid-column: 1/-1; text-align:center; padding:50px; color:var(--primary); font-weight:900; font-size:1.2rem;" class="animate-pulse">A carregar cat√°logo da granja...</div>
  </div>
</main>

<footer id="footer-text">¬© 2026 App Ovos Aline ¬∑ Todos os direitos reservados</footer>

<div class="overlay" id="overlay" onclick="window.closeAll()"></div>

<div class="sidebar" id="sidebar">
  <div class="sb-header">
    <h3>üõí O seu Carrinho</h3>
    <button class="close-x" onclick="window.closeAll()">‚úï</button>
  </div>
  <div id="cart-items" class="cart-items"></div>
  <div class="sb-footer">
    <div class="total-row"><span>Total</span><span id="cart-total" style="color:var(--primary)">R$ 0,00</span></div>
    <button class="checkout-btn" id="checkout-btn" onclick="window.openCheckout()" disabled>Finalizar Encomenda</button>
  </div>
</div>

<div class="mbk" id="checkout-modal">
  <div class="modal">
    <div class="checkout-top">
      <button class="close-modal-x" onclick="window.closeAll()">‚úï</button>
      <div style="font-size:2.8rem; line-height:1; margin-bottom: 8px;">üõçÔ∏è</div>
      <h3>Finalizar Pedido</h3>
      <p>Dados para a entrega ou recolha</p>
    </div>
    <div class="modal-body">
      <div style="display:flex; gap:10px; width:100%; background:#f1f5f9; padding:5px; border-radius:15px">
        <button class="dt-btn" id="btn-retirada" style="flex:1; border:none; padding:10px; border-radius:10px; cursor:pointer; font-weight:800; background:white" onclick="window.setDelivery('retirada')">üè™ Retirar</button>
        <button class="dt-btn" id="btn-entrega" style="flex:1; border:none; padding:10px; border-radius:10px; cursor:pointer; font-weight:800; background:none" onclick="window.setDelivery('entrega')">üöö Entregar</button>
      </div>

      <div class="checkout-section" style="width:100%">
        <input type="text" id="cli-nome" placeholder="O seu Nome Completo" class="form-input">
        <input type="tel" id="cli-tel" placeholder="Telem√≥vel / WhatsApp" class="form-input" style="margin-top:10px">
      </div>

      <div id="info-retirada" class="checkout-section" style="width:100%">
        <div style="background:#fff1f2; padding:15px; border-radius:12px; font-size:0.85rem; border: 1px solid #fda4af;">
          Local: <strong>Rua Ant√≥nio Freire da Silva, n¬∞ 87</strong>, Jardim das Camelias - SP.
        </div>
      </div>

      <div id="info-entrega" class="checkout-section" style="display:none; width:100%">
          <input type="text" id="cli-rua" placeholder="Rua / Avenida" class="form-input">
          <div style="display:flex; gap:10px; margin-top:10px">
              <input type="text" id="cli-num" placeholder="N√∫mero" class="form-input" style="width:100px">
              <input type="text" id="cli-bairro" placeholder="Bairro" class="form-input">
          </div>
      </div>

      <div class="checkout-section" style="width:100%">
        <label style="font-size: 0.7rem; font-weight: 800; color: var(--muted); margin-bottom: 5px; display: block; text-transform: uppercase;">M√©todo de Pagamento</label>
        <select id="pagamento-select" class="form-input" style="background:#f8fafc">
            <option value="pix_online">PIX Online (Pagar Agora)</option>
            <option value="dinheiro">Dinheiro na Entrega</option>
            <option value="cartao">Cart√£o na Entrega</option>
        </select>
      </div>

      <div style="width:100%; display:flex; flex-direction:column; gap:8px">
          <button class="checkout-btn" onclick="window.processCheckout()" style="background:var(--green)">‚úÖ Confirmar Pedido (<span id="chk-btn-total">R$ 0,00</span>)</button>
          <button class="btn-ghost" onclick="window.backToCart()">‚¨ÖÔ∏è Voltar para o Carrinho</button>
      </div>
    </div>
  </div>
</div>

<div class="mbk" id="pix-modal">
  <div class="modal" style="text-align:center">
    <div class="modal-top pix-top" style="background:var(--green); color:#fff; padding:25px; border-radius:28px 28px 0 0; position: relative;">
      <button class="close-modal-x" onclick="window.closeAll()">‚úï</button>
      <h3 style="font-weight:900">Pagamento PIX</h3>
      <p style="font-size:0.85rem">Escaneie o c√≥digo ou copie a chave abaixo</p>
    </div>
    <div class="modal-body">
      <div id="qrcode" style="background:#fff; padding:15px; border:1px solid #eee; border-radius:15px; display: inline-block;"></div>
      <div id="pix-code-box" style="background:#f1f5f9; padding:18px; border-radius:12px; font-size:0.7rem; word-break:break-all; cursor:pointer; font-family: monospace; border: 2px dashed #cbd5e1; font-weight:800" onclick="window.doCopy()">A gerar c√≥digo...</div>
      <div style="width:100%; display:flex; flex-direction:column; gap:10px">
          <button class="checkout-btn" style="background:var(--brown)" onclick="window.saveOrderToFirebase()">‚úÖ J√° Paguei ‚Äî Confirmar Pedido</button>
          <button class="btn-ghost" onclick="window.backToCheckout()">‚¨ÖÔ∏è Alterar M√©todo de Pagamento</button>
      </div>
    </div>
  </div>
</div>

<div class="success" id="success">
  <button class="close-modal-x dark" onclick="window.location.reload()">‚úï</button>
  <div style="font-size:5rem">üéâ</div>
  <h2 style="font-weight:900">Pedido Registrado!</h2>
  <p style="color:var(--muted); margin:10px 0">N¬∫ do pedido: <strong id="order-num">#000000</strong></p>
  <button class="checkout-btn" style="background:#10b981; max-width:280px" onclick="window.sendWhatsApp()">üì≤ Avisar no WhatsApp</button>
  <button class="btn-ghost" style="margin-top:15px; max-width:200px" onclick="window.location.reload()">üõí Novo Pedido</button>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// --- UTILIT√ÅRIOS ---
window.fmt = n => Number(n || 0).toFixed(2).replace('.',',');

window.toast = (msg) => {
    const t = document.getElementById('toast'); if(!t) return;
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
};

window.generateUUID = () => {
    if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16);
    });
};

window.removeAccents = (s) => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\x00-\x7F]/g,'').toUpperCase();

window.crc16 = (s) => {
    let c = 0xFFFF;
    for (let i = 0; i < s.length; i++) {
        c ^= (s.charCodeAt(i) & 0xFF) << 8;
        for (let j = 0; j < 8; j++) c = (c & 0x8000) ? ((c << 1) ^ 0x1021) & 0xFFFF : (c << 1) & 0xFFFF;
    }
    return (c & 0xFFFF).toString(16).toUpperCase().padStart(4,'0');
};

window.pixPayload = (key, amount, name, city, txid) => {
    const tlv = (id, v) => id + String(v.length).padStart(2,'0') + v;
    const ma = tlv('00','BR.GOV.BCB.PIX') + tlv('01', key);
    let p = tlv('00','01') + tlv('26', ma) + tlv('52','0000') + tlv('53','986') + tlv('54', Number(amount).toFixed(2)) + tlv('58','BR') + tlv('59', window.removeAccents(name).slice(0,25)||'LOJA') + tlv('60', window.removeAccents(city).slice(0,15)||'BR') + tlv('62', tlv('05', window.removeAccents(txid).slice(0,25)||'TESTE'));
    return p + tlv('63', window.crc16(p + '6304'));
};

// --- CONFIGURA√á√ÉO FIREBASE FIXA E PADRONIZADA ---
// Configura√ß√£o absoluta para garantir que a loja escreve no mesmo local onde o Admin l√™
const firebaseConfig = {
    apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
    authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
    projectId: "distribuidora-de-ovos-aline",
    storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
    messagingSenderId: "92187548716",
    appId: "1:92187548716:web:d61d18a29aa76aead7c589"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const auth = getAuth(appFB);

// PADRONIZA√á√ÉO DA APP ID (Obriga a loja a gravar na cole√ß√£o certa)
const appId = 'app-egg-pro-transacional';

const FALLBACK_PRODS = [
    { id: 'f1', nome: 'Ovos Brancos M√©dios', preco: 10.90, embalagem: 'D√∫zia (12)', ativo: true, emoji: 'ü•ö' },
    { id: 'f2', nome: 'Ovos Brancos Grandes', preco: 12.90, embalagem: 'D√∫zia (12)', ativo: true, emoji: 'ü•ö' },
    { id: 'f3', nome: 'Ovos Caipira', preco: 18.90, embalagem: 'D√∫zia (12)', ativo: true, emoji: 'üêì' }
];

window.produtosFirebase = null; // null = carregando
window.carrinho = {};
window.pix_config = { rawKey: '11983454007', nomeRecebedor: 'App Ovos Aline', cidade: 'SAO PAULO' };
window.configuracoes_loja = { nome: 'App Ovos Aline', emoji: 'ü•ö', slogan: 'Qualidade Garantida', whatsapp: '11985706243', corPrimaria: '#e11d48', corSecundaria: '#be123c' };

window.getProdutos = () => window.produtosFirebase || FALLBACK_PRODS;

// --- AUTH LOGIC ---
async function initAuth() {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
                await signInWithCustomToken(auth, __initial_auth_token);
                return;
            } catch(e) { 
                console.warn("Token mismatch detetado. A tentar login an√≥nimo...");
            }
        }
        await signInAnonymously(auth);
    } catch (e) { 
        console.warn("Autentica√ß√£o an√≥nima bloqueada ou indispon√≠vel. Carregando modo offline/fallback.", e);
        // Em caso de falha de Auth (como admin-restricted-operation), exibe produtos locais e avisa utilizador
        window.produtosFirebase = null;
        window.renderProdutos();
        const lm = document.getElementById('loader-msg');
        if (lm) lm.style.display = 'none';
        window.toast("Aviso: O Cat√°logo n√£o p√¥de ligar √† Base de Dados. A usar dados locais.");
    }
}

// Iniciar Radares ap√≥s confirma√ß√£o de Auth
initAuth().then(() => {
    onAuthStateChanged(auth, (user) => {
        if (!user) return; // Se a autentica√ß√£o falhou totalmente, as queries Firebase n√£o correm.
        
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'estoque'), s => {
            window.produtosFirebase = s.empty ? [] : s.docs.map(d => ({id:d.id, ...d.data()}));
            window.renderProdutos();
            window.syncCart();
            const lm = document.getElementById('loader-msg'); if(lm) lm.style.display = 'none';
        }, err => { console.warn("Erro de acesso Firebase. Usando Fallback."); window.renderProdutos(); });

        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), s => {
            if(s.exists()) {
                const d = s.data();
                window.pix_config = { 
                    rawKey: (d.rawKey || d.key || '11983454007').replace(/\D/g, ''), 
                    nomeRecebedor: d.nomeRecebedor || 'App Ovos Aline',
                    cidade: (d.cidade || 'SAO PAULO').toUpperCase()
                };
            }
        });

        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'store_config'), s => {
            if(s.exists()) {
                window.configuracoes_loja = { ...window.configuracoes_loja, ...s.data() };
                window.applyConfig();
            }
        });
    });
});

// --- UI HANDLERS ---
window.applyConfig = () => {
  const c = window.configuracoes_loja;
  document.getElementById('h-name').textContent = c.nome;
  document.getElementById('page-title').textContent = c.nome;
  document.documentElement.style.setProperty('--primary', c.corPrimaria);
  document.documentElement.style.setProperty('--dark', c.corSecundaria);
};

window.renderProdutos = () => {
    const grid = document.getElementById('product-grid'); if(!grid) return;
    const prods = window.getProdutos();
    const ativos = prods.filter(p => p.ativo !== false);
    if(ativos.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:50px; font-weight:700">Stock a ser atualizado...</div>';
        return;
    }
    grid.innerHTML = ativos.map(p => `
        <div class="card">
            <div class="card-img">${p.foto_url ? `<img src="${p.foto_url}">` : (p.emoji||'ü•ö')}</div>
            <div class="card-body">
                <div class="sub">${p.tipo || 'Ovos'}</div>
                <h3>${p.nome}</h3>
                <p>${p.embalagem || 'Unidade'}</p>
                <div class="card-price">R$ ${window.fmt(p.preco)}</div>
                <div class="qty-row">
                  <button class="qty-btn" onclick="window.chQty('${p.id}',-1)">‚àí</button>
                  <span class="qty-val" id="qty-${p.id}">0</span>
                  <button class="qty-btn" onclick="window.chQty('${p.id}',+1)">+</button>
                  <button class="add-btn" onclick="window.addCart('${p.id}')">Adicionar</button>
                </div>
            </div>
        </div>`).join('');
};

window.chQty = (id, d) => { const el = document.getElementById('qty-' + id); if (el) el.textContent = Math.max(0, parseInt(el.textContent || '0') + d); };

window.addCart = (id) => {
    const qty = parseInt(document.getElementById('qty-' + id)?.textContent || '0');
    if (!qty) return window.toast("Aumente a quantidade primeiro!");
    window.carrinho[id] = (window.carrinho[id] || 0) + qty;
    document.getElementById('qty-' + id).textContent = 0;
    window.syncCart();
    window.toast("‚úÖ Produto adicionado ao carrinho!");
};

window.syncCart = () => {
    const totalItems = Object.values(window.carrinho).reduce((a,b)=>a+b, 0);
    document.getElementById('cart-count').textContent = totalItems;
    document.getElementById('checkout-btn').disabled = totalItems === 0;
    window.renderCart();
};

window.renderCart = () => {
    const el = document.getElementById('cart-items'); if(!el) return;
    const prods = window.produtosFirebase || [];
    const items = Object.keys(window.carrinho).map(id => {
        const p = prods.find(x => x.id === id); if(!p) return '';
        return `
        <div class="ci">
            <div class="ci-emoji" style="font-size:1.8rem; background:#f8fafc; padding:8px; border-radius:12px">${p.emoji||'ü•ö'}</div>
            <div class="ci-info">
                <h4>${p.nome}</h4>
                <div class="qty-controls">
                    <button onclick="window.changeCartQty('${id}', -1)">-</button>
                    <span>${window.carrinho[id]}</span>
                    <button onclick="window.addCartSingle('${id}')">+</button>
                </div>
            </div>
            <div style="text-align:right">
                <div class="ci-price">R$ ${window.fmt(p.preco * window.carrinho[id])}</div>
                <button class="ci-rm" style="background:none; border:none; color:var(--primary); font-size:0.7rem; font-weight:800; cursor:pointer" onclick="window.deleteFromCart('${id}')">REMOVER</button>
            </div>
        </div>`;
    }).join('');
    el.innerHTML = items || '<div style="text-align:center; padding:40px; color:var(--muted); font-weight:700">Seu carrinho est√° vazio</div>';
    const total = Object.keys(window.carrinho).reduce((acc, id) => acc + ((prods.find(x => x.id === id)?.preco || 0) * window.carrinho[id]), 0);
    document.getElementById('cart-total').textContent = 'R$ ' + window.fmt(total);
    document.getElementById('chk-btn-total').textContent = 'R$ ' + window.fmt(total);
};

window.changeCartQty = (id, delta) => { window.carrinho[id] += delta; if (window.carrinho[id] <= 0) delete window.carrinho[id]; window.syncCart(); };
window.addCartSingle = (id) => { window.carrinho[id]++; window.syncCart(); };
window.deleteFromCart = (id) => { delete window.carrinho[id]; window.syncCart(); };

window.toggleCart = () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('open'); };
window.closeAll = () => document.querySelectorAll('.sidebar, .overlay, .mbk').forEach(el => el.classList.remove('open'));
window.backToCart = () => { document.getElementById('checkout-modal').classList.remove('open'); document.getElementById('sidebar').classList.add('open'); };
window.backToCheckout = () => { document.getElementById('pix-modal').classList.remove('open'); document.getElementById('checkout-modal').classList.add('open'); };
window.openCheckout = () => { window.closeAll(); document.getElementById('checkout-modal').classList.add('open'); document.getElementById('overlay').classList.add('open'); };

window.setDelivery = (type) => {
    window.currentDeliveryType = type;
    document.getElementById('btn-retirada').style.background = type === 'retirada' ? 'white' : 'none';
    document.getElementById('btn-entrega').style.background = type === 'entrega' ? 'white' : 'none';
    document.getElementById('info-retirada').style.display = type === 'retirada' ? 'block' : 'none';
    document.getElementById('info-entrega').style.display = type === 'entrega' ? 'block' : 'none';
};

window.processCheckout = () => {
    if(!document.getElementById('cli-nome').value.trim() || !document.getElementById('cli-tel').value.trim()) return window.toast("Por favor, preencha os seus dados de contacto!");
    document.getElementById('pagamento-select').value === 'pix_online' ? window.openPix() : window.saveOrderToFirebase();
};

window.openPix = () => {
    const prods = window.produtosFirebase || [];
    const total = Object.keys(window.carrinho).reduce((acc, id) => acc + ((prods.find(x => x.id === id)?.preco || 0) * window.carrinho[id]), 0);
    const payload = window.pixPayload(window.pix_config.rawKey, total, window.pix_config.nomeRecebedor, window.pix_config.cidade, 'PEDIDO');
    document.getElementById('pix-code-box').textContent = payload;
    const qrDiv = document.getElementById('qrcode'); qrDiv.innerHTML = '';
    new QRCode(qrDiv, { text: payload, width: 200, height: 200, colorDark: "#0f172a" });
    document.getElementById('checkout-modal').classList.remove('open');
    document.getElementById('pix-modal').classList.add('open');
};

// ‚úÖ ESTRUTURA DE DADOS CORRIGIDA
window.saveOrderToFirebase = async () => {
    const prods = window.getProdutos();
    const orderNum = '#' + Math.floor(100000 + Math.random() * 900000);
    
    // Loja agora envia com o "id" mapeado e usando o prefixo padrao "qtd"
    const items = Object.keys(window.carrinho).map(k => { 
        const p = prods.find(x => String(x.id) === String(k)) || {}; 
        return { id: p.id || k, nome: p.nome || 'Produto', qtd: window.carrinho[k], preco: p.preco || 0 }; 
    });
    
    const totalVal = Object.keys(window.carrinho).reduce((acc, id) => acc + ((prods.find(x => String(x.id) === String(id))?.preco || 0) * window.carrinho[id]), 0);
    
    const finishOrderLocal = () => {
        document.getElementById('order-num').textContent = orderNum;
        window.closeAll(); document.getElementById('success').classList.add('open');
        window.carrinho = {}; window.syncCart();
    }

    // Fallback: se o utilizador nao estiver autenticado (ex: admin-restricted) processa na mesma na interface do cliente
    if (!auth.currentUser) {
        return finishOrderLocal();
    }

    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), { 
            pedidoID: orderNum, valorTotal: totalVal, itens: items, 
            dadosCliente: { nome: document.getElementById('cli-nome').value, tel: document.getElementById('cli-tel').value }, 
            formaPagamento: document.getElementById('pagamento-select').value, 
            status: 'CRIADO', criadoEm: serverTimestamp() 
        });
        finishOrderLocal();
    } catch(e) { 
        console.warn("Erro de permiss√£o no Firebase. Pedido finalizado localmente.", e);
        // Garante que o cliente consegue sempre enviar a mensagem por WhatsApp, independentemente do Firebase
        finishOrderLocal();
    }
};

window.doCopy = () => { navigator.clipboard.writeText(document.getElementById('pix-code-box').textContent); window.toast("üìã Chave copiada!"); };
window.sendWhatsApp = () => { window.open(`https://wa.me/${window.configuracoes_loja.whatsapp}?text=Ol√°! Acabei de fazer o pedido: ${document.getElementById('order-num').textContent}`, '_blank'); };

window.renderProdutos(); // Render inicial (A carregar...)
</script>
</body>
</html>
