<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg - Faça seu Pedido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body class="pb-24">

    <div id="app-client"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // CONFIGURAÇÃO FIREBASE (Mesma do seu Painel)
        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const app = initializeApp(firebaseConfig);
        const dbFirestore = getFirestore(app);
        const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";

        window.state = {
            produtos: [],
            carrinho: [],
            loading: true,
            view: 'loja' // 'loja' ou 'carrinho'
        };

        window.actions = {
            loadProdutos: async () => {
                try {
                    const res = await fetch(`${API_BASE}/produtos`);
                    window.state.produtos = await res.json();
                    window.state.loading = false;
                    window.render();
                } catch (e) { console.error("Erro ao carregar loja"); }
            },
            adicionarAoCarrinho: (p) => {
                const item = window.state.carrinho.find(c => c.id === p.id);
                if (item) {
                    item.qtd += 1;
                } else {
                    window.state.carrinho.push({ ...p, qtd: 1 });
                }
                window.render();
            },
            finalizarPedido: async () => {
                const nomeCliente = prompt("Qual o seu nome?");
                if (!nomeCliente) return;

                alert("Processando seu pedido...");
                
                try {
                    // Para cada item no carrinho, cria um log de venda no Firestore
                    // O seu Worker do painel vai ver isso e dar baixa no estoque real!
                    for (const item of window.state.carrinho) {
                        await addDoc(collection(dbFirestore, "vendas_logs"), {
                            produtoNome: item.nome,
                            postgresId: item.id,
                            quantidade: item.qtd,
                            precoNoMomento: parseFloat(item.preco),
                            cliente: nomeCliente,
                            status: 'PENDENTE',
                            criadoEm: serverTimestamp()
                        });
                    }

                    window.state.carrinho = [];
                    window.state.view = 'loja';
                    alert("Pedido enviado com sucesso! Obrigado pela preferência.");
                    window.actions.loadProdutos();
                } catch (e) {
                    alert("Erro ao enviar pedido.");
                }
            }
        };

        window.render = () => {
            const root = document.getElementById('app-client');
            
            if (window.state.loading) {
                root.innerHTML = `<div class="flex h-screen items-center justify-center font-bold text-indigo-600">Carregando AppEgg...</div>`;
                return;
            }

            if (window.state.view === 'loja') {
                root.innerHTML = `
                    <header class="p-6 flex justify-between items-center border-b sticky top-0 bg-white z-10">
                        <h1 class="text-2xl font-black italic text-slate-800 tracking-tighter">AppEgg</h1>
                        <button onclick="window.state.view = 'carrinho'; window.render()" class="relative p-2 bg-slate-100 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                            ${window.state.carrinho.length > 0 ? `<span class="cart-badge">${window.state.carrinho.reduce((a,b) => a + b.qtd, 0)}</span>` : ''}
                        </button>
                    </header>

                    <main class="p-4 grid grid-cols-1 gap-4">
                        ${window.state.produtos.filter(p => p.quantidade > 0).map(p => `
                            <div class="bg-white border rounded-3xl p-5 flex justify-between items-center shadow-sm">
                                <div>
                                    <h3 class="font-bold text-slate-800">${p.nome}</h3>
                                    <p class="text-indigo-600 font-black text-lg">R$ ${parseFloat(p.preco).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                    <p class="text-[10px] text-slate-400 uppercase font-bold">Disponível: ${p.quantidade} un</p>
                                </div>
                                <button onclick='window.actions.adicionarAoCarrinho(${JSON.stringify(p)})' class="bg-indigo-600 text-white px-6 py-2 rounded-2xl font-black text-sm active:scale-90 transition-transform shadow-lg shadow-indigo-100">
                                    + ADICIONAR
                                </button>
                            </div>
                        `).join('')}
                    </main>
                `;
            } else {
                const total = window.state.carrinho.reduce((acc, item) => acc + (item.preco * item.qtd), 0);
                root.innerHTML = `
                    <header class="p-6 flex items-center gap-4 border-b">
                        <button onclick="window.state.view = 'loja'; window.render()" class="text-slate-400 font-black text-xl">←</button>
                        <h1 class="text-xl font-black text-slate-800">Meu Carrinho</h1>
                    </header>
                    <main class="p-6 space-y-6">
                        ${window.state.carrinho.length === 0 ? '<p class="text-center text-slate-400 py-20 font-bold">Seu carrinho está vazio.</p>' : ''}
                        ${window.state.carrinho.map(item => `
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-slate-800">${item.nome}</p>
                                    <p class="text-sm text-slate-400">${item.qtd}x R$ ${parseFloat(item.preco).toFixed(2)}</p>
                                </div>
                                <p class="font-black text-slate-800">R$ ${(item.qtd * item.preco).toFixed(2)}</p>
                            </div>
                        `).join('')}
                        
                        <div class="border-t pt-6">
                            <div class="flex justify-between items-center mb-8">
                                <span class="text-slate-400 font-bold uppercase tracking-widest text-xs">Total do Pedido</span>
                                <span class="text-3xl font-black text-indigo-600">R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            </div>
                            <button onclick="window.actions.finalizarPedido()" class="w-full py-5 bg-emerald-500 text-white rounded-[2rem] font-black text-lg shadow-xl shadow-emerald-100 active:scale-95 transition-transform uppercase tracking-tighter">
                                ENVIAR PEDIDO AGORA
                            </button>
                        </div>
                    </main>
                `;
            }
        };

        window.actions.loadProdutos();
    </script>
</body>
</html>