<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Sua Loja de Ovos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f8fafc; 
            padding-bottom: 120px; 
            color: #1e293b; 
            overflow-x: hidden; 
        }

        .logo-text { font-weight: 900; color: #e11d48; font-size: 1.8rem; letter-spacing: -1px; }
        
        .nav-bottom { 
            position: fixed; bottom: 20px; left: 15px; right: 15px; 
            background: #0f172a; border-radius: 32px; display: flex; 
            justify-content: space-around; padding: 18px; z-index: 100; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        .nav-item { 
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; 
            color: #64748b; font-size: 9px; font-weight: 900; text-transform: uppercase; 
            border: none; background: transparent; cursor: pointer; transition: 0.3s;
        }
        .nav-item.active { color: #fff; transform: scale(1.1); }
        
        .card-egg { 
            background: white; border: 1px solid #f1f5f9; border-radius: 40px; 
            padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); 
            transition: 0.3s; position: relative;
        }
        
        .btn-main { 
            background: #e11d48; color: white; padding: 20px; border-radius: 28px; 
            font-weight: 900; text-transform: uppercase; font-size: 13px; 
            box-shadow: 0 10px 25px rgba(225, 29, 72, 0.2); width: 100%; 
            transition: 0.2s; cursor: pointer; border: none;
        }
        .btn-main:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        
        .input-egg { 
            width: 100%; padding: 18px; background: #f1f5f9; border-radius: 20px; 
            border: 2px solid transparent; font-weight: 700; font-size: 14px; outline: none; transition: 0.2s; 
        }
        .input-egg:focus { border-color: #e11d48; background: #fff; }

        .btn-add-fast {
            background: #e11d48; color: white; width: 44px; height: 44px;
            border-radius: 16px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 900; transition: 0.2s;
        }
        .btn-add-fast:active { transform: scale(0.9); }

        .option-card {
            border: 2px solid #f1f5f9; border-radius: 24px; padding: 16px;
            transition: 0.2s; cursor: pointer; text-align: left;
        }
        .option-card.active { border-color: #e11d48; background: #fff1f2; }

        .btn-filter {
            padding: 10px 14px; border-radius: 16px; font-size: 10px; font-weight: 800;
            text-transform: uppercase; transition: 0.2s; border: 2px solid #f1f5f9;
            color: #64748b; background: white; white-space: nowrap;
        }
        .btn-filter.active { background: #e11d48; color: white; border-color: #e11d48; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pix-box { background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 24px; padding: 20px; margin-top: 15px; text-align: center; }
        
        .text-label-red { color: #e11d48; font-weight: 800; text-transform: uppercase; font-size: 10px; letter-spacing: 0.05em; }

        .qr-container { background: white; padding: 15px; border-radius: 20px; display: inline-block; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="no-scrollbar">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, addDoc, 
            serverTimestamp, increment, updateDoc, setDoc, runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, updatePassword 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const auth = getAuth(appFB);
        
        const appId = "app-egg-pro-transacional";
        const DISTRIBUIDORA_ENDERECO = "R. Ant√¥nio Freire da Silva, 67 - Jardim das Camelias, S√£o Paulo - SP, 08050-300";

        // --- ESTADO GLOBAL ---
        window.state = { 
            user: null, 
            profile: null,
            view: 'loja', 
            produtos: [], 
            pedidos: [], 
            cart: [],
            pix: { key: '', type: '', copiaCola: '' }, 
            checkout: { tipoEntrega: 'entrega', endereco: null, metodoPagamento: 'pix_agora' },
            profileMode: 'view',
            ordersFilter: 'aberto', 
            ordersDate: '', 
            loading: true, 
            processing: false,
            payingOrder: null
        };

        // --- FUN√á√ïES GLOBAIS ---

        window.handleLogin = async (e) => {
            if (e) e.preventDefault();
            const email = document.getElementById('le').value.trim();
            const pass = document.getElementById('lp').value;
            try { 
                await signInWithEmailAndPassword(auth, email, pass);
                // Ativar notifica√ß√µes ap√≥s login
                window.registerPushNotifications();
            } catch (err) { 
                alert("Dados de acesso incorretos."); 
            }
        };

        window.setView = (v) => { 
            window.state.view = v; 
            window.state.profileMode = 'view';
            window.state.payingOrder = null;
            window.render(); 
        };

        window.handleSignOut = () => signOut(auth);

        window.maskDoc = (i) => {
            let v = i.value.replace(/\D/g, "");
            if (v.length <= 11) i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g, "$1.$2.$3-$4");
            else i.value = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g, "$1.$2.$3/$4-$5");
        };

        window.maskTel = (i) => { 
            let v = i.value.replace(/\D/g, ""); 
            i.value = v.replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d{5})(\d)/, "$1-$2").substring(0, 15); 
        };

        window.maskCEP = (i) => { 
            let v = i.value.replace(/\D/g, ""); 
            i.value = v.replace(/(\d{5})(\d)/, "$1-$2").substring(0, 9); 
        };

        window.addToCart = (id) => {
            const p = window.state.produtos.find(x => x.id === id);
            if (!p) return;
            const existing = window.state.cart.find(x => x.id === id);
            if (existing) {
                if (existing.qtd + 1 > p.quantidade) { alert("Stock m√°ximo atingido!"); return; }
                existing.qtd++;
            } else {
                if (p.quantidade < 1) { alert("Produto esgotado!"); return; }
                window.state.cart.push({ ...p, qtd: 1 });
            }
            window.render();
        };

        window.repeatOrder = (pedidoId) => {
            const pedido = window.state.pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;
            const items = pedido.items || [{ produto: pedido.produto, quantidade: pedido.quantidade }];
            items.forEach(item => {
                const p = window.state.produtos.find(x => x.nome === item.produto);
                if (p && p.quantidade >= item.quantidade) {
                    const existing = window.state.cart.find(x => x.id === p.id);
                    if (existing) existing.qtd += item.quantidade; else window.state.cart.push({ ...p, qtd: item.quantidade });
                }
            });
            window.state.view = 'carrinho'; window.render();
        };

        window.updateCartQtd = (id, val) => {
            const item = window.state.cart.find(x => x.id === id);
            const p = window.state.produtos.find(x => x.id === id);
            if (!item) return;
            item.qtd = Math.max(0, item.qtd + val);
            if (item.qtd > p.quantidade) item.qtd = p.quantidade;
            if (item.qtd === 0) window.state.cart = window.state.cart.filter(x => x.id !== id);
            window.render();
        };

        window.copyPixCopiaCola = (texto) => {
            if (!texto) { alert("Aguardando c√≥digo PIX..."); return; }
            navigator.clipboard.writeText(texto).then(() => {
                alert("C√≥digo PIX Copia e Cola copiado!");
            }).catch(() => {
                const el = document.createElement('textarea'); el.value = texto; document.body.appendChild(el);
                el.select(); document.execCommand('copy'); document.body.removeChild(el); 
                alert("C√≥digo PIX copiado!");
            });
        };

        // ‚úÖ CONFIRMAR PAGAMENTO: UNIFICADO PARA PIX_PAGO COM ATUALIZA√á√ÉO LOCAL
        window.confirmarPagamentoPix = async (pedidoId) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vendas_logs', pedidoId), {
                    'pagamento.pago': true,
                    'pagamento.confirmadoEm': serverTimestamp(),
                    status: 'PIX_PAGO'
                });
                
                // ‚úÖ ATUALIZA√á√ÉO LOCAL IMEDIATA
                const pedIdx = window.state.pedidos.findIndex(p => p.id === pedidoId);
                if (pedIdx !== -1) {
                    window.state.pedidos[pedIdx].status = 'PIX_PAGO';
                    if(window.state.pedidos[pedIdx].pagamento) window.state.pedidos[pedIdx].pagamento.pago = true;
                }

                alert("Obrigado! O lojista foi notificado do seu pagamento.");
                window.state.payingOrder = null;
                window.state.view = 'pedidos';
                window.render();
            } catch (e) {
                alert("Erro ao confirmar pagamento.");
            }
        };

        window.handleUpdateProfile = async (e) => {
            e.preventDefault();
            if (window.state.processing) return;
            window.state.processing = true; window.render();
            const f = new FormData(e.target);
            const newData = {
                name: f.get('name'), doc: f.get('doc'), phone: f.get('phone'),
                address: { rua: f.get('rua'), numero: f.get('numero'), bairro: f.get('bairro'), cep: f.get('cep'), cidade: f.get('cidade'), estado: f.get('estado').toUpperCase() },
                updatedAt: serverTimestamp()
            };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, 'profiles', 'main'), newData, { merge: true });
                window.state.profileMode = 'view';
                alert("Dados atualizados com sucesso!");
            } catch (err) { alert("Erro ao atualizar perfil."); } 
            finally { window.state.processing = false; window.render(); }
        };

        window.handleUpdatePassword = async (e) => {
            e.preventDefault();
            const newPass = document.getElementById('newPass').value;
            if (newPass.length < 6) { alert("A senha deve ter no m√≠nimo 6 caracteres."); return; }
            window.state.processing = true; window.render();
            try {
                await updatePassword(auth.currentUser, newPass);
                alert("Senha alterada com sucesso!");
                window.state.profileMode = 'view';
            } catch (err) { alert("Erro ao trocar senha: " + err.message); } 
            finally { window.state.processing = false; window.render(); }
        };

        window.handleSaveCheckoutAddress = (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            window.state.checkout.endereco = { rua: f.get('rua'), numero: f.get('numero'), bairro: f.get('bairro'), cep: f.get('cep'), cidade: f.get('cidade'), estado: f.get('estado').toUpperCase() };
            window.state.checkout.tipoEntrega = 'entrega';
            window.state.view = 'checkout-endereco';
            window.render();
        };

        // --- FINALIZA√á√ÉO AT√îMICA COM PEDIDO CONSOLIDADO ---
        window.handleFinalizeOrder = async () => {
            if (window.state.processing || window.state.cart.length === 0) return;
            window.state.processing = true; window.render();
            try {
                const s = window.state;
                const totalPedido = s.cart.reduce((acc, i) => acc + (i.preco * i.qtd), 0);
                const finalAddr = s.checkout.tipoEntrega === 'retirada' ? DISTRIBUIDORA_ENDERECO : (s.checkout.endereco ? `${s.checkout.endereco.rua}, ${s.checkout.endereco.numero} - ${s.checkout.endereco.bairro}` : `${s.profile?.address?.rua || ''}, ${s.profile?.address?.numero || ''}`);

                let pedidoCriadoId = "";

                await runTransaction(db, async (transaction) => {
                    const stockUpdates = [];
                    for (const item of s.cart) {
                        const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'estoque', item.id);
                        const prodSnap = await transaction.get(prodRef);
                        if (!prodSnap.exists()) throw new Error(`Produto ${item.nome} indispon√≠vel.`);
                        const currentQty = Number(prodSnap.data().quantidade);
                        if (currentQty < item.qtd) throw new Error(`Estoque insuficiente para ${item.nome}.`);
                        stockUpdates.push({ ref: prodRef, newQty: currentQty - item.qtd });
                    }

                    stockUpdates.forEach(upd => transaction.update(upd.ref, { quantidade: upd.newQty }));
                    
                    const orderRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'));
                    pedidoCriadoId = orderRef.id;
                    
                    transaction.set(orderRef, {
                        clienteId: auth.currentUser.uid,
                        clienteNome: s.profile?.name || auth.currentUser.email?.split('@')[0],
                        items: s.cart.map(i => ({ produto: i.nome, quantidade: i.qtd, precoUn: i.preco, embalagem: i.embalagem })),
                        valorTotal: totalPedido,
                        tipoEntrega: s.checkout.tipoEntrega,
                        enderecoEntrega: finalAddr,
                        status: 'EM SEPARA√á√ÉO', // ‚úÖ REGRA DE NEG√ìCIO: STATUS INICIAL AUTOM√ÅTICO
                        pagamento: {
                            metodo: s.checkout.metodoPagamento,
                            pago: false,
                            pix: s.checkout.metodoPagamento === 'pix_agora' ? { copiaCola: s.pix.copiaCola, keyUsed: s.pix.key } : null
                        },
                        criadoEm: serverTimestamp()
                    });
                });

                if (s.checkout.metodoPagamento === 'pix_agora') {
                    window.state.payingOrder = { id: pedidoCriadoId, valor: totalPedido, pixString: s.pix.copiaCola };
                } else {
                    window.state.view = 'pedidos';
                    alert("Pedido em separa√ß√£o! ü•ö‚ú®");
                }

                window.state.cart = [];
                window.render();
            } catch (e) { alert(e.message); } finally { window.state.processing = false; window.render(); }
        };

        // ‚îÄ‚îÄ NOTIFICA√á√ïES PUSH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        window.registerPushNotifications = async () => {
            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                alert("Notifica√ß√µes n√£o suportadas neste navegador.");
                return;
            }

            try {
                // 1. Registra o SW
                const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                console.log('Service Worker FCM registrado');

                // 2. Pede permiss√£o
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    alert("Permiss√£o de notifica√ß√µes negada.");
                    return;
                }

                // 3. Obt√©m token FCM
                const messaging = getMessaging(appFB);

                // SUBSTITUA PELA SUA CHAVE VAPID P√öBLICA (Firebase Console > Cloud Messaging > Web Push certificates)
                const vapidKey = 'SUA_CHAVE_VAPID_PUBLICA_AQUI';  // ‚Üê cole aqui!

                const token = await getToken(messaging, { 
                    vapidKey,
                    serviceWorkerRegistration: reg 
                });

                if (token) {
                    console.log('Token FCM obtido:', token);

                    // Salva no Firestore
                    await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'notifications', 'main'), {
                        token: token,
                        updatedAt: serverTimestamp(),
                        userAgent: navigator.userAgent,
                        platform: 'web'
                    }, { merge: true });

                    alert("Notifica√ß√µes push ativadas! üîî");
                }
            } catch (err) {
                console.error('Erro ao ativar push:', err);
                alert("Erro ao ativar notifica√ß√µes.");
            }
        };

        // Mensagens em foreground (app aberto)
        const messaging = getMessaging(appFB);
        onMessage(messaging, (payload) => {
            console.log('Mensagem push em foreground:', payload);
            const title = payload.notification?.title || 'AppEgg';
            const body = payload.notification?.body || 'Nova atualiza√ß√£o!';
            alert(`${title}\n${body}`);
        });

        const safeImg = (url) => (url && url.startsWith('data:image')) ? url : "https://via.placeholder.com/300x300?text=AppEgg";

        // --- RENDERIZA√á√ÉO DAS TELAS ---
        window.render = () => {
            const root = document.getElementById('app-root');
            const s = window.state;
            if (s.loading) { root.innerHTML = `<div class="h-screen flex items-center justify-center font-black text-rose-600 animate-pulse text-2xl uppercase italic text-center">AppEgg...</div>`; return; }
            if (!s.user) { root.innerHTML = renderLogin(); return; }

            root.innerHTML = `
                <div class="p-6 max-w-lg mx-auto text-left">
                    <header class="flex justify-between items-center mb-8">
                        <div class="logo-text italic uppercase">AppEgg</div>
                        <div class="bg-slate-100 px-4 py-2 rounded-2xl text-[9px] font-black text-slate-400 uppercase italic">Cliente Platinum</div>
                    </header>
                    ${s.view === 'loja' ? renderLoja() : 
                      s.view === 'carrinho' ? renderCarrinho() : 
                      s.view === 'checkout-endereco' ? renderCheckoutEndereco() : 
                      s.view === 'checkout-novo-endereco' ? renderCheckoutNovoEndereco() : 
                      s.view === 'checkout-pagamento' ? renderCheckoutPagamento() : 
                      s.view === 'pedidos' ? renderPedidos() : 
                      renderPerfil()}
                </div>
                <nav class="nav-bottom">
                    <button onclick="window.setView('loja')" class="nav-item ${s.view==='loja'?'active':''}">Loja</button>
                    <button onclick="window.setView('carrinho')" class="nav-item ${s.view==='carrinho'?'active':''} relative">${s.cart.length > 0 ? `<span class="absolute -top-1 right-2 bg-rose-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-[#0f172a]">${s.cart.reduce((a,b)=>a+b.qtd,0)}</span>` : ''}Carrinho</button>
                    <button onclick="window.setView('pedidos')" class="nav-item ${s.view==='pedidos'?'active':''}">Meus Pedidos</button>
                    <button onclick="window.setView('perfil')" class="nav-item ${s.view==='perfil'?'active':''}">Perfil</button>
                </nav>
                ${s.payingOrder ? renderPixModal() : ''}
            `;
        };

        function renderLoja() { return `<div class="space-y-6 text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase">Ovos Frescos</h2><div class="grid gap-6">${window.state.produtos.map(p => `<div class="card-egg flex items-center gap-6 shadow-sm"><div class="w-24 h-24 bg-slate-50 rounded-[32px] overflow-hidden flex items-center justify-center text-center"><img src="${safeImg(p.foto_url)}" class="w-full h-full object-cover"></div><div class="flex-1 text-left"><h3 class="font-black text-xs uppercase text-slate-800 leading-none mb-1 text-left">${p.nome}</h3><p class="text-slate-400 text-[10px] font-bold uppercase mb-2 text-left">${p.embalagem}</p><p class="text-rose-600 font-[950] text-2xl tracking-tighter italic text-left leading-none">R$ ${Number(p.preco).toFixed(2)}</p></div><button onclick="window.addToCart('${p.id}')" class="btn-add-fast shadow-lg shadow-rose-200 text-center">+</button></div>`).join('')}</div></div>${window.state.cart.length > 0 ? `<div class="fixed bottom-32 left-8 right-8 z-[150] animate-bounce text-center"><button onclick="window.setView('carrinho')" class="btn-main flex items-center justify-center gap-3 shadow-2xl">Ir para o Carrinho (R$ ${window.state.cart.reduce((a,b)=>a+(b.preco*b.qtd),0).toFixed(2)})</button></div>` : ''}`; }
        function renderCarrinho() { const total = window.state.cart.reduce((acc, item) => acc + (item.preco * item.qtd), 0); return `<div class="space-y-8 fade-in text-left text-left text-left"><h2 class="text-2xl font-black text-slate-800 italic uppercase text-left text-left">Seu Carrinho</h2>${window.state.cart.length === 0 ? `<div class="py-20 text-center"><p class="text-slate-300 font-black uppercase text-xs mb-8">Carrinho Vazio</p><button onclick="window.setView('loja')" class="btn-main">Voltar √† Loja</button></div>` : `<div class="space-y-4 text-left">${window.state.cart.map(item =>
