<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AppEgg</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; background:#fff }
.logo { color:#e11d48; font-weight:900 }
.nav-bottom {
  position:fixed; bottom:16px; left:16px; right:16px;
  background:#111827; border-radius:22px;
  display:flex; justify-content:space-around;
  padding:10px; z-index:50;
}
.nav-item { color:#9ca3af; font-size:10px; font-weight:800 }
.nav-item.active { color:#fff }
.fab {
  position:fixed; bottom:90px; right:18px;
  background:#22c55e; color:#fff;
  padding:14px; border-radius:50%;
  font-size:20px; z-index:60;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}
.footer {
  padding:20px; text-align:center;
  font-size:11px; color:#6b7280;
}
</style>
</head>

<body>
<div id="app"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig = {
 apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
 authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
 projectId: "distribuidora-de-ovos-aline",
 storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
 messagingSenderId: "92187548716",
 appId: "1:92187548716:web:d61d18a29aa76aead7c589"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const auth = getAuth(appFB);

const WHATSAPP = "5511985706243";

const state = {
 user:null,
 tela:'catalogo',
 produtos:[],
 pedidos:[]
};

onAuthStateChanged(auth,u=>{
 state.user=u;
 if(u){
  carregarProdutos();
  monitorarPedidos();
 }
 render();
});

function render(){
 const app=document.getElementById('app');
 if(!state.user){
  app.innerHTML=`
   <div class="min-h-screen flex flex-col justify-center p-10 text-center">
    <div class="logo text-5xl mb-10">AppEgg</div>
    <form onsubmit="login(event)" class="space-y-4">
     <input name="email" type="email" placeholder="E-mail" class="w-full p-4 rounded-xl bg-gray-100 font-bold" required>
     <input name="senha" type="password" placeholder="Senha" class="w-full p-4 rounded-xl bg-gray-100 font-bold" required>
     <button class="w-full p-4 bg-rose-600 text-white rounded-xl font-black uppercase">Entrar</button>
    </form>
   </div>`;
  return;
 }

 app.innerHTML=`
 <div class="pb-40">
  ${state.tela==='catalogo'?renderCatalogo():renderPedidos()}
  ${state.tela==='pedidos'?botaoWhatsapp():''}
 </div>

 <nav class="nav-bottom">
  <button onclick="nav('catalogo')" class="nav-item ${state.tela==='catalogo'?'active':''}">ðŸ¥š<br>Comprar</button>
  <button onclick="nav('pedidos')" class="nav-item ${state.tela==='pedidos'?'active':''}">ðŸ“¦<br>Pedidos</button>
  <button onclick="logout()" class="nav-item">ðŸšª<br>Sair</button>
 </nav>

 <div class="footer">
  AppEgg â€¢ Distribuidora de Ovos Aline<br>
  Atendimento via WhatsApp
 </div>
 `;
}

function renderCatalogo(){
 return `
 <header class="p-6 text-center">
  <div class="logo text-3xl">AppEgg</div>
 </header>
 <div class="grid grid-cols-2 gap-4 p-4">
 ${state.produtos.map(p=>`
  <div class="border rounded-2xl p-4 text-center">
   <img src="${p.foto_url}" class="h-20 mx-auto mb-2">
   <p class="font-black text-xs uppercase">${p.nome}</p>
   <p class="text-rose-600 font-black">R$ ${p.preco.toFixed(2)}</p>
   <button onclick="pedir(${JSON.stringify(p).replace(/"/g,'&quot;')})"
    class="mt-3 w-full bg-gray-900 text-white p-3 rounded-xl text-xs font-black">
    Pedir
   </button>
  </div>`).join('')}
 </div>`;
}

function renderPedidos(){
 return `
 <div class="p-6">
  <h2 class="text-2xl font-black mb-6">Meus Pedidos</h2>
  ${state.pedidos.map(p=>`
   <div class="border rounded-2xl p-5 mb-4">
    <div class="flex justify-between mb-2">
     <span class="font-black text-rose-600 text-xs">${p.status}</span>
     <span class="font-black">R$ ${p.precoNoMomento.toFixed(2)}</span>
    </div>
    <p class="font-bold text-xs uppercase mb-2">${p.produto}</p>
    <p class="text-[10px] text-gray-500">Pagamento: ${p.pagamento}</p>
   </div>`).join('')||'<p class="text-gray-400 font-bold">Nenhum pedido</p>'}
 </div>`;
}

function botaoWhatsapp(){
 const msg = encodeURIComponent(
  `OlÃ¡! Fiz um pedido no AppEgg ðŸ¥š\nCliente: ${state.user.email}`
 );
 return `
 <a href="https://wa.me/${WHATSAPP}?text=${msg}" target="_blank" class="fab">ðŸ’¬</a>
 `;
}

window.nav=t=>{state.tela=t;render()}
window.login=async e=>{
 e.preventDefault();
 await signInWithEmailAndPassword(auth,e.target.email.value,e.target.senha.value);
}
window.logout=()=>signOut(auth)

async function carregarProdutos(){
 const r=await fetch("https://painel-distribuidora-backend.onrender.com/api/produtos");
 state.produtos=await r.json();
 render();
}

function monitorarPedidos(){
 const q=query(collection(db,"vendas_logs"),
  where("clienteWhatsapp","==",state.user.email),
  orderBy("criadoEm","desc"));
 onSnapshot(q,s=>{
  state.pedidos=s.docs.map(d=>d.data());
  render();
 });
}

window.pedir=async p=>{
 await addDoc(collection(db,"vendas_logs"),{
  clienteNome:state.user.email.split('@')[0],
  clienteWhatsapp:state.user.email,
  produto:p.nome,
  precoNoMomento:p.preco,
  pagamento:"PIX NA RETIRADA",
  status:"PENDENTE",
  criadoEm:serverTimestamp()
 });
 alert("Pedido realizado!");
 state.tela='pedidos';
 render();
}
</script>
</body>
</html>
