<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AppEgg | Sua Distribuidora de Ovos</title>
    <script src="https://cdn.tailwindcss.com/3.4.13"></script>
    <!-- Stripe.js (obrigat√≥rio para integra√ß√£o) -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #ffffff; 
            color: #0f172a; 
            padding-bottom: 100px; 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
        }

        .logo-font { font-weight: 800; color: #e11d48; font-size: 1.4rem; letter-spacing: -1px; }
        
        .nav-bottom { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #ffffff; border-top: 1px solid #f1f5f9;
            display: flex; justify-content: space-around; padding: 12px 0 24px 0; z-index: 100; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.03);
        }
        
        .nav-item { 
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; 
            color: #94a3b8; font-size: 10px; font-weight: 600; 
            border: none; background: transparent; cursor: pointer; transition: 0.2s;
        }
        .nav-item.active { color: #e11d48; }
        
        .card-product { 
            background: white; border: 1px solid #f1f5f9; border-radius: 16px; 
            overflow: hidden; transition: 0.2s ease; position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.01);
        }
        .card-product:active { transform: scale(0.98); border-color: #e11d48; }
        
        .btn-primary { 
            background: #e11d48; color: white; padding: 16px; border-radius: 14px; 
            font-weight: 700; font-size: 14px; width: 100%; 
            transition: 0.2s; cursor: pointer; border: none; text-transform: uppercase;
        }
        .btn-primary:active { background: #be123c; transform: scale(0.98); }
        .btn-primary:disabled { background: #f1f5f9; color: #cbd5e1; cursor: not-allowed; }
        
        .btn-stripe {
            background: #635bff; color: white; padding: 16px; border-radius: 14px;
            font-weight: 700; font-size: 14px; width: 100%; text-transform: uppercase;
            transition: 0.2s; cursor: pointer; border: none;
        }
        .btn-stripe:active { background: #4f46e5; transform: scale(0.98); }
        
        .input-refined { 
            width: 100%; padding: 14px 16px; background: #f8fafc; border-radius: 12px; 
            border: 1px solid #e2e8f0; font-weight: 500; font-size: 14px; outline: none; transition: 0.2s; 
        }
        .input-refined:focus { border-color: #e11d48; background: #fff; box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.08); }

        .badge-status {
            padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.02em;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .loading-screen { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .btn-add-circle {
            width: 36px; height: 36px; background: #e11d48; color: white;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(225, 29, 72, 0.15);
        }
        .btn-add-circle:active { transform: scale(0.85); }

        .cart-count {
            position: absolute; top: -2px; right: -2px; background: #e11d48; color: white;
            font-size: 9px; font-weight: 800; width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; border: 2px solid white;
        }

        .toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; padding: 12px 24px; border-radius: 12px; background: #1e293b;
            color: white; font-weight: 600; font-size: 13px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .option-card {
            border: 1.5px solid #f1f5f9; border-radius: 16px; padding: 16px;
            transition: 0.2s; cursor: pointer; text-align: left; background: #fff;
            display: flex; align-items: center; gap: 12px;
        }
        .option-card.active { border-color: #e11d48; background: #fff1f2; }

        .qr-frame { background: #f8fafc; padding: 16px; border-radius: 20px; border: 1px dashed #e2e8f0; display: inline-block; }
    </style>
</head>
<body class="no-scrollbar">

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, addDoc, 
            serverTimestamp, increment, updateDoc, setDoc, runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, updatePassword, signInAnonymously, signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const auth = getAuth(appFB);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : "app-egg-pro-transacional";
        const DISTRIBUIDORA_ENDERECO = "R. Ant√¥nio Freire da Silva, 67 - Jd. Camelias, SP";

        // --- CHAVE P√öBLICA STRIPE (substitua pela sua real!) ---
        const stripe = Stripe('pk_test_SUA_CHAVE_PUBLICA_AQUI');  // ‚Üê COLOQUE AQUI SUA CHAVE PUBLICA DO STRIPE

        // --- ESTADO GLOBAL ---
        window.state = { 
            user: null, 
            profile: null,
            view: 'loja', 
            produtos: [], 
            pedidos: [], 
            cart: [],
            pix: { key: '', type: '', copiaCola: '' }, 
            checkout: { tipoEntrega: 'entrega', endereco: null, metodoPagamento: 'pix_agora' },
            profileMode: 'view',
            ordersFilter: 'aberto', 
            loading: true, 
            processing: false,
            payingOrder: null,
            toast: null
        };

        let lastStateHash = "";
        let renderTimeout = null;

        // --- FUN√á√ïES AUXILIARES (mantidas iguais) ---

        window.scheduleRender = () => {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => { window.render(); }, 16);
        };

        window.showToast = (msg) => {
            window.state.toast = msg;
            window.scheduleRender();
            setTimeout(() => {
                window.state.toast = null;
                window.scheduleRender();
            }, 3000);
        };

        window.setView = (v) => { 
            window.state.view = v; 
            window.state.profileMode = 'view';
            window.state.payingOrder = null;
            window.scheduleRender(); 
        };

        window.copyToClipboard = (text) => {
            if (!text) return;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                window.showToast('C√≥digo PIX copiado!');
            } catch (err) {
                console.error('Erro ao copiar:', err);
            }
            document.body.removeChild(textArea);
        };

        // ... (mantenha maskTel, maskCEP, maskDoc, gerarPix, addToCart, updateCartQtd, etc.)

        // --- FINALIZAR PEDIDO COM STRIPE OU PIX ---
        window.handleFinalizeOrder = async (paymentMethod = 'pix_agora') => {
            if (window.state.processing || window.state.cart.length === 0) return;
            window.state.processing = true; window.scheduleRender();

            try {
                const s = window.state;
                const totalPedido = s.cart.reduce((acc, i) => acc + (i.preco * i.qtd), 0);
                const finalAddr = s.checkout.tipoEntrega === 'retirada' ? DISTRIBUIDORA_ENDERECO : (s.checkout.endereco ? `${s.checkout.endereco.rua}, ${s.checkout.endereco.numero}` : `${s.profile?.address?.rua || ''}, ${s.profile?.address?.numero || ''}`);

                let pedidoCriadoId = "";
                let pixGerado = "";

                await runTransaction(db, async (transaction) => {
                    for (const item of s.cart) {
                        const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'estoque', item.id);
                        const prodSnap = await transaction.get(prodRef);
                        const curQty = Number(prodSnap.data()?.quantidade || 0);
                        if (curQty < item.qtd) throw new Error(`Stock insuficiente para ${item.nome}.`);
                        transaction.update(prodRef, { quantidade: curQty - item.qtd });
                    }

                    const orderRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'));
                    pedidoCriadoId = orderRef.id;

                    if (paymentMethod === 'stripe') {
                        // Cria sess√£o Stripe
                        const response = await fetch('https://sua-url-de-backend.com/create-checkout-session', {  // ‚Üê SUBSTITUA PELA SUA URL DE BACKEND
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                amount: Math.round(totalPedido * 100), // em centavos
                                currency: 'brl',
                                orderId: pedidoCriadoId,
                                customerEmail: auth.currentUser.email
                            })
                        });

                        const { sessionId } = await response.json();
                        stripe.redirectToCheckout({ sessionId });
                        return;
                    } else {
                        // PIX (fallback)
                        pixGerado = gerarPix({ chave: s.pix.key_raw || s.pix.key, tipo: s.pix.type, valor: totalPedido, txid: pedidoCriadoId });
                    }

                    transaction.set(orderRef, {
                        clienteId: auth.currentUser.uid,
                        clienteNome: s.profile?.name || "Cliente",
                        items: s.cart.map(i => ({ produto: i.nome, quantidade: i.qtd, precoUn: i.preco, embalagem: i.embalagem })),
                        valorTotal: totalPedido,
                        status: paymentMethod === 'stripe' ? 'PENDENTE_STRIPE' : 'PENDENTE_PAGAMENTO',
                        pix_payload: pixGerado || null,
                        tipoEntrega: s.checkout.tipoEntrega,
                        enderecoEntrega: finalAddr,
                        pagamento: { metodo: paymentMethod, pago: false, status: 'PENDENTE' },
                        criadoEm: serverTimestamp()
                    });
                });

                if (paymentMethod === 'stripe') {
                    // O redirecionamento j√° aconteceu
                    return;
                }

                if (paymentMethod === 'pix_agora') {
                    window.state.payingOrder = { id: pedidoCriadoId, valor: totalPedido, pixString: pixGerado };
                } else {
                    window.setView('pedidos');
                    window.showToast("Pedido confirmado! Aguarde separa√ß√£o ü•ö");
                }

                window.state.cart = [];
                window.scheduleRender();
            } catch (e) {
                window.showToast(e.message || "Erro ao finalizar pedido.");
            } finally {
                window.state.processing = false;
                window.scheduleRender();
            }
        };

        // ... (mantenha as demais fun√ß√µes: confirmarPagamentoPix, render, etc.)

        // --- RENDERIZA√á√ÉO DO CARRINHO (com bot√£o Stripe) ---
        function renderCarrinho() {
            const total = window.state.cart.reduce((acc, i) => acc + (i.preco * i.qtd), 0);
            return `
                <div class="space-y-6 fade-in">
                    <h2 class="text-2xl font-extrabold text-slate-900">Seu Carrinho</h2>
                    ${window.state.cart.length === 0 ? `
                        <p class="text-center text-slate-400 py-12">Seu carrinho est√° vazio</p>
                    ` : `
                        <div class="space-y-4">
                            ${window.state.cart.map(item => `
                                <div class="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border">
                                    <div>
                                        <p class="font-bold">${item.nome}</p>
                                        <p class="text-sm text-slate-500">R$ ${item.preco.toFixed(2)} √ó ${item.qtd}</p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <button onclick="window.updateCartQtd('${item.id}', -1)" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl font-bold">-</button>
                                        <span class="font-bold text-lg">${item.qtd}</span>
                                        <button onclick="window.updateCartQtd('${item.id}', 1)" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl font-bold">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="bg-slate-50 p-6 rounded-2xl mt-6">
                            <div class="flex justify-between text-xl font-bold">
                                <span>Total</span>
                                <span class="text-rose-600">R$ ${total.toFixed(2)}</span>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mt-6">
                                <button onclick="window.handleFinalizeOrder('stripe')" class="btn-stripe">
                                    Pagar com Cart√£o (Stripe)
                                </button>
                                <button onclick="window.handleFinalizeOrder('pix_agora')" class="btn-primary">
                                    Pagar com PIX
                                </button>
                            </div>
                        </div>
                    `}
                </div>`;
        }

        // ... (mantenha o resto do seu render, incluindo renderPixModal, renderLogin, etc.)

        // Inicializa√ß√£o
        onAuthStateChanged(auth, (u) => {
            window.state.user = u;
            window.state.loading = false;
            window.scheduleRender();
        });
    </script>
</body>
</html>
