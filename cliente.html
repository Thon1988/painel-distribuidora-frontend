<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, serverTimestamp, increment, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
        authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
        projectId: "distribuidora-de-ovos-aline",
        storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
        messagingSenderId: "92187548716",
        appId: "1:92187548716:web:d61d18a29aa76aead7c589"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);
    const auth = getAuth(appFB);
    const appId = "app-egg-pro-transacional";

    // Estado Global
    window.state = {
        user: null,
        view: 'loja',
        produtos: [],
        pedidos: [],
        comprando: null,
        qtd: 1,
        loading: true,
        processing: false
    };

    // FunÃ§Ãµes de Interface
    window.showMessage = (msg) => {
        const container = document.getElementById('toast-root');
        const el = document.createElement('div');
        el.className = 'toast-msg';
        el.innerText = msg;
        container.appendChild(el);
        setTimeout(() => el.remove(), 3000);
    };

    window.setView = (v) => {
        window.state.view = v;
        window.render();
    };

    window.abrirCompra = (id) => {
        window.state.comprando = window.state.produtos.find(x => x.id === id);
        window.state.qtd = 1;
        window.render();
    };

    window.updateQtd = (val) => {
        window.state.qtd = Math.max(1, window.state.qtd + val);
        window.render();
    };

    window.handleSignOut = () => signOut(auth);

    // Login corrigido e com feedback claro
    window.handleLogin = async (e) => {
        e.preventDefault();

        const emailInput = document.getElementById('le');
        const passInput = document.getElementById('lp');

        if (!emailInput || !passInput) {
            window.showMessage("Erro: formulÃ¡rio nÃ£o encontrado.");
            return;
        }

        const email = emailInput.value.trim();
        const password = passInput.value;

        if (!email || !password) {
            window.showMessage("Preencha email e senha.");
            return;
        }

        window.state.loading = true;
        window.render();

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            window.showMessage("Login realizado com sucesso! ðŸ¥š");
            // O onAuthStateChanged vai detectar e atualizar tudo automaticamente
        } catch (error) {
            console.error("Erro no login:", error.code, error.message);

            let mensagem = "Erro ao fazer login.";
            if (error.code === 'auth/wrong-password') {
                mensagem = "Senha incorreta.";
            } else if (error.code === 'auth/user-not-found') {
                mensagem = "UsuÃ¡rio nÃ£o encontrado.";
            } else if (error.code === 'auth/invalid-email') {
                mensagem = "Email invÃ¡lido.";
            } else if (error.code === 'auth/too-many-requests') {
                mensagem = "Muitas tentativas. Tente novamente mais tarde.";
            }

            window.showMessage(mensagem);
        } finally {
            window.state.loading = false;
            window.render();
        }
    };

    // ... (mantenha todas as outras funÃ§Ãµes: handlePurchase, renderLoja, renderPedidos, renderModalCompra, etc.)

    // SincronizaÃ§Ã£o (jÃ¡ estava boa, sÃ³ adicionamos mais proteÃ§Ã£o)
    onAuthStateChanged(auth, (user) => {
        window.state.user = user;
        window.state.loading = !!user; // loading sÃ³ enquanto sincroniza

        if (user && (user.email === 'teste@lojista.com.br' || user.isAnonymous)) {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'estoque'), (snapshot) => {
                window.state.produtos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));
                window.state.loading = false;
                window.render();
            }, (err) => {
                console.error("Erro ao carregar estoque:", err);
                window.state.loading = false;
                window.render();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.state.pedidos = data
                    .filter(p => p.clienteId === user.uid)
                    .sort((a, b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));
                window.render();
            }, (err) => {
                console.error("Erro ao carregar pedidos:", err);
            });
        } else {
            window.state.loading = false;
            window.render();
        }
    });

    // Primeiro render ao carregar a pÃ¡gina
    document.addEventListener('DOMContentLoaded', () => {
        window.render();
    });
</script>
