<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AppEgg Admin | Gest√£o</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
body { font-family:'Inter',sans-serif;background:#f4f7f6;color:#1f2937 }
.logo-text{font-weight:900;color:#e11d48;font-size:1.6rem}
.nav-link{font-size:12px;font-weight:800;text-transform:uppercase;padding:14px 24px;border-radius:16px;color:#6b7280;transition:.2s}
.nav-link.active{background:#fff;color:#e11d48;border:2px solid #ffe4e6}
.card{background:#fff;border-radius:28px;border:1px solid #f1f1f1;padding:24px;margin-bottom:20px}
.btn{padding:14px;border-radius:16px;font-weight:900;text-transform:uppercase;font-size:11px}
</style>
</head>

<body>
<div id="app-root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
authDomain:"distribuidora-de-ovos-aline.firebaseapp.com",
projectId:"distribuidora-de-ovos-aline",
storageBucket:"distribuidora-de-ovos-aline.firebasestorage.app",
messagingSenderId:"92187548716",
appId:"1:92187548716:web:d61d18a29aa76aead7c589"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);
const API="https://painel-distribuidora-backend.onrender.com/api";

window.state={user:null,view:'pedidos',logs:[],produtos:[]};

onAuthStateChanged(auth,u=>{
state.user=u;
if(u){carregarProdutos();ouvirPedidos();}
render();
});

async function carregarProdutos(){
const r=await fetch(`${API}/produtos`);
state.produtos=await r.json();
}

function ouvirPedidos(){
const q=query(collection(db,"vendas_logs"),orderBy("criadoEm","desc"));
onSnapshot(q,s=>{
state.logs=s.docs.map(d=>({id:d.id,...d.data()}));
render();
});
}

window.render=()=>{
const root=document.getElementById("app-root");
if(!state.user){root.innerHTML=login();return}

root.innerHTML=`
<nav class="bg-white border-b px-8 h-24 flex justify-between items-center">
<div class="logo-text">AppEgg Admin</div>
<div class="flex gap-2">
<button onclick="state.view='pedidos';render()" class="nav-link ${state.view==='pedidos'?'active':''}">Pedidos</button>
<button onclick="state.view='estoque';render()" class="nav-link ${state.view==='estoque'?'active':''}">Estoque</button>
<button onclick="signOut(auth)" class="nav-link text-rose-600">Sair</button>
</div>
</nav>

<main class="p-8 max-w-6xl mx-auto">
${state.view==='pedidos'?renderPedidos():renderEstoque()}
</main>
`;
};

/* ================= PEDIDOS ================= */

function renderPedidos(){
return state.logs
.filter(l=>!['CANCELADO'].includes(l.status))
.map(l=>`
<div class="card border-l-8 ${l.status==='FINALIZADO'?'border-emerald-500':'border-blue-500'}">
<div class="flex justify-between mb-4">
<div>
<h3 class="font-black uppercase">${l.clienteNome}</h3>
<p class="text-[10px] text-gray-400">${l.recorrencia||'Pedido √önico'}</p>
</div>
<span class="text-[10px] font-black uppercase">${l.status}</span>
</div>

<div class="bg-gray-50 p-4 rounded-xl flex justify-between mb-4">
<span class="font-black">${l.quantidade}x ${l.produto}</span>
<span class="text-rose-600 font-black">R$ ${Number(l.valorTotal).toFixed(2)}</span>
</div>

<div class="grid grid-cols-2 md:grid-cols-4 gap-2">
<button onclick="mudarStatus('${l.id}','EMBALANDO')" class="btn bg-yellow-100">Embalando</button>
<button onclick="mudarStatus('${l.id}','SAIU PARA ENTREGA')" class="btn bg-blue-100">Saiu</button>
<button onclick="mudarStatus('${l.id}','PRONTO PARA RETIRADA')" class="btn bg-purple-100">Retirada</button>
<button onclick="finalizarPedido('${l.id}')" class="btn bg-emerald-600 text-white">Finalizar</button>
</div>
</div>
`).join('') || `<p class="text-center text-gray-300 font-black">SEM PEDIDOS</p>`;
}

/* ======== STATUS / ESTOQUE ======== */

window.mudarStatus=async(id,novo)=>{
const ref=doc(db,"vendas_logs",id);
const snap=await getDoc(ref);
const pedido=snap.data();

/* ‚Üì‚Üì‚Üì RESERVA ESTOQUE SOMENTE AO EMBALAR ‚Üì‚Üì‚Üì */
if(novo==='EMBALANDO' && pedido.status==='CRIADO'){
const prod=state.produtos.find(p=>p.id===pedido.produtoId);
if(prod){
await fetch(`${API}/produtos/${prod.id}`,{
method:"PUT",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({...prod,quantidade:prod.quantidade-pedido.quantidade})
});
}
}

await updateDoc(ref,{status:novo,ultimaAtualizacao:serverTimestamp()});
};

window.finalizarPedido=async(id)=>{
const ref=doc(db,"vendas_logs",id);
const snap=await getDoc(ref);
const p=snap.data();

await updateDoc(ref,{status:'FINALIZADO',horarioConcluido:serverTimestamp()});

/* WHATSAPP SOMENTE AGORA */
if(p.telefone){
window.open(`https://wa.me/${p.telefone.replace(/\D/g,'')}?text=${encodeURIComponent('Seu pedido AppEgg foi finalizado ü•ö')}`);
}
};

/* ================= ESTOQUE ================= */

function renderEstoque(){
return state.produtos.map(p=>`
<div class="card flex justify-between items-center">
<div>
<h4 class="font-black uppercase">${p.nome}</h4>
<p class="text-[10px] text-gray-400">${p.quantidade} em estoque</p>
</div>
</div>
`).join('');
}

/* ================= LOGIN ================= */

function login(){
return `
<div class="min-h-screen flex items-center justify-center bg-gray-900">
<form onsubmit="doLogin(event)" class="bg-white p-12 rounded-[48px] w-full max-w-md">
<div class="logo-text text-center mb-6">AppEgg</div>
<input name="email" class="w-full p-4 border rounded-2xl mb-3" placeholder="Email">
<input name="pass" type="password" class="w-full p-4 border rounded-2xl mb-6" placeholder="Senha">
<button class="w-full bg-rose-600 text-white py-5 rounded-2xl font-black uppercase">Entrar</button>
</form>
</div>`;
}

window.doLogin=async(e)=>{
e.preventDefault();
const f=new FormData(e.target);
await signInWithEmailAndPassword(auth,f.get("email"),f.get("pass"));
};
</script>
</body>
</html>
