<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äî App Ovos Aline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    
    :root {
      --primary: #e11d48; 
      --dark:    #be123c; 
      --brown:   #0f172a; 
      --cream:   #f8fafc; 
      --muted:   #64748b; 
      --white:   #ffffff;
      --green:   #10b981; 
      --red:     #e11d48; 
      --border:  #e2e8f0; 
      --shadow:  0 4px 20px rgba(15, 23, 42, .08);
    }
    
    body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--cream); color:var(--brown); min-height:100vh; display:flex; flex-direction:column; }
    
    header { background:linear-gradient(135deg,var(--dark),var(--primary)); color:#fff; padding:0 24px; height:64px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; box-shadow:0 3px 14px rgba(0,0,0,.15); }
    .h-logo { display:flex; align-items:center; gap:10px; font-size:1.15rem; font-weight:900; }
    .h-logo span { font-size:1.5rem; }
    .h-back { background:rgba(255,255,255,.2); border:2px solid rgba(255,255,255,.5); color:#fff; border-radius:50px; padding:6px 16px; cursor:pointer; font-size:.85rem; font-weight:700; text-decoration:none; display:flex; align-items:center; gap:6px; transition:background .2s; }
    .h-back:hover { background:rgba(255,255,255,.35); }
    
    .layout { display:flex; flex:1; }
    .nav { width:220px; background:var(--white); border-right:1px solid var(--border); padding:20px 0; flex-shrink:0; }
    .nav-title { font-size:.7rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:1px; padding:6px 20px 10px; }
    .nav-item { display:flex; align-items:center; gap:10px; padding:11px 20px; cursor:pointer; font-size:.9rem; font-weight:600; color:var(--muted); border-left:3px solid transparent; transition:all .15s; }
    .nav-item:hover  { background:#fff1f2; color:var(--brown); }
    .nav-item.active { background:#fff1f2; color:var(--dark); border-left-color:var(--dark); }
    .nav-item .ni { font-size:1.1rem; width:22px; text-align:center; }
    
    .content { flex:1; padding:28px 24px; overflow-y:auto; max-width:900px; margin: 0 auto; width: 100%;}
    .section { display:none; }
    .section.active { display:block; animation: fadeIn 0.3s ease-out; }
    
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .page-title { font-size:1.4rem; font-weight:900; margin-bottom:6px; letter-spacing:-0.5px; }
    .page-sub   { font-size:.85rem; color:var(--muted); margin-bottom:24px; font-weight:600; }
    hr.div { border:none; border-top:1px solid var(--border); margin:24px 0; }
    
    .card { background:var(--white); border-radius:20px; box-shadow:var(--shadow); padding:28px; margin-bottom:24px; border:1px solid var(--border); }
    .card h3 { font-size:1.1rem; font-weight:900; margin-bottom:20px; display:flex; align-items:center; gap:8px; color:var(--brown); }
    
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-grid.full { grid-template-columns:1fr; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:.75rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; }
    .field input, .field select, .field textarea { border:2px solid var(--border); border-radius:12px; padding:12px 16px; font-size:.92rem; color:var(--brown); font-family:inherit; transition:all .2s; outline:none; background:var(--cream); font-weight: 700;}
    .field input:focus, .field select:focus, .field textarea:focus { border-color:var(--primary); box-shadow:0 0 0 4px rgba(225,29,72,.15); background:var(--white);}
    .field input:disabled { opacity: 0.7; cursor: not-allowed; }
    .field textarea { resize:vertical; min-height:80px; }
    .color-row { display:flex; align-items:center; gap:12px; }
    .color-row input[type=color] { width:44px; height:40px; padding:2px; border-radius:10px; cursor:pointer; border:2px solid var(--border); }
    
    .btn { border:none; border-radius:50px; padding:12px 24px; font-size:.9rem; font-weight:800; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; justify-content:center; gap:8px; text-transform:uppercase; letter-spacing:0.5px;}
    .btn:hover:not(:disabled) { opacity:.9; transform:translateY(-2px); box-shadow: 0 4px 12px rgba(15,23,42,.15);}
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn-primary { background:linear-gradient(135deg,var(--dark),var(--primary)); color:#fff; box-shadow: 0 4px 12px rgba(225,29,72,.25); }
    .btn-green   { background:linear-gradient(135deg,var(--green),#059669); color:#fff; box-shadow: 0 4px 12px rgba(16,185,129,.25); }
    .btn-red     { background:var(--red); color:#fff; }
    .btn-ghost   { background:var(--white); border:2px solid var(--border); color:var(--muted); box-shadow:none; }
    .btn-ghost:hover:not(:disabled) { border-color:var(--primary); color:var(--dark); box-shadow: 0 4px 12px rgba(0,0,0,.05); }
    .btn-sm { padding:8px 16px; font-size:.8rem; }
    .save-row { margin-top:24px; display:flex; gap:10px; align-items:center; }
    
    .prod-list { display:flex; flex-direction:column; gap:16px; }
    .prod-item { background:var(--white); border:1px solid var(--border); border-radius:20px; padding:18px 24px; display:flex; align-items:center; gap:18px; transition:all .2s; }
    .prod-item:hover { box-shadow:var(--shadow); transform:translateY(-2px); border-color:#cbd5e1; }
    .prod-emoji { font-size:2.4rem; width:60px; height:60px; text-align:center; flex-shrink:0; background: var(--cream); border-radius: 16px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .prod-info  { flex:1; text-align: left; }
    .prod-info h4 { font-size:1.05rem; font-weight:900; color:var(--brown); margin:0; }
    .prod-info p  { font-size:.8rem; color:var(--muted); margin-top:4px; font-weight: 600;}
    .prod-price   { font-size:1.2rem; font-weight:900; color:var(--primary); min-width:80px; text-align:right; margin:0; }
    .prod-actions { display:flex; gap:8px; align-items:center; }
    .toggle-btn { background:var(--cream); border:1px solid var(--border); border-radius:12px; cursor:pointer; font-size:1.2rem; width:40px; height:40px; display:flex; align-items:center; justify-content:center; transition:all .2s; }
    .toggle-btn:hover { background: var(--border); }
    .inactive { opacity:.5; filter: grayscale(100%); }
    
    .modal-bg { position:fixed; inset:0; background:rgba(15,23,42,.7); backdrop-filter: blur(4px); z-index:300; display:flex; align-items:center; justify-content:center; padding:20px; opacity:0; pointer-events:none; transition:opacity .3s; }
    .modal-bg.open { opacity:1; pointer-events:all; }
    .modal-box { background:var(--white); border-radius:24px; width:min(520px,100%); max-height:90vh; overflow-y:auto; box-shadow:0 24px 60px rgba(0,0,0,.28); transform:scale(.95) translateY(20px); transition:all .3s cubic-bezier(0.34, 1.56, 0.64, 1); border:1px solid var(--border); text-align: left;}
    .modal-bg.open .modal-box { transform:scale(1) translateY(0); }
    .modal-head { background:linear-gradient(135deg,var(--dark),var(--primary)); color:#fff; padding:24px; border-radius:24px 24px 0 0; display:flex; justify-content:space-between; align-items:center; }
    .modal-head h3 { font-size:1.2rem; font-weight:900; margin:0;}
    .modal-close { background:rgba(255,255,255,.2); border:none; color:#fff; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; transition: background .2s; }
    .modal-close:hover { background:rgba(255,255,255,.35); }
    .modal-body-inner { padding:28px; display:flex; flex-direction:column; gap:16px; }
    
    .badge-opts { display:flex; gap:8px; flex-wrap:wrap; }
    .badge-opt { padding:6px 14px; border-radius:50px; font-size:.75rem; font-weight:800; cursor:pointer; border:2px solid transparent; transition:all .2s; text-transform: uppercase;}
    .badge-opt.sel { border-color:var(--brown); transform: scale(1.05); box-shadow:0 4px 10px rgba(0,0,0,.1); }
    .bo-none  { background:#e2e8f0; color:var(--muted); }
    .bo-red   { background:var(--primary); color:#fff; }
    .bo-amber { background:#f59e0b; color:#fff; }
    .bo-green { background:var(--green); color:#fff; }
    
    .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--brown); color:#fff; padding:14px 28px; border-radius:50px; font-size:.9rem; font-weight:800; z-index:600; white-space:nowrap; transition:transform .4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .toast.show { transform:translateX(-50%) translateY(0); }
    
    .preview-bar { background:linear-gradient(135deg,var(--green),#059669); color:#fff; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; font-size:.88rem; font-weight: 700; box-shadow:0 2px 10px rgba(16,185,129,.2);}
    .preview-bar a { color:#fff; font-weight:800; text-decoration:none; padding:6px 16px; background:rgba(255,255,255,.2); border-radius:50px; transition:background .2s; }
    .preview-bar a:hover { background:rgba(255,255,255,.35); }
    
    .pix-types { display:flex; flex-wrap:wrap; gap:8px; }
    .pix-type-btn { padding:8px 16px; border-radius:50px; border:2px solid var(--border); background:var(--white); color:var(--muted); font-size:.82rem; font-weight:800; cursor:pointer; transition:all .2s; }
    .pix-type-btn:hover { border-color:var(--primary); color:var(--primary); }
    .pix-type-btn.active { border-color:var(--primary); background:var(--primary); color:#fff; box-shadow:0 4px 10px rgba(225,29,72,.2); }

    /* Login Screen */
    #login-view { position:fixed; inset:0; background:var(--brown); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    #app-view { display:none; flex-direction:column; min-height:100vh; }
    
    @media (max-width:700px) {
      .layout { flex-direction:column; }
      .nav { width:100%; display:flex; flex-direction:row; overflow-x:auto; padding:0; border-right:none; border-bottom:1px solid var(--border); }
      .nav-title { display:none; }
      .nav-item { border-left:none; border-bottom:3px solid transparent; flex-direction:column; gap:4px; font-size:.72rem; padding:12px 16px; white-space:nowrap; }
      .nav-item.active { border-bottom-color:var(--dark); }
      .form-grid { grid-template-columns:1fr; }
      .content { padding:20px 16px; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-view">
    <div class="card" style="width:100%; max-width:400px; text-align:center; padding:40px; border-radius:32px; border:4px solid var(--border);">
        <h2 style="color:var(--primary); margin-bottom: 5px; font-size: 2.2rem; font-weight: 900; font-style: italic; letter-spacing: -1px;">App Ovos Aline</h2>
        <p style="color:var(--muted); font-size: 0.75rem; font-weight: 800; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px;">Gest√£o Admin Cloud</p>
        
        <form id="login-form" onsubmit="event.preventDefault(); window.fazerLogin();">
            <div class="field" style="margin-bottom: 15px;">
                <input type="email" id="login-email" placeholder="E-mail" value="thon@lojista.com.br" style="text-align:center;" required>
            </div>
            <div class="field" style="margin-bottom: 24px;">
                <input type="password" id="login-pass" placeholder="Palavra-passe" style="text-align:center;" required>
            </div>
            <button id="btn-login" type="submit" class="btn btn-primary" style="width:100%; justify-content:center; padding: 16px; font-size: 1rem;">Entrar no Painel</button>
        </form>
    </div>
</div>

<!-- APP -->
<div id="app-view">
    <header>
      <div class="h-logo"><span>ü•ö</span> App Ovos Aline</div>
      <button class="h-back" style="background: rgba(255,255,255,0.15); border: none;" onclick="window.fazerLogout()">Sair</button>
    </header>

    <div class="preview-bar">
      <span>‚úÖ Sincronizado com Firebase Cloud</span>
    </div>

    <div class="layout">
      <nav class="nav">
        <div class="nav-title">Menu</div>
        <div class="nav-item active" onclick="window.goTo('dashboard')"><span class="ni">üìä</span> Dashboard</div>
        <div class="nav-item" onclick="window.goTo('pedidos')"><span class="ni">üì¶</span> Pedidos</div>
        <div class="nav-item" onclick="window.goTo('produtos')"><span class="ni">ü•ö</span> Produtos</div>
        <div class="nav-item" onclick="window.goTo('loja')"><span class="ni">üè™</span> Loja</div>
        <div class="nav-item" onclick="window.goTo('pix')"><span class="ni">üíö</span> PIX</div>
        <div class="nav-item" onclick="window.goTo('aparencia')"><span class="ni">üé®</span> Cores</div>
      </nav>

      <div class="content">
          <main id="main-content" class="w-full"></main>
      </div>
    </div>
</div>

<!-- MODAL PRODUTO -->
<div class="modal-bg" id="prod-modal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="modal-prod-title">Novo Produto</h3>
      <button class="modal-close" onclick="window.closeProdModal()">‚úï</button>
    </div>
    <div class="modal-body-inner">
      <input type="hidden" id="mp-id" />
      
      <div class="form-grid">
        <div class="field" style="grid-column: span 2;">
            <label>Imagem (URL ou Upload)</label>
            <div style="display: flex; gap: 12px; align-items: center; margin-top: 4px;">
                <div id="mp-img-preview" style="width: 64px; height: 64px; border-radius: 12px; background: var(--cream); border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                    <span style="font-size: 1.5rem; color: var(--muted);">üì∑</span>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" id="mp-foto" placeholder="Cole o link da imagem" oninput="window.updateImgPreview()">
                    <input type="file" id="mp-file" accept="image/*" style="font-size: 0.8rem; padding: 6px; cursor: pointer; background: var(--white); border: 1px solid var(--border); border-radius: 8px;" onchange="window.handleFileUpload(event)">
                </div>
            </div>
        </div>

        <div class="field" style="grid-column: span 2;"><label>Nome</label><input id="mp-nome" placeholder="Ex: Ovos Brancos" /></div>
        <div class="field"><label>Tipo</label><input id="mp-tipo" placeholder="Tamanho G" /></div>
        <div class="field"><label>Emoji</label><input id="mp-emoji" placeholder="ü•ö" maxlength="4" /></div>
        <div class="field"><label>Embalagem</label><input type="text" id="mp-embalagem" placeholder="D√∫zia (12)"></div>
        <div class="field"><label>Pre√ßo (R$)</label><input id="mp-preco" type="number" min="0" step="0.01" placeholder="12.90" /></div>
      </div>
      <div class="field"><label>Descri√ß√£o</label><textarea id="mp-desc" rows="3" placeholder="Descri√ß√£o..."></textarea></div>
      <div class="field">
        <label>Badge</label>
        <div class="badge-opts">
          <div class="badge-opt bo-none sel" onclick="window.selBadge(this,'','')">Nenhuma</div>
          <div class="badge-opt bo-red" onclick="window.selBadge(this,'Popular','rose')">Popular</div>
          <div class="badge-opt bo-red" onclick="window.selBadge(this,'Top Venda','rose')">Top Venda</div>
          <div class="badge-opt bo-amber" onclick="window.selBadge(this,'Especial','amber')">Especial</div>
          <div class="badge-opt bo-green" onclick="window.selBadge(this,'Premium','green')">Premium</div>
          <div class="badge-opt bo-red" onclick="window.selBadge(this,'Novo','rose')">Novo</div>
          <div class="badge-opt bo-amber" onclick="window.selBadge(this,'Promo√ß√£o','amber')">Promo√ß√£o</div>
        </div>
        <input type="hidden" id="mp-badge" />
        <input type="hidden" id="mp-badgeClass" />
      </div>
      <div style="display:flex;gap:12px;margin-top:10px">
        <button id="btn-save-prod" class="btn btn-primary" style="flex:1" onclick="window.saveProd()">üíæ Guardar</button>
        <button class="btn btn-ghost" onclick="window.closeProdModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
    authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
    projectId: "distribuidora-de-ovos-aline",
    storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
    messagingSenderId: "92187548716",
    appId: "1:92187548716:web:d61d18a29aa76aead7c589"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = 'app-egg-pro-transacional';

window.produtos = [];
window.logs = [];
window.config = {nome:'App Ovos Aline', emoji:'ü•ö', slogan:'Qualidade Premium', heroTitle:'Ovos Fresquinhos', heroDesc:'', pixChave:'', pixTipo:'Celular', pixNome:'App Ovos Aline', pixCidade:'SAO PAULO', corPrimaria:'#e11d48', corSecundaria:'#be123c'};
window.state = {view:'dashboard'};
window.unsubs = [];

window.toast = (msg) => {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2500);
};

window.fmt = n => Number(n||0).toFixed(2).replace('.',',');

window.goTo = (sec) => {
    document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('active');
        if(el.getAttribute('onclick') && el.getAttribute('onclick').includes(`'${sec}'`)) el.classList.add('active');
    });
    window.state.view = sec;
    const m = document.getElementById('main-content');
    if(m) m.innerHTML = window.buildView();
    
    if(sec==='dashboard') window.renderDash();
    if(sec==='pedidos') window.renderPedidos();
    if(sec==='produtos') window.renderProds();
    if(sec==='pix') { window.loadPix(); setTimeout(()=>window.renderQR(), 100); }
    if(sec==='loja') window.loadLoja();
    if(sec==='aparencia') window.loadApar();
};

window.buildView = () => {
    const v = window.state.view;
    if(v==='dashboard') return '<div id="dash-content"></div>';
    if(v==='pedidos') return '<h2 class="page-title">Pedidos</h2><div id="pedidos-list"></div>';
    if(v==='produtos') return '<div style="display:flex;justify-content:space-between;margin-bottom:20px;"><h2 class="page-title">Produtos</h2><button class="btn btn-primary" onclick="window.openProdModal()">+ Adicionar</button></div><div id="prods-list"></div>';
    
    if(v==='pix') {
        const c = window.config;
        return `<h2 class="page-title">Configurar PIX</h2>
        <div class="card"><form onsubmit="event.preventDefault();window.savePix();">
        <div class="form-grid">
        <div class="field"><label>Tipo</label><select id="pixType"><option>Celular</option><option>CPF</option><option>CNPJ</option><option>E-mail</option><option>Chave Aleat√≥ria</option></select></div>
        <div class="field"><label>Chave</label><input id="pixKey" value="${c.pixChave||''}" required></div>
        <div class="field"><label>Nome</label><input id="pixNome" value="${c.pixNome||''}" maxlength="25" required></div>
        <div class="field"><label>Cidade</label><input id="pixCidade" value="${c.pixCidade||''}" maxlength="15" required></div>
        </div>
        <button type="submit" class="btn btn-green" style="width:100%;margin-top:20px;">Guardar PIX</button>
        </form>
        <div style="margin-top:30px;text-align:center;"><p style="font-size:0.8rem;color:var(--muted);margin-bottom:10px;">QR Code Teste (R$ 1,00)</p><div id="qr-container" style="display:inline-block;padding:10px;background:white;border-radius:12px;border:2px solid var(--border);"></div></div>
        </div>`;
    }
    
    if(v==='loja') {
        const c = window.config;
        return `<h2 class="page-title">Dados da Loja</h2>
        <div class="card"><form onsubmit="event.preventDefault();window.saveLoja();">
        <div class="form-grid">
        <div class="field"><label>Nome</label><input id="cfg-nome" value="${c.nome||''}" required></div>
        <div class="field"><label>Emoji</label><input id="cfg-emoji" value="${c.emoji||'ü•ö'}" maxlength="4"></div>
        <div class="field"><label>Slogan</label><input id="cfg-slogan" value="${c.slogan||''}"></div>
        <div class="field" style="grid-column:span 2;"><label>T√≠tulo Banner</label><input id="cfg-heroTitle" value="${c.heroTitle||''}"></div>
        <div class="field" style="grid-column:span 2;"><label>Descri√ß√£o Banner</label><textarea id="cfg-heroDesc" rows="2">${c.heroDesc||''}</textarea></div>
        </div>
        <button type="submit" class="btn btn-green" style="width:100%;margin-top:20px;">Guardar Loja</button>
        </form></div>`;
    }
    
    if(v==='aparencia') {
        const c = window.config;
        return `<h2 class="page-title">Cores do Tema</h2>
        <div class="card"><form onsubmit="event.preventDefault();window.saveApar();">
        <div class="form-grid">
        <div class="field"><label>Cor Principal</label><input type="color" id="cfg-corPrimaria" value="${c.corPrimaria||'#e11d48'}"></div>
        <div class="field"><label>Cor Secund√°ria</label><input type="color" id="cfg-corSecundaria" value="${c.corSecundaria||'#be123c'}"></div>
        </div>
        <button type="submit" class="btn btn-green" style="width:100%;margin-top:20px;">Guardar Cores</button>
        </form></div>`;
    }
    
    return '';
};

window.renderDash = () => {
    const d = document.getElementById('dash-content');
    if(!d) return;
    const active = window.logs.filter(l => !['FINALIZADO','CANCELADO'].includes(l.status));
    const total = active.reduce((a,l)=>a+(Number(l.valorTotal)||0),0);
    const ativos = window.produtos.filter(p=>p.ativo).length;
    
    d.innerHTML = `
    <h2 class="page-title">Dashboard</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;">
        <div class="card" style="background:linear-gradient(135deg,var(--primary),var(--dark));color:white;text-align:center;">
            <p style="font-size:0.8rem;opacity:0.9;margin-bottom:5px;">Pedidos Ativos</p>
            <h3 style="font-size:2.5rem;margin:0;">${active.length}</h3>
        </div>
        <div class="card" style="text-align:center;">
            <p style="font-size:0.8rem;color:var(--muted);margin-bottom:5px;">A Receber</p>
            <h3 style="font-size:2rem;margin:0;color:var(--primary);">R$ ${window.fmt(total)}</h3>
        </div>
        <div class="card" style="text-align:center;">
            <p style="font-size:0.8rem;color:var(--muted);margin-bottom:5px;">Produtos</p>
            <h3 style="font-size:2rem;margin:0;">${ativos}/${window.produtos.length}</h3>
        </div>
    </div>
    <div class="card"><h3>√öltimos Pedidos</h3><div>${active.slice(0,5).map(l=>`<div class="prod-item" style="margin-bottom:10px;"><div style="flex:1;"><h4 style="margin:0;">${l.dadosCliente?.nome||'An√¥nimo'}</h4><p style="margin:0;font-size:0.8rem;color:var(--muted);">R$ ${window.fmt(l.valorTotal)}</p></div><span style="padding:4px 12px;background:var(--cream);border-radius:20px;font-size:0.75rem;font-weight:800;">${l.status}</span></div>`).join('')||'<p style="color:var(--muted);text-align:center;">Sem pedidos</p>'}</div></div>
    `;
};

window.renderPedidos = () => {
    const list = document.getElementById('pedidos-list');
    if(!list) return;
    const pending = window.logs.filter(l=>!['FINALIZADO','CANCELADO'].includes(l.status));
    if(!pending.length) { list.innerHTML = '<div class="card"><p style="text-align:center;color:var(--muted);">Sem pedidos</p></div>'; return; }
    
    list.innerHTML = pending.map(l=>{
        const c = l.dadosCliente?.nome||'An√¥nimo';
        const itens = (l.itens||[]).map(i=>`${i.qtd||i.quantidade}x ${i.nome||i.produto}`).join(', ');
        return `<div class="card"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><div><h3 style="margin:0;">${c}</h3><p style="margin:4px 0 0;font-size:0.85rem;color:var(--muted);">${l.pedidoID||'#---'}</p></div><h3 style="margin:0;color:var(--primary);">R$ ${window.fmt(l.valorTotal)}</h3></div><p style="margin-bottom:10px;"><strong>Itens:</strong> ${itens}</p><p style="margin-bottom:10px;"><strong>Pagamento:</strong> ${(l.formaPagamento||'').toUpperCase()}</p><select onchange="window.updateStatus('${l.id}',this.value)" style="width:100%;padding:10px;border-radius:10px;border:2px solid var(--border);font-weight:800;"><option ${l.status==='CRIADO'?'selected':''}>CRIADO</option><option ${l.status==='AGUARDANDO PIX'?'selected':''}>AGUARDANDO PIX</option><option ${l.status==='EM SEPARA√á√ÉO'?'selected':''}>EM SEPARA√á√ÉO</option><option ${l.status==='SAIU PARA ENTREGA'?'selected':''}>SAIU PARA ENTREGA</option><option ${l.status==='PRONTO PARA RETIRADA'?'selected':''}>PRONTO PARA RETIRADA</option><option ${l.status==='FINALIZADO'?'selected':''}>FINALIZADO</option><option ${l.status==='CANCELADO'?'selected':''}>CANCELADO</option></select></div>`;
    }).join('');
};

window.updateStatus = async (id, status) => {
    await updateDoc(doc(db,'artifacts',appId,'public','data','vendas_logs',id), {status, updatedAt:serverTimestamp()});
    window.toast('‚úÖ Status atualizado');
};

window.renderProds = () => {
    const list = document.getElementById('prods-list');
    if(!list) return;
    if(!window.produtos.length) {
        list.innerHTML = '<div class="card" style="text-align:center;padding:40px;"><p style="color:var(--muted);margin-bottom:20px;">Cat√°logo vazio</p><button class="btn btn-primary" onclick="window.seedProds()">Carregar Produtos Padr√£o</button></div>';
        return;
    }
    list.innerHTML = window.produtos.map(p=>{
        const img = (p.foto_url && p.foto_url.length>5) ? `<img src="${p.foto_url}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">` : (p.emoji||'ü•ö');
        return `<div class="prod-item ${p.ativo?'':'inactive'}"><div class="prod-emoji" style="padding:${p.foto_url?'0':'4px'};">${img}</div><div class="prod-info"><h4>${p.nome||''}</h4><p>${p.tipo||''} ‚Ä¢ ${p.embalagem||'Unidade'}</p></div><div class="prod-price">R$ ${window.fmt(p.preco)}</div><div class="prod-actions"><button class="toggle-btn" onclick="window.toggleProd('${p.id}')">${p.ativo?'üü¢':'‚ö´'}</button><button class="btn btn-ghost btn-sm" onclick="window.openProdModal('${p.id}')">Editar</button><button class="btn btn-red btn-sm" onclick="window.delProd('${p.id}')">üóë</button></div></div>`;
    }).join('');
};

window.toggleProd = async (id) => {
    const p = window.produtos.find(x=>x.id===id);
    if(p) {
        await updateDoc(doc(db,'artifacts',appId,'public','data','estoque',id), {ativo:!p.ativo});
        window.toast(p.ativo?'‚ö´ Ocultado':'üü¢ Ativado');
    }
};

window.delProd = async (id) => {
    if(confirm('Eliminar produto?')) {
        await deleteDoc(doc(db,'artifacts',appId,'public','data','estoque',id));
        window.toast('üóë Eliminado');
    }
};

window.openProdModal = (id=null) => {
    window.editingId = id;
    document.getElementById('modal-prod-title').textContent = id?'Editar':'Novo Produto';
    const p = id ? window.produtos.find(x=>x.id===id) : {};
    document.getElementById('mp-id').value = id||'';
    document.getElementById('mp-nome').value = p.nome||'';
    document.getElementById('mp-emoji').value = p.emoji||'ü•ö';
    document.getElementById('mp-tipo').value = p.tipo||'';
    document.getElementById('mp-embalagem').value = p.embalagem||'D√∫zia (12)';
    document.getElementById('mp-preco').value = p.preco||'';
    document.getElementById('mp-desc').value = p.desc||'';
    document.getElementById('mp-badge').value = p.badge||'';
    document.getElementById('mp-badgeClass').value = p.badgeClass||'';
    document.getElementById('mp-foto').value = p.foto_url||'';
    window.updateImgPreview();
    document.querySelectorAll('.badge-opt').forEach(el=>{
        el.classList.remove('sel');
        if(el.textContent.includes(p.badge||'')) el.classList.add('sel');
    });
    document.getElementById('prod-modal').classList.add('open');
};

window.closeProdModal = () => document.getElementById('prod-modal').classList.remove('open');

window.saveProd = async () => {
    const nome = document.getElementById('mp-nome').value.trim();
    const preco = parseFloat(document.getElementById('mp-preco').value);
    if(!nome || isNaN(preco)) { window.toast('‚ö†Ô∏è Preencha nome e pre√ßo'); return; }
    
    const btn = document.getElementById('btn-save-prod');
    btn.disabled = true; btn.textContent = 'A guardar...';
    
    const docId = window.editingId || crypto.randomUUID();
    let ativo = true;
    if(window.editingId) {
        const p = window.produtos.find(x=>x.id===window.editingId);
        if(p && p.hasOwnProperty('ativo')) ativo = p.ativo;
    }
    
    const payload = {
        nome,
        emoji: document.getElementById('mp-emoji').value||'ü•ö',
        tipo: document.getElementById('mp-tipo').value,
        embalagem: document.getElementById('mp-embalagem').value||'Unidade',
        preco,
        desc: document.getElementById('mp-desc').value,
        badge: document.getElementById('mp-badge').value,
        badgeClass: document.getElementById('mp-badgeClass').value,
        foto_url: document.getElementById('mp-foto').value,
        ativo,
        updatedAt: serverTimestamp()
    };
    
    try {
        await setDoc(doc(db,'artifacts',appId,'public','data','estoque',docId), payload, {merge:true});
        window.closeProdModal();
        window.toast('‚úÖ Guardado');
    } catch(e) { window.toast('Erro'); }
    finally { btn.disabled=false; btn.textContent='üíæ Guardar'; }
};

window.seedProds = async () => {
    const defaults = [
        {nome:'Ovos Brancos Pequenos',emoji:'ü•ö',tipo:'Tamanho P',embalagem:'D√∫zia (12)',preco:8.90,desc:'Ovos brancos pequenos',badge:'',badgeClass:'',foto_url:'',ativo:true},
        {nome:'Ovos Brancos M√©dios',emoji:'ü•ö',tipo:'Tamanho M',embalagem:'Cartela (30)',preco:21.90,desc:'Favorito',badge:'',badgeClass:'',foto_url:'',ativo:true},
        {nome:'Ovos Brancos Grandes',emoji:'ü•ö',tipo:'Tamanho G',embalagem:'D√∫zia (12)',preco:12.90,desc:'Gema volumosa',badge:'Popular',badgeClass:'rose',foto_url:'',ativo:true},
        {nome:'Ovos Extra Grandes',emoji:'ü•ö',tipo:'Tamanho XG',embalagem:'D√∫zia (12)',preco:14.90,desc:'Os maiores',badge:'Top Venda',badgeClass:'rose',foto_url:'',ativo:true},
        {nome:'Ovos Caipira',emoji:'üêì',tipo:'Caipira',embalagem:'Meia D√∫zia (6)',preco:9.90,desc:'Gema laranja',badge:'Especial',badgeClass:'amber',foto_url:'',ativo:true},
        {nome:'Ovos Org√¢nicos',emoji:'üåø',tipo:'Org√¢nico',embalagem:'Caixa (120)',preco:95.90,desc:'100% org√¢nicos',badge:'Premium',badgeClass:'green',foto_url:'',ativo:true}
    ];
    window.toast('Carregando...');
    await Promise.all(defaults.map(p=>setDoc(doc(db,'artifacts',appId,'public','data','estoque',crypto.randomUUID()),{...p,updatedAt:serverTimestamp()})));
    window.toast('‚úÖ Carregado');
};

window.loadPix = () => {
    const t = document.getElementById('pixType');
    const k = document.getElementById('pixKey');
    const n = document.getElementById('pixNome');
    const c = document.getElementById('pixCidade');
    if(t) t.value = window.config.pixTipo||'Celular';
    if(k) k.value = window.config.pixChave||'';
    if(n) n.value = window.config.pixNome||'';
    if(c) c.value = window.config.pixCidade||'';
};

window.savePix = async () => {
    const type = document.getElementById('pixType').value;
    const key = document.getElementById('pixKey').value.trim();
    const nome = document.getElementById('pixNome').value.trim();
    const cidade = document.getElementById('pixCidade').value.trim();
    
    await setDoc(doc(db,'artifacts',appId,'public','data','settings','pix_config'), {
        type, rawKey:key, key, nomeRecebedor:nome, cidade, updatedAt:serverTimestamp()
    }, {merge:true});
    window.toast('‚úÖ PIX guardado');
    setTimeout(()=>window.renderQR(), 100);
};

window.renderQR = () => {
    const cont = document.getElementById('qr-container');
    if(!cont) return;
    cont.innerHTML = '';
    
    const key = window.config.pixChave || document.getElementById('pixKey')?.value || '11999999999';
    const nome = window.config.pixNome || document.getElementById('pixNome')?.value || 'LOJA';
    const cidade = window.config.pixCidade || document.getElementById('pixCidade')?.value || 'BRASIL';
    
    const payload = window.pixPayload(key, 1.00, nome, cidade, 'TESTE');
    
    setTimeout(()=>{
        try {
            if(typeof QRCode !== 'undefined') {
                new QRCode(cont, {text:payload, width:150, height:150, colorDark:'#be123c', colorLight:'#fff'});
            }
        } catch(e) { console.error('QRCode error:', e); }
    }, 50);
};

window.loadLoja = () => {
    const els = {
        'cfg-nome': window.config.nome,
        'cfg-emoji': window.config.emoji,
        'cfg-slogan': window.config.slogan,
        'cfg-heroTitle': window.config.heroTitle,
        'cfg-heroDesc': window.config.heroDesc
    };
    Object.entries(els).forEach(([id,val])=>{
        const el = document.getElementById(id);
        if(el) el.value = val||'';
    });
};

window.saveLoja = async () => {
    await setDoc(doc(db,'artifacts',appId,'public','data','settings','store_config'), {
        nome: document.getElementById('cfg-nome').value,
        emoji: document.getElementById('cfg-emoji').value,
        slogan: document.getElementById('cfg-slogan').value,
        heroTitle: document.getElementById('cfg-heroTitle').value,
        heroDesc: document.getElementById('cfg-heroDesc').value,
        updatedAt: serverTimestamp()
    }, {merge:true});
    window.toast('‚úÖ Loja guardada');
};

window.loadApar = () => {
    const p = document.getElementById('cfg-corPrimaria');
    const s = document.getElementById('cfg-corSecundaria');
    if(p) p.value = window.config.corPrimaria||'#e11d48';
    if(s) s.value = window.config.corSecundaria||'#be123c';
};

window.saveApar = async () => {
    await setDoc(doc(db,'artifacts',appId,'public','data','settings','store_config'), {
        corPrimaria: document.getElementById('cfg-corPrimaria').value,
        corSecundaria: document.getElementById('cfg-corSecundaria').value,
        updatedAt: serverTimestamp()
    }, {merge:true});
    window.toast('‚úÖ Cores guardadas');
};

window.updateImgPreview = () => {
    const val = document.getElementById('mp-foto').value;
    const prev = document.getElementById('mp-img-preview');
    if(prev) prev.innerHTML = val ? `<img src="${val}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">` : 'üì∑';
};

window.handleFileUpload = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        document.getElementById('mp-foto').value = ev.target.result;
        window.updateImgPreview();
    };
    reader.readAsDataURL(file);
};

window.selBadge = (el, badge, cls) => {
    document.querySelectorAll('.badge-opt').forEach(x=>x.classList.remove('sel'));
    el.classList.add('sel');
    document.getElementById('mp-badge').value = badge;
    document.getElementById('mp-badgeClass').value = cls;
};

window.removeAccents = (s) => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\x00-\x7F]/g,'').toUpperCase();

window.pixPayload = (key, amount, name, city, txid) => {
    const tlv = (id,v) => id + String(v.length).padStart(2,'0') + v;
    const ma = tlv('00','BR.GOV.BCB.PIX') + tlv('01', key);
    let p = tlv('00','01') + tlv('26',ma) + tlv('52','0000') + tlv('53','986') + tlv('54',Number(amount).toFixed(2)) + tlv('58','BR') + tlv('59',window.removeAccents(name).slice(0,25)||'LOJA') + tlv('60',window.removeAccents(city).slice(0,15)||'BR') + tlv('62',tlv('05',window.removeAccents(txid).slice(0,25)||'TESTE'));
    return p + tlv('63', window.crc16(p+'6304'));
};

window.crc16 = (s) => {
    let c = 0xFFFF;
    for(let i=0; i<s.length; i++) {
        c ^= (s.charCodeAt(i) & 0xFF) << 8;
        for(let j=0; j<8; j++) c = (c & 0x8000) ? ((c << 1) ^ 0x1021) & 0xFFFF : (c << 1) & 0xFFFF;
    }
    return (c & 0xFFFF).toString(16).toUpperCase().padStart(4,'0');
};

window.fazerLogin = async () => {
    const btn = document.getElementById('btn-login');
    const em = document.getElementById('login-email').value.trim();
    const ps = document.getElementById('login-pass').value;
    
    btn.disabled = true; btn.textContent = 'A validar...';
    
    if(em==='thon@lojista.com.br' && ps==='admin123') {
        localStorage.setItem('admin_bypass','true');
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'flex';
        window.initListeners();
        window.goTo('dashboard');
        return;
    }
    
    alert('Acesso negado');
    btn.disabled = false; btn.textContent = 'Entrar no Painel';
};

window.fazerLogout = () => {
    localStorage.removeItem('admin_bypass');
    window.unsubs.forEach(u=>u());
    window.unsubs = [];
    document.getElementById('login-view').style.display = 'flex';
    document.getElementById('app-view').style.display = 'none';
    signOut(auth);
};

window.initListeners = () => {
    const u1 = onSnapshot(collection(db,'artifacts',appId,'public','data','estoque'), s => {
        window.produtos = s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
        if(window.state.view==='produtos') window.renderProds();
        if(window.state.view==='dashboard') window.renderDash();
    });
    
    const u2 = onSnapshot(collection(db,'artifacts',appId,'public','data','vendas_logs'), s => {
        window.logs = s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{
            const tA = a.criadoEm?.seconds||0;
            const tB = b.criadoEm?.seconds||0;
            return tB - tA;
        });
        if(window.state.view==='pedidos') window.renderPedidos();
        if(window.state.view==='dashboard') window.renderDash();
    });
    
    const u3 = onSnapshot(doc(db,'artifacts',appId,'public','data','settings','store_config'), s => {
        if(s.exists()) {
            window.config = {...window.config, ...s.data()};
            if(window.state.view==='loja') window.loadLoja();
            if(window.state.view==='aparencia') window.loadApar();
        }
    });
    
    const u4 = onSnapshot(doc(db,'artifacts',appId,'public','data','settings','pix_config'), s => {
        if(s.exists()) {
            const d = s.data();
            window.config.pixChave = d.rawKey||'';
            window.config.pixTipo = d.type||'Celular';
            window.config.pixNome = d.nomeRecebedor||'';
            window.config.pixCidade = d.cidade||'';
            if(window.state.view==='pix') window.loadPix();
        }
    });
    
    window.unsubs = [u1, u2, u3, u4];
};

(async () => {
    await signInAnonymously(auth).catch(()=>{});
    
    if(localStorage.getItem('admin_bypass')==='true') {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'flex';
        window.initListeners();
        window.goTo('dashboard');
    }
})();
</script>
</body>
</html>
