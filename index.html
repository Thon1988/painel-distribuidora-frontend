<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äî App Ovos Aline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script>
    // Stub preventivo para evitar erros de clique antes do carregamento completo do m√≥dulo
    window.fazerLogin = function() {
        alert("A ligar ao servidor. Por favor, aguarde um instante...");
    };
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    
    :root {
      /* Identidade Premium Vermelha (Rose/Slate) perfeitamente integrada no seu layout */
      --primary: #e11d48; /* Rose 600 */
      --dark:    #be123c; /* Rose 700 */
      --brown:   #0f172a; /* Slate 900 */
      --cream:   #f8fafc; /* Slate 50 */
      --muted:   #64748b; /* Slate 500 */
      --white:   #ffffff;
      --green:   #10b981; /* Emerald 500 */
      --red:     #e11d48; /* Rose 600 */
      --border:  #e2e8f0; /* Slate 200 */
      --shadow:  0 4px 20px rgba(15, 23, 42, .08);
    }
    
    body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--cream); color:var(--brown); min-height:100vh; display:flex; flex-direction:column; }
    
    header { background:linear-gradient(135deg,var(--dark),var(--primary)); color:#fff; padding:0 24px; height:64px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; box-shadow:0 3px 14px rgba(0,0,0,.15); }
    .h-logo { display:flex; align-items:center; gap:10px; font-size:1.15rem; font-weight:900; }
    .h-logo span { font-size:1.5rem; }
    .h-back { background:rgba(255,255,255,.2); border:2px solid rgba(255,255,255,.5); color:#fff; border-radius:50px; padding:6px 16px; cursor:pointer; font-size:.85rem; font-weight:700; text-decoration:none; display:flex; align-items:center; gap:6px; transition:background .2s; }
    .h-back:hover { background:rgba(255,255,255,.35); }
    
    .layout { display:flex; flex:1; }
    .nav { width:220px; background:var(--white); border-right:1px solid var(--border); padding:20px 0; flex-shrink:0; }
    .nav-title { font-size:.7rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:1px; padding:6px 20px 10px; }
    .nav-item { display:flex; align-items:center; gap:10px; padding:11px 20px; cursor:pointer; font-size:.9rem; font-weight:600; color:var(--muted); border-left:3px solid transparent; transition:all .15s; }
    .nav-item:hover  { background:#fff1f2; color:var(--brown); }
    .nav-item.active { background:#fff1f2; color:var(--dark); border-left-color:var(--dark); }
    .nav-item .ni { font-size:1.1rem; width:22px; text-align:center; }
    
    .content { flex:1; padding:28px 24px; overflow-y:auto; max-width:900px; margin: 0 auto; width: 100%;}
    .section { display:none; }
    .section.active { display:block; animation: fadeIn 0.3s ease-out; }
    
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .page-title { font-size:1.4rem; font-weight:900; margin-bottom:6px; letter-spacing:-0.5px; }
    .page-sub   { font-size:.85rem; color:var(--muted); margin-bottom:24px; font-weight:600; }
    hr.div { border:none; border-top:1px solid var(--border); margin:24px 0; }
    
    .card { background:var(--white); border-radius:20px; box-shadow:var(--shadow); padding:28px; margin-bottom:24px; border:1px solid var(--border); }
    .card h3 { font-size:1.1rem; font-weight:900; margin-bottom:20px; display:flex; align-items:center; gap:8px; color:var(--brown); }
    
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-grid.full { grid-template-columns:1fr; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:.75rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; }
    .field input, .field select, .field textarea { border:2px solid var(--border); border-radius:12px; padding:12px 16px; font-size:.92rem; color:var(--brown); font-family:inherit; transition:all .2s; outline:none; background:var(--cream); font-weight: 700;}
    .field input:focus, .field select:focus, .field textarea:focus { border-color:var(--primary); box-shadow:0 0 0 4px rgba(225,29,72,.15); background:var(--white);}
    .field input:disabled { opacity: 0.7; cursor: not-allowed; }
    .field textarea { resize:vertical; min-height:80px; }
    .color-row { display:flex; align-items:center; gap:12px; }
    .color-row input[type=color] { width:44px; height:40px; padding:2px; border-radius:10px; cursor:pointer; border:2px solid var(--border); }
    
    .btn { border:none; border-radius:50px; padding:12px 24px; font-size:.9rem; font-weight:800; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; justify-content:center; gap:8px; text-transform:uppercase; letter-spacing:0.5px;}
    .btn:hover:not(:disabled) { opacity:.9; transform:translateY(-2px); box-shadow: 0 4px 12px rgba(15,23,42,.15);}
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn-primary { background:linear-gradient(135deg,var(--dark),var(--primary)); color:#fff; box-shadow: 0 4px 12px rgba(225,29,72,.25); }
    .btn-green   { background:linear-gradient(135deg,var(--green),#059669); color:#fff; box-shadow: 0 4px 12px rgba(16,185,129,.25); }
    .btn-red     { background:var(--red); color:#fff; }
    .btn-ghost   { background:var(--white); border:2px solid var(--border); color:var(--muted); box-shadow:none; }
    .btn-ghost:hover:not(:disabled) { border-color:var(--primary); color:var(--dark); box-shadow: 0 4px 12px rgba(0,0,0,.05); }
    .btn-sm { padding:8px 16px; font-size:.8rem; }
    .save-row { margin-top:24px; display:flex; gap:10px; align-items:center; }
    
    .prod-list { display:flex; flex-direction:column; gap:16px; }
    .prod-item { background:var(--white); border:1px solid var(--border); border-radius:20px; padding:18px 24px; display:flex; align-items:center; gap:18px; transition:all .2s; }
    .prod-item:hover { box-shadow:var(--shadow); transform:translateY(-2px); border-color:#cbd5e1; }
    .prod-emoji { font-size:2.4rem; width:60px; height:60px; text-align:center; flex-shrink:0; background: var(--cream); border-radius: 16px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .prod-info  { flex:1; text-align: left; }
    .prod-info h4 { font-size:1.05rem; font-weight:900; color:var(--brown); margin:0; }
    .prod-info p  { font-size:.8rem; color:var(--muted); margin-top:4px; font-weight: 600;}
    .prod-price   { font-size:1.2rem; font-weight:900; color:var(--primary); min-width:80px; text-align:right; margin:0; }
    .prod-actions { display:flex; gap:8px; align-items:center; }
    .toggle-btn { background:var(--cream); border:1px solid var(--border); border-radius:12px; cursor:pointer; font-size:1.2rem; width:40px; height:40px; display:flex; align-items:center; justify-content:center; transition:all .2s; }
    .toggle-btn:hover { background: var(--border); }
    .inactive { opacity:.5; filter: grayscale(100%); }
    
    .modal-bg { position:fixed; inset:0; background:rgba(15,23,42,.7); backdrop-filter: blur(4px); z-index:300; display:flex; align-items:center; justify-content:center; padding:20px; opacity:0; pointer-events:none; transition:opacity .3s; }
    .modal-bg.open { opacity:1; pointer-events:all; }
    .modal-box { background:var(--white); border-radius:24px; width:min(520px,100%); max-height:90vh; overflow-y:auto; box-shadow:0 24px 60px rgba(0,0,0,.28); transform:scale(.95) translateY(20px); transition:all .3s cubic-bezier(0.34, 1.56, 0.64, 1); border:1px solid var(--border); text-align: left;}
    .modal-bg.open .modal-box { transform:scale(1) translateY(0); }
    .modal-head { background:linear-gradient(135deg,var(--dark),var(--primary)); color:#fff; padding:24px; border-radius:24px 24px 0 0; display:flex; justify-content:space-between; align-items:center; }
    .modal-head h3 { font-size:1.2rem; font-weight:900; margin:0;}
    .modal-close { background:rgba(255,255,255,.2); border:none; color:#fff; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; transition: background .2s; }
    .modal-close:hover { background:rgba(255,255,255,.35); }
    .modal-body-inner { padding:28px; display:flex; flex-direction:column; gap:16px; }
    
    .badge-opts { display:flex; gap:8px; flex-wrap:wrap; }
    .badge-opt { padding:6px 14px; border-radius:50px; font-size:.75rem; font-weight:800; cursor:pointer; border:2px solid transparent; transition:all .2s; text-transform: uppercase;}
    .badge-opt.sel { border-color:var(--brown); transform: scale(1.05); box-shadow:0 4px 10px rgba(0,0,0,.1); }
    .bo-none  { background:#e2e8f0; color:var(--muted); }
    .bo-red   { background:var(--primary); color:#fff; }
    .bo-amber { background:#f59e0b; color:#fff; }
    .bo-green { background:var(--green); color:#fff; }
    
    .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--brown); color:#fff; padding:14px 28px; border-radius:50px; font-size:.9rem; font-weight:800; z-index:600; white-space:nowrap; transition:transform .4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .toast.show { transform:translateX(-50%) translateY(0); }
    
    .preview-bar { background:linear-gradient(135deg,var(--green),#059669); color:#fff; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; font-size:.88rem; font-weight: 700; box-shadow:0 2px 10px rgba(16,185,129,.2);}
    .preview-bar a { color:#fff; font-weight:800; text-decoration:none; padding:6px 16px; background:rgba(255,255,255,.2); border-radius:50px; transition:background .2s; }
    .preview-bar a:hover { background:rgba(255,255,255,.35); }
    
    .pix-types { display:flex; flex-wrap:wrap; gap:8px; }
    .pix-type-btn { padding:8px 16px; border-radius:50px; border:2px solid var(--border); background:var(--white); color:var(--muted); font-size:.82rem; font-weight:800; cursor:pointer; transition:all .2s; }
    .pix-type-btn:hover { border-color:var(--primary); color:var(--primary); }
    .pix-type-btn.active { border-color:var(--primary); background:var(--primary); color:#fff; box-shadow:0 4px 10px rgba(225,29,72,.2); }

    /* Login Screen Setup */
    #login-view { position:fixed; inset:0; background:var(--brown); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    #app-view { display:none; flex-direction:column; min-height:100vh; }
    
    @media (max-width:700px) {
      .layout { flex-direction:column; }
      .nav { width:100%; display:flex; flex-direction:row; overflow-x:auto; padding:0; border-right:none; border-bottom:1px solid var(--border); }
      .nav-title { display:none; }
      .nav-item { border-left:none; border-bottom:3px solid transparent; flex-direction:column; gap:4px; font-size:.72rem; padding:12px 16px; white-space:nowrap; }
      .nav-item.active { border-bottom-color:var(--dark); }
      .form-grid { grid-template-columns:1fr; }
      .content { padding:20px 16px; }
    }
  </style>
</head>
<body>

<!-- ECR√É DE LOGIN ESTILO PREMIUM -->
<div id="login-view">
    <div class="card" style="width:100%; max-width:400px; text-align:center; padding:40px; border-radius:32px; border:4px solid var(--border);">
        <h2 style="color:var(--primary); margin-bottom: 5px; font-size: 2.2rem; font-weight: 900; font-style: italic; letter-spacing: -1px;">App Ovos Aline</h2>
        <p style="color:var(--muted); font-size: 0.75rem; font-weight: 800; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px;">Gest√£o Admin Cloud</p>
        
        <form id="login-form" onsubmit="event.preventDefault(); window.fazerLogin();">
            <div class="field" style="margin-bottom: 15px;">
                <input type="email" id="login-email" placeholder="E-mail" value="thon@lojista.com.br" style="text-align:center;" required>
            </div>
            <div class="field" style="margin-bottom: 24px;">
                <input type="password" id="login-pass" placeholder="Palavra-passe" style="text-align:center;" required>
            </div>
            <button id="btn-login" type="submit" class="btn btn-primary" style="width:100%; justify-content:center; padding: 16px; font-size: 1rem;" disabled>A carregar...</button>
        </form>
    </div>
</div>

<!-- ESTRUTURA PRINCIPAL DO APP -->
<div id="app-view">
    <header>
      <div class="h-logo"><span>ü•ö</span> App Ovos Aline</div>
      <div style="display:flex; gap:10px;">
        <button class="h-back" style="background: rgba(255,255,255,0.15); border: none;" onclick="window.fazerLogout()">Sair do Painel</button>
      </div>
    </header>

    <div class="preview-bar">
      <span>‚úÖ As altera√ß√µes s√£o gravadas na Base de Dados Cloud em tempo real.</span>
    </div>

    <div class="layout">
      <nav class="nav">
        <div class="nav-title">Menu de Gest√£o</div>
        <div class="nav-item active" onclick="window.goTo('dashboard')"><span class="ni">üìä</span> Administrativo</div>
        <div class="nav-item" onclick="window.goTo('pedidos')"><span class="ni">üì¶</span> Encomendas</div>
        <div class="nav-item" onclick="window.goTo('produtos')"><span class="ni">ü•ö</span> Cat√°logo</div>
        <div class="nav-item" onclick="window.goTo('loja')"><span class="ni">üè™</span> Dados da Loja</div>
        <div class="nav-item" onclick="window.goTo('pix')"><span class="ni">üíö</span> Configurar PIX</div>
        <div class="nav-item" onclick="window.goTo('aparencia')"><span class="ni">üé®</span> Apar√™ncia</div>
      </nav>

      <div class="content">
          <main id="main-content" class="w-full">
              <!-- CONTE√öDO RENDERIZADO VIA JAVASCRIPT AQUI -->
          </main>
      </div>
    </div>
</div>

<!-- MODAL DE PRODUTO -->
<div class="modal-bg" id="prod-modal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="modal-prod-title">Novo Produto</h3>
      <button class="modal-close" onclick="window.closeProdModal()">‚úï</button>
    </div>
    <div class="modal-body-inner">
      <input type="hidden" id="mp-id" />
      
      <div class="form-grid">
        <div class="field" style="grid-column: span 2;">
            <label>Imagem do Produto (Colar URL ou Fazer Upload)</label>
            <div style="display: flex; gap: 12px; align-items: center; margin-top: 4px;">
                <div id="mp-img-preview" style="width: 64px; height: 64px; border-radius: 12px; background: var(--cream); border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                    <span style="font-size: 1.5rem; color: var(--muted);">üì∑</span>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" id="mp-foto" placeholder="Cole o link da imagem (http://...)" oninput="window.updateImgPreview()">
                    <input type="file" id="mp-file" accept="image/*" style="font-size: 0.8rem; padding: 6px; cursor: pointer; background: var(--white); border: 1px solid var(--border); border-radius: 8px;" onchange="window.handleFileUpload(event)">
                </div>
            </div>
        </div>

        <div class="field" style="grid-column: span 2;"><label>Nome do Produto</label><input id="mp-nome" placeholder="Ex: Ovos Brancos" /></div>
        <div class="field"><label>Tipo / Subt√≠tulo</label><input id="mp-tipo" placeholder="Ex: Tamanho G" /></div>
        <div class="field"><label>Emoji (Opcional)</label><input id="mp-emoji" placeholder="ü•ö" maxlength="4" /></div>
        
        <div class="field">
            <label>Formato / Embalagem</label>
            <input type="text" id="mp-embalagem" list="mp-embalagem-list" placeholder="Ex: Cartela (20)" style="cursor: text;">
            <datalist id="mp-embalagem-list">
                <option value="Unidade"></option>
                <option value="Meia D√∫zia (6)"></option>
                <option value="D√∫zia (12)"></option>
                <option value="Cartela (30)"></option>
                <option value="Caixa com 120 ovos"></option>
            </datalist>
        </div>
        
        <div class="field"><label>Pre√ßo (R$)</label><input id="mp-preco" type="number" min="0" step="0.01" placeholder="12.90" /></div>
      </div>
      <div class="field"><label>Descri√ß√£o Longa</label><textarea id="mp-desc" rows="3" placeholder="Descreva o produto com carinho..."></textarea></div>
      <div class="field">
        <label>Etiqueta Promocional (Badge)</label>
        <div class="badge-opts">
          <div class="badge-opt bo-none sel" data-badge="" data-class="" onclick="window.selBadge(this,'','')">Nenhuma</div>
          <div class="badge-opt bo-red"   data-badge="Popular"   data-class="rose"  onclick="window.selBadge(this,'Popular','rose')">Popular</div>
          <div class="badge-opt bo-red"   data-badge="Top Venda" data-class="rose"  onclick="window.selBadge(this,'Top Venda','rose')">Top Venda</div>
          <div class="badge-opt bo-amber" data-badge="Especial"  data-class="amber" onclick="window.selBadge(this,'Especial','amber')">Especial</div>
          <div class="badge-opt bo-green" data-badge="Premium"   data-class="green" onclick="window.selBadge(this,'Premium','green')">Premium</div>
          <div class="badge-opt bo-red"   data-badge="Novo"      data-class="rose"  onclick="window.selBadge(this,'Novo','rose')">Novo</div>
          <div class="badge-opt bo-amber" data-badge="Promo√ß√£o"  data-class="amber" onclick="window.selBadge(this,'Promo√ß√£o','amber')">Promo√ß√£o</div>
        </div>
        <input type="hidden" id="mp-badge" />
        <input type="hidden" id="mp-badgeClass" />
      </div>
      <div style="display:flex;gap:12px;margin-top:10px">
        <button id="btn-save-product-modal" class="btn btn-primary" style="flex:1" onclick="window.saveProd()">üíæ Guardar no Firebase</button>
        <button class="btn btn-ghost" onclick="window.closeProdModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- L√ìGICA JAVASCRIPT & FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// --- CONFIGURA√á√ÉO FIREBASE ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
    authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
    projectId: "distribuidora-de-ovos-aline",
    storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
    messagingSenderId: "92187548716",
    appId: "1:92187548716:web:d61d18a29aa76aead7c589"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const auth = getAuth(appFB);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'app-egg-pro-transacional';

const DEFAULT_PRODUTOS = [
    { nome: 'Ovos Brancos Pequenos', emoji: 'ü•ö', tipo: 'Tamanho P', embalagem: 'D√∫zia (12)', preco: 8.90, desc: 'Ovos brancos selecionados, tamanho pequeno.', badge: '', badgeClass: '', foto_url: '', ativo: true },
    { nome: 'Ovos Brancos M√©dios', emoji: 'ü•ö', tipo: 'Tamanho M', embalagem: 'Cartela (30)', preco: 21.90, desc: 'O favorito do dia a dia! Tamanho ideal para qualquer receita.', badge: '', badgeClass: '', foto_url: '', ativo: true },
    { nome: 'Ovos Brancos Grandes', emoji: 'ü•ö', tipo: 'Tamanho G', embalagem: 'D√∫zia (12)', preco: 12.90, desc: 'Ovos maiores com gema mais volumosa.', badge: 'Popular', badgeClass: 'rose', foto_url: '', ativo: true },
    { nome: 'Ovos Extra Grandes', emoji: 'ü•ö', tipo: 'Tamanho XG', embalagem: 'D√∫zia (12)', preco: 14.90, desc: 'Os maiores! Gema rica e intensa.', badge: 'Top Venda', badgeClass: 'rose', foto_url: '', ativo: true },
    { nome: 'Ovos Caipira', emoji: 'üêì', tipo: 'Caipira', embalagem: 'Meia D√∫zia (6)', preco: 9.90, desc: 'Cria√ß√£o livre no campo. Gema laranjinha e sabor incompar√°vel.', badge: 'Especial', badgeClass: 'amber', foto_url: '', ativo: true },
    { nome: 'Ovos Org√¢nicos', emoji: 'üåø', tipo: 'Org√¢nico', embalagem: 'Caixa com 120 ovos', preco: 95.90, desc: '100% org√¢nicos, sem antibi√≥ticos. Certificado. Ideal para revenda.', badge: 'Premium', badgeClass: 'green', foto_url: '', ativo: true }
];

window.STATUS_OPTIONS = ["CRIADO", "AGUARDANDO PIX", "EM SEPARA√á√ÉO", "SAIU PARA ENTREGA", "PRONTO PARA RETIRADA", "FINALIZADO", "CANCELADO"];

window.config = {
    nome:'App Ovos Aline', slogan:'Qualidade Premium', emoji:'ü•ö',
    heroTitle:'Ovos Fresquinhos ü•ö', heroDesc:'Do campo direto pra sua mesa.',
    pixChave:'', pixTipo:'Celular', pixNome:'App Ovos Aline', pixCidade:'SAO PAULO',
    corPrimaria:'#e11d48', corSecundaria:'#be123c',
    taxaDebito: 0, taxaCredito: 0, whatsapp: ''
};

window.produtos = [];
window.logs = [];
window.editingId = null;
window.firebaseUnsubs = [];
window.isListening = false;
window.state = { view: 'dashboard' };

// --- FUN√á√ïES GLOBAIS ---
window.clearAdminListeners = () => {
    window.firebaseUnsubs.forEach(unsub => {
        if (typeof unsub === 'function') unsub();
    });
    window.firebaseUnsubs = [];
    window.isListening = false;
};

window.initAuth = async () => {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            // Tentamos logar anonimamente mas silenciamos o erro admin-restricted
            await signInAnonymously(auth).catch(err => {
                if (err.code !== 'auth/admin-restricted-operation') throw err;
                console.warn("Aviso: Acesso an√≥nimo desativado no Firebase. Isto n√£o impede o login do Administrador com senha.");
            });
        }
    } catch (e) {
        console.error("Erro na autentica√ß√£o base:", e);
    }
};

window.generateUUID = () => {
    if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16);
    });
};

window.toast = (msg) => {
    const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
};

window.fmt = n => Number(n).toFixed(2).replace('.',',');

window.goTo = (sec) => {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    let actived = false;
    if (window.event && window.event.currentTarget && window.event.currentTarget.classList && window.event.type === 'click') {
        window.event.currentTarget.classList.add('active');
        actived = true;
    }
    
    if (!actived) {
        document.querySelectorAll('.nav-item').forEach(el => {
            if(el.getAttribute('onclick') && el.getAttribute('onclick').includes(`'${sec}'`)) {
                el.classList.add('active');
            }
        });
    }
    
    window.state.view = sec;
    
    const mainEl = document.getElementById('main-content');
    if (mainEl) {
        mainEl.innerHTML = window.buildActiveViewBase();
    }
    
    if (sec === 'loja') window.loadLojaForm();
    if (sec === 'pix') { window.loadPixForm(); window.renderPixPreview(); }
    if (sec === 'aparencia') window.loadAparenciaForm();
    if (sec === 'dashboard') window.renderDashboard();
    if (sec === 'pedidos') window.renderPedidos();
    if (sec === 'produtos') window.renderProdList();
};

window.buildActiveViewBase = () => {
    switch(window.state.view) {
        case 'dashboard': 
            return `
            <div class="space-y-10 fade-in">
                <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic mb-2">Administrativo</h2>
                <div id="dash-stats-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                <div id="dash-payment-breakdown"></div>
                <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm mt-6">
                    <h4 class="font-black uppercase text-sm text-slate-400 border-b border-slate-100 pb-4 mb-6 italic">√öltimas Atividades</h4>
                    <div id="dash-orders-recent" class="space-y-3"></div>
                </div>
            </div>`;
        
        case 'produtos': 
            return `
            <div class="space-y-10 fade-in">
                <div class="flex justify-between items-center flex-wrap gap-4 mb-6">
                    <div>
                        <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic mb-1">Gerenciar Produtos</h2>
                        <p class="text-slate-500 font-bold text-sm">Adicione, edite, ative/desative e elimine produtos do cat√°logo.</p>
                    </div>
                    <button onclick="window.openProdModal()" class="btn btn-primary shadow-md active:scale-95 transition-all">
                        + Adicionar Produto
                    </button>
                </div>
                <div id="prod-list" class="prod-list"></div>
            </div>`;

        case 'pedidos': 
            return `
            <div class="space-y-10 fade-in">
                <div class="mb-6">
                    <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic mb-1">Gest√£o de Encomendas</h2>
                    <p class="text-slate-500 font-bold text-sm">Organize as entregas e as retiradas na loja.</p>
                </div>
                <div id="pedidos-list" class="grid gap-6"></div>
            </div>`;

        case 'pix': {
            const cfg = window.config || {};
            return `
            <div class="space-y-10 fade-in">
                <div class="mb-6">
                    <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic mb-1">Configurar PIX</h2>
                    <p class="text-slate-500 font-bold text-sm">Configure os dados de recebimento PIX que v√£o aparecer no Checkout.</p>
                </div>
                
                <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm">
                    <div class="flex flex-col lg:flex-row justify-between items-center gap-10">
                        <div class="flex-1 w-full">
                            <h3 class="text-2xl font-black uppercase text-slate-800 tracking-tighter mb-2">Chave PIX da Loja</h3>
                            <p class="text-xs font-bold text-slate-500 mb-8">Estes dados aparecem no momento do Checkout do cliente.</p>
                            <form onsubmit="window.handleSavePixConfig(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="field">
                                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Tipo de Chave</label>
                                    <select id="pixType" class="input-egg text-xs uppercase font-bold">
                                        <option value="Celular" ${cfg.pixTipo==='Celular'?'selected':''}>Celular</option>
                                        <option value="CPF" ${cfg.pixTipo==='CPF'?'selected':''}>CPF</option>
                                        <option value="CNPJ" ${cfg.pixTipo==='CNPJ'?'selected':''}>CNPJ</option>
                                        <option value="E-mail" ${cfg.pixTipo==='E-mail'?'selected':''}>E-mail</option>
                                        <option value="Chave Aleat√≥ria" ${cfg.pixTipo==='Chave Aleat√≥ria'?'selected':''}>Chave Aleat√≥ria</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Chave de Registo Exata</label>
                                    <input id="pixKey" value="${cfg.pixChave || ''}" class="input-egg font-black text-slate-900" placeholder="Insira a chave" required>
                                </div>
                                <div class="field">
                                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Nome do Recebedor (PIX)</label>
                                    <input id="pixNome" value="${cfg.pixNome || 'App Ovos Aline'}" class="input-egg font-bold text-slate-700" maxlength="25" required>
                                </div>
                                <div class="field">
                                    <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Cidade (PIX)</label>
                                    <input id="pixCidade" value="${cfg.pixCidade || 'SAO PAULO'}" class="input-egg font-bold text-slate-700" maxlength="15" required>
                                </div>
                                <div class="md:col-span-2 pt-2">
                                    <button type="submit" class="w-full btn btn-primary shadow-xl transition-all" style="padding:16px; font-size:1.1rem;">üíæ Salvar Configura√ß√µes do PIX</button>
                                </div>
                            </form>
                        </div>
                        <div class="w-full lg:w-72 bg-slate-50 p-8 rounded-[32px] text-center border border-slate-200 flex flex-col items-center">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Teste do QR Code (R$ 1,00)</p>
                            <div id="pix-preview-qr" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 w-[172px] h-[172px] flex items-center justify-center"></div>
                            <button class="btn btn-ghost btn-sm mt-4" onclick="window.renderPixPreview()">üîÑ Gerar Pr√©via</button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        case 'loja': {
            const s = window.config;
            return `
            <div class="space-y-10 fade-in">
                <div class="mb-6">
                    <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic mb-1">Apar√™ncia da Loja</h2>
                    <p class="text-slate-500 font-bold text-sm">Personalize os textos e as configura√ß√µes base de contato.</p>
                </div>
                <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm">
                    <form onsubmit="window.handleSaveStoreConfig(event)">
                        
                        <h3 class="text-lg font-black text-slate-800 uppercase mb-4 border-b border-slate-100 pb-2">Identidade e Textos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="field">
                                <label class="text-[11px] font-black uppercase text-slate-500 ml-2">Nome da Loja</label>
                                <input id="cfg-nome" type="text" value="${s.nome || ''}" class="input-egg text-slate-900 font-black" required>
                            </div>
                            <div class="flex gap-4 field">
                                <div class="w-1/3">
                                    <label class="text-[11px] font-black uppercase text-slate-500 ml-2">√çcone</label>
                                    <input id="cfg-emoji" type="text" value="${s.emoji || 'ü•ö'}" class="input-egg text-center text-xl" maxlength="4">
                                </div>
                                <div class="flex-1">
                                    <label class="text-[11px] font-black uppercase text-slate-500 ml-2">Slogan</label>
                                    <input id="cfg-slogan" type="text" value="${s.slogan || ''}" class="input-egg" placeholder="Ex: Direto da Granja">
                                </div>
                            </div>
                            <div class="md:col-span-2 field">
                                <label class="text-[11px] font-black uppercase text-slate-500 ml-2">T√≠tulo Principal (Banner Destaque)</label>
                                <input id="cfg-heroTitle" type="text" value="${s.heroTitle || ''}" class="input-egg font-bold" placeholder="Ex: Ovos Fresquinhos ü•ö">
                            </div>
                            <div class="md:col-span-2 field">
                                <label class="text-[11px] font-black uppercase text-slate-500 ml-2">Subt√≠tulo (Banner Destaque)</label>
                                <textarea id="cfg-heroDesc" rows="2" class="input-egg py-3" placeholder="Mensagem para os seus clientes...">${s.heroDesc || ''}</textarea>
                            </div>
                        </div>

                        <h3 class="text-lg font-black text-slate-800 uppercase mb-4 border-b border-slate-100 pb-2">Contato (Novo)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div class="field md:col-span-2">
                                <label class="text-[11px] font-black uppercase text-slate-500 ml-2">WhatsApp da Loja (Apenas n√∫meros c/ DDD)</label>
                                <input id="cfg-whatsapp" type="text" value="${s.whatsapp || ''}" class="input-egg text-slate-900 font-black" placeholder="Ex: 11985706243">
                            </div>
                        </div>

                        <div class="save-row mt-8"><button type="submit" class="btn btn-green w-full">üíæ Guardar Configura√ß√µes na Nuvem</button></div>
                    </form>
                </div>
            </div>`;
        }
        case 'aparencia': {
            const s = window.config;
            return `
            <div class="space-y-10 fade-in">
                <div class="mb-6">
                    <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic mb-1">Cores do Tema</h2>
                    <p class="text-slate-500 font-bold text-sm">Personalize os as cores principais que a loja vai exibir.</p>
                </div>
                <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm">
                    <form onsubmit="window.handleSaveAparencia(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <input type="color" id="cfg-corPrimaria" value="${s.corPrimaria || '#e11d48'}" class="w-12 h-12 rounded-lg cursor-pointer border-0 p-0 bg-transparent" oninput="window.updateColorPreview()">
                                <div>
                                    <p class="font-black text-xs uppercase text-slate-700">Cor Principal (Bot√µes e Destaques)</p>
                                </div>
                                <input type="hidden" id="cfg-corPrimariaHex" value="${s.corPrimaria || '#e11d48'}">
                            </div>
                            <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <input type="color" id="cfg-corSecundaria" value="${s.corSecundaria || '#be123c'}" class="w-12 h-12 rounded-lg cursor-pointer border-0 p-0 bg-transparent" oninput="window.updateColorPreview()">
                                <div>
                                    <p class="font-black text-xs uppercase text-slate-700">Cor Secund√°ria (Degrad√™ do Topo)</p>
                                </div>
                                <input type="hidden" id="cfg-corSecundariaHex" value="${s.corSecundaria || '#be123c'}">
                            </div>
                        </div>
                        <div style="margin-top:20px;padding:20px;background:var(--cream);border-radius:16px;border:1px solid var(--border)">
                          <p style="font-size:.85rem;font-weight:800;color:var(--brown);margin-bottom:12px;text-transform:uppercase;">Temas pr√©-definidos r√°pidos:</p>
                          <div style="display:flex;gap:10px;flex-wrap:wrap">
                            <button type="button" class="btn btn-sm" style="background:linear-gradient(135deg,#be123c,#e11d48);color:#fff" onclick="window.setTheme('#e11d48','#be123c')">‚ù§Ô∏è Premium Rose</button>
                            <button type="button" class="btn btn-sm" style="background:linear-gradient(135deg,#D4500A,#E8960C);color:#fff" onclick="window.setTheme('#E8960C','#D4500A')">ü•ö Original Laranja</button>
                            <button type="button" class="btn btn-sm" style="background:linear-gradient(135deg,#2E7D32,#43A047);color:#fff" onclick="window.setTheme('#43A047','#2E7D32')">üåø Verde Campo</button>
                          </div>
                        </div>
                        <div class="save-row mt-8"><button id="btn-save-aparencia" type="submit" class="btn btn-green w-full" style="padding:16px; font-size:1.1rem;">üíæ Guardar Cores</button></div>
                    </form>
                </div>
            </div>`;
        }
    }
    return '';
};

window.renderDashboard = () => {
    const active = window.logs.filter(l => !["FINALIZADO", "CANCELADO"].includes(l.status));
    const pendingTotal = active.reduce((acc,l)=>acc+(Number(l.valorTotal)||0), 0);
    const produtosAtivos = window.produtos.filter(p => p.ativo).length;
    
    let totalPix = 0;
    let totalDinheiro = 0;
    let totalDebito = 0;
    let totalCredito = 0;
    let totalCartaoGenerico = 0;

    active.forEach(l => {
        let val = Number(l.valorTotal) || 0;
        let pg = (l.formaPagamento || '').toLowerCase();
        if (pg.includes('pix')) totalPix += val;
        else if (pg.includes('dinheiro')) totalDinheiro += val;
        else if (pg.includes('debito') || pg.includes('d√©bito')) totalDebito += val;
        else if (pg.includes('credito') || pg.includes('cr√©dito')) totalCredito += val;
        else if (pg.includes('cartao') || pg.includes('cart√£o')) totalCartaoGenerico += val; 
    });

    const tDebito = window.config.taxaDebito || 0;
    const tCredito = window.config.taxaCredito || 0;
    
    const deducoes = (totalDebito * (tDebito/100)) + ((totalCredito + totalCartaoGenerico) * (tCredito/100));
    const valorLiquido = pendingTotal - deducoes;

    const dashStats = document.getElementById('dash-stats-grid');
    if (dashStats) {
        dashStats.innerHTML = `
            <div class="bg-gradient-to-br from-rose-700 to-rose-500 p-6 rounded-[24px] text-white shadow-xl">
                <p class="text-xs font-black uppercase opacity-80 mb-1">Pedidos em Andamento</p>
                <h3 class="text-4xl font-[950] italic">${active.length}</h3>
            </div>
            <div class="bg-white border border-slate-200 p-6 rounded-[24px] shadow-sm text-slate-800">
                <p class="text-xs font-black uppercase text-slate-400 mb-1">Valores a Receber (Bruto)</p>
                <h3 class="text-3xl font-[950] italic text-slate-700">R$ ${window.fmt(pendingTotal)}</h3>
            </div>
            <div class="bg-slate-900 p-6 rounded-[24px] text-white shadow-2xl">
                <p class="text-xs font-black uppercase opacity-60 mb-1">Produtos na Vitrine</p>
                <h3 class="text-4xl font-[950] italic">${produtosAtivos} / ${window.produtos.length}</h3>
            </div>
        `;
    }

    const focusedId = document.activeElement ? document.activeElement.id : null;
    const dashPaymentBreakdown = document.getElementById('dash-payment-breakdown');
    // Previne redesenho caso o utilizador esteja focado num destes inputs (evita loop infinito de memoria)
    if (dashPaymentBreakdown && focusedId !== 'input-taxa-debito' && focusedId !== 'input-taxa-credito') {
        dashPaymentBreakdown.innerHTML = `
            <div class="bg-white rounded-[32px] p-8 border border-slate-200 shadow-sm mt-6">
                <h3 class="text-lg font-black uppercase text-slate-800 tracking-tighter mb-6 flex items-center gap-2">üí≥ M√©todos de Pagamento & Taxas (A Receber)</h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <p class="text-[10px] font-black uppercase text-slate-400">PIX</p>
                        <h4 class="text-xl font-black text-emerald-500 m-0">R$ ${window.fmt(totalPix)}</h4>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <p class="text-[10px] font-black uppercase text-slate-400">Dinheiro</p>
                        <h4 class="text-xl font-black text-amber-500 m-0">R$ ${window.fmt(totalDinheiro)}</h4>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <p class="text-[10px] font-black uppercase text-slate-400">Cart√£o D√©bito</p>
                        <h4 class="text-xl font-black text-rose-500 m-0">R$ ${window.fmt(totalDebito)}</h4>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <p class="text-[10px] font-black uppercase text-slate-400">Cart√£o Cr√©dito</p>
                        <h4 class="text-xl font-black text-rose-500 m-0">R$ ${window.fmt(totalCredito + totalCartaoGenerico)}</h4>
                    </div>
                </div>

                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-200 flex flex-wrap gap-6 items-center">
                    <div class="field w-full md:w-auto">
                        <label class="text-[10px] font-black uppercase text-slate-400">Taxa M√°quina D√©bito (%)</label>
                        <input type="number" id="input-taxa-debito" value="${tDebito}" step="0.01" min="0" onchange="window.updateTaxa(this.value, 'taxaDebito')" placeholder="Ex: 1.99" class="input-egg font-black text-lg py-2" style="max-width: 140px;">
                    </div>
                    <div class="field w-full md:w-auto">
                        <label class="text-[10px] font-black uppercase text-slate-400">Taxa M√°quina Cr√©dito (%)</label>
                        <input type="number" id="input-taxa-credito" value="${tCredito}" step="0.01" min="0" onchange="window.updateTaxa(this.value, 'taxaCredito')" placeholder="Ex: 4.99" class="input-egg font-black text-lg py-2" style="max-width: 140px;">
                    </div>
                    
                    <div class="flex-1 text-right mt-4 md:mt-0">
                        <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Dedu√ß√µes M√°quina</p>
                        <h4 class="text-xl font-black text-rose-600 m-0">- R$ ${window.fmt(deducoes)}</h4>
                    </div>
                    <div class="text-right border-l-2 border-dashed border-slate-300 pl-6 mt-4 md:mt-0">
                        <p class="text-[10px] font-black uppercase text-slate-800 mb-1">Valor L√≠quido Projetado</p>
                        <h4 class="text-3xl font-black text-emerald-500 m-0">R$ ${window.fmt(valorLiquido)}</h4>
                    </div>
                </div>
            </div>
        `;
    }

    const dashRecent = document.getElementById('dash-orders-recent');
    if (dashRecent) {
        dashRecent.innerHTML = active.slice(0, 5).map(l => {
            const cliente = l.dadosCliente?.nome || 'An√¥nimo';
            const isEntrega = l.tipoEntrega === 'entrega';
            const badge = isEntrega ? `<span style="background:#e0f2fe;color:#1d4ed8;padding:4px 8px;border-radius:12px;font-size:0.7rem;font-weight:800;">üöö ENTREGA</span>` : `<span style="background:#dcfce7;color:#047857;padding:4px 8px;border-radius:12px;font-size:0.7rem;font-weight:800;">üè™ RETIRADA</span>`;
            
            return `
            <div class="prod-item" style="padding:16px 24px;">
                <div style="flex:1;">
                    <h4 style="margin:0;font-size:1.05rem;font-weight:900;color:var(--brown);">${cliente} <span style="color:var(--primary);font-size:0.75rem;margin-left:6px;">${l.pedidoID || ''}</span></h4>
                    <div style="margin-top:6px;display:flex;gap:10px;align-items:center;">
                        ${badge}
                        <span style="font-size:0.85rem;font-weight:800;color:var(--muted);">R$ ${window.fmt(l.valorTotal)}</span>
                    </div>
                </div>
                <div style="background:var(--cream);border:1px solid var(--border);padding:6px 14px;border-radius:50px;font-size:0.75rem;font-weight:900;color:var(--brown);">
                    ${l.status}
                </div>
            </div>
            `;
        }).join('') || '<p style="color:var(--muted);text-align:center;padding:20px;font-weight:700;">Sem atividades recentes.</p>';
    }
};

window.renderPedidos = () => {
    const list = document.getElementById('pedidos-list');
    if (!list) return;

    const pending = window.logs.filter(l => !['FINALIZADO','CANCELADO'].includes(l.status));
    
    if (!pending.length) {
        list.innerHTML = '<div style="text-align:center;padding:40px;background:var(--white);border:1px solid var(--border);border-radius:20px;"><p style="font-weight:800;color:var(--muted);font-size:1.1rem;margin:0;">Nenhum pedido na fila</p></div>';
        return;
    }

    list.innerHTML = pending.map(l => {
        const cliente = l.dadosCliente?.nome || 'An√¥nimo';
        const tel = l.dadosCliente?.tel || 'Sem telefone';
        const isEntrega = l.tipoEntrega === 'entrega';
        const entregaStr = isEntrega ? 'üöö ENTREGA EM CASA' : 'üè™ RETIRAR NA LOJA';
        const endereco = isEntrega 
            ? `${l.dadosCliente?.rua || ''}, ${l.dadosCliente?.num || ''} - ${l.dadosCliente?.bairro || ''} <br><span style="font-size:0.75rem;color:var(--muted);margin-top:4px;display:block;">Comp: ${l.dadosCliente?.comp || 'N/A'}</span>`
            : 'O cliente vir√° buscar os produtos fisicamente.';
        
        const itensStr = (l.itens || []).map(i => `<div style="margin-bottom:4px;"><span style="background:var(--cream);color:var(--primary);padding:2px 6px;border-radius:6px;font-weight:900;font-size:0.75rem;margin-right:6px;border:1px solid var(--border);">${i.qtd || i.quantidade}x</span><span style="font-weight:800;font-size:0.85rem;color:var(--brown);">${i.nome || i.produto}</span></div>`).join('');
        const pagStr = (l.formaPagamento || 'N√£o Informado').replace('_', ' ').toUpperCase();

        let borderColor = 'var(--border)';
        if (l.status === 'CRIADO') borderColor = '#f59e0b';
        else if (l.status === 'EM SEPARA√á√ÉO') borderColor = 'var(--primary)';
        else if (l.status === 'SAIU PARA ENTREGA' || l.status === 'PRONTO PARA RETIRADA') borderColor = 'var(--green)';

        return `
        <div class="card" style="border-left: 12px solid ${borderColor}; padding: 24px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:16px; border-bottom:1px solid var(--border); padding-bottom:16px; margin-bottom:16px;">
                <div>
                    <span style="background:var(--cream); color:var(--primary); border:1px solid var(--border); padding:4px 10px; border-radius:50px; font-size:0.75rem; font-weight:900; letter-spacing:1px;">Pedido ${l.pedidoID || '#---'}</span>
                    <span style="font-size:0.75rem; color:var(--muted); font-weight:800; margin-left:10px;">${l.criadoEm ? new Date(l.criadoEm.seconds * 1000).toLocaleString('pt-PT') : 'Hoje'}</span>
                    <h3 style="margin:12px 0 4px; font-size:1.3rem; color:var(--brown);">${cliente}</h3>
                    <p style="font-size:0.85rem; font-weight:800; color:var(--muted); margin:0;">üìû ${tel}</p>
                </div>
                <div style="text-align:right;">
                    <span style="background:${isEntrega ? '#e0f2fe' : '#dcfce7'}; color:${isEntrega ? '#1d4ed8' : '#047857'}; padding:6px 14px; border-radius:10px; font-size:0.75rem; font-weight:900; display:inline-block; margin-bottom:12px;">${entregaStr}</span>
                    <h2 style="font-size:1.8rem; font-weight:900; color:var(--primary); margin:0;">R$ ${window.fmt(l.valorTotal)}</h2>
                </div>
            </div>
            
            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 24px;">
                <div>
                    <p style="font-size:0.75rem; font-weight:900; color:var(--muted); text-transform:uppercase; margin-bottom:8px; border-bottom:2px solid var(--cream); padding-bottom:4px;">Itens Solicitados</p>
                    ${itensStr}
                </div>
                <div>
                    <p style="font-size:0.75rem; font-weight:900; color:var(--muted); text-transform:uppercase; margin-bottom:8px; border-bottom:2px solid var(--cream); padding-bottom:4px;">Met√≥do de Pagamento</p>
                    <span style="background:var(--cream); border:1px solid var(--border); padding:6px 12px; border-radius:10px; font-size:0.8rem; font-weight:800; color:var(--brown); display:inline-block;">${pagStr}</span>
                </div>
                <div>
                    <p style="font-size:0.75rem; font-weight:900; color:var(--muted); text-transform:uppercase; margin-bottom:8px; border-bottom:2px solid var(--cream); padding-bottom:4px;">Endere√ßo / Retirada</p>
                    <p style="font-size:0.85rem; font-weight:700; color:var(--brown); line-height:1.5; margin:0;">${endereco}</p>
                </div>
            </div>

            <div style="background:var(--cream); padding:16px 20px; border-radius:16px; border:1px solid var(--border); display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
                <span style="font-size:0.8rem; font-weight:900; color:var(--muted); text-transform:uppercase;">Atualizar Estado Operacional:</span>
                <select onchange="window.handleStatusUpdate('${l.id}', this.value)" style="flex:1; min-width:200px; padding:12px 16px; border-radius:12px; border:2px solid var(--brown); background:var(--brown); color:var(--white); font-weight:800; outline:none; cursor:pointer;">
                    ${window.STATUS_OPTIONS.map(opt => `<option value="${opt}" ${l.status===opt?'selected':''}>${opt}</option>`).join('')}
                </select>
            </div>
        </div>
        `;
    }).join('');
};

window.handleStatusUpdate = async (id, status) => {
    try {
        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'vendas_logs', id);
        const updates = { status };
        if (status === 'FINALIZADO') updates.finalizadoEm = serverTimestamp();
        await updateDoc(ref, updates);
        window.toast(`‚úÖ Estado Atualizado`);
    } catch(e) { window.toast("Erro ao atualizar."); }
};

window.renderProdList = () => {
    const list = document.getElementById('prod-list');
    if (!list) return;
    if (!window.produtos || window.produtos.length === 0) { 
        list.innerHTML = `
        <div style="background:var(--white); border:2px dashed var(--border); border-radius:20px; padding:40px; text-align:center;">
            <span style="font-size:3rem; display:block; margin-bottom:10px;">üì¶</span>
            <h3 style="font-size:1.2rem; font-weight:900; color:var(--brown); margin-bottom:4px;">Cat√°logo Vazio</h3>
            <p style="color:var(--muted); font-size:0.9rem; font-weight:600; margin-bottom:20px;">Carregue os produtos originais para come√ßar.</p>
            <button class="btn btn-primary" onclick="window.seedDefaultProducts()">Carregar Produtos Padr√£o</button>
        </div>`; 
        return; 
    }
    
    list.innerHTML = window.produtos.map(p => {
        const imageElement = (p.foto_url && p.foto_url.length > 5) 
            ? `<img src="${p.foto_url}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;" />` 
            : `${p.emoji || 'ü•ö'}`;
            
        const imgPadding = (p.foto_url && p.foto_url.length > 5) ? '0' : '4px';

        return `
        <div class="prod-item ${p.ativo?'':'inactive'}">
            <div class="prod-emoji" style="padding: ${imgPadding}; border: ${p.foto_url ? 'none' : ''};">${imageElement}</div>
            <div class="prod-info">
                <h4>${p.nome || ''} ${p.badge?`<span style="background:${p.badgeClass==='green'?'#10b981':p.badgeClass==='amber'?'#f59e0b':'#e11d48'};color:#fff;font-size:.65rem;padding:3px 10px;border-radius:50px;font-weight:800;vertical-align:middle;margin-left:8px;">${p.badge}</span>`:''}</h4>
                <p>${p.tipo || ''} ¬∑ Embalagem: <strong>${p.embalagem || 'N√£o definida'}</strong> ¬∑ ${p.ativo?'‚úÖ Ativo':'‚è∏ Oculto'}</p>
            </div>
            <div class="prod-price">R$ ${window.fmt(p.preco)}</div>
            <div class="prod-actions">
                <button title="Ativar/Ocultar" class="toggle-btn" onclick="window.toggleProd('${p.id}')">${p.ativo?'üü¢':'‚ö´'}</button>
                <button class="btn btn-ghost btn-sm" onclick="window.openProdModal('${p.id}')">‚úèÔ∏è Editar</button>
                <button class="btn btn-red btn-sm" onclick="window.deleteProd('${p.id}')">üóë</button>
            </div>
        </div>`;
    }).join('');
};

window.toggleProd = async (id) => {
    const p = window.produtos.find(x => x.id === id);
    if (p) {
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', id), {
            ativo: !p.ativo, updatedAt: serverTimestamp()
        });
        window.toast(!p.ativo ? '‚úÖ Produto ativado na loja!' : '‚è∏ Produto oculto');
    }
};

window.deleteProd = async (id) => {
    if (!confirm('Eliminar este produto definitivamente da nuvem?')) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', id));
    window.toast('üóë Produto eliminado!');
};

window.updateImgPreview = () => {
    const val = document.getElementById('mp-foto').value;
    const preview = document.getElementById('mp-img-preview');
    if (val && val.length > 5) {
        preview.innerHTML = `<img src="${val}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">`;
    } else {
        preview.innerHTML = `<span style="font-size: 1.5rem; color: var(--muted);">üì∑</span>`;
    }
};

window.handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 400;
            const MAX_HEIGHT = 400;
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('mp-foto').value = dataUrl;
            window.updateImgPreview();
            window.toast("üì∏ Foto anexada e otimizada!");
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
};

window.openProdModal = (id = null) => {
    window.editingId = id;
    document.getElementById('modal-prod-title').textContent = id ? 'Editar Produto' : 'Novo Produto';
    const p = id ? window.produtos.find(x => x.id === id) : {};
    
    document.getElementById('mp-id').value         = id || '';
    document.getElementById('mp-nome').value        = p.nome  || '';
    document.getElementById('mp-emoji').value       = p.emoji || 'ü•ö';
    document.getElementById('mp-tipo').value        = p.tipo  || '';
    document.getElementById('mp-embalagem').value   = p.embalagem || 'D√∫zia (12)';
    document.getElementById('mp-preco').value       = p.preco || '';
    document.getElementById('mp-desc').value        = p.desc  || '';
    document.getElementById('mp-badge').value       = p.badge || '';
    document.getElementById('mp-badgeClass').value  = p.badgeClass || '';
    document.getElementById('mp-foto').value        = p.foto_url || '';
    document.getElementById('mp-file').value        = ''; 
    
    window.updateImgPreview();
    
    document.querySelectorAll('.badge-opt').forEach(el => {
        el.classList.remove('sel');
        if (el.dataset.badge === (p.badge||'')) el.classList.add('sel');
    });
    document.getElementById('prod-modal').classList.add('open');
};

window.closeProdModal = () => { document.getElementById('prod-modal').classList.remove('open'); };

window.selBadge = (el, badge, cls) => {
    document.querySelectorAll('.badge-opt').forEach(x => x.classList.remove('sel'));
    el.classList.add('sel');
    document.getElementById('mp-badge').value      = badge;
    document.getElementById('mp-badgeClass').value = cls;
};

window.saveProd = async () => {
    const nome  = document.getElementById('mp-nome').value.trim();
    const preco = parseFloat(document.getElementById('mp-preco').value);
    
    if (!nome) { window.toast('‚ö†Ô∏è Informe o nome!'); return; }
    if (isNaN(preco)) { window.toast('‚ö†Ô∏è Informe o pre√ßo!'); return; }
    
    const docId = window.editingId || window.generateUUID();
    let isAtivo = true;
    if (window.editingId) {
        const p = window.produtos.find(x => x.id === window.editingId);
        if(p && p.hasOwnProperty('ativo')) isAtivo = p.ativo;
    }

    const payload = {
        nome, 
        emoji: document.getElementById('mp-emoji').value || 'ü•ö',
        tipo: document.getElementById('mp-tipo').value, 
        embalagem: document.getElementById('mp-embalagem').value.trim() || 'Unidade',
        preco,
        desc: document.getElementById('mp-desc').value,
        badge: document.getElementById('mp-badge').value,
        badgeClass: document.getElementById('mp-badgeClass').value,
        foto_url: document.getElementById('mp-foto').value,
        ativo: isAtivo, 
        updatedAt: serverTimestamp()
    };

    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', docId), payload, { merge: true });
        window.closeProdModal();
        window.toast('‚úÖ Guardado na Nuvem!');
    } catch(e) { window.toast('Erro ao guardar.'); }
};

window.seedDefaultProducts = async () => {
    try {
        window.toast("A carregar cat√°logo predefinido...");
        await Promise.all(DEFAULT_PRODUTOS.map(p => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', window.generateUUID()), {...p, updatedAt: serverTimestamp()})));
        window.toast("‚úÖ Produtos carregados com sucesso!");
    } catch(e) {
        window.toast("Erro ao carregar cat√°logo.");
    }
};

window.seedDefaultPix = async () => {
    try {
        const defaultPix = {
            type: 'Celular',
            key: '(11) 99999-9999',
            rawKey: '11999999999',
            nomeRecebedor: window.config.nome || 'App Ovos Aline Teste',
            cidade: 'SAO PAULO',
            copiaCola: window.pixPayload('11999999999', 1.00, window.config.nome || 'App Ovos Aline Teste', 'SAO PAULO', 'TESTE001'),
            updatedAt: serverTimestamp()
        };
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), defaultPix, { merge: true });
    } catch(e) { console.error("Erro ao gerar PIX padr√£o:", e); }
};

window.loadLojaForm = () => {
    if(document.getElementById('cfg-nome')) document.getElementById('cfg-nome').value      = window.config.nome      || '';
    if(document.getElementById('cfg-emoji')) document.getElementById('cfg-emoji').value     = window.config.emoji     || 'ü•ö';
    if(document.getElementById('cfg-slogan')) document.getElementById('cfg-slogan').value    = window.config.slogan    || '';
    if(document.getElementById('cfg-heroTitle')) document.getElementById('cfg-heroTitle').value = window.config.heroTitle || '';
    if(document.getElementById('cfg-heroDesc')) document.getElementById('cfg-heroDesc').value  = window.config.heroDesc  || '';
    
    const whatsappEl = document.getElementById('cfg-whatsapp');
    if(whatsappEl) whatsappEl.value = window.config.whatsapp || '';
};

window.loadPixForm = () => {
    if(document.getElementById('pixKey')) document.getElementById('pixKey').value = window.config.pixChave || '';
    if(document.getElementById('pixNome')) document.getElementById('pixNome').value = window.config.pixNome || '';
    if(document.getElementById('pixCidade')) document.getElementById('pixCidade').value = window.config.pixCidade || '';
    if(document.getElementById('pixType')) document.getElementById('pixType').value = window.config.pixTipo || 'Celular';
};

window.setPixType = (tipo, placeholder) => {
    const el = document.getElementById('pixType');
    if(el) {
        el.value = tipo;
        window.config.pixTipo = tipo;
    }
    const pk = document.getElementById('pixKey');
    if(pk) pk.placeholder = placeholder;
};

window.removeAccents = (s) => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\x00-\x7F]/g,'').toUpperCase();
window.pixPayload = (key, amount, name, city, txid) => {
    const tlv = (id, v) => id + String(v.length).padStart(2,'0') + v;
    const ma = tlv('00','BR.GOV.BCB.PIX') + tlv('01', key);
    let p = tlv('00','01') + tlv('26', ma) + tlv('52','0000') + tlv('53','986') + tlv('54', amount.toFixed(2)) + tlv('58','BR') + tlv('59', window.removeAccents(name).slice(0,25)||'LOJA') + tlv('60', window.removeAccents(city).slice(0,15)||'BR') + tlv('62', tlv('05', window.removeAccents(txid).slice(0,25)||'TESTE'));
    return p + tlv('63', window.crc16(p + '6304'));
};
window.crc16 = (s) => {
    let c = 0xFFFF;
    for (let i=0; i<s.length; i++) {
        c ^= (s.charCodeAt(i) & 0xFF) << 8;
        for (let j=0; j<8; j++) c = (c & 0x8000) ? ((c << 1) ^ 0x1021) & 0xFFFF : (c << 1) & 0xFFFF;
    }
    return (c & 0xFFFF).toString(16).toUpperCase().padStart(4,'0');
};

window.renderPixPreview = () => {
    const elKey = document.getElementById('pixKey');
    const elNome = document.getElementById('pixNome');
    const elCidade = document.getElementById('pixCidade');
    
    const chave  = (elKey ? elKey.value : window.config.pixChave) || '11999999999';
    const nome   = (elNome ? elNome.value : window.config.pixNome) || 'LOJA';
    const cidade = (elCidade ? elCidade.value : window.config.pixCidade) || 'BRASIL';
    
    const p      = window.pixPayload(chave, 1.00, nome, cidade, 'TESTE001');
    const div    = document.getElementById('pix-preview-qr');
    if(div) {
        div.innerHTML = '';
        setTimeout(()=>{
            try { new QRCode(div, { text:p, width:150, height:150, colorDark: window.config.corSecundaria || '#be123c', colorLight:'#FFFFFF', correctLevel:QRCode.CorrectLevel.M }); } catch(e){}
        }, 50);
    }
};

window.loadAparenciaForm = () => {
    const p = window.config.corPrimaria   || '#e11d48';
    const s = window.config.corSecundaria || '#be123c';
    if(document.getElementById('cfg-corPrimaria')) document.getElementById('cfg-corPrimaria').value = p;
    if(document.getElementById('cfg-corPrimariaHex')) document.getElementById('cfg-corPrimariaHex').value = p;
    if(document.getElementById('cfg-corSecundaria')) document.getElementById('cfg-corSecundaria').value = s;
    if(document.getElementById('cfg-corSecundariaHex')) document.getElementById('cfg-corSecundariaHex').value = s;
    document.documentElement.style.setProperty('--primary', p);
    document.documentElement.style.setProperty('--dark', s);
};

window.updateColorPreview = () => {
    if(document.getElementById('cfg-corPrimariaHex') && document.getElementById('cfg-corPrimaria')) document.getElementById('cfg-corPrimariaHex').value   = document.getElementById('cfg-corPrimaria').value;
    if(document.getElementById('cfg-corSecundariaHex') && document.getElementById('cfg-corSecundaria')) document.getElementById('cfg-corSecundariaHex').value = document.getElementById('cfg-corSecundaria').value;
};

window.syncColorFromText = (which) => {
    const hex = document.getElementById('cfg-cor'+which+'Hex').value;
    if (/^#[0-9A-Fa-f]{6}$/.test(hex)) document.getElementById('cfg-cor'+which).value = hex;
};

window.setTheme = (primary, secondary) => {
    if(document.getElementById('cfg-corPrimaria')) document.getElementById('cfg-corPrimaria').value = primary;
    if(document.getElementById('cfg-corSecundaria')) document.getElementById('cfg-corSecundaria').value = secondary;
    window.updateColorPreview();
    window.toast('üé® Clique em Guardar Apar√™ncia para fixar');
};

window.handleSavePixConfig = async (e) => {
    e.preventDefault();
    const typeEl = document.getElementById('pixType');
    const keyEl = document.getElementById('pixKey');
    if(!typeEl || !keyEl) return;

    const type = typeEl.value;
    const rawKey = keyEl.value.trim();
    const cleanKey = rawKey.replace(/\D/g, "");
    
    let chaveFinal = rawKey; let chaveVisual = rawKey;

    if (type === "CPF") {
        if (cleanKey.length !== 11) return window.toast("‚ö†Ô∏è CPF INV√ÅLIDO");
        chaveFinal = cleanKey; chaveVisual = cleanKey.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
    } else if (type === "CNPJ") {
        if (cleanKey.length !== 14) return window.toast("‚ö†Ô∏è CNPJ INV√ÅLIDO");
        chaveFinal = cleanKey; chaveVisual = cleanKey.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
    } else if (type === "Celular") {
        if (cleanKey.length < 10) return window.toast("‚ö†Ô∏è N√öMERO INV√ÅLIDO");
        chaveFinal = cleanKey; chaveVisual = cleanKey.replace(/(\d{2})(\d{5}|\d{4})(\d{4})/, "($1) $2-$3");
    } else if (type === "E-mail") {
        if (!rawKey.includes("@")) return window.toast("‚ö†Ô∏è E-MAIL INV√ÅLIDO");
        chaveFinal = rawKey.toLowerCase(); chaveVisual = chaveFinal;
    } else if (type === "Chave Aleat√≥ria") {
        chaveFinal = rawKey; chaveVisual = rawKey;
    }

    const nomeLoja = document.getElementById('pixNome') ? document.getElementById('pixNome').value.trim() : 'App Ovos Aline';
    const cidadeLoja = document.getElementById('pixCidade') ? document.getElementById('pixCidade').value.trim() : 'SAO PAULO';
    
    const copiaCola = window.pixPayload(chaveFinal, 1.00, nomeLoja, cidadeLoja, 'TESTE001');

    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), {
            type, key: chaveVisual, rawKey: chaveFinal, nomeRecebedor: nomeLoja, cidade: cidadeLoja, copiaCola, updatedAt: serverTimestamp()
        }, { merge: true });
        window.toast("‚úÖ PIX Salvo e Armazenado com Sucesso!");
    } catch (err) { window.toast("Erro ao guardar PIX."); }
};

window.handleSaveStoreConfig = async (e) => {
    e.preventDefault();
    try {
        if(document.getElementById('cfg-nome')) window.config.nome = document.getElementById('cfg-nome').value;
        if(document.getElementById('cfg-slogan')) window.config.slogan = document.getElementById('cfg-slogan').value;
        if(document.getElementById('cfg-emoji')) window.config.emoji = document.getElementById('cfg-emoji').value;
        if(document.getElementById('cfg-heroTitle')) window.config.heroTitle = document.getElementById('cfg-heroTitle').value;
        if(document.getElementById('cfg-heroDesc')) window.config.heroDesc = document.getElementById('cfg-heroDesc').value;
        
        const wpp = document.getElementById('cfg-whatsapp');
        if (wpp) window.config.whatsapp = wpp.value.replace(/\D/g, '');

        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'store_config'), {
            nome: window.config.nome, slogan: window.config.slogan, emoji: window.config.emoji,
            heroTitle: window.config.heroTitle, heroDesc: window.config.heroDesc,
            whatsapp: window.config.whatsapp,
            updatedAt: serverTimestamp()
        }, {merge:true});
        window.toast('‚úÖ Atualizado na Base de Dados!');
    } catch(e) { window.toast('Erro ao sincronizar loja.'); }
};

window.handleSaveAparencia = async (e) => {
    e.preventDefault();
    try {
        if (document.getElementById('cfg-corPrimaria') && document.getElementById('cfg-corPrimaria').value !== "") {
            window.config.corPrimaria   = document.getElementById('cfg-corPrimaria').value;
            window.config.corSecundaria = document.getElementById('cfg-corSecundaria').value;
            document.documentElement.style.setProperty('--primary', window.config.corPrimaria);
            document.documentElement.style.setProperty('--dark', window.config.corSecundaria);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'store_config'), {
                corPrimaria: window.config.corPrimaria, corSecundaria: window.config.corSecundaria, updatedAt: serverTimestamp()
            }, {merge:true});
            window.toast('‚úÖ Cores Atualizadas e Guardadas!');
        }
    } catch(e) { window.toast('Erro ao sincronizar config.'); }
};

// --- AUTH E LIGA√á√ÉO ---
window.fazerLogin = async () => {
    const btn = document.getElementById('btn-login');
    if (btn) {
        btn.disabled = true;
        btn.innerText = "A validar...";
    }
    
    const em = document.getElementById('login-email').value.trim();
    const ps = document.getElementById('login-pass').value;
    
    if (em === 'thon@lojista.com.br' && ps === 'admin123') {
        localStorage.setItem('admin_bypass', 'true');
        // Bypass direto sem verifica√ß√£o de auth.currentUser (evita alert de admin-restricted)
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'flex';
        window.initListeners();
        window.goTo('dashboard');
        return;
    }
    
    try { 
        await signInWithEmailAndPassword(auth, em, ps); 
    } catch(e) { 
        alert("Acesso negado."); 
        if (btn) {
            btn.disabled = false;
            btn.innerText = "Entrar no Painel";
        }
    }
};

window.fazerLogout = async () => {
    localStorage.removeItem('admin_bypass');
    window.clearAdminListeners();
    document.getElementById('login-view').style.display = 'flex';
    document.getElementById('app-view').style.display = 'none';
    
    const btn = document.getElementById('btn-login');
    if (btn) {
        btn.disabled = false;
        btn.innerText = "Entrar no Painel";
    }
    
    await signOut(auth);
};

window.initListeners = () => {
    if (window.isListening) return;
    window.isListening = true;

    // VENDAS / PEDIDOS LOGS 
    const u4 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), s => {
        window.logs = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>{
            const tA = a.criadoEm?.seconds || 0;
            const tB = b.criadoEm?.seconds || 0;
            return tB - tA;
        });
        if (window.state.view === 'dashboard') window.renderDashboard();
        if (window.state.view === 'pedidos') window.renderPedidos();
    });

    // ESTOQUE
    const u1 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'estoque'), s => {
        window.produtos = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>(a.nome||"").localeCompare(b.nome||""));
        if (window.state.view === 'produtos') window.renderProdList();
        if (window.state.view === 'dashboard') window.renderDashboard(); 
    });

    // LOJA E CORES
    const u2 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'store_config'), s => {
        if(s.exists()){
            const d = s.data();
            window.config.nome = d.nome !== undefined ? d.nome : window.config.nome;
            window.config.emoji = d.emoji !== undefined ? d.emoji : window.config.emoji;
            window.config.slogan = d.slogan !== undefined ? d.slogan : window.config.slogan;
            window.config.heroTitle = d.heroTitle !== undefined ? d.heroTitle : window.config.heroTitle;
            window.config.heroDesc = d.heroDesc !== undefined ? d.heroDesc : window.config.heroDesc;
            window.config.corPrimaria = d.corPrimaria || window.config.corPrimaria;
            window.config.corSecundaria = d.corSecundaria || window.config.corSecundaria;
            window.config.taxaDebito = d.taxaDebito !== undefined ? parseFloat(d.taxaDebito) : window.config.taxaDebito;
            window.config.taxaCredito = d.taxaCredito !== undefined ? parseFloat(d.taxaCredito) : window.config.taxaCredito;
            window.config.whatsapp = d.whatsapp !== undefined ? d.whatsapp : window.config.whatsapp;
            
            if (window.state.view === 'loja') window.loadLojaForm();
            if (window.state.view === 'aparencia') window.loadAparenciaForm();
            
            const focusedId = document.activeElement ? document.activeElement.id : null;
            if (window.state.view === 'dashboard' && focusedId !== 'input-taxa-debito' && focusedId !== 'input-taxa-credito') {
                window.renderDashboard();
            }
        }
    });

    // PIX
    const u3 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), s => {
        if(s.exists()){
            const d = s.data();
            window.config.pixTipo = d.type || window.config.pixTipo;
            window.config.pixChave = d.rawKey || window.config.pixChave;
            window.config.pixNome = d.nomeRecebedor || window.config.pixNome;
            window.config.pixCidade = d.cidade || window.config.pixCidade;
            if (window.state.view === 'pix') {
                window.loadPixForm();
                window.renderPixPreview();
            }
        } else {
            // Seed default se n√£o existir
            window.seedDefaultPix();
        }
    });

    window.firebaseUnsubs.push(u1, u2, u3, u4);
};

// ARRANQUE
window.boot = async () => {
    await window.initAuth();
    
    const loginBtn = document.getElementById('btn-login');
    if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.innerText = "Entrar no Painel";
    }
    
    if (localStorage.getItem('admin_bypass') === 'true') {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'flex';
        window.initListeners();
        window.goTo('dashboard');
        return;
    }
    
    onAuthStateChanged(auth, u => {
        if (u) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'flex';
            window.initListeners();
            window.goTo('dashboard');
        } else {
            window.clearAdminListeners();
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('app-view').style.display = 'none';
        }
    });
};

window.boot();
</script>
</body>
</html>
