<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o - AppEgg</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-root" class="w-full max-w-2xl bg-white p-6 md:p-10 rounded-2xl shadow-xl border border-gray-100">
        <div class="text-center py-10">
            <div class="loader mb-4"></div>
            <p class="text-gray-500">Sincronizando com AppEgg...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // üîó Importa√ß√£o da sua API do Render
        import { api } from "./api.js";

        // ‚úÖ Configura√ß√µes REAIS do Projeto AppEgg (Atualizadas por voc√™)
        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appId = "distribuidora-de-ovos-aline";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estado Global
        window.state = {
            user: null,
            role: null,
            loading: true,
            produtos: []
        };

        // Fun√ß√µes de A√ß√£o
        window.actions = {
            login: (email, pass) => signInWithEmailAndPassword(auth, email, pass),
            logout: () => signOut(auth),
            createAdmin: async () => {
                const email = "thon@lojista.com.br";
                const pass = "882010";
                try {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, `artifacts/${appId}/users/${res.user.uid}/profiles`, 'main'), {
                        email: email,
                        role: 'admin',
                        name: 'Thon - AppEgg'
                    });
                    return { success: true, msg: "Conta Admin criada com sucesso!" };
                } catch (e) {
                    if (e.code === 'auth/email-already-in-use') return { success: true, msg: "Acesso j√° configurado." };
                    throw e;
                }
            }
        };

        // Monitor de Autentica√ß√£o
        onAuthStateChanged(auth, async (user) => {
            window.state.loading = true;
            window.render();

            if (user) {
                window.state.user = user;
                try {
                    // 1. Busca perfil no Firestore
                    const profile = await getDoc(doc(db, `artifacts/${appId}/users/${user.uid}/profiles`, 'main'));
                    window.state.role = profile.exists() ? profile.data().role : 'admin';

                    // 2. Sincroniza Token no Postgres (Render)
                    await api.saveToken(user.uid, "token_navegador_padrao");

                    // 3. Busca Produtos Reais no Postgres (Render)
                    window.state.produtos = await api.getProdutos();
                    
                } catch (err) {
                    console.error("Erro na sincroniza√ß√£o:", err);
                }
            } else {
                window.state.user = null;
                window.state.role = null;
            }

            window.state.loading = false;
            window.render();
        });

        // Login an√¥nimo inicial para evitar telas em branco
        signInAnonymously(auth).catch(() => {});
        window.render = render;
    </script>

    <script>
        function render() {
            const root = document.getElementById('app-root');
            const { loading, user, role, produtos } = window.state;

            if (loading) {
                root.innerHTML = `<div class="text-center py-10"><div class="loader mb-4"></div><p class="text-gray-500">Sincronizando com AppEgg...</p></div>`;
                return;
            }

            // --- TELA LOGADA (ADMIN) ---
            if (user && role === 'admin') {
                const itensHTML = produtos.length > 0 
                    ? produtos.map(p => `
                        <div class="flex justify-between items-center p-4 border-b hover:bg-gray-50 transition">
                            <span class="font-medium text-gray-700">${p.nome}</span>
                            <span class="font-bold text-indigo-600">R$ ${p.preco}</span>
                        </div>
                    `).join('')
                    : '<div class="p-8 text-center text-sm text-gray-500 italic">O estoque do Postgres est√° vazio.</div>';

                root.innerHTML = `
                    <div class="animate-fade-in text-left">
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900">Painel AppEgg</h1>
                                <p class="text-xs text-green-500 font-bold uppercase tracking-wider">‚óè Conectado ao Render</p>
                            </div>
                            <button onclick="window.actions.logout()" class="px-4 py-2 text-sm font-bold text-red-500 bg-red-50 rounded-lg hover:bg-red-100 transition">Sair</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            <div class="p-6 bg-white border rounded-2xl shadow-sm">
                                <p class="text-xs font-bold text-gray-400 uppercase mb-1">Itens em Estoque</p>
                                <p class="text-3xl font-black text-indigo-600">${produtos.length}</p>
                            </div>
                            <div class="p-6 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-100">
                                <p class="text-xs font-bold text-indigo-100 uppercase mb-1">Banco de Dados</p>
                                <p class="text-xl font-bold text-white">PostgreSQL Online</p>
                            </div>
                        </div>

                        <div class="bg-white border rounded-2xl overflow-hidden shadow-sm">
                            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                                <span class="font-bold text-gray-700">Invent√°rio Atual</span>
                                <button class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-bold hover:bg-indigo-200 transition">+ Novo Produto</button>
                            </div>
                            <div class="max-h-64 overflow-y-auto">${itensHTML}</div>
                        </div>
                    </div>
                `;
                return;
            }

            // --- TELA DE LOGIN ---
            root.innerHTML = `
                <div class="max-w-sm mx-auto">
                    <div class="text-center mb-10">
                        <div class="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg shadow-indigo-200">
                           <span class="text-white text-3xl font-black">A</span>
                        </div>
                        <h1 class="text-3xl font-black text-gray-900">AppEgg Admin</h1>
                        <p class="text-gray-400 text-sm">Distribuidora de Ovos Aline</p>
                    </div>

                    <form onsubmit="handleAuth(event)" class="space-y-4">
                        <div class="space-y-1 text-left">
                            <label class="text-xs font-bold text-gray-500 uppercase ml-1">E-mail</label>
                            <input type="email" id="email" value="thon@lojista.com.br" required class="w-full p-4 bg-gray-50 border-transparent border focus:border-indigo-500 focus:bg-white rounded-xl outline-none transition">
                        </div>
                        <div class="space-y-1 text-left">
                            <label class="text-xs font-bold text-gray-500 uppercase ml-1">Senha</label>
                            <input type="password" id="pass" value="882010" required class="w-full p-4 bg-gray-50 border-transparent border focus:border-indigo-500 focus:bg-white rounded-xl outline-none transition">
                        </div>
                        <button type="submit" id="btn-login" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 shadow-xl shadow-indigo-200 transition-all active:scale-95">
                            ENTRAR NO SISTEMA
                        </button>
                    </form>
                    
                    <button onclick="setupAdmin()" class="w-full mt-6 text-xs text-gray-400 hover:text-indigo-600 transition underline decoration-dotted">
                        Configurar acesso Thon Lojista (Passo 1)
                    </button>
                </div>
            `;
        }

        async function setupAdmin() {
            try {
                const res = await window.actions.createAdmin();
                alert(res.msg);
            } catch (e) {
                alert("Erro ao configurar: " + e.message);
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;
            try {
                await window.actions.login(email, pass);
            } catch (err) {
                alert("Falha no login: E-mail ou senha incorretos.");
                btn.innerHTML = 'ENTRAR NO SISTEMA';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>