<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg Admin | Gestão de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        .logo-admin { font-weight: 900; color: #e11d48; font-size: 1.5rem; letter-spacing: -1px; }
        .card-admin { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .btn-status { padding: 10px 14px; border-radius: 12px; font-size: 10px; font-weight: 900; text-transform: uppercase; transition: all 0.2s; border: none; cursor: pointer; }
        .status-badge { font-size: 10px; font-weight: 900; padding: 4px 10px; border-radius: 8px; text-transform: uppercase; }
        .status-CRIADO { background: #fef3c7; color: #92400e; }
        .status-EMBALANDO { background: #dcfce7; color: #166534; }
        .status-ENTREGA { background: #dbeafe; color: #1e40af; }
        .status-FINALIZADO { background: #f1f5f9; color: #475569; }
    </style>
</head>
<body>
    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const auth = getAuth(appFB);

        window.state = { user: null, pedidos: [] };

        onAuthStateChanged(auth, user => {
            window.state.user = user;
            if (user) {
                const q = query(collection(db, "vendas_logs"), orderBy("criadoEm", "desc"));
                onSnapshot(q, s => {
                    window.state.pedidos = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.render();
                });
            }
            window.render();
        });

        window.mudarStatus = async (id, novoStatus) => {
            try {
                const docRef = doc(db, "vendas_logs", id);
                await updateDoc(docRef, { status: novoStatus });
            } catch (err) {
                console.error("Erro ao atualizar:", err);
                alert("Erro ao mudar status");
            }
        };

        window.deletarPedido = async (id) => {
            if (confirm("Tem certeza que deseja apagar este pedido do histórico?")) {
                await deleteDoc(doc(db, "vendas_logs", id));
            }
        };

        window.render = () => {
            const root = document.getElementById('app-root');
            if (!window.state.user) { root.innerHTML = renderLogin(); return; }

            root.innerHTML = `
                <nav class="bg-white border-b border-slate-200 p-6 flex justify-between items-center sticky top-0 z-50">
                    <div class="logo-admin">AppEgg <span class="text-slate-400 font-medium text-sm">ADMIN</span></div>
                    <button onclick="signOut(auth)" class="text-rose-600 font-black text-xs uppercase tracking-widest">Sair</button>
                </nav>

                <main class="p-6 max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="font-black text-slate-800 text-xl">Painel de Pedidos</h2>
                        <span class="bg-slate-200 text-slate-600 px-3 py-1 rounded-full text-[10px] font-bold">${window.state.pedidos.length} PEDIDOS</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${window.state.pedidos.map(p => `
                            <div class="card-admin border-l-[8px] ${p.status === 'FINALIZADO' ? 'border-slate-300' : 'border-rose-500'}">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-black text-lg text-slate-800 uppercase">${p.clienteNome || 'Cliente'}</h3>
                                        <p class="text-sm font-bold text-slate-500">${p.quantidade}x ${p.produto}</p>
                                        <p class="text-[10px] text-slate-400 mt-1">ID: ${p.id}</p>
                                    </div>
                                    <span class="status-badge status-${(p.status || 'CRIADO').replace(/\s/g, '')}">${p.status || 'CRIADO'}</span>
                                </div>

                                <div class="bg-slate-50 rounded-2xl p-4 mb-6 space-y-2">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-slate-400 font-bold uppercase">WhatsApp:</span>
                                        <span class="font-black text-slate-700">${p.telefone || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-slate-400 font-bold uppercase">Recorrência:</span>
                                        <span class="font-black text-rose-600">${p.recorrencia || 'Única'}</span>
                                    </div>
                                    ${p.dataProximaRemessa ? `
                                        <div class="flex justify-between text-xs pt-2 border-t border-slate-200">
                                            <span class="text-slate-400 font-bold uppercase">Agendado para:</span>
                                            <span class="font-black text-blue-600">${p.dataProximaRemessa}</span>
                                        </div>
                                    ` : ''}
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button onclick="window.mudarStatus('${p.id}', 'EMBALANDO')" class="btn-status bg-amber-100 text-amber-700 hover:bg-amber-200">Embalar</button>
                                    <button onclick="window.mudarStatus('${p.id}', 'SAIU PARA ENTREGA')" class="btn-status bg-blue-100 text-blue-700 hover:bg-blue-200">Entrega</button>
                                    <button onclick="window.mudarStatus('${p.id}', 'FINALIZADO')" class="btn-status bg-emerald-600 text-white hover:bg-emerald-700">Finalizar</button>
                                    <button onclick="window.deletarPedido('${p.id}')" class="btn-status bg-slate-100 text-slate-400 hover:bg-rose-100 hover:text-rose-600 ml-auto">Excluir</button>
                                </div>
                            </div>
                        `).join('') || '<div class="col-span-full text-center py-20 font-black text-slate-300 uppercase tracking-widest">Nenhum pedido recebido</div>'}
                    </div>
                </main>
            `;
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            try {
                await signInWithEmailAndPassword(auth, f.get('email'), f.get('pass'));
            } catch (err) {
                alert("Falha no login admin");
            }
        };

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-8 bg-slate-900">
                    <form onsubmit="window.handleLogin(event)" class="bg-white p-10 rounded-[40px] w-full max-w-sm space-y-4 shadow-2xl">
                        <div class="logo-admin text-center text-3xl mb-8">AppEgg Admin</div>
                        <input name="email" type="email" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 outline-none focus:border-rose-500 font-bold" placeholder="E-mail Admin" required>
                        <input name="pass" type="password" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 outline-none focus:border-rose-500 font-bold" placeholder="Senha" required>
                        <button type="submit" class="w-full bg-rose-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-rose-200 active:scale-95 transition-all">Entrar no Painel</button>
                    </form>
                </div>
            `;
        }
    </script>
</body>
</html>