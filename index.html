
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AppEgg Admin</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
body { font-family: 'Inter', sans-serif; background:#f9fafb; color:#1f2937; }
.card { background:#fff; border:1px solid #f3f4f6; border-radius:24px; box-shadow:0 4px 15px rgba(0,0,0,0.02); }
.nav-link { font-size:10px; font-weight:800; text-transform:uppercase; color:#9ca3af; padding:12px 14px; border-radius:12px; cursor:pointer; }
.nav-link.active { color:#e11d48; background:#fff1f2; }
.logo-text { font-weight:800; color:#e11d48; font-size:1.25rem; letter-spacing:-0.05em; }
.timeline-dot { width:8px; height:8px; border-radius:50%; background:#e11d48; position:absolute; left:-5px; top:4px; }
.timeline-step { position:relative; padding-left:20px; border-left:2px solid #f3f4f6; margin-left:3px; padding-bottom:15px; }
.timeline-step:last-child { border-left:none; }
</style>
</head>

<body>
<div id="app-root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
  authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
  projectId: "distribuidora-de-ovos-aline",
  storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
  messagingSenderId: "92187548716",
  appId: "1:92187548716:web:d61d18a29aa76aead7c589"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.state = {
  user:null,
  view:'pedidos',
  logs:[],
  clienteSelecionado:null
};

onAuthStateChanged(auth,(user)=>{
  window.state.user = user;
  if(user) initRealtime();
  render();
});

const formatTime = (ts)=>{
  if(!ts) return "--:--";
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
};

function render(){
  const root = document.getElementById("app-root");

  if(!window.state.user){
    root.innerHTML = `
    <div class="min-h-screen flex items-center justify-center bg-rose-600">
      <div class="bg-white p-10 rounded-[40px] w-full max-w-md text-center">
        <div class="logo-text text-3xl mb-6">AppEgg Admin</div>
        <form id="loginForm" class="space-y-4">
          <input id="email" type="email" placeholder="E-mail" class="w-full p-5 bg-gray-50 rounded-2xl font-bold" required>
          <input id="pass" type="password" placeholder="Senha" class="w-full p-5 bg-gray-50 rounded-2xl font-bold" required>
          <button class="w-full py-5 bg-rose-600 text-white rounded-2xl font-black uppercase">Entrar</button>
        </form>
      </div>
    </div>`;
    document.getElementById("loginForm").onsubmit = async(e)=>{
      e.preventDefault();
      await signInWithEmailAndPassword(auth,email.value,pass.value);
    };
    return;
  }

  root.innerHTML = `
  <nav class="bg-white border-b px-6 h-20 flex items-center justify-between">
    <div class="logo-text">AppEgg</div>
    <div class="flex gap-2">
      ${navBtn("pedidos","Pedidos")}
      ${navBtn("clientes","Clientes")}
      <button onclick="logout()" class="p-3 text-gray-300 font-black text-[10px] uppercase">Sair</button>
    </div>
  </nav>
  <main class="max-w-5xl mx-auto p-6">
    ${window.state.view==="pedidos" ? renderPedidos() : renderClientes()}
  </main>`;
}

function navBtn(view,label){
  return `<button onclick="window.state.view='${view}';window.state.clienteSelecionado=null;render()" 
    class="nav-link ${window.state.view===view?'active':''}">${label}</button>`;
}

function renderPedidos(){
  const ativos = window.state.logs.filter(l=>!["FINALIZADO","CANCELADO"].includes(l.status));
  if(!ativos.length) return `<p class="text-center py-20 font-black text-gray-300 uppercase">Sem pedidos</p>`;

  return `<div class="grid gap-6">
    ${ativos.map(p=>`
      <div class="card p-6 border-l-8 border-rose-500">
        <div class="flex justify-between mb-4">
          <div>
            <h3 class="font-black uppercase">${p.clienteNome||'Cliente'}</h3>
            <p class="text-[10px] font-bold text-gray-400">${p.clienteWhatsapp}</p>
          </div>
          <span class="bg-rose-50 text-rose-600 text-[10px] font-black px-3 py-1 rounded-full">${p.status}</span>
        </div>

        <div class="bg-gray-50 p-4 rounded-2xl mb-4 text-xs font-bold">${p.produto}</div>

        <div class="grid grid-cols-2 gap-2">
          <button onclick="mudarStatus('${p.id}','EMBALANDO')" class="bg-blue-500 text-white py-3 rounded-xl text-[9px] font-black uppercase">Embalando</button>
          <button onclick="pronto('${p.id}','${p.pagamento||''}')" class="bg-orange-500 text-white py-3 rounded-xl text-[9px] font-black uppercase">Pronto</button>
          <button onclick="mudarStatus('${p.id}','FINALIZADO')" class="bg-emerald-500 text-white py-3 rounded-xl text-[9px] font-black uppercase">Concluir</button>
          <button onclick="mudarStatus('${p.id}','CANCELADO')" class="bg-gray-200 text-gray-500 py-3 rounded-xl text-[9px] font-black uppercase">Cancelar</button>
        </div>
      </div>
    `).join("")}
  </div>`;
}

function renderClientes(){
  const map = {};
  window.state.logs.forEach(l=>{
    if(!map[l.clienteWhatsapp]) map[l.clienteWhatsapp]=[];
    map[l.clienteWhatsapp].push(l);
  });

  if(window.state.clienteSelecionado){
    const peds = map[window.state.clienteSelecionado];
    return `
      <button onclick="window.state.clienteSelecionado=null;render()" class="mb-6 font-black text-rose-600 uppercase text-[10px]">← Voltar</button>
      <h2 class="text-xl font-black mb-6 uppercase">${peds[0].clienteNome}</h2>
      ${peds.map(p=>`
        <div class="card p-6 mb-4">
          <div class="flex justify-between mb-3">
            <span class="text-[10px] font-black uppercase bg-gray-100 px-2 py-1 rounded">${p.status}</span>
            <span class="font-black text-rose-600">R$ ${Number(p.precoNoMomento||0).toFixed(2)}</span>
          </div>
          <p class="text-xs font-bold uppercase mb-4">${p.produto}</p>
          <div class="border-t pt-4">
            ${step("Pedido",p.criadoEm)}
            ${step("Embalando",p.horarioEmbalando)}
            ${step("Saiu / Retirada",p.horarioSaiu)}
            ${step("Finalizado",p.horarioConcluido)}
          </div>
        </div>
      `).join("")}
    `;
  }

  return `
  <div class="card">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr class="text-[10px] font-black uppercase text-gray-400">
          <th class="p-4">Cliente</th>
          <th class="p-4">Ação</th>
        </tr>
      </thead>
      <tbody>
        ${Object.keys(map).map(z=>`
          <tr class="border-t">
            <td class="p-4 font-bold uppercase">${map[z][0].clienteNome}</td>
            <td class="p-4">
              <button onclick="window.state.clienteSelecionado='${z}';render()" class="text-rose-600 font-black uppercase text-[10px]">Ver Detalhes</button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  </div>`;
}

const step = (label,ts)=>`
<div class="timeline-step">
  <div class="timeline-dot ${!ts?'bg-gray-200':''}"></div>
  <p class="text-[10px] font-black uppercase text-gray-400">${label}: <span class="text-gray-900">${formatTime(ts)}</span></p>
</div>`;

function initRealtime(){
  onSnapshot(query(collection(db,"vendas_logs"),orderBy("criadoEm","desc")),s=>{
    window.state.logs = s.docs.map(d=>({id:d.id,...d.data()}));
    render();
  });
}

async function mudarStatus(id,status){
  const data = { status };
  const now = new Date();
  if(status==="EMBALANDO") data.horarioEmbalando=now;
  if(status==="FINALIZADO") data.horarioConcluido=now;
  await updateDoc(doc(db,"vendas_logs",id),data);
}

async function pronto(id,pagamento){
  const entrega = pagamento.includes("ENTREGA");
  await updateDoc(doc(db,"vendas_logs",id),{
    status: entrega ? "SAIU PARA ENTREGA" : "DISPONÍVEL PARA RETIRADA",
    horarioSaiu: new Date()
  });
}

function logout(){ signOut(auth); }

</script>
</body>
</html>
