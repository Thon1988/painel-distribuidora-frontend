<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ‚Äî App Ovos Aline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            /* Mapeamento das cores da Ovos Aline para a Identidade Premium Atual (Rose/Slate) */
            --primary: #e11d48;
            --dark:    #be123c;
            --brown:   #0f172a;
            --cream:   #f8fafc;
            --muted:   #64748b;
            --white:   #ffffff;
            --green:   #10b981;
            --red:     #e11d48;
            --border:  #e2e8f0;
            --shadow:  0 4px 20px rgba(15, 23, 42, .08);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--cream); 
            color: var(--brown); 
            overflow-x: hidden; 
        }
        
        /* Navega√ß√£o Estilo Premium */
        .nav-link { 
            font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--muted); 
            padding: 14px 24px; border-radius: 16px; cursor: pointer; transition: all 0.3s ease; 
            white-space: nowrap; border: 2px solid transparent; display: flex; align-items: center; justify-content: center;
        }
        .nav-link:hover { background: var(--white); color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .nav-link.active { color: var(--primary); background: var(--white); border-color: #ffe4e6; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.08); }
        
        .logo-text { font-weight: 900; color: var(--primary); font-size: 1.6rem; letter-spacing: -1px; }
        
        /* Inputs Premium (Geral) */
        .input-egg { 
            width: 100%; padding: 16px 20px; background: #f1f5f9; border-radius: 16px; 
            border: 2px solid transparent; font-weight: 700; font-size: 14px; outline: none; transition: 0.2s; color: var(--brown);
        }
        .input-egg:focus { border-color: var(--primary); background: var(--white); box-shadow: 0 0 0 4px rgba(225, 29, 72, 0.1); }

        .modal-blur { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .toast-egg {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); padding: 16px 32px; 
            background: var(--brown); color: white; border-radius: 50px; font-weight: 800;
            font-size: 13px; text-transform: uppercase; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: opacity 0.3s ease-in-out;
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           C√ìDIGO INJETADO DO CAT√ÅLOGO/MODAL
           ========================================= */
        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; text-align: left; }
        .form-grid.full { grid-template-columns:1fr; }
        .field { display:flex; flex-direction:column; gap:5px; text-align: left; }
        .field label { font-size:.78rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom: 2px;}
        .field input, .field select, .field textarea { border:1.5px solid var(--border); border-radius:10px; padding:12px 14px; font-size:.95rem; font-weight: 700; color:var(--brown); font-family:inherit; transition:border-color .18s,box-shadow .18s; outline:none; background:var(--cream); }
        .field input:focus, .field select:focus, .field textarea:focus { border-color:var(--primary); box-shadow:0 0 0 3px rgba(225,29,72,.15); background: var(--white); }
        .field textarea { resize:vertical; min-height:80px; }
        .btn { border:none; border-radius:50px; padding:12px 24px; font-size:.95rem; font-weight:800; cursor:pointer; transition:opacity .2s,transform .15s; display:inline-flex; align-items:center; justify-content:center; gap:6px; text-transform: uppercase; }
        .btn:hover { opacity:.9; transform:scale(1.02); }
        .btn-green { background:var(--green); color:#fff; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
        .btn-ghost { background:var(--white); border:2px solid var(--border); color:var(--muted); }
        .btn-ghost:hover { border-color:var(--primary); color:var(--dark); }
        .btn-red { background:var(--red); color:#fff; }
        .btn-sm { padding:8px 16px; font-size:.8rem; }
        
        .prod-list { display:flex; flex-direction:column; gap:14px; }
        .prod-item { background:var(--white); border:1px solid var(--border); border-radius:20px; padding:18px 24px; display:flex; align-items:center; gap:20px; transition:box-shadow .2s; }
        .prod-item:hover { box-shadow:var(--shadow); }
        .prod-emoji { font-size:2.5rem; width:60px; height: 60px; background: var(--cream); border-radius: 16px; display: flex; align-items: center; justify-content: center; flex-shrink:0; }
        .prod-info  { flex:1; text-align: left; }
        .prod-info h4 { font-size:1.1rem; font-weight:900; margin: 0; color: var(--brown); }
        .prod-info p  { font-size:.85rem; font-weight: 700; color:var(--muted); margin-top:4px; }
        .prod-price   { font-size:1.2rem; font-weight:900; color:var(--primary); min-width:90px; text-align:right; margin: 0; }
        .prod-actions { display:flex; gap:10px; align-items:center; }
        .toggle-btn { background:var(--cream); border:1px solid var(--border); border-radius: 12px; cursor:pointer; font-size:1.4rem; padding:8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .toggle-btn:hover { background: var(--border); }
        .inactive { opacity:.5; filter: grayscale(100%); }
        
        /* Modal Estilizado do Cat√°logo */
        .modal-bg { position:fixed; inset:0; background:rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); z-index:300; display:flex; align-items:center; justify-content:center; padding:20px; opacity:0; pointer-events:none; transition:opacity .3s; }
        .modal-bg.open { opacity:1; pointer-events:all; }
        .modal-box { background:var(--white); border-radius:24px; width:min(560px,100%); max-height:90vh; overflow-y:auto; box-shadow:0 24px 60px rgba(0,0,0,.28); transform:scale(.9); transition:transform .3s; border: 1px solid var(--border); }
        .modal-bg.open .modal-box { transform:scale(1); }
        .modal-head { background:linear-gradient(135deg,var(--dark),var(--primary)); color:#fff; padding:24px 28px; border-radius:24px 24px 0 0; display:flex; justify-content:space-between; align-items:center; }
        .modal-head h3 { font-size:1.2rem; font-weight:900; margin: 0; }
        .modal-close { background:rgba(255,255,255,.2); border:none; color:#fff; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:.9rem; display:flex; align-items:center; justify-content:center; transition: background 0.2s; }
        .modal-close:hover { background:rgba(255,255,255,.4); }
        .modal-body-inner { padding:28px; display:flex; flex-direction:column; gap:18px; }
        
        .badge-opts { display:flex; gap:8px; flex-wrap:wrap; }
        .badge-opt { padding:6px 14px; border-radius:50px; font-size:.75rem; font-weight:800; cursor:pointer; border:2px solid transparent; transition:all .15s; text-transform: uppercase; }
        .badge-opt.sel { border-color:var(--brown); transform: scale(1.05); }
        .bo-none  { background:#e2e8f0; color:#64748b; }
        .bo-red   { background:var(--primary); color:#fff; }
        .bo-amber { background:#f59e0b; color:#fff; }
        .bo-green { background:var(--green); color:#fff; }
    </style>
</head>
<body class="no-scrollbar text-left">
    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const appFB = initializeApp(firebaseConfig);
        const db = getFirestore(appFB);
        const auth = getAuth(appFB);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'app-egg-pro-transacional';

        const STATUS_OPTIONS = ["CRIADO", "AGUARDANDO PIX", "EM SEPARA√á√ÉO", "SAIU PARA ENTREGA", "PRONTO PARA RETIRADA", "FINALIZADO", "CANCELADO"];
        const PIX_TYPES = ["CPF", "CNPJ", "E-mail", "Celular", "Chave Aleat√≥ria"];

        // Cat√°logo Padr√£o Copiado Exatamente
        const DEFAULT_PRODUTOS = [
            { nome: 'Ovos Brancos Pequenos', emoji: 'ü•ö', tipo: 'Tamanho P ‚Äî D√∫zia', preco: 8.90, desc: 'Ovos brancos selecionados, tamanho pequeno. Perfeitos para caf√© da manh√£ e fritadas r√°pidas.', badge: '', badgeClass: '', ativo: true },
            { nome: 'Ovos Brancos M√©dios', emoji: 'ü•ö', tipo: 'Tamanho M ‚Äî D√∫zia', preco: 10.90, desc: 'O favorito do dia a dia! Tamanho ideal para qualquer receita, da omelete ao bolo.', badge: '', badgeClass: '', ativo: true },
            { nome: 'Ovos Brancos Grandes', emoji: 'ü•ö', tipo: 'Tamanho G ‚Äî D√∫zia', preco: 12.90, desc: 'Ovos maiores com gema mais volumosa. √ìtimos para massas, tortas e confeitaria.', badge: 'Popular', badgeClass: 'rose', ativo: true },
            { nome: 'Ovos Extra Grandes', emoji: 'ü•ö', tipo: 'Tamanho XG ‚Äî D√∫zia', preco: 14.90, desc: 'Os maiores! Gema rica e intensa. Escolha dos chefs para bolos especiais e cremes.', badge: 'Top Venda', badgeClass: 'rose', ativo: true },
            { nome: 'Ovos Caipira', emoji: 'üêì', tipo: 'Caipira ‚Äî D√∫zia', preco: 18.90, desc: 'Cria√ß√£o livre no campo. Gema laranjinha e sabor incompar√°vel. Direto da ro√ßa!', badge: 'Especial', badgeClass: 'amber', ativo: true },
            { nome: 'Ovos Org√¢nicos', emoji: 'üåø', tipo: 'Org√¢nico ‚Äî D√∫zia', preco: 24.90, desc: '100% org√¢nicos, sem antibi√≥ticos. Saud√°vel e sustent√°vel. Certificado.', badge: 'Premium', badgeClass: 'green', ativo: true }
        ];

        let lastPixHash = "";
        let lastStockHash = "";
        let lastLogsHash = "";
        let lastStoreConfigHash = "";

        // --- ESTADO GLOBAL ---
        window.state = {
            user: null, 
            view: 'dashboard', 
            produtos: [], 
            logs: [], 
            editandoId: null, 
            loading: true, 
            saving: false, 
            confirmExcluir: null, 
            toast: { show: false, msg: '' },
            pixConfig: { type: 'Celular', key: '', rawKey: '', copiaCola: '', nomeRecebedor: 'App Ovos Aline', cidade: 'SAO PAULO' },
            storeConfig: { nome: 'App Ovos Aline', emoji: 'ü•ö', slogan: 'Qualidade Premium', heroTitle: 'Ovos Fresquinhos', heroDesc: '', corPrimaria: '#e11d48', corSecundaria: '#be123c' },
            lastOrderCount: 0,
            hasNewOrder: false
        };

        // --- AUTENTICA√á√ÉO BASE ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Erro na autentica√ß√£o base:", e);
            }
        }
        initAuth();

        // --- UTILIDADES ---
        window.setView = (v) => { 
            window.state.view = v; 
            window.state.editandoId = null; 
            if(v === 'pedidos') window.state.hasNewOrder = false;
            window.render(); 
        };

        window.showToast = (msg) => { 
            window.state.toast = { show: true, msg }; 
            window.syncData(); 
            setTimeout(() => { 
                window.state.toast.show = false; 
                window.syncData(); 
            }, 3000); 
        };

        window.selBadge = (el, badgeName, badgeClass) => {
            document.getElementById('mp-badge').value = badgeName;
            document.getElementById('mp-badgeClass').value = badgeClass;
            document.querySelectorAll('.badge-opt').forEach(b => b.classList.remove('sel'));
            el.classList.add('sel');
        };

        // --- L√ìGICA PIX EMV OFICIAL ---
        window.removeAccents = (s) => {
            return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\x00-\x7F]/g,'').toUpperCase();
        };

        window.pixPayload = (key, amount, name, city, txid) => {
            const tlv = (id, v) => id + String(v.length).padStart(2,'0') + v;
            const ma = tlv('00','BR.GOV.BCB.PIX') + tlv('01', key);
            const txidClean = window.removeAccents(txid).replace(/[^A-Za-z0-9]/g,'').slice(0,25) || 'LOJA';
            const adf = tlv('05', txidClean);
            const safeName = window.removeAccents(name).slice(0,25) || 'APP OVOS ALINE';
            const safeCity = window.removeAccents(city).slice(0,15) || 'BRASIL';
            let p = tlv('00','01') + tlv('26', ma) + tlv('52','0000') + tlv('53','986');
            if (amount > 0) p += tlv('54', amount.toFixed(2));
            p += tlv('58','BR') + tlv('59', safeName) + tlv('60', safeCity) + tlv('62', adf);
            return p + tlv('63', window.crc16(p + '6304'));
        };

        window.crc16 = (s) => {
            let c = 0xFFFF;
            for (let i = 0; i < s.length; i++) {
                c ^= (s.charCodeAt(i) & 0xFF) << 8;
                for (let j = 0; j < 8; j++) c = (c & 0x8000) ? ((c << 1) ^ 0x1021) & 0xFFFF : (c << 1) & 0xFFFF;
            }
            return (c & 0xFFFF).toString(16).toUpperCase().padStart(4,'0');
        };

        // --- L√ìGICA DE PRODUTOS ---
        window.carregarProdutosPadrao = async () => {
            window.state.loading = true; window.render();
            try {
                for (const p of DEFAULT_PRODUTOS) {
                    const docId = crypto.randomUUID();
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', docId), {
                        ...p,
                        updatedAt: serverTimestamp()
                    });
                }
                window.showToast("‚úÖ Produtos Iniciais Carregados!");
            } catch (error) {
                alert("Erro ao carregar os produtos padr√£o.");
            }
            window.state.loading = false;
        };

        window.openProdModal = (id = null) => {
            window.state.editandoId = id;
            const p = id ? window.state.produtos.find(x => x.id === id) : {};
            
            document.getElementById('modal-prod-title').textContent = id ? 'Editar Produto' : 'Novo Produto';
            document.getElementById('mp-id').value         = id || '';
            document.getElementById('mp-nome').value        = p.nome  || '';
            document.getElementById('mp-emoji').value       = p.emoji || 'ü•ö';
            document.getElementById('mp-tipo').value        = p.tipo  || '';
            document.getElementById('mp-preco').value       = p.preco || '';
            document.getElementById('mp-desc').value        = p.desc  || '';
            document.getElementById('mp-badge').value       = p.badge || '';
            document.getElementById('mp-badgeClass').value  = p.badgeClass || '';
            
            document.querySelectorAll('.badge-opt').forEach(el => {
                el.classList.remove('sel');
                if (el.dataset.badge === (p.badge||'')) el.classList.add('sel');
            });
            
            document.getElementById('prod-modal').classList.add('open');
        };

        window.closeProdModal = () => {
            document.getElementById('prod-modal').classList.remove('open');
            window.state.editandoId = null;
        };

        window.saveProd = async () => {
            if (window.state.saving) return;
            
            const nome  = document.getElementById('mp-nome').value.trim();
            const preco = parseFloat(document.getElementById('mp-preco').value);
            
            if (!nome) { window.showToast('‚ö†Ô∏è Informe o nome!'); return; }
            if (isNaN(preco)) { window.showToast('‚ö†Ô∏è Informe o pre√ßo!'); return; }

            window.state.saving = true;
            const docId = window.state.editandoId || crypto.randomUUID();
            
            let isAtivo = true;
            if (window.state.editandoId) {
                const existingProd = window.state.produtos.find(p => p.id === window.state.editandoId);
                if (existingProd && existingProd.hasOwnProperty('ativo')) {
                    isAtivo = existingProd.ativo;
                }
            }

            const payload = {
                nome, 
                emoji: document.getElementById('mp-emoji').value || 'ü•ö',
                tipo: document.getElementById('mp-tipo').value, 
                preco,
                desc: document.getElementById('mp-desc').value,
                badge: document.getElementById('mp-badge').value,
                badgeClass: document.getElementById('mp-badgeClass').value,
                ativo: isAtivo,
                updatedAt: serverTimestamp()
            };

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', docId), payload, { merge: true });
                window.closeProdModal();
                window.showToast("‚úÖ Produto salvo com sucesso!");
            } catch (err) { alert("Erro ao salvar produto."); }
            
            window.state.saving = false;
        };

        window.toggleProd = async (id) => {
            const p = window.state.produtos.find(x => x.id === id);
            if (p) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', id), {
                        ativo: !p.ativo,
                        updatedAt: serverTimestamp()
                    });
                    window.showToast(!p.ativo ? 'üü¢ Produto ativado!' : '‚ö´ Produto inativo');
                } catch (err) { console.error(err); }
            }
        };

        window.pedirConfirmExcluir = (id) => { window.state.confirmExcluir = id; window.syncData(); };

        window.handleExcluirReal = async () => {
            if (!window.state.confirmExcluir) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'estoque', window.state.confirmExcluir));
                window.state.confirmExcluir = null; 
                window.showToast("üóë Produto exclu√≠do!");
                window.syncData();
            } catch (e) { alert("Erro ao excluir."); }
        };

        // --- L√ìGICA DE PEDIDOS E PIX ---
        window.handleStatusUpdate = async (id, status) => {
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'vendas_logs', id);
            const updates = { status };
            if (status === 'FINALIZADO') updates.finalizadoEm = serverTimestamp();
            await updateDoc(ref, updates);
            window.showToast(`‚úÖ Status Atualizado`);
        };

        window.handleSavePixConfig = async (e) => {
            e.preventDefault();
            const type = document.getElementById('pixType').value;
            const rawKey = document.getElementById('pixKey').value.trim();
            const cleanKey = rawKey.replace(/\D/g, "");
            
            let chaveFinal = rawKey; let chaveVisual = rawKey;

            if (type === "CPF") {
                if (cleanKey.length !== 11) return window.showToast("‚ö†Ô∏è CPF INV√ÅLIDO");
                chaveFinal = cleanKey; chaveVisual = cleanKey.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            } else if (type === "CNPJ") {
                if (cleanKey.length !== 14) return window.showToast("‚ö†Ô∏è CNPJ INV√ÅLIDO");
                chaveFinal = cleanKey; chaveVisual = cleanKey.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
            } else if (type === "Celular") {
                if (cleanKey.length < 10) return window.showToast("‚ö†Ô∏è N√öMERO INV√ÅLIDO");
                chaveFinal = cleanKey; chaveVisual = cleanKey.replace(/(\d{2})(\d{5}|\d{4})(\d{4})/, "($1) $2-$3");
            } else if (type === "E-mail") {
                if (!rawKey.includes("@")) return window.showToast("‚ö†Ô∏è E-MAIL INV√ÅLIDO");
                chaveFinal = rawKey.toLowerCase(); chaveVisual = chaveFinal;
            } else if (type === "Chave Aleat√≥ria") {
                chaveFinal = rawKey; chaveVisual = rawKey;
            }

            const nomeLoja = document.getElementById('pixNome').value.trim() || 'App Ovos Aline';
            const cidadeLoja = document.getElementById('pixCidade').value.trim() || 'SAO PAULO';
            
            const copiaCola = window.pixPayload(chaveFinal, 1.00, nomeLoja, cidadeLoja, 'TESTE001');

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), {
                    type, key: chaveVisual, rawKey: chaveFinal, nomeRecebedor: nomeLoja, cidade: cidadeLoja, copiaCola, updatedAt: serverTimestamp()
                }, { merge: true });
                window.showToast("‚úÖ PIX Sincronizado!");
            } catch (err) { alert("Erro ao salvar PIX."); }
        };

        window.handleSaveStoreConfig = async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'store_config'), {
                    nome: form.get('nome'),
                    emoji: form.get('emoji'),
                    slogan: form.get('slogan'),
                    heroTitle: form.get('heroTitle'),
                    heroDesc: form.get('heroDesc'),
                    corPrimaria: form.get('corPrimaria'),
                    corSecundaria: form.get('corSecundaria'),
                    updatedAt: serverTimestamp()
                }, { merge: true });
                window.showToast("‚úÖ Apar√™ncia Salva!");
            } catch (err) { alert("Erro ao salvar Loja."); }
        };

        // --- SISTEMA DE LOGIN ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const em = document.getElementById('loginEmail').value.trim();
            const ps = document.getElementById('loginPass').value;
            
            if (em === 'thon@lojista.com.br' && ps === 'admin123') {
                localStorage.setItem('admin_bypass', 'true');
                window.state.user = { email: em };
                window.showToast("‚úÖ Acesso Liberado");
                initAdminListeners();
                window.state.loading = false;
                window.render();
                return;
            }
            try { 
                await signInWithEmailAndPassword(auth, em, ps); 
            } catch (err) { 
                alert("Acesso negado. Dica: Use a senha padr√£o 'admin123'.");
            }
        };

        window.handleSignOut = () => {
            localStorage.removeItem('admin_bypass');
            window.state.user = null;
            signOut(auth);
            window.render();
        };

        // --- RENDERIZA√á√ÉO & ANTI-FLICKER ---

        window.render = () => {
            const root = document.getElementById('app-root');
            if (window.state.loading) {
                root.innerHTML = `<div class="h-screen flex items-center justify-center font-black text-rose-600 animate-pulse uppercase italic text-xl">Sincronizando Painel...</div>`;
                return;
            }

            if (!window.state.user) { root.innerHTML = window.buildLoginView(); return; }

            const currentView = root.getAttribute('data-view');
            if (currentView !== window.state.view) {
                root.setAttribute('data-view', window.state.view);
                root.innerHTML = `
                    <nav class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50 h-24 px-8 flex justify-between items-center shadow-sm">
                        <div class="logo-text cursor-pointer uppercase italic tracking-tighter flex items-center gap-2" onclick="window.setView('dashboard')">
                            <span class="text-3xl">${window.state.storeConfig.emoji || 'ü•ö'}</span> ${window.state.storeConfig.nome || 'App Ovos Aline'}
                        </div>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar">
                            <button onclick="window.setView('dashboard')" class="nav-link ${window.state.view==='dashboard'?'active':''}">Dashboard</button>
                            <button onclick="window.setView('estoque')" class="nav-link ${window.state.view==='estoque'?'active':''}">Cat√°logo</button>
                            <button onclick="window.setView('pedidos')" id="nav-pedidos" class="nav-link relative ${window.state.view==='pedidos'?'active':''}">Encomendas</button>
                            <button onclick="window.setView('financeiro')" class="nav-link ${window.state.view==='financeiro'?'active':''}">Caixa & PIX</button>
                            <button onclick="window.setView('loja')" class="nav-link ${window.state.view==='loja'?'active':''}">Apar√™ncia</button>
                            <button onclick="window.handleSignOut()" class="nav-link text-rose-600 font-black ml-4">Sair</button>
                        </div>
                    </nav>
                    <main class="p-8 max-w-6xl mx-auto fade-in text-left">
                        ${window.buildActiveViewBase()}
                    </main>
                    
                    <!-- Modal de Produto Fixo na Estrutura Principal -->
                    <div class="modal-bg" id="prod-modal">
                        <div class="modal-box text-left">
                            <div class="modal-head">
                                <h3 id="modal-prod-title">Novo Produto</h3>
                                <button class="modal-close" onclick="window.closeProdModal()">‚úï</button>
                            </div>
                            <div class="modal-body-inner">
                                <input type="hidden" id="mp-id" />
                                <div class="form-grid">
                                    <div class="field"><label>Nome do Produto</label><input id="mp-nome" placeholder="Ex: Ovos Grandes" /></div>
                                    <div class="field"><label>Emoji</label><input id="mp-emoji" placeholder="ü•ö" maxlength="4" /></div>
                                    <div class="field"><label>Tipo / Subt√≠tulo</label><input id="mp-tipo" placeholder="Ex: Tamanho G ‚Äî D√∫zia" /></div>
                                    <div class="field"><label>Pre√ßo (R$)</label><input id="mp-preco" type="number" min="0" step="0.01" placeholder="12.90" /></div>
                                </div>
                                <div class="field"><label>Descri√ß√£o</label><textarea id="mp-desc" rows="3" placeholder="Descreva o produto..."></textarea></div>
                                <div class="field">
                                    <label>Etiqueta (Badge)</label>
                                    <div class="badge-opts">
                                        <div class="badge-opt bo-none sel" data-badge="" data-class="" onclick="window.selBadge(this,'','')">Nenhuma</div>
                                        <div class="badge-opt bo-red"   data-badge="Popular"   data-class="rose"  onclick="window.selBadge(this,'Popular','rose')">Popular</div>
                                        <div class="badge-opt bo-red"   data-badge="Top Venda" data-class="rose"  onclick="window.selBadge(this,'Top Venda','rose')">Top Venda</div>
                                        <div class="badge-opt bo-amber" data-badge="Especial"  data-class="amber" onclick="window.selBadge(this,'Especial','amber')">Especial</div>
                                        <div class="badge-opt bo-green" data-badge="Premium"   data-class="green" onclick="window.selBadge(this,'Premium','green')">Premium</div>
                                        <div class="badge-opt bo-red"   data-badge="Novo"      data-class="rose"  onclick="window.selBadge(this,'Novo','rose')">Novo</div>
                                        <div class="badge-opt bo-amber" data-badge="Promo√ß√£o"  data-class="amber" onclick="window.selBadge(this,'Promo√ß√£o','amber')">Promo√ß√£o</div>
                                    </div>
                                    <input type="hidden" id="mp-badge" />
                                    <input type="hidden" id="mp-badgeClass" />
                                </div>
                                <div style="display:flex;gap:10px;margin-top:6px">
                                    <button class="btn btn-green" style="flex:1" onclick="window.saveProd()">üíæ Salvar Produto</button>
                                    <button class="btn btn-ghost" onclick="window.closeProdModal()">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="modal-container"></div>
                    <div id="toast-container"></div>
                `;
            } else {
                document.querySelector('main').innerHTML = window.buildActiveViewBase();
            }

            window.syncData();
        };

        window.syncData = () => {
            if (!window.state.user) return;

            const navPedidos = document.getElementById('nav-pedidos');
            if (navPedidos) navPedidos.innerHTML = `Encomendas ${window.state.hasNewOrder ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-rose-500 rounded-full animate-ping"></span>' : ''}`;

            const toastContainer = document.getElementById('toast-container');
            if (toastContainer) toastContainer.innerHTML = window.state.toast.show ? `<div class="toast-egg border-2 border-white">${window.state.toast.msg}</div>` : '';

            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) modalContainer.innerHTML = window.state.confirmExcluir ? window.buildModalExcluir() : '';

            if (window.state.view === 'dashboard') {
                const dashStats = document.getElementById('dash-stats-grid');
                if (dashStats) dashStats.innerHTML = window.buildDashStats();
                const dashOrders = document.getElementById('dash-orders-grid');
                if (dashOrders) dashOrders.innerHTML = window.buildDashOrders();
            } 
            else if (window.state.view === 'estoque') {
                const estoqueList = document.getElementById('estoque-list-grid');
                if (estoqueList) estoqueList.innerHTML = window.buildEstoqueList();
            } 
            else if (window.state.view === 'pedidos') {
                const pedidosList = document.getElementById('pedidos-list-grid');
                if (pedidosList) pedidosList.innerHTML = window.buildPedidosList();
            }
            else if (window.state.view === 'financeiro') {
                const finStats = document.getElementById('fin-stats-grid');
                if (finStats) finStats.innerHTML = window.buildFinStats();

                // Atualiza inputs de PIX apenas se n√£o estiver focado no momento
                const cfg = window.state.pixConfig;
                const pType = document.getElementById('pixType');
                const pKey = document.getElementById('pixKey');
                const pNome = document.getElementById('pixNome');
                const pCid = document.getElementById('pixCidade');
                if (pType && document.activeElement !== pType) pType.value = cfg.type || 'Celular';
                if (pKey && document.activeElement !== pKey) pKey.value = cfg.rawKey || cfg.key || '';
                if (pNome && document.activeElement !== pNome) pNome.value = cfg.nomeRecebedor || 'App Ovos Aline';
                if (pCid && document.activeElement !== pCid) pCid.value = cfg.cidade || 'SAO PAULO';

                const qrPreview = document.getElementById('qrPreview');
                if (qrPreview) {
                    qrPreview.innerHTML = '';
                    if (window.state.pixConfig?.copiaCola) {
                        try {
                            new QRCode(qrPreview, {
                                text: window.state.pixConfig.copiaCola,
                                width: 140,
                                height: 140,
                                colorDark: "#0f172a",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.M
                            });
                        } catch(e) {
                            qrPreview.innerHTML = '<span class="text-xs font-bold text-rose-500">Erro ao gerar</span>';
                        }
                    } else {
                        qrPreview.innerHTML = `<div class="text-slate-300 uppercase font-black text-[9px] text-center">Salve a chave para gerar</div>`;
                    }
                }
            }
            else if (window.state.view === 'loja') {
                const s = window.state.storeConfig;
                const fields = ['nome', 'emoji', 'slogan', 'heroTitle', 'heroDesc', 'corPrimaria', 'corSecundaria'];
                fields.forEach(f => {
                    const el = document.querySelector(`[name="${f}"]`);
                    if (el && document.activeElement !== el && s[f] !== undefined) {
                        el.value = s[f];
                    }
                });
            }
        };

        // --- BUILDERS DE HTML ---

        window.buildLoginView = () => {
            return `
                <div class="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-center">
                    <div class="bg-white p-12 rounded-[48px] shadow-2xl w-full max-w-md border-4 border-slate-200">
                        <div class="text-4xl font-[950] text-rose-600 mb-2 italic uppercase tracking-tighter text-center">App Ovos Aline</div>
                        <p class="text-slate-400 font-bold text-[10px] uppercase mb-10 italic tracking-[0.3em] text-center">Gest√£o Admin Central</p>
                        <form onsubmit="window.handleLogin(event)" class="space-y-4">
                            <input id="loginEmail" type="email" value="thon@lojista.com.br" class="input-egg text-center font-bold" required>
                            <input id="loginPass" type="password" placeholder="Digite a Senha" class="input-egg text-center font-bold" required>
                            <button class="w-full bg-rose-600 hover:bg-rose-700 text-white py-5 rounded-[24px] font-black uppercase shadow-xl mt-6 active:scale-95 transition-all text-center">Entrar no Painel</button>
                        </form>
                    </div>
                </div>`;
        };

        window.buildActiveViewBase = () => {
            switch(window.state.view) {
                case 'dashboard': return `
                    <div class="space-y-10 fade-in">
                        <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic">Vis√£o Geral</h2>
                        <div id="dash-stats-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                        <div class="bg-white rounded-[40px] p-10 border border-slate-200 shadow-sm">
                            <h4 class="font-black uppercase text-sm text-slate-400 border-b border-slate-100 pb-4 mb-6 italic">√öltimas Atividades</h4>
                            <div id="dash-orders-grid" class="space-y-3"></div>
                        </div>
                    </div>`;
                
                case 'estoque': 
                    return `
                    <div class="space-y-10 fade-in">
                        <div class="flex justify-between items-center flex-wrap gap-4">
                            <div>
                                <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic">Gerenciar Produtos</h2>
                                <p class="text-slate-500 font-bold text-sm">Adicione, edite, ative/desative e exclua produtos do cat√°logo.</p>
                            </div>
                            <button onclick="window.openProdModal()" class="bg-rose-600 hover:bg-rose-700 text-white px-8 py-4 rounded-[20px] font-black uppercase text-xs shadow-md active:scale-95 transition-all">
                                + Adicionar Produto
                            </button>
                        </div>
                        <div id="estoque-list-grid" class="prod-list mt-6"></div>
                    </div>`;

                case 'pedidos': return `
                    <div class="space-y-10 fade-in">
                        <div>
                            <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic">Pedidos Recebidos</h2>
                            <p class="text-slate-500 font-bold text-sm">Organize as entregas e as retiradas na loja.</p>
                        </div>
                        <div id="pedidos-list-grid" class="grid gap-6"></div>
                    </div>`;

                case 'financeiro': 
                    const cfg = window.state.pixConfig;
                    return `
                    <div class="space-y-10 fade-in">
                        <div>
                            <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic">Caixa Central & PIX</h2>
                            <p class="text-slate-500 font-bold text-sm">Resumo financeiro e configura√ß√µes de recebimento.</p>
                        </div>
                        <div id="fin-stats-grid" class="grid grid-cols-1 gap-8"></div>
                        
                        <div class="bg-white rounded-[40px] p-10 border border-slate-200 shadow-sm">
                            <div class="flex flex-col lg:flex-row justify-between items-center gap-10">
                                <div class="flex-1 w-full">
                                    <h3 class="text-2xl font-black uppercase text-slate-800 tracking-tighter mb-2">Chave PIX da Loja</h3>
                                    <p class="text-xs font-bold text-slate-500 mb-8">Estes dados aparecem no momento do Checkout do cliente.</p>
                                    <form onsubmit="window.handleSavePixConfig(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Tipo de Chave</label>
                                            <select id="pixType" class="input-egg text-xs uppercase font-bold">
                                                <option value="Celular">Celular</option>
                                                <option value="CPF">CPF</option>
                                                <option value="CNPJ">CNPJ</option>
                                                <option value="E-mail">E-mail</option>
                                                <option value="Chave Aleat√≥ria">Chave Aleat√≥ria</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Chave de Registro</label>
                                            <input id="pixKey" class="input-egg font-black text-slate-900" placeholder="Insira a chave" required>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Nome do Recebedor (PIX)</label>
                                            <input id="pixNome" class="input-egg font-bold text-slate-700" maxlength="25" required>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Cidade (PIX)</label>
                                            <input id="pixCidade" class="input-egg font-bold text-slate-700" maxlength="15" required>
                                        </div>
                                        <div class="md:col-span-2 pt-2">
                                            <button type="submit" class="w-full bg-slate-900 hover:bg-black text-white py-5 rounded-[20px] font-black uppercase text-sm shadow-xl transition-all">Sincronizar Chave PIX</button>
                                        </div>
                                    </form>
                                </div>
                                <div class="w-full lg:w-72 bg-slate-50 p-8 rounded-[32px] text-center border border-slate-200 flex flex-col items-center">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Teste do QR Code (R$ 1,00)</p>
                                    <div id="qrPreview" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 w-[172px] h-[172px] flex items-center justify-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                case 'loja': 
                    const s = window.state.storeConfig;
                    return `
                    <div class="space-y-10 fade-in">
                        <div>
                            <h2 class="text-4xl font-[950] text-slate-900 tracking-tighter uppercase italic">Apar√™ncia da Loja</h2>
                            <p class="text-slate-500 font-bold text-sm">Personalize os textos e o visual do app dos clientes.</p>
                        </div>
                        <div class="bg-white rounded-[40px] p-10 border border-slate-200 shadow-sm">
                            <form onsubmit="window.handleSaveStoreConfig(event)" class="space-y-8">
                                <div>
                                    <h3 class="text-lg font-black text-slate-800 uppercase mb-4 border-b border-slate-100 pb-2">Identidade e Textos</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="text-[11px] font-black uppercase text-slate-500 ml-2">Nome da Loja</label>
                                            <input name="nome" type="text" class="input-egg text-slate-900 font-black" required>
                                        </div>
                                        <div class="flex gap-4">
                                            <div class="w-1/3">
                                                <label class="text-[11px] font-black uppercase text-slate-500 ml-2">√çcone</label>
                                                <input name="emoji" type="text" class="input-egg text-center text-xl" maxlength="4">
                                            </div>
                                            <div class="flex-1">
                                                <label class="text-[11px] font-black uppercase text-slate-500 ml-2">Slogan</label>
                                                <input name="slogan" type="text" class="input-egg" placeholder="Ex: Direto da Granja">
                                            </div>
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="text-[11px] font-black uppercase text-slate-500 ml-2">T√≠tulo Principal (Banner Destaque)</label>
                                            <input name="heroTitle" type="text" class="input-egg font-bold" placeholder="Ex: Ovos Fresquinhos ü•ö">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="text-[11px] font-black uppercase text-slate-500 ml-2">Subt√≠tulo (Banner Destaque)</label>
                                            <textarea name="heroDesc" rows="2" class="input-egg py-3" placeholder="Mensagem para seus clientes..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-black text-slate-800 uppercase mb-4 border-b border-slate-100 pb-2">Cores do Tema</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                            <input type="color" name="corPrimaria" class="w-12 h-12 rounded-lg cursor-pointer border-0 p-0 bg-transparent">
                                            <div>
                                                <p class="font-black text-xs uppercase text-slate-700">Cor Principal (Bot√µes e Destaques)</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                            <input type="color" name="corSecundaria" class="w-12 h-12 rounded-lg cursor-pointer border-0 p-0 bg-transparent">
                                            <div>
                                                <p class="font-black text-xs uppercase text-slate-700">Cor Secund√°ria (Degrad√™ do Topo)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-5 rounded-[20px] font-black uppercase text-sm shadow-xl active:scale-95 transition-all">
                                    üíæ Salvar Apar√™ncia da Loja
                                </button>
                            </form>
                        </div>
                    </div>`;
            }
        };

        window.buildDashStats = () => {
            const active = window.state.logs.filter(l => !["FINALIZADO", "CANCELADO"].includes(l.status));
            const pendingTotal = active.reduce((acc,l)=>acc+(Number(l.valorTotal)||0), 0);
            const produtosAtivos = window.state.produtos.filter(p => p.ativo).length;
            return `
                <div class="bg-gradient-to-br from-rose-700 to-rose-500 p-8 rounded-[32px] text-white shadow-xl">
                    <p class="text-xs font-black uppercase opacity-80 mb-2">Pedidos em Andamento</p>
                    <h3 class="text-5xl font-[950] italic">${active.length}</h3>
                </div>
                <div class="bg-white border border-slate-200 p-8 rounded-[32px] shadow-sm text-slate-800">
                    <p class="text-xs font-black uppercase text-slate-400 mb-2">Valores a Receber</p>
                    <h3 class="text-4xl font-[950] italic text-slate-700">R$ ${pendingTotal.toFixed(2)}</h3>
                </div>
                <div class="bg-slate-900 p-8 rounded-[32px] text-white shadow-2xl">
                    <p class="text-xs font-black uppercase opacity-60 mb-2">Produtos na Vitrine</p>
                    <h3 class="text-5xl font-[950] italic">${produtosAtivos} / ${window.state.produtos.length}</h3>
                </div>
            `;
        };

        window.buildDashOrders = () => {
            const active = window.state.logs.filter(l => !["FINALIZADO", "CANCELADO"].includes(l.status));
            return active.slice(0, 5).map(l => {
                const cliente = l.dadosCliente?.nome || 'Cliente An√¥nimo';
                const isEntrega = l.tipoEntrega === 'entrega';
                const entregaTag = isEntrega ? '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-black italic">üöö ENTREGA</span>' : '<span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-[10px] font-black italic">üè™ RETIRADA</span>';
                
                return `
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-slate-800 uppercase text-xs mb-1">${cliente} <span class="text-rose-500 text-[10px] ml-1">${l.pedidoID || ''}</span></p>
                        <div class="flex items-center gap-2">
                            ${entregaTag}
                            <span class="text-[10px] font-bold text-slate-500 uppercase">R$ ${Number(l.valorTotal).toFixed(2)}</span>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-white border border-slate-200 text-slate-700 rounded-full font-bold text-[10px] uppercase shadow-sm">${l.status}</span>
                </div>
                `
            }).join('') || '<p class="text-center font-bold text-slate-400 py-6">Sem pedidos no momento.</p>';
        };

        // GERA A LISTA DE PRODUTOS NO FORMATO EXATO QUE O UTILIZADOR PEDIU
        window.buildEstoqueList = () => {
            if (window.state.produtos.length === 0) {
                return `
                <div class="col-span-full bg-slate-50 border-2 border-dashed border-slate-200 rounded-[32px] p-10 text-center">
                    <span class="text-5xl block mb-4">üì¶</span>
                    <h3 class="text-xl font-black text-slate-800 mb-2 uppercase italic">Cat√°logo Vazio</h3>
                    <p class="text-sm font-bold text-slate-500 mb-6">Parece que n√£o existem produtos guardados no sistema.</p>
                    <button onclick="window.carregarProdutosPadrao()" class="bg-rose-600 hover:bg-rose-700 text-white px-8 py-4 rounded-[20px] font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Carregar Produtos Iniciais da Ovos Aline</button>
                </div>`;
            }

            return window.state.produtos.map(p => {
                let badgeColor = '#64748b'; // default slate
                if(p.badgeClass === 'green') badgeColor = '#10b981';
                if(p.badgeClass === 'amber') badgeColor = '#f59e0b';
                if(p.badgeClass === 'rose') badgeColor = '#e11d48';

                const badgeHtml = p.badge ? `<span style="background:${badgeColor};color:#fff;font-size:.65rem;padding:2px 8px;border-radius:50px;font-weight:800;vertical-align:middle;margin-left:8px">${p.badge}</span>` : '';
                
                return `
                <div class="prod-item ${p.ativo ? '' : 'inactive'}">
                    <div class="prod-emoji">${p.emoji || 'ü•ö'}</div>
                    <div class="prod-info">
                        <h4>${p.nome} ${badgeHtml}</h4>
                        <p>${p.tipo || ''} ¬∑ ${p.ativo ? '‚úÖ Ativo na Loja' : '‚è∏ Oculto da Loja'}</p>
                    </div>
                    <div class="prod-price">R$ ${Number(p.preco).toFixed(2).replace('.',',')}</div>
                    <div class="prod-actions">
                        <button title="Ativar / Ocultar" class="toggle-btn" onclick="window.toggleProd('${p.id}')">${p.ativo ? 'üü¢' : '‚ö´'}</button>
                        <button class="btn btn-ghost btn-sm" onclick="window.openProdModal('${p.id}')">‚úèÔ∏è Editar</button>
                        <button class="btn btn-red btn-sm" onclick="window.pedirConfirmExcluir('${p.id}')">üóë</button>
                    </div>
                </div>
                `
            }).join('');
        };

        window.buildPedidosList = () => {
            const pending = window.state.logs.filter(l => !['FINALIZADO','CANCELADO'].includes(l.status));
            return pending.map(l => {
                const cliente = l.dadosCliente?.nome || 'Cliente N√£o Identificado';
                const telefone = l.dadosCliente?.tel || 'Sem telefone';
                const isEntrega = l.tipoEntrega === 'entrega';
                const entregaStr = isEntrega ? 'üöö ENTREGA' : 'üè™ RETIRAR NA LOJA';
                const endereco = isEntrega 
                    ? `${l.dadosCliente?.rua || ''}, ${l.dadosCliente?.num || ''} - ${l.dadosCliente?.bairro || ''} <br><span class="text-[10px] uppercase font-bold text-slate-400 mt-1 block">Comp: ${l.dadosCliente?.comp || 'N/A'}</span>`
                    : 'Cliente vai at√© o endere√ßo f√≠sico da loja para retirar.';
                
                const itensStr = (l.itens || []).map(i => `<span class="bg-rose-50 text-rose-700 px-2 py-0.5 rounded font-black text-xs mr-1 border border-rose-100">${i.qtd || i.quantidade}x</span> <span class="font-bold text-slate-700">${i.nome || i.produto}</span>`).join('<br>');
                const pagStr = (l.formaPagamento || 'N√£o Informado').replace('_', ' ').toUpperCase();

                let borderStatus = 'border-slate-300';
                if (l.status === 'CRIADO') borderStatus = 'border-amber-400';
                else if (l.status === 'EM SEPARA√á√ÉO') borderStatus = 'border-rose-500';
                else if (l.status === 'SAIU PARA ENTREGA' || l.status === 'PRONTO PARA RETIRADA') borderStatus = 'border-emerald-500';

                return `
                <div class="bg-white p-8 rounded-[32px] border-l-[12px] ${borderStatus} shadow-sm border-y border-r border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-100 pb-5 mb-5 gap-4">
                        <div>
                            <span class="text-xs font-black uppercase text-rose-600 bg-rose-50 px-3 py-1 rounded-full border border-rose-200 tracking-widest block w-max mb-2">
                                Pedido ${l.pedidoID || '#---'}
                            </span>
                            <span class="text-[10px] font-bold text-slate-400 block mb-1">${l.criadoEm ? new Date(l.criadoEm.seconds * 1000).toLocaleString('pt-BR') : 'Hoje'}</span>
                            <h3 class="text-xl font-black text-slate-900 uppercase">${cliente}</h3>
                            <p class="text-xs font-bold text-slate-500 mt-1">üìû ${telefone}</p>
                        </div>
                        <div class="text-left md:text-right">
                            <span class="px-3 py-1.5 rounded-lg text-[9px] font-black uppercase ${isEntrega ? 'bg-blue-50 text-blue-700 border border-blue-100' : 'bg-emerald-50 text-emerald-700 border border-emerald-100'} inline-block mb-2">${entregaStr}</span>
                            <p class="text-2xl font-[950] text-rose-600">R$ ${Number(l.valorTotal).toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-2 border-b border-slate-50 pb-2">Itens Solicitados</p>
                            <p class="text-sm leading-loose">${itensStr}</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-2 border-b border-slate-50 pb-2">Forma de Pagamento</p>
                            <p class="text-[11px] font-black text-slate-700 inline-block px-3 py-1.5 bg-slate-100 border border-slate-200 rounded-lg uppercase">${pagStr}</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-2 border-b border-slate-50 pb-2">Endere√ßo / Retirada</p>
                            <p class="text-sm font-medium text-slate-600 leading-relaxed">${endereco}</p>
                        </div>
                    </div>

                    <div class="mt-6 pt-5 border-t border-slate-100 flex items-center gap-4">
                        <span class="text-[10px] font-black text-slate-400 uppercase">Atualizar Status Operacional:</span>
                        <select onchange="window.handleStatusUpdate('${l.id}', this.value)" class="p-4 bg-slate-900 text-white rounded-xl font-black text-[11px] uppercase outline-none cursor-pointer flex-1 md:flex-none md:w-64 text-center shadow-lg border-b-4 border-black active:border-b-0 active:translate-y-1 transition-all">
                            ${STATUS_OPTIONS.map(opt => `<option value="${opt}" ${l.status===opt?'selected':''}>${opt}</option>`).join('')}
                        </select>
                    </div>
                </div>
                `;
            }).join('') || '<div class="text-center py-16 bg-white rounded-[32px] border border-slate-200"><p class="font-black text-slate-300 uppercase italic text-lg">Nenhum pedido na fila</p></div>';
        };

        window.buildFinStats = () => {
            const finished = window.state.logs.filter(l => l.status === 'FINALIZADO');
            const total = finished.reduce((acc,l)=>acc+Number(l.valorTotal),0);

            return `
                <div class="bg-white rounded-[40px] p-12 border border-slate-200 shadow-sm text-center max-w-md">
                    <p class="text-[11px] font-black uppercase text-slate-400 mb-2">Faturamento Bruto Realizado</p>
                    <h3 class="text-5xl font-[950] text-emerald-500">R$ ${total.toFixed(2)}</h3>
                </div>
            `;
        };

        window.buildModalExcluir = () => {
            return `
                <div class="fixed inset-0 modal-blur z-[1000] flex items-center justify-center p-4">
                    <div class="bg-white rounded-[40px] p-10 max-w-sm w-full shadow-2xl text-center border border-slate-100">
                        <div class="w-20 h-20 rounded-full bg-rose-50 text-rose-600 flex items-center justify-center mx-auto mb-6 text-4xl font-black">!</div>
                        <h3 class="text-2xl font-black text-slate-900 mb-2 uppercase italic tracking-tighter">Apagar Produto?</h3>
                        <p class="text-slate-500 text-sm font-bold mb-10">O item sumir√° instantaneamente da vitrine e do estoque.</p>
                        <div class="flex flex-col gap-4">
                            <button onclick="window.handleExcluirReal()" class="w-full py-5 rounded-[24px] bg-rose-600 hover:bg-rose-700 text-white font-black text-xs uppercase italic shadow-lg active:scale-95 transition-all">Deletar Permanentemente</button>
                            <button onclick="window.state.confirmExcluir=null;window.syncData()" class="w-full py-5 rounded-[24px] text-slate-500 bg-slate-100 font-black text-xs uppercase italic active:scale-95 transition-all">Cancelar</button>
                        </div>
                    </div>
                </div>`;
        };

        // --- LISTENERS E INIT ---
        function initAdminListeners() {
            if (window.adminListenersInitialized) return;
            window.adminListenersInitialized = true;

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'estoque'), s => {
                const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                const cleanData = data.map(({updatedAt, ...rest}) => rest);
                const hash = JSON.stringify(cleanData);
                if (hash !== lastStockHash) {
                    lastStockHash = hash;
                    window.state.produtos = data.sort((a,b)=>(a.nome||"").localeCompare(b.nome||""));
                    
                    // Auto-preenchimento
                    if (data.length === 0 && window.state.loading) {
                        window.carregarProdutosPadrao();
                    } else {
                        window.state.loading = false; 
                        window.syncData();
                    }
                }
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'vendas_logs'), s => {
                const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                const cleanData = data.map(({atualizadoEm, ...rest}) => rest);
                const hash = JSON.stringify(cleanData);
                if (hash !== lastLogsHash) {
                    if (data.length > window.state.lastOrderCount && window.state.lastOrderCount !== 0) {
                        window.state.hasNewOrder = true; window.showToast("üîî NOVO PEDIDO RECEBIDO!");
                    }
                    window.state.lastOrderCount = data.length;
                    
                    window.state.logs = data.sort((a,b)=>{
                        const tA = a.criadoEm?.seconds || Date.now()/1000;
                        const tB = b.criadoEm?.seconds || Date.now()/1000;
                        return tB - tA;
                    });
                    
                    lastLogsHash = hash; window.syncData();
                }
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pix_config'), snap => {
                if (snap.exists()) { 
                    const data = snap.data();
                    const hash = JSON.stringify({t: data.type, k: data.key, c: data.copiaCola});
                    if (hash !== lastPixHash) {
                        lastPixHash = hash;
                        window.state.pixConfig = data; window.syncData(); 
                    }
                }
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'store_config'), snap => {
                if (snap.exists()) { 
                    const data = snap.data();
                    const hash = JSON.stringify(data);
                    if (hash !== lastStoreConfigHash) {
                        lastStoreConfigHash = hash;
                        window.state.storeConfig = { ...window.state.storeConfig, ...data };
                        window.syncData(); 
                    }
                }
            });
        }

        onAuthStateChanged(auth, u => {
            const hasBypass = localStorage.getItem('admin_bypass') === 'true';
            if (hasBypass || (u && u.email === 'thon@lojista.com.br')) {
                window.state.user = { email: 'thon@lojista.com.br', uid: u?.uid };
                initAdminListeners();
            } else {
                window.state.user = null;
                window.state.loading = false;
                window.render();
            }
        });
    </script>
</body>
</html>
