<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg Admin | Gestão de Distribuição</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        .font-title { font-family: 'Montserrat', sans-serif; }
        .nav-link { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; padding: 10px 5px; border-bottom: 3px solid transparent; }
        .nav-link.active { color: #e11d48; border-bottom-color: #e11d48; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; }
        .status-badge { padding: 4px 8px; border-radius: 99px; font-size: 9px; font-weight: 900; text-transform: uppercase; }
        .status-pendente { background: #fef9c3; color: #854d0e; }
        .status-finalizado { background: #dcfce7; color: #166534; }
    </style>
</head>
<body class="pb-10">
    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";

        window.state = { view: 'pedidos', produtos: [], logs: [], editingId: null };

        window.actions = {
            loadProdutos: async () => {
                const res = await fetch(`${API_BASE}/produtos`);
                window.state.produtos = await res.json();
                window.render();
            },
            mudarStatus: async (id, status) => {
                await updateDoc(doc(db, "vendas_logs", id), { status });
            },
            deleteLog: async (id) => {
                if(confirm("Excluir permanentemente?")) await deleteDoc(doc(db, "vendas_logs", id));
            },
            gerarPDF: (p) => {
                const { jsPDF } = window.jspdf;
                const docPdf = new jsPDF();
                docPdf.setFillColor(225, 29, 72);
                docPdf.rect(0, 0, 210, 40, 'F');
                docPdf.setTextColor(255, 255, 255);
                docPdf.setFontSize(22);
                docPdf.text("AppEgg - Recibo de Venda", 20, 25);
                docPdf.setTextColor(0,0,0);
                docPdf.setFontSize(12);
                docPdf.text(`Cliente: ${p.clienteNome}`, 20, 60);
                docPdf.text(`Produto: ${p.produto}`, 20, 70);
                docPdf.text(`Pagamento: ${p.pagamento}`, 20, 80);
                docPdf.text(`Total: R$ ${parseFloat(p.precoNoMomento || 0).toFixed(2)}`, 20, 90);
                docPdf.save(`recibo-${p.clienteNome}.pdf`);
            },
            gerarRoteiroEntregas: () => {
                const { jsPDF } = window.jspdf;
                const docPdf = new jsPDF();
                const pendentes = window.state.logs.filter(l => l.status !== 'FINALIZADO');
                docPdf.text("AppEgg | Roteiro de Entregas", 20, 20);
                let y = 40;
                pendentes.forEach(p => {
                    docPdf.text(`${p.clienteNome} - ${p.produto} - ${p.clienteWhatsapp}`, 20, y);
                    y += 10;
                });
                docPdf.save("roteiro-entregas.pdf");
            }
        };

        onSnapshot(query(collection(db, "vendas_logs"), orderBy("criadoEm", "desc")), (snap) => {
            window.state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            window.render();
        });

        window.render = () => {
            const root = document.getElementById('app-root');
            const pedidosUnicos = window.state.logs.filter(l => l.tipo !== 'assinatura');
            const assinaturas = window.state.logs.filter(l => l.tipo === 'assinatura');
            
            const clientesMap = {};
            window.state.logs.forEach(l => {
                if (!clientesMap[l.clienteWhatsapp]) clientesMap[l.clienteWhatsapp] = { ...l, total: 0 };
                clientesMap[l.clienteWhatsapp].total++;
            });

            root.innerHTML = `
                <nav class="bg-white border-b px-6 sticky top-0 z-50">
                    <div class="max-w-6xl mx-auto flex justify-between items-center h-20">
                        <h1 class="font-title font-900 text-rose-600 italic text-2xl tracking-tighter uppercase">AppEgg</h1>
                        <div class="flex gap-4">
                            <button onclick="window.state.view='pedidos';window.render()" class="nav-link ${window.state.view==='pedidos'?'active':''}">Pedidos</button>
                            <button onclick="window.state.view='assinaturas';window.render()" class="nav-link ${window.state.view==='assinaturas'?'active':''}">Clube</button>
                            <button onclick="window.state.view='clientes';window.render()" class="nav-link ${window.state.view==='clientes'?'active':''}">Clientes</button>
                        </div>
                    </div>
                </nav>
                <main class="max-w-6xl mx-auto p-6">
                    ${window.state.view === 'pedidos' ? `
                        <div class="flex justify-between mb-6">
                            <h2 class="font-title font-900 uppercase">Entregas Pendentes</h2>
                            <button onclick="window.actions.gerarRoteiroEntregas()" class="bg-black text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Imprimir Roteiro</button>
                        </div>
                        <div class="grid gap-4">
                            ${pedidosUnicos.map(p => `
                                <div class="card p-5 border-l-4 ${p.status === 'FINALIZADO' ? 'border-green-500' : 'border-rose-500'} flex justify-between items-center">
                                    <div>
                                        <span class="status-badge ${p.status === 'FINALIZADO' ? 'status-finalizado' : 'status-pendente'}">${p.status || 'PENDENTE'}</span>
                                        <h3 class="font-bold text-gray-800 mt-1">${p.clienteNome}</h3>
                                        <p class="text-xs text-rose-500 font-black">${p.produto}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick='window.actions.gerarPDF(${JSON.stringify(p)})' class="bg-blue-100 text-blue-600 p-2 rounded-lg text-[10px] font-bold">PDF</button>
                                        <a href="https://wa.me/55${p.clienteWhatsapp}" target="_blank" class="bg-green-100 text-green-600 p-2 rounded-lg text-[10px] font-bold">ZAP</a>
                                        ${p.status !== 'FINALIZADO' ? `<button onclick="window.actions.mudarStatus('${p.id}', 'FINALIZADO')" class="bg-rose-600 text-white p-2 rounded-lg text-[10px] font-bold uppercase">Entregue</button>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${window.state.view === 'clientes' ? `
                        <h2 class="font-title font-900 uppercase mb-6">Meus Clientes</h2>
                        <div class="card overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 text-[10px] font-black text-gray-400 uppercase">
                                    <tr><th class="p-4">Nome</th><th class="p-4">WhatsApp</th><th class="p-4">Pedidos</th><th class="p-4">Ação</th></tr>
                                </thead>
                                <tbody>
                                    ${Object.values(clientesMap).map(c => `
                                        <tr class="border-t">
                                            <td class="p-4 font-bold text-sm">${c.clienteNome}</td>
                                            <td class="p-4 text-xs font-bold">${c.clienteWhatsapp}</td>
                                            <td class="p-4 font-black text-rose-500">${c.total}</td>
                                            <td class="p-4"><a href="https://wa.me/55${c.clienteWhatsapp}" target="_blank" class="text-green-600 font-bold text-[10px] uppercase">Chamar</a></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </main>
            `;
        };
        window.actions.loadProdutos();
    </script>
</body>
</html>