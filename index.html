<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg Admin | Gest√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #1f2937; }
        .card { background: #ffffff; border: 1px solid #f3f4f6; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .nav-link { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #9ca3af; padding: 12px 14px; border-radius: 12px; cursor: pointer; }
        .nav-link.active { color: #e11d48; background: #fff1f2; }
        .logo-text { font-weight: 800; color: #e11d48; font-size: 1.25rem; font-style: italic; }
        .input-egg { width: 100%; padding: 14px; background: #f9fafb; border-radius: 16px; border: 1px solid #f3f4f6; font-weight: 700; font-size: 13px; outline: none; }
    </style>
</head>
<body>
<div id="app-root"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
        authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
        projectId: "distribuidora-de-ovos-aline",
        storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
        messagingSenderId: "92187548716",
        appId: "1:92187548716:web:d61d18a29aa76aead7c589"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";

    window.state = { user:null, view:'pedidos', logs:[], produtos:[], editando: null };

    onAuthStateChanged(auth, user => {
        window.state.user = user;
        if(user) { loadProdutos(); initRealtime(); }
        render();
    });

    async function loadProdutos() {
        const r = await fetch(`${API_BASE}/produtos`);
        state.produtos = await r.json();
        render();
    }

    function initRealtime() {
        onSnapshot(query(collection(db,"vendas_logs"), orderBy("criadoEm","desc")), s => {
            state.logs = s.docs.map(d => ({id:d.id, ...d.data()}));
            render();
        });
    }

    function render() {
        const root = document.getElementById('app-root');
        if(!window.state.user) {
            root.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-rose-600"><form onsubmit="login(event)" class="bg-white p-10 rounded-3xl space-y-4"><div class="logo-text text-3xl text-center">AppEgg Admin</div><input name="email" class="w-full p-4 border rounded-xl" placeholder="Email"><input name="pass" type="password" class="w-full p-4 border rounded-xl" placeholder="Senha"><button class="w-full bg-rose-600 text-white py-4 rounded-xl font-black">Entrar</button></form></div>`;
            return;
        }

        root.innerHTML = `
        <nav class="bg-white border-b px-6 h-20 flex justify-between items-center">
            <div class="logo-text">AppEgg Admin</div>
            <div class="flex gap-1">
                <button class="nav-link ${state.view==='pedidos'?'active':''}" onclick="state.view='pedidos';render()">Pedidos</button>
                <button class="nav-link ${state.view==='estoque'?'active':''}" onclick="state.view='estoque';render()">Estoque</button>
                <button class="nav-link ${state.view==='financeiro'?'active':''}" onclick="state.view='financeiro';render()">Financeiro</button>
                <button class="nav-link" onclick="window.logout()">Sair</button>
            </div>
        </nav>
        <main class="p-6 max-w-5xl mx-auto">
            ${state.view==='financeiro' ? renderFinanceiro() : state.view==='estoque' ? renderEstoque() : renderPedidos()}
        </main>`;
    }

    function renderPedidos() {
        const ativos = state.logs.filter(l => !['FINALIZADO','CANCELADO'].includes(l.status));
        return ativos.map(l => `
        <div class="card p-6 mb-4 border-l-8 ${l.status==='AGUARDANDO PAGAMENTO'?'border-rose-400':'border-blue-400'}">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-black">${l.clienteNome}</h3>
                <span class="text-[9px] font-black uppercase bg-gray-100 px-2 py-1 rounded-md">${l.status}</span>
            </div>
            <p class="text-xs mb-4 font-bold text-gray-400">${l.quantidade}x ${l.produto} ‚Äî R$ ${l.valorTotal.toFixed(2)}</p>
            <div class="flex gap-2">
                <button onclick="finalizar('${l.id}')" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-black text-xs uppercase">Concluir e Avisar</button>
                <button onclick="cancelar('${l.id}')" class="bg-gray-100 px-4 rounded-xl font-black text-xs text-gray-400 uppercase">Cancelar</button>
            </div>
        </div>`).join('') || `<p class="text-center text-gray-300 font-black py-10 uppercase text-xs">Sem pedidos</p>`;
    }

    function renderEstoque() {
        const p = state.editando || { nome: '', preco: '', preco_custo: '', quantidade: '' };
        return `
        <div class="card p-6 mb-6">
            <h3 class="font-black text-xs uppercase mb-4 text-rose-600 italic">Gerenciar Produto</h3>
            <form onsubmit="salvarProduto(event)" class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input name="nome" value="${p.nome}" placeholder="Nome" class="input-egg border md:col-span-2" required>
                <input name="preco_custo" type="number" step="0.01" value="${p.preco_custo}" placeholder="Custo R$" class="input-egg border" required>
                <input name="preco" type="number" step="0.01" value="${p.preco}" placeholder="Venda R$" class="input-egg border" required>
                <input name="quantidade" type="number" value="${p.quantidade}" placeholder="Estoque" class="input-egg border" required>
                <button class="bg-rose-600 text-white font-black rounded-xl uppercase text-xs py-4 md:col-span-3">Salvar</button>
                ${state.editando ? `<button type="button" onclick="state.editando=null;render()" class="bg-gray-100 text-gray-400 rounded-xl font-black text-xs">Cancelar</button>` : ''}
            </form>
        </div>
        <div class="grid gap-2">
            ${state.produtos.map(prod => `
            <div class="card p-4 flex justify-between items-center">
                <div><p class="font-black text-xs uppercase">${prod.nome}</p><p class="text-[10px] text-gray-400 font-bold">Estoque: ${prod.quantidade}</p></div>
                <button onclick='state.editando=${JSON.stringify(prod)};render()' class="text-blue-500 font-black text-[10px] uppercase">Editar</button>
            </div>`).join('')}
        </div>`;
    }

    function renderFinanceiro() {
        const fins = state.logs.filter(l => l.status === 'FINALIZADO');
        let totalVenda = 0;
        let totalCusto = 0;

        fins.forEach(l => {
            totalVenda += (l.valorTotal || 0);
            const pInfo = state.produtos.find(p => p.nome === l.produto);
            totalCusto += (pInfo?.preco_custo || l.precoUnidade * 0.7) * l.quantidade; // Fallback 70% custo se n√£o achar
        });

        return `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="card p-8 text-center bg-rose-600 text-white shadow-xl shadow-rose-100">
                <p class="text-[10px] uppercase font-black opacity-70">Vendido</p>
                <h2 class="text-3xl font-black italic">R$ ${totalVenda.toFixed(2)}</h2>
            </div>
            <div class="card p-8 text-center bg-gray-800 text-white">
                <p class="text-[10px] uppercase font-black opacity-70">Custo</p>
                <h2 class="text-3xl font-black italic">R$ ${totalCusto.toFixed(2)}</h2>
            </div>
            <div class="card p-8 text-center bg-emerald-500 text-white shadow-xl shadow-emerald-100">
                <p class="text-[10px] uppercase font-black opacity-70">Lucro Real</p>
                <h2 class="text-3xl font-black italic">R$ ${(totalVenda - totalCusto).toFixed(2)}</h2>
            </div>
        </div>`;
    }

    // A√ß√µes
    window.login = async e => {
        e.preventDefault();
        await signInWithEmailAndPassword(auth, e.target.email.value, e.target.pass.value);
    };
    window.logout = () => signOut(auth);

    window.finalizar = async id => {
        const snap = await getDoc(doc(db,"vendas_logs",id));
        const p = snap.data();
        await updateDoc(doc(db,"vendas_logs",id), { status:'FINALIZADO', horarioConcluido: serverTimestamp() });
        
        const msg = `Ol√° ${p.clienteNome}! Seu pedido de ${p.quantidade}x ${p.produto} foi conclu√≠do e j√° est√° saindo para entrega! ü•ö‚ú®`;
        window.open(`https://wa.me/${p.telefone || ''}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.cancelar = async id => {
        const snap = await getDoc(doc(db,"vendas_logs",id));
        const p = snap.data();
        const prodRes = await fetch(`${API_BASE}/produtos/${p.produtoId}`);
        const prod = await prodRes.json();
        await fetch(`${API_BASE}/produtos/${p.produtoId}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ quantidade: prod.quantidade + p.quantidade })
        });
        await updateDoc(doc(db,"vendas_logs",id), { status:'CANCELADO' });
    };

    window.salvarProduto = async e => {
        e.preventDefault();
        const f = new FormData(e.target);
        const payload = {
            nome: f.get('nome'),
            preco: parseFloat(f.get('preco')),
            preco_custo: parseFloat(f.get('preco_custo')),
            quantidade: parseInt(f.get('quantidade')),
            tipo_estoque: 'Unidade'
        };
        const url = state.editando ? `${API_BASE}/produtos/${state.editando.id}` : `${API_BASE}/produtos`;
        await fetch(url, { method: state.editando?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        state.editando = null;
        loadProdutos();
    };

    window.render = render;
</script>
</body>
</html>