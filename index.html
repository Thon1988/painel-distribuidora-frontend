<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="app-root" class="w-full max-w-2xl bg-white p-10 rounded-2xl shadow-xl">
        <div class="text-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-500">Sincronizando com AppEgg...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { api } from "./api.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        window.api = api;
        window.state = { user: null, loading: true, produtos: [] };

        window.logout = () => signOut(auth);
        
        window.cadastrarNovoProduto = async () => {
            const nome = prompt("Nome:");
            const preco = prompt("PreÃ§o:");
            const qtd = prompt("Qtd:");
            if(!nome || !preco) return;
            try {
                await api.createProduto({ nome, preco: parseFloat(preco), quantidade: parseInt(qtd) });
                alert("Salvo!");
                window.state.produtos = await api.getProdutos();
                render();
            } catch (e) { alert("Erro ao salvar"); }
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Erro no login"); }
        };

        function render() {
            const root = document.getElementById('app-root');
            const { loading, user, produtos } = window.state;

            if (loading) {
                root.innerHTML = `<div class="text-center"><div class="loader mb-4"></div><p>Carregando...</p></div>`;
                return;
            }

            if (user && !user.isAnonymous) {
                const itens = produtos.map(p => `<div class="flex justify-between p-3 border-b"><span>${p.nome}</span><b>R$ ${p.preco}</b></div>`).join('');
                root.innerHTML = `
                    <div class="flex justify-between mb-6">
                        <h1 class="text-xl font-bold">Painel Distribuidora</h1>
                        <button onclick="logout()" class="text-red-500">Sair</button>
                    </div>
                    <button onclick="cadastrarNovoProduto()" class="w-full bg-indigo-600 text-white p-3 rounded-lg mb-6">+ Novo Produto</button>
                    <div class="bg-gray-50 rounded-lg">${itens || '<p class="p-4 text-center">Nenhum produto.</p>'}</div>
                `;
            } else {
                root.innerHTML = `
                    <h1 class="text-2xl font-bold text-center mb-6">Login AppEgg</h1>
                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        <input id="email" type="email" placeholder="Email" class="w-full p-3 border rounded-lg">
                        <input id="pass" type="password" placeholder="Senha" class="w-full p-3 border rounded-lg">
                        <button class="w-full bg-indigo-600 text-white p-3 rounded-lg">Entrar</button>
                    </form>
                `;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            window.state.user = user;
            if (user && !user.isAnonymous) {
                window.state.produtos = await api.getProdutos();
            }
            window.state.loading = false;
            render();
        });

        window.render = render;
    </script>
</body>
</html>