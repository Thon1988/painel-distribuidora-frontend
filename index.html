<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppEgg Admin | Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f2f5; color: #1e293b; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .nav-active { background: #4f46e5; color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); }
        .card-order { transition: transform 0.2s; }
        .card-order:hover { transform: translateY(-4px); }
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-root"></div>
    <div id="printable-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3Otz9-zdZH-E5Feg9IOGWPzVycoe8gro",
            authDomain: "distribuidora-de-ovos-aline.firebaseapp.com",
            projectId: "distribuidora-de-ovos-aline",
            storageBucket: "distribuidora-de-ovos-aline.firebasestorage.app",
            messagingSenderId: "92187548716",
            appId: "1:92187548716:web:d61d18a29aa76aead7c589"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const API_BASE = "https://painel-distribuidora-backend.onrender.com/api";

        window.state = { user: null, view: 'pedidos', produtos: [], pedidos: [], editingProduct: null };

        window.actions = {
            login: async (e) => {
                e.preventDefault();
                try { await signInWithEmailAndPassword(auth, e.target.email.value, e.target.senha.value); } 
                catch (e) { alert("Acesso negado."); }
            },
            logout: () => signOut(auth),
            loadEstoque: async () => {
                const res = await fetch(`${API_BASE}/produtos`);
                window.state.produtos = await res.json();
                window.render();
            },
            updateStatus: async (id, status) => { await updateDoc(doc(db, "vendas_logs", id), { status }); },
            excluirPedido: async (id) => {
                if(prompt("Senha Admin:") === "admin123") await deleteDoc(doc(db, "vendas_logs", id));
            },
            excluirProduto: async (id) => {
                if(prompt("Senha Admin:") === "admin123") {
                    await fetch(`${API_BASE}/produtos/${id}`, { method: 'DELETE' });
                    window.actions.loadEstoque();
                }
            },
            imprimir: (o) => {
                const printArea = document.getElementById('printable-area');
                const isCNPJ = o.clienteDoc?.replace(/\D/g, '').length > 11;
                printArea.innerHTML = `<div style="padding:20px; font-family:monospace; width:280px; border:1px solid #000">
                    <center><h2>AppEgg</h2><p>Recibo de Entrega</p></center><hr>
                    <p><b>CLIENTE:</b> ${o.clienteNome}</p>
                    ${isCNPJ ? `<p><b>CNPJ:</b> ${o.clienteDoc}</p>` : ''}
                    <p><b>ENDERE√áO:</b><br>${o.enderecoEntrega}</p><hr>
                    <p><b>ITEM:</b> ${o.quantidade} ${o.tipoEstoque} x ${o.produtoNome}</p>
                    <h3 style="text-align:right">TOTAL: R$ ${(o.precoNoMomento * o.quantidade).toFixed(2)}</h3>
                </div>`;
                window.print();
            }
        };

        // Snapshot de Pedidos e tamb√©m extra√ß√£o de Clientes √önicos
        onSnapshot(query(collection(db, "vendas_logs"), orderBy("criadoEm", "desc")), (snap) => {
            window.state.pedidos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            window.render();
        });

        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            if (user) window.actions.loadEstoque();
            window.render();
        });

        window.render = () => {
            const root = document.getElementById('app-root');
            if (!window.state.user) {
                root.innerHTML = `<div class="h-screen flex items-center justify-center bg-indigo-700 p-6">
                    <form onsubmit="window.actions.login(event)" class="glass p-10 rounded-[3rem] w-full max-w-sm shadow-2xl">
                        <h1 class="text-4xl font-extrabold text-white mb-8 text-center tracking-tighter italic">AppEgg</h1>
                        <input name="email" type="email" value="thon@lojista.com.br" class="w-full p-4 rounded-2xl mb-4 bg-white/20 border border-white/30 text-white placeholder-white/70 outline-none font-semibold">
                        <input name="senha" type="password" placeholder="Sua Senha" class="w-full p-4 rounded-2xl mb-6 bg-white/20 border border-white/30 text-white placeholder-white/70 outline-none font-semibold">
                        <button class="w-full py-4 bg-white text-indigo-700 rounded-2xl font-extrabold shadow-xl">ACESSAR PAINEL</button>
                    </form>
                </div>`;
                return;
            }

            // Clientes √önicos (Baseado nos pedidos)
            const clientesUnicos = Array.from(new Set(window.state.pedidos.map(p => p.clienteEmail)))
                .map(email => window.state.pedidos.find(p => p.clienteEmail === email));

            const hoje = new Date().toLocaleDateString('pt-BR');
            const pedidosHoje = window.state.pedidos.filter(p => p.criadoEm?.toDate().toLocaleDateString('pt-BR') === hoje);
            const totalHoje = pedidosHoje.reduce((acc, p) => acc + (p.precoNoMomento * p.quantidade), 0);

            root.innerHTML = `
                <nav class="p-6 flex justify-between items-center sticky top-0 z-50 glass mb-4">
                    <h1 class="text-2xl font-extrabold italic text-indigo-600 tracking-tighter">AppEgg</h1>
                    <div class="flex gap-1 bg-slate-200/50 p-1 rounded-2xl">
                        ${['pedidos', 'estoque', 'clientes'].map(view => `
                            <button onclick="window.state.view='${view}';window.render()" class="px-5 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition-all ${window.state.view === view ? 'nav-active' : 'text-slate-500'}">${view}</button>
                        `).join('')}
                    </div>
                    <button onclick="window.actions.logout()" class="text-slate-400 font-bold text-xs uppercase">Sair</button>
                </nav>

                <main class="max-w-5xl mx-auto p-6 pt-0">
                    ${window.state.view === 'pedidos' ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                            <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-2xl shadow-indigo-200 relative overflow-hidden">
                                <div class="relative z-10"><p class="text-xs font-bold opacity-70 mb-1 uppercase">Faturamento Hoje</p><h2 class="text-4xl font-extrabold">R$ ${totalHoje.toFixed(2)}</h2></div>
                                <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-white/10 rounded-full"></div>
                            </div>
                            <div class="glass p-8 rounded-[2.5rem] shadow-sm"><p class="text-xs font-bold text-slate-400 mb-1 uppercase">Volume de Vendas</p><h2 class="text-4xl font-extrabold text-slate-800">${pedidosHoje.length} <span class="text-sm font-bold text-slate-300 italic uppercase">Pedidos</span></h2></div>
                        </div>
                        <div class="grid gap-6">
                            ${window.state.pedidos.map(o => `
                                <div class="glass p-6 rounded-[2.5rem] card-order shadow-sm border border-white">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex gap-2">
                                            <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-extrabold uppercase italic">ID #${o.id.slice(-4)}</span>
                                            <span class="bg-slate-100 text-slate-400 px-3 py-1 rounded-full text-[10px] font-extrabold italic uppercase">${o.criadoEm?.toDate().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>
                                        </div>
                                        <div class="flex gap-3">
                                            <button onclick='window.actions.imprimir(${JSON.stringify(o)})' class="text-[10px] font-extrabold text-emerald-500 uppercase">üñ®Ô∏è Recibo</button>
                                            <button onclick="window.actions.excluirPedido('${o.id}')" class="text-[10px] font-extrabold text-red-400 uppercase">Remover</button>
                                        </div>
                                    </div>
                                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                                        <div>
                                            <h3 class="font-extrabold text-lg text-slate-800 leading-tight">${o.clienteNome}</h3>
                                            <p class="text-xs font-semibold text-slate-400 mt-1">${o.enderecoEntrega}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs font-bold text-indigo-600 uppercase mb-1">${o.quantidade} ${o.tipoEstoque} de ${o.produtoNome}</p>
                                            <p class="text-2xl font-black text-slate-800">R$ ${(o.precoNoMomento * o.quantidade).toFixed(2)}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 mt-6">
                                        ${['PENDENTE', 'EM ROTA', 'ENTREGUE'].map(s => `
                                            <button onclick="window.actions.updateStatus('${o.id}', '${s}')" class="flex-1 py-3 rounded-2xl text-[10px] font-extrabold transition-all ${o.status === s ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-400'}">${s}</button>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : window.state.view === 'estoque' ? `
                        <div class="glass p-8 rounded-[3rem] mb-10">
                            <h2 class="font-extrabold text-xl mb-6 uppercase italic text-indigo-600">Gerenciar Estoque</h2>
                            <form onsubmit="/* a√ß√£o de salvar */" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input placeholder="Nome do Produto" class="p-4 rounded-2xl bg-white border outline-none font-bold">
                                <input placeholder="R$ Pre√ßo" class="p-4 rounded-2xl bg-white border outline-none font-bold">
                                <button class="md:col-span-2 py-4 bg-indigo-600 text-white rounded-2xl font-extrabold uppercase">Adicionar Item</button>
                            </form>
                        </div>
                    ` : `
                        <h2 class="font-extrabold text-xl mb-6 uppercase italic text-indigo-600 px-2">Meus Clientes Cadastrados</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${clientesUnicos.map(c => `
                                <div class="glass p-6 rounded-[2.5rem] shadow-sm">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-extrabold text-slate-800 leading-none">${c.clienteNome}</h3>
                                            <p class="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-widest">${c.clienteDoc || 'CPF'}</p>
                                        </div>
                                        <a href="https://wa.me/55${c.clienteWhatsapp?.replace(/\D/g,'')}" target="_blank" class="bg-emerald-500 text-white p-3 rounded-2xl shadow-lg">
                                            <span class="text-xs font-black uppercase">WhatsApp</span>
                                        </a>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-slate-100">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase">Localiza√ß√£o</p>
                                        <p class="text-xs font-semibold text-slate-600 italic">${c.enderecoEntrega}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </main>
            `;
        };
    </script>
</body>
</html>